<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session ca309764-5372-43e8-83bb-f9a68e433ab3 (2026-01-25 18:23Z) -->

# DeleteLocation method update and documentation (2026-01-25 18:23Z)

_**User**_

we have added the DeviceKey behaviour for writing operations, did we also update and document the DeleteLocation method properly?

---

_**Agent (model default, mode Agent)**_


Checking if DeleteLocation uses DeviceKey and is documented. Searching the codebase.


---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "DeleteLocation method implementation DeviceKey authentication",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 746,
            "column": 1
          },
          "endPosition": {
            "line": 807,
            "column": 3
          }
        },
        "contents": "/**\n * DeleteLocation\n * Deletes all location data (current and historical) for a device\n * @param req\n * @param res\n * @param next\n */\nfunction deleteLocation(req, res, next) {\n    var locationRequest = req.MIATARU.request;\n    var deviceId = locationRequest.device();\n    \n    var lastKey = kb.build(deviceId, KEY_LAST);\n    var historyKey = kb.build(deviceId, KEY_HISTORY);\n    var visitKey = kb.build(deviceId, KEY_VISIT);\n    \n    var deletedCount = 0;\n\n    seq()\n        // Delete last known location\n        .par(function() {\n            var done = this;\n            db.del(lastKey, function(error, reply) {\n                if (error) return done(error);\n                if (reply &gt; 0) deletedCount++;\n                done();\n            });\n        })\n        // Delete location history\n        .par(function() {\n            var done = this;\n            db.del(historyKey, function(error, reply) {\n                if (error) return done(error);\n                if (reply &gt; 0) deletedCount++;\n                done();\n            });\n        })\n        // Delete visitor history\n        .par(function() {\n            var done = this;\n            db.del(visitKey, function(error, reply) {\n                if (error) return done(error);\n                if (reply &gt; 0) deletedCount++;\n                done();\n            });\n        })\n        .seq(function() {\n            res.send((new models.ResponseDeleteLocation(deviceId, deletedCount)).data());\n        })\n        .catch(function(error) {\n            next(new errors.InternalServerError(error));\n        });\n}\n\n/**\n * SetDeviceKey\n * Sets or changes the device key for a device\n * @param req\n * @param res\n * @param next\n */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 749
          },
          {
            "text": " * DeleteLocation",
            "lineNumber": 750
          },
          {
            "text": " * Deletes all location data (current and historical) for a device",
            "lineNumber": 751
          },
          {
            "text": " * @param req",
            "lineNumber": 752
          },
          {
            "text": " * @param res",
            "lineNumber": 753
          },
          {
            "text": " * @param next",
            "lineNumber": 754
          },
          {
            "text": " */",
            "lineNumber": 755
          },
          {
            "text": "function deleteLocation(req, res, next) {",
            "lineNumber": 756,
            "isSignature": true
          },
          {
            "text": "    var locationRequest = req.MIATARU.request;",
            "lineNumber": 757
          },
          {
            "text": "    var deviceId = locationRequest.device();",
            "lineNumber": 758
          },
          {
            "text": "    ",
            "lineNumber": 759
          },
          {
            "text": "    var lastKey = kb.build(deviceId, KEY_LAST);",
            "lineNumber": 760
          },
          {
            "text": "    var historyKey = kb.build(deviceId, KEY_HISTORY);",
            "lineNumber": 761
          },
          {
            "text": "    var visitKey = kb.build(deviceId, KEY_VISIT);",
            "lineNumber": 762
          },
          {
            "text": "    ",
            "lineNumber": 763
          },
          {
            "text": "    var deletedCount = 0;",
            "lineNumber": 764
          },
          {
            "lineNumber": 765
          },
          {
            "text": "    seq()",
            "lineNumber": 766
          },
          {
            "text": "        // Delete last known location",
            "lineNumber": 767
          },
          {
            "text": "        .par(function() {",
            "lineNumber": 768
          },
          {
            "text": "            var done = this;",
            "lineNumber": 769
          },
          {
            "text": "            db.del(lastKey, function(error, reply) {",
            "lineNumber": 770
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 771
          },
          {
            "text": "                if (reply &gt; 0) deletedCount++;",
            "lineNumber": 772
          },
          {
            "text": "                done();",
            "lineNumber": 773
          },
          {
            "text": "            });",
            "lineNumber": 774
          },
          {
            "text": "        })",
            "lineNumber": 775
          },
          {
            "text": "        // Delete location history",
            "lineNumber": 776
          },
          {
            "text": "        .par(function() {",
            "lineNumber": 777
          },
          {
            "text": "            var done = this;",
            "lineNumber": 778
          },
          {
            "text": "            db.del(historyKey, function(error, reply) {",
            "lineNumber": 779
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 780
          },
          {
            "text": "                if (reply &gt; 0) deletedCount++;",
            "lineNumber": 781
          },
          {
            "text": "                done();",
            "lineNumber": 782
          },
          {
            "text": "            });",
            "lineNumber": 783
          },
          {
            "text": "        })",
            "lineNumber": 784
          },
          {
            "text": "        // Delete visitor history",
            "lineNumber": 785
          },
          {
            "text": "        .par(function() {",
            "lineNumber": 786
          },
          {
            "text": "            var done = this;",
            "lineNumber": 787
          },
          {
            "text": "            db.del(visitKey, function(error, reply) {",
            "lineNumber": 788
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 789
          },
          {
            "text": "                if (reply &gt; 0) deletedCount++;",
            "lineNumber": 790
          },
          {
            "text": "                done();",
            "lineNumber": 791
          },
          {
            "text": "            });",
            "lineNumber": 792
          },
          {
            "text": "        })",
            "lineNumber": 793
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 794
          },
          {
            "text": "            res.send((new models.ResponseDeleteLocation(deviceId, deletedCount)).data());",
            "lineNumber": 795
          },
          {
            "text": "        })",
            "lineNumber": 796
          },
          {
            "text": "        .catch(function(error) {",
            "lineNumber": 797
          },
          {
            "text": "            next(new errors.InternalServerError(error));",
            "lineNumber": 798
          },
          {
            "text": "        });",
            "lineNumber": 799
          },
          {
            "text": "}",
            "lineNumber": 800,
            "isSignature": true
          },
          {
            "lineNumber": 801
          },
          {
            "text": "/**",
            "lineNumber": 802
          },
          {
            "text": " * SetDeviceKey",
            "lineNumber": 803
          },
          {
            "text": " * Sets or changes the device key for a device",
            "lineNumber": 804
          },
          {
            "text": " * @param req",
            "lineNumber": 805
          },
          {
            "text": " * @param res",
            "lineNumber": 806
          },
          {
            "text": " * @param next",
            "lineNumber": 807
          },
          {
            "text": " */",
            "lineNumber": 808
          }
        ]
      },
      "score": 0.5140373110771179
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 324,
            "column": 1
          },
          "endPosition": {
            "line": 433,
            "column": 1
          }
        },
        "contents": "/**\n * UpdateLocation\n * api endpoint that updates the currentLocation and a arbitrary number of history locations\n *\n * @param req\n * @param res\n * @param next\n */\nfunction updateLocation(req, res, next) {\n    var MIATARU = req.MIATARU;\n    var requestConfig = MIATARU.config;\n    var locations = MIATARU.locations;\n\n    var chain = seq();\n\n    // Validate DeviceKey for each location if DeviceKey is set for the device\n    locations.forEach(function(loc, idx) {\n        var deviceId = loc.device();\n        var providedDeviceKey = loc.deviceKey();\n\n        chain.seq(function() {\n            var done = this;\n            // Check if DeviceKey is set for this device\n            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {\n                if (error) {\n                    return done(error);\n                }\n\n                // If DeviceKey is set for this device, validate provided key\n                if (storedKey !== null &amp;&amp; storedKey !== undefined) {\n                    // DeviceKey is required when it's set\n                    if (!providedDeviceKey || providedDeviceKey === null || providedDeviceKey === '') {\n                        return done(new errors.ForbiddenError('DeviceKey is required for this device'));\n                    }\n\n                    // Validate provided key matches stored key\n                    deviceKeyUtils.validateDeviceKey(deviceId, providedDeviceKey, function(error2, isValid) {\n                        if (error2) {\n                            return done(error2);\n                        }\n\n                        if (!isValid) {\n                            return done(new errors.ForbiddenError('DeviceKey does not match'));\n                        }\n\n                        done();\n                    });\n                } else {\n                    // No DeviceKey set, proceed normally (backward compatible)\n                    done();\n                }\n            });\n        });\n    });\n\n    if(requestConfig.enableLocationHistory())\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 327
          },
          {
            "text": " * UpdateLocation",
            "lineNumber": 328
          },
          {
            "text": " * api endpoint that updates the currentLocation and a arbitrary number of history locations",
            "lineNumber": 329
          },
          {
            "text": " *",
            "lineNumber": 330
          },
          {
            "text": " * @param req",
            "lineNumber": 331
          },
          {
            "text": " * @param res",
            "lineNumber": 332
          },
          {
            "text": " * @param next",
            "lineNumber": 333
          },
          {
            "text": " */",
            "lineNumber": 334
          },
          {
            "text": "function updateLocation(req, res, next) {",
            "lineNumber": 335,
            "isSignature": true
          },
          {
            "text": "    var MIATARU = req.MIATARU;",
            "lineNumber": 336
          },
          {
            "text": "    var requestConfig = MIATARU.config;",
            "lineNumber": 337
          },
          {
            "text": "    var locations = MIATARU.locations;",
            "lineNumber": 338
          },
          {
            "lineNumber": 339
          },
          {
            "text": "    var chain = seq();",
            "lineNumber": 340
          },
          {
            "lineNumber": 341
          },
          {
            "text": "    // Validate DeviceKey for each location if DeviceKey is set for the device",
            "lineNumber": 342
          },
          {
            "text": "    locations.forEach(function(loc, idx) {",
            "lineNumber": 343
          },
          {
            "text": "        var deviceId = loc.device();",
            "lineNumber": 344
          },
          {
            "text": "        var providedDeviceKey = loc.deviceKey();",
            "lineNumber": 345
          },
          {
            "lineNumber": 346
          },
          {
            "text": "        chain.seq(function() {",
            "lineNumber": 347
          },
          {
            "text": "            var done = this;",
            "lineNumber": 348
          },
          {
            "text": "            // Check if DeviceKey is set for this device",
            "lineNumber": 349
          },
          {
            "text": "            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {",
            "lineNumber": 350
          },
          {
            "text": "                if (error) {",
            "lineNumber": 351
          },
          {
            "text": "                    return done(error);",
            "lineNumber": 352
          },
          {
            "text": "                }",
            "lineNumber": 353
          },
          {
            "lineNumber": 354
          },
          {
            "text": "                // If DeviceKey is set for this device, validate provided key",
            "lineNumber": 355
          },
          {
            "text": "                if (storedKey !== null &amp;&amp; storedKey !== undefined) {",
            "lineNumber": 356
          },
          {
            "text": "                    // DeviceKey is required when it's set",
            "lineNumber": 357
          },
          {
            "text": "                    if (!providedDeviceKey || providedDeviceKey === null || providedDeviceKey === '') {",
            "lineNumber": 358
          },
          {
            "text": "                        return done(new errors.ForbiddenError('DeviceKey is required for this device'));",
            "lineNumber": 359
          },
          {
            "text": "                    }",
            "lineNumber": 360
          },
          {
            "lineNumber": 361
          },
          {
            "text": "                    // Validate provided key matches stored key",
            "lineNumber": 362
          },
          {
            "text": "                    deviceKeyUtils.validateDeviceKey(deviceId, providedDeviceKey, function(error2, isValid) {",
            "lineNumber": 363
          },
          {
            "text": "                        if (error2) {",
            "lineNumber": 364
          },
          {
            "text": "                            return done(error2);",
            "lineNumber": 365
          },
          {
            "text": "                        }",
            "lineNumber": 366
          },
          {
            "lineNumber": 367
          },
          {
            "text": "                        if (!isValid) {",
            "lineNumber": 368
          },
          {
            "text": "                            return done(new errors.ForbiddenError('DeviceKey does not match'));",
            "lineNumber": 369
          },
          {
            "text": "                        }",
            "lineNumber": 370
          },
          {
            "lineNumber": 371
          },
          {
            "text": "                        done();",
            "lineNumber": 372
          },
          {
            "text": "                    });",
            "lineNumber": 373
          },
          {
            "text": "                } else {",
            "lineNumber": 374
          },
          {
            "text": "                    // No DeviceKey set, proceed normally (backward compatible)",
            "lineNumber": 375
          },
          {
            "text": "                    done();",
            "lineNumber": 376
          },
          {
            "text": "                }",
            "lineNumber": 377
          },
          {
            "text": "            });",
            "lineNumber": 378
          },
          {
            "text": "        });",
            "lineNumber": 379
          },
          {
            "text": "    });",
            "lineNumber": 380
          },
          {
            "lineNumber": 381
          },
          {
            "text": "    if(requestConfig.enableLocationHistory())",
            "lineNumber": 382
          },
          {
            "text": "}",
            "lineNumber": 434,
            "isSignature": true
          }
        ]
      },
      "score": 0.49006974697113037
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/DELETE_LOCATION_API.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 83,
            "column": 4
          }
        },
        "contents": "# DeleteLocation API Documentation\n\n## Overview\n\nThe DeleteLocation API endpoint allows you to permanently delete all location data associated with a specific device. This includes:\n\n- Current/last known location data\n- Complete location history\n- Visitor history data\n\n## Endpoints\n\n### Version 1 API\n- **POST** &#96;/v1/DeleteLocation&#96;\n\n### Default API (Legacy)\n- **POST** &#96;/DeleteLocation&#96;\n\n## Request Format\n\n### Request Body Structure\n&#96;&#96;&#96;json\n{\n  \"MiataruDeleteLocation\": {\n    \"Device\": \"device-id-here\"\n  }\n}\n&#96;&#96;&#96;\n\n### Parameters\n\n| Parameter | Type | Required | Description |\n|-----------|------|----------|-------------|\n| &#96;MiataruDeleteLocation&#96; | Object | Yes | Container object for delete request |\n| &#96;Device&#96; | String | Yes | Unique identifier of the device whose location data should be deleted |\n\n## Response Format\n\n### Success Response\n&#96;&#96;&#96;json\n{\n  \"MiataruResponse\": \"ACK\",\n  \"MiataruVerboseResponse\": \"Location data deleted for device: device-id-here\",\n  \"MiataruDeletedCount\": 3\n}\n&#96;&#96;&#96;\n\n### Response Fields\n\n| Field | Type | Description |\n|-------|------|-------------|\n| &#96;MiataruResponse&#96; | String | Always \"ACK\" for successful deletion |\n| &#96;MiataruVerboseResponse&#96; | String | Human-readable message confirming deletion |\n| &#96;MiataruDeletedCount&#96; | Number | Number of Redis keys that were deleted (0-3) |\n\n### Error Response\n&#96;&#96;&#96;json\n{\n  \"error\": \"BadRequestError\",\n  \"message\": \"missing device\"\n}\n&#96;&#96;&#96;\n\n## Usage Examples\n\n### cURL Examples\n\n#### Delete location data for a specific device\n&#96;&#96;&#96;bash\ncurl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/v1/DeleteLocation' \\\n  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'\n&#96;&#96;&#96;\n\n#### Delete location data using legacy endpoint\n&#96;&#96;&#96;bash\ncurl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/DeleteLocation' \\\n  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'\n&#96;&#96;&#96;\n\n### JavaScript Example\n&#96;&#96;&#96;javascript\nconst deleteLocationData = async (deviceId) =&gt; {\n  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\n    ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# DeleteLocation API Documentation",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "## Overview",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "The DeleteLocation API endpoint allows you to permanently delete all location data associated with a specific device. This includes:",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "- Current/last known location data",
            "lineNumber": 7
          },
          {
            "text": "- Complete location history",
            "lineNumber": 8
          },
          {
            "text": "- Visitor history data",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "## Endpoints",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "### Version 1 API",
            "lineNumber": 13
          },
          {
            "text": "- **POST** &#96;/v1/DeleteLocation&#96;",
            "lineNumber": 14
          },
          {
            "lineNumber": 15
          },
          {
            "text": "### Default API (Legacy)",
            "lineNumber": 16
          },
          {
            "text": "- **POST** &#96;/DeleteLocation&#96;",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "## Request Format",
            "lineNumber": 19
          },
          {
            "lineNumber": 20
          },
          {
            "text": "### Request Body Structure",
            "lineNumber": 21
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 22
          },
          {
            "text": "{",
            "lineNumber": 23
          },
          {
            "text": "  \"MiataruDeleteLocation\": {",
            "lineNumber": 24
          },
          {
            "text": "    \"Device\": \"device-id-here\"",
            "lineNumber": 25
          },
          {
            "text": "  }",
            "lineNumber": 26
          },
          {
            "text": "}",
            "lineNumber": 27
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 28
          },
          {
            "lineNumber": 29
          },
          {
            "text": "### Parameters",
            "lineNumber": 30
          },
          {
            "lineNumber": 31
          },
          {
            "text": "| Parameter | Type | Required | Description |",
            "lineNumber": 32
          },
          {
            "text": "|-----------|------|----------|-------------|",
            "lineNumber": 33
          },
          {
            "text": "| &#96;MiataruDeleteLocation&#96; | Object | Yes | Container object for delete request |",
            "lineNumber": 34
          },
          {
            "text": "| &#96;Device&#96; | String | Yes | Unique identifier of the device whose location data should be deleted |",
            "lineNumber": 35
          },
          {
            "lineNumber": 36
          },
          {
            "text": "## Response Format",
            "lineNumber": 37
          },
          {
            "lineNumber": 38
          },
          {
            "text": "### Success Response",
            "lineNumber": 39
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 40
          },
          {
            "text": "{",
            "lineNumber": 41
          },
          {
            "text": "  \"MiataruResponse\": \"ACK\",",
            "lineNumber": 42
          },
          {
            "text": "  \"MiataruVerboseResponse\": \"Location data deleted for device: device-id-here\",",
            "lineNumber": 43
          },
          {
            "text": "  \"MiataruDeletedCount\": 3",
            "lineNumber": 44
          },
          {
            "text": "}",
            "lineNumber": 45
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 46
          },
          {
            "lineNumber": 47
          },
          {
            "text": "### Response Fields",
            "lineNumber": 48
          },
          {
            "lineNumber": 49
          },
          {
            "text": "| Field | Type | Description |",
            "lineNumber": 50
          },
          {
            "text": "|-------|------|-------------|",
            "lineNumber": 51
          },
          {
            "text": "| &#96;MiataruResponse&#96; | String | Always \"ACK\" for successful deletion |",
            "lineNumber": 52
          },
          {
            "text": "| &#96;MiataruVerboseResponse&#96; | String | Human-readable message confirming deletion |",
            "lineNumber": 53
          },
          {
            "text": "| &#96;MiataruDeletedCount&#96; | Number | Number of Redis keys that were deleted (0-3) |",
            "lineNumber": 54
          },
          {
            "lineNumber": 55
          },
          {
            "text": "### Error Response",
            "lineNumber": 56
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 57
          },
          {
            "text": "{",
            "lineNumber": 58
          },
          {
            "text": "  \"error\": \"BadRequestError\",",
            "lineNumber": 59
          },
          {
            "text": "  \"message\": \"missing device\"",
            "lineNumber": 60
          },
          {
            "text": "}",
            "lineNumber": 61
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 62
          },
          {
            "lineNumber": 63
          },
          {
            "text": "## Usage Examples",
            "lineNumber": 64
          },
          {
            "lineNumber": 65
          },
          {
            "text": "### cURL Examples",
            "lineNumber": 66
          },
          {
            "lineNumber": 67
          },
          {
            "text": "#### Delete location data for a specific device",
            "lineNumber": 68
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 69
          },
          {
            "text": "curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/v1/DeleteLocation' \\",
            "lineNumber": 70
          },
          {
            "text": "  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'",
            "lineNumber": 71
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 72
          },
          {
            "lineNumber": 73
          },
          {
            "text": "#### Delete location data using legacy endpoint",
            "lineNumber": 74
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 75
          },
          {
            "text": "curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/DeleteLocation' \\",
            "lineNumber": 76
          },
          {
            "text": "  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'",
            "lineNumber": 77
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 78
          },
          {
            "lineNumber": 79
          },
          {
            "text": "### JavaScript Example",
            "lineNumber": 80
          },
          {
            "text": "&#96;&#96;&#96;javascript",
            "lineNumber": 81
          },
          {
            "text": "const deleteLocationData = async (deviceId) =&gt; {",
            "lineNumber": 82
          },
          {
            "text": "  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {",
            "lineNumber": 83
          },
          {
            "text": "    ",
            "lineNumber": 84
          }
        ]
      },
      "score": 0.42783045768737793
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/DELETE_LOCATION_API.md",
        "range": {
          "startPosition": {
            "line": 79
          },
          "endPosition": {
            "line": 157
          }
        },
        "contents": "### JavaScript Example\n&#96;&#96;&#96;javascript\nconst deleteLocationData = async (deviceId) =&gt; {\n  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      MiataruDeleteLocation: {\n        Device: deviceId\n      }\n    })\n  });\n  \n  const result = await response.json();\n  console.log(&#96;Deleted ${result.MiataruDeletedCount} data entries for device ${deviceId}&#96;);\n  return result;\n};\n&#96;&#96;&#96;\n\n## What Gets Deleted\n\nThe DeleteLocation operation removes the following Redis keys for the specified device:\n\n1. **Last Known Location**: &#96;miad:{device-id}:last&#96;\n   - Contains the most recent location data\n   - May have TTL (time-to-live) if location history is disabled\n\n2. **Location History**: &#96;miad:{device-id}:hist&#96;\n   - Contains the complete location history as a Redis list\n   - Only exists if location history is enabled\n\n3. **Visitor History**: &#96;miad:{device-id}:visit&#96;\n   - Contains visitor tracking data\n   - Tracks who has accessed the device's location data\n\n## Behavior Notes\n\n### Non-Existent Devices\n- Deleting data for a non-existent device returns success with &#96;MiataruDeletedCount: 0&#96;\n- No error is thrown for missing devices\n\n### Partial Deletions\n- If only some data types exist (e.g., only current location but no history), only existing keys are deleted\n- &#96;MiataruDeletedCount&#96; reflects the actual number of keys removed\n\n### Atomic Operation\n- All deletions are performed in parallel for efficiency\n- The operation is atomic - either all deletions succeed or none do\n\n## Error Handling\n\n### Common Error Scenarios\n\n1. **Missing Device Parameter**\n   &#96;&#96;&#96;json\n   {\n     \"error\": \"BadRequestError\",\n     \"message\": \"missing device\"\n   }\n   &#96;&#96;&#96;\n\n2. **Invalid Request Format**\n   &#96;&#96;&#96;json\n   {\n     \"error\": \"BadRequestError\",\n     \"message\": \"Invalid request format\"\n   }\n   &#96;&#96;&#96;\n\n3. **Method Not Allowed**\n   - Only POST requests are accepted\n   - GET, PUT, DELETE, etc. return 405 Method Not Supported\n\n## Security Considerations\n\n- **No Authentication**: The current implementation does not include authentication",
        "signatures": {},
        "detailedLines": [
          {
            "text": "### JavaScript Example",
            "lineNumber": 80
          },
          {
            "text": "&#96;&#96;&#96;javascript",
            "lineNumber": 81
          },
          {
            "text": "const deleteLocationData = async (deviceId) =&gt; {",
            "lineNumber": 82
          },
          {
            "text": "  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {",
            "lineNumber": 83
          },
          {
            "text": "    method: 'POST',",
            "lineNumber": 84
          },
          {
            "text": "    headers: {",
            "lineNumber": 85
          },
          {
            "text": "      'Content-Type': 'application/json'",
            "lineNumber": 86
          },
          {
            "text": "    },",
            "lineNumber": 87
          },
          {
            "text": "    body: JSON.stringify({",
            "lineNumber": 88
          },
          {
            "text": "      MiataruDeleteLocation: {",
            "lineNumber": 89
          },
          {
            "text": "        Device: deviceId",
            "lineNumber": 90
          },
          {
            "text": "      }",
            "lineNumber": 91
          },
          {
            "text": "    })",
            "lineNumber": 92
          },
          {
            "text": "  });",
            "lineNumber": 93
          },
          {
            "text": "  ",
            "lineNumber": 94
          },
          {
            "text": "  const result = await response.json();",
            "lineNumber": 95
          },
          {
            "text": "  console.log(&#96;Deleted ${result.MiataruDeletedCount} data entries for device ${deviceId}&#96;);",
            "lineNumber": 96
          },
          {
            "text": "  return result;",
            "lineNumber": 97
          },
          {
            "text": "};",
            "lineNumber": 98
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 99
          },
          {
            "lineNumber": 100
          },
          {
            "text": "## What Gets Deleted",
            "lineNumber": 101
          },
          {
            "lineNumber": 102
          },
          {
            "text": "The DeleteLocation operation removes the following Redis keys for the specified device:",
            "lineNumber": 103
          },
          {
            "lineNumber": 104
          },
          {
            "text": "1. **Last Known Location**: &#96;miad:{device-id}:last&#96;",
            "lineNumber": 105
          },
          {
            "text": "   - Contains the most recent location data",
            "lineNumber": 106
          },
          {
            "text": "   - May have TTL (time-to-live) if location history is disabled",
            "lineNumber": 107
          },
          {
            "lineNumber": 108
          },
          {
            "text": "2. **Location History**: &#96;miad:{device-id}:hist&#96;",
            "lineNumber": 109
          },
          {
            "text": "   - Contains the complete location history as a Redis list",
            "lineNumber": 110
          },
          {
            "text": "   - Only exists if location history is enabled",
            "lineNumber": 111
          },
          {
            "lineNumber": 112
          },
          {
            "text": "3. **Visitor History**: &#96;miad:{device-id}:visit&#96;",
            "lineNumber": 113
          },
          {
            "text": "   - Contains visitor tracking data",
            "lineNumber": 114
          },
          {
            "text": "   - Tracks who has accessed the device's location data",
            "lineNumber": 115
          },
          {
            "lineNumber": 116
          },
          {
            "text": "## Behavior Notes",
            "lineNumber": 117
          },
          {
            "lineNumber": 118
          },
          {
            "text": "### Non-Existent Devices",
            "lineNumber": 119
          },
          {
            "text": "- Deleting data for a non-existent device returns success with &#96;MiataruDeletedCount: 0&#96;",
            "lineNumber": 120
          },
          {
            "text": "- No error is thrown for missing devices",
            "lineNumber": 121
          },
          {
            "lineNumber": 122
          },
          {
            "text": "### Partial Deletions",
            "lineNumber": 123
          },
          {
            "text": "- If only some data types exist (e.g., only current location but no history), only existing keys are deleted",
            "lineNumber": 124
          },
          {
            "text": "- &#96;MiataruDeletedCount&#96; reflects the actual number of keys removed",
            "lineNumber": 125
          },
          {
            "lineNumber": 126
          },
          {
            "text": "### Atomic Operation",
            "lineNumber": 127
          },
          {
            "text": "- All deletions are performed in parallel for efficiency",
            "lineNumber": 128
          },
          {
            "text": "- The operation is atomic - either all deletions succeed or none do",
            "lineNumber": 129
          },
          {
            "lineNumber": 130
          },
          {
            "text": "## Error Handling",
            "lineNumber": 131
          },
          {
            "lineNumber": 132
          },
          {
            "text": "### Common Error Scenarios",
            "lineNumber": 133
          },
          {
            "lineNumber": 134
          },
          {
            "text": "1. **Missing Device Parameter**",
            "lineNumber": 135
          },
          {
            "text": "   &#96;&#96;&#96;json",
            "lineNumber": 136
          },
          {
            "text": "   {",
            "lineNumber": 137
          },
          {
            "text": "     \"error\": \"BadRequestError\",",
            "lineNumber": 138
          },
          {
            "text": "     \"message\": \"missing device\"",
            "lineNumber": 139
          },
          {
            "text": "   }",
            "lineNumber": 140
          },
          {
            "text": "   &#96;&#96;&#96;",
            "lineNumber": 141
          },
          {
            "lineNumber": 142
          },
          {
            "text": "2. **Invalid Request Format**",
            "lineNumber": 143
          },
          {
            "text": "   &#96;&#96;&#96;json",
            "lineNumber": 144
          },
          {
            "text": "   {",
            "lineNumber": 145
          },
          {
            "text": "     \"error\": \"BadRequestError\",",
            "lineNumber": 146
          },
          {
            "text": "     \"message\": \"Invalid request format\"",
            "lineNumber": 147
          },
          {
            "text": "   }",
            "lineNumber": 148
          },
          {
            "text": "   &#96;&#96;&#96;",
            "lineNumber": 149
          },
          {
            "lineNumber": 150
          },
          {
            "text": "3. **Method Not Allowed**",
            "lineNumber": 151
          },
          {
            "text": "   - Only POST requests are accepted",
            "lineNumber": 152
          },
          {
            "text": "   - GET, PUT, DELETE, etc. return 405 Method Not Supported",
            "lineNumber": 153
          },
          {
            "lineNumber": 154
          },
          {
            "text": "## Security Considerations",
            "lineNumber": 155
          },
          {
            "lineNumber": 156
          },
          {
            "text": "- **No Authentication**: The current implementation does not include authentication",
            "lineNumber": 157
          }
        ]
      },
      "score": 0.421985387802124
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 799,
            "column": 1
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "/**\n * SetDeviceKey\n * Sets or changes the device key for a device\n * @param req\n * @param res\n * @param next\n */\nfunction setDeviceKey(req, res, next) {\n    var request = req.MIATARU.request;\n    var deviceId = request.deviceId();\n    var currentDeviceKey = request.currentDeviceKey();\n    var newDeviceKey = request.newDeviceKey();\n\n    seq()\n        .seq(function() {\n            var done = this;\n            // Check if device already has a key set\n            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {\n                if (error) {\n                    return done(error);\n                }\n\n                done.vars = done.vars || {};\n                done.vars.storedKey = storedKey;\n                done();\n            });\n        })\n        .seq(function() {\n            var done = this;\n            var storedKey = (done.vars || {}).storedKey;\n\n            // If a key exists, validate CurrentDeviceKey\n            if (storedKey !== null &amp;&amp; storedKey !== undefined) {\n                // Key exists, so CurrentDeviceKey must be provided and match\n                if (!currentDeviceKey || currentDeviceKey === null || currentDeviceKey === '') {\n                    return done(new errors.ForbiddenError('CurrentDeviceKey is required to change existing key'));\n                }\n\n                // Validate CurrentDeviceKey matches stored key\n                deviceKeyUtils.validateDeviceKey(deviceId, currentDeviceKey, function(error, isValid) {\n                    if (error) {\n                        return done(error);\n                    }\n\n                    if (!isValid) {\n                        return done(new errors.ForbiddenError('CurrentDeviceKey does not match'));\n                    }\n\n                    done();\n                });\n            } else {\n                // No key exists, so CurrentDeviceKey should be null/empty (first-time setup)\n                // This is allowed, proceed\n                done();\n            }\n        })\n        .seq(function() {\n            var done = this;\n            // Set the new key\n            deviceKeyUtils.setDeviceKey\n\n\n\n\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 802
          },
          {
            "text": " * SetDeviceKey",
            "lineNumber": 803
          },
          {
            "text": " * Sets or changes the device key for a device",
            "lineNumber": 804
          },
          {
            "text": " * @param req",
            "lineNumber": 805
          },
          {
            "text": " * @param res",
            "lineNumber": 806
          },
          {
            "text": " * @param next",
            "lineNumber": 807
          },
          {
            "text": " */",
            "lineNumber": 808
          },
          {
            "text": "function setDeviceKey(req, res, next) {",
            "lineNumber": 809,
            "isSignature": true
          },
          {
            "text": "    var request = req.MIATARU.request;",
            "lineNumber": 810
          },
          {
            "text": "    var deviceId = request.deviceId();",
            "lineNumber": 811
          },
          {
            "text": "    var currentDeviceKey = request.currentDeviceKey();",
            "lineNumber": 812
          },
          {
            "text": "    var newDeviceKey = request.newDeviceKey();",
            "lineNumber": 813
          },
          {
            "lineNumber": 814
          },
          {
            "text": "    seq()",
            "lineNumber": 815
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 816
          },
          {
            "text": "            var done = this;",
            "lineNumber": 817
          },
          {
            "text": "            // Check if device already has a key set",
            "lineNumber": 818
          },
          {
            "text": "            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {",
            "lineNumber": 819
          },
          {
            "text": "                if (error) {",
            "lineNumber": 820
          },
          {
            "text": "                    return done(error);",
            "lineNumber": 821
          },
          {
            "text": "                }",
            "lineNumber": 822
          },
          {
            "lineNumber": 823
          },
          {
            "text": "                done.vars = done.vars || {};",
            "lineNumber": 824
          },
          {
            "text": "                done.vars.storedKey = storedKey;",
            "lineNumber": 825
          },
          {
            "text": "                done();",
            "lineNumber": 826
          },
          {
            "text": "            });",
            "lineNumber": 827
          },
          {
            "text": "        })",
            "lineNumber": 828
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 829
          },
          {
            "text": "            var done = this;",
            "lineNumber": 830
          },
          {
            "text": "            var storedKey = (done.vars || {}).storedKey;",
            "lineNumber": 831
          },
          {
            "lineNumber": 832
          },
          {
            "text": "            // If a key exists, validate CurrentDeviceKey",
            "lineNumber": 833
          },
          {
            "text": "            if (storedKey !== null &amp;&amp; storedKey !== undefined) {",
            "lineNumber": 834
          },
          {
            "text": "                // Key exists, so CurrentDeviceKey must be provided and match",
            "lineNumber": 835
          },
          {
            "text": "                if (!currentDeviceKey || currentDeviceKey === null || currentDeviceKey === '') {",
            "lineNumber": 836
          },
          {
            "text": "                    return done(new errors.ForbiddenError('CurrentDeviceKey is required to change existing key'));",
            "lineNumber": 837
          },
          {
            "text": "                }",
            "lineNumber": 838
          },
          {
            "lineNumber": 839
          },
          {
            "text": "                // Validate CurrentDeviceKey matches stored key",
            "lineNumber": 840
          },
          {
            "text": "                deviceKeyUtils.validateDeviceKey(deviceId, currentDeviceKey, function(error, isValid) {",
            "lineNumber": 841
          },
          {
            "text": "                    if (error) {",
            "lineNumber": 842
          },
          {
            "text": "                        return done(error);",
            "lineNumber": 843
          },
          {
            "text": "                    }",
            "lineNumber": 844
          },
          {
            "lineNumber": 845
          },
          {
            "text": "                    if (!isValid) {",
            "lineNumber": 846
          },
          {
            "text": "                        return done(new errors.ForbiddenError('CurrentDeviceKey does not match'));",
            "lineNumber": 847
          },
          {
            "text": "                    }",
            "lineNumber": 848
          },
          {
            "lineNumber": 849
          },
          {
            "text": "                    done();",
            "lineNumber": 850
          },
          {
            "text": "                });",
            "lineNumber": 851
          },
          {
            "text": "            } else {",
            "lineNumber": 852
          },
          {
            "text": "                // No key exists, so CurrentDeviceKey should be null/empty (first-time setup)",
            "lineNumber": 853
          },
          {
            "text": "                // This is allowed, proceed",
            "lineNumber": 854
          },
          {
            "text": "                done();",
            "lineNumber": 855
          },
          {
            "text": "            }",
            "lineNumber": 856
          },
          {
            "text": "        })",
            "lineNumber": 857
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 858
          },
          {
            "text": "            var done = this;",
            "lineNumber": 859
          },
          {
            "text": "            // Set the new key",
            "lineNumber": 860
          },
          {
            "text": "            deviceKeyUtils.setDeviceKey",
            "lineNumber": 861
          },
          {
            "lineNumber": 867
          },
          {
            "lineNumber": 868
          },
          {
            "lineNumber": 871
          },
          {
            "lineNumber": 877
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.4070030450820923
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/index.js",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 44,
            "column": 5
          }
        },
        "contents": "var v1 = require('./v1');\nvar errors = require('../../errors');\n\nmodule.exports.install = function(app) {\n\n    ///////////////////////////////////////////\n    ///// API Version 1 ///////////////////////\n    ///////////////////////////////////////////\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\n    });\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\n    app.post('/v1/setDeviceKey', v1.inputParser, v1.setDeviceKey);\n    app.post('/v1/setAllowedDeviceList', v1.inputParser, v1.setAllowedDeviceList);\n\n    ///////////////////////////////////////////\n    ///// API current /////////////////////////\n    ///////////////////////////////////////////\n    app.post('/UpdateLocation', v1.inputParser, v1.updateLocation);\n    app.post('/GetLocation', v1.inputParser, v1.getLocation);\n    app.post('/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\n    app.get('/GetLocationGeoJSON/:id?',  function(req, res){\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\n    });\n    app.post('/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\n    app.post('/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\n    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\n    app.post('/setDeviceKey', v1.inputParser, v1.setDeviceKey);\n    app.post('/setAllowedDeviceList', v1.inputParser, v1.setAllowedDeviceList);\n\n    ///////////////////////////////////////////\n    ///// non-Post /////////////////////////\n    ///////////////////////////////////////////\n    function handleUnsupportedMethod(req, res, next) {\n        if\n    }",
        "signatures": {},
        "detailedLines": [
          {
            "text": "var v1 = require('./v1');",
            "lineNumber": 1
          },
          {
            "text": "var errors = require('../../errors');",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "module.exports.install = function(app) {",
            "lineNumber": 4
          },
          {
            "lineNumber": 5
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 6
          },
          {
            "text": "    ///// API Version 1 ///////////////////////",
            "lineNumber": 7
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 8
          },
          {
            "text": "    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);",
            "lineNumber": 9
          },
          {
            "text": "    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);",
            "lineNumber": 10
          },
          {
            "text": "    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);",
            "lineNumber": 11
          },
          {
            "text": "    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){",
            "lineNumber": 12
          },
          {
            "text": "        v1.getLocationGeoJSONGET(req.params.id, res,null);",
            "lineNumber": 13
          },
          {
            "text": "    });",
            "lineNumber": 14
          },
          {
            "text": "    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);",
            "lineNumber": 15
          },
          {
            "text": "    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);",
            "lineNumber": 16
          },
          {
            "text": "    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);",
            "lineNumber": 17
          },
          {
            "text": "    app.post('/v1/setDeviceKey', v1.inputParser, v1.setDeviceKey);",
            "lineNumber": 18
          },
          {
            "text": "    app.post('/v1/setAllowedDeviceList', v1.inputParser, v1.setAllowedDeviceList);",
            "lineNumber": 19
          },
          {
            "lineNumber": 20
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 21
          },
          {
            "text": "    ///// API current /////////////////////////",
            "lineNumber": 22
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 23
          },
          {
            "text": "    app.post('/UpdateLocation', v1.inputParser, v1.updateLocation);",
            "lineNumber": 24
          },
          {
            "text": "    app.post('/GetLocation', v1.inputParser, v1.getLocation);",
            "lineNumber": 25
          },
          {
            "text": "    app.post('/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);",
            "lineNumber": 26
          },
          {
            "text": "    app.get('/GetLocationGeoJSON/:id?',  function(req, res){",
            "lineNumber": 27
          },
          {
            "text": "        v1.getLocationGeoJSONGET(req.params.id, res,null);",
            "lineNumber": 28
          },
          {
            "text": "    });",
            "lineNumber": 29
          },
          {
            "text": "    app.post('/GetLocationHistory', v1.inputParser, v1.getLocationHistory);",
            "lineNumber": 30
          },
          {
            "text": "    app.post('/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);",
            "lineNumber": 31
          },
          {
            "text": "    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);",
            "lineNumber": 32
          },
          {
            "text": "    app.post('/setDeviceKey', v1.inputParser, v1.setDeviceKey);",
            "lineNumber": 33
          },
          {
            "text": "    app.post('/setAllowedDeviceList', v1.inputParser, v1.setAllowedDeviceList);",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 36
          },
          {
            "text": "    ///// non-Post /////////////////////////",
            "lineNumber": 37
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 38
          },
          {
            "text": "    function handleUnsupportedMethod(req, res, next) {",
            "lineNumber": 39
          },
          {
            "text": "        if",
            "lineNumber": 40
          },
          {
            "text": "    }",
            "lineNumber": 45
          }
        ]
      },
      "score": 0.3966102600097656
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 638,
            "column": 1
          },
          "endPosition": {
            "line": 746,
            "column": 1
          }
        },
        "contents": "/**\n * GetVisitorHistory\n * Retrieves the complete visitor history\n * @param req\n * @param res\n * @param next\n */\nfunction getVisitorHistory(req, res, next) {\n    var locationRequest = req.MIATARU.request;\n    var deviceId = locationRequest.device();\n    var providedDeviceKey = locationRequest.deviceKey();\n    var key = kb.build(deviceId, KEY_VISIT);\n\n    seq()\n        .seq(function() {\n            var done = this;\n            // Check if DeviceKey is set for this device\n            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {\n                if (error) {\n                    return done(error);\n                }\n\n                // If DeviceKey is set for this device, validate provided key\n                if (storedKey !== null &amp;&amp; storedKey !== undefined) {\n                    // DeviceKey is required when it's set\n                    if (!providedDeviceKey || providedDeviceKey === null || providedDeviceKey === '') {\n                        return done(new errors.ForbiddenError('DeviceKey is required for this device'));\n                    }\n\n                    // Validate provided key matches stored key\n                    deviceKeyUtils.validateDeviceKey(deviceId, providedDeviceKey, function(error2, isValid) {\n                        if (error2) {\n                            return done(error2);\n                        }\n\n                        if (!isValid) {\n                            return done(new errors.ForbiddenError('DeviceKey does not match'));\n                        }\n\n                        done();\n                    });\n                } else {\n                    // No DeviceKey set, proceed normally (backward compatible)\n                    done();\n                }\n            });\n        })\n        .par('listLength', function() {\n            db.llen(key, this);\n        })\n        .seq(function() {\n            var done = this;\n            var vars = done.vars = done.vars || {};\n\n\n\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 641
          },
          {
            "text": " * GetVisitorHistory",
            "lineNumber": 642
          },
          {
            "text": " * Retrieves the complete visitor history",
            "lineNumber": 643
          },
          {
            "text": " * @param req",
            "lineNumber": 644
          },
          {
            "text": " * @param res",
            "lineNumber": 645
          },
          {
            "text": " * @param next",
            "lineNumber": 646
          },
          {
            "text": " */",
            "lineNumber": 647
          },
          {
            "text": "function getVisitorHistory(req, res, next) {",
            "lineNumber": 648,
            "isSignature": true
          },
          {
            "text": "    var locationRequest = req.MIATARU.request;",
            "lineNumber": 649
          },
          {
            "text": "    var deviceId = locationRequest.device();",
            "lineNumber": 650
          },
          {
            "text": "    var providedDeviceKey = locationRequest.deviceKey();",
            "lineNumber": 651
          },
          {
            "text": "    var key = kb.build(deviceId, KEY_VISIT);",
            "lineNumber": 652
          },
          {
            "lineNumber": 653
          },
          {
            "text": "    seq()",
            "lineNumber": 654
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 655
          },
          {
            "text": "            var done = this;",
            "lineNumber": 656
          },
          {
            "text": "            // Check if DeviceKey is set for this device",
            "lineNumber": 657
          },
          {
            "text": "            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {",
            "lineNumber": 658
          },
          {
            "text": "                if (error) {",
            "lineNumber": 659
          },
          {
            "text": "                    return done(error);",
            "lineNumber": 660
          },
          {
            "text": "                }",
            "lineNumber": 661
          },
          {
            "lineNumber": 662
          },
          {
            "text": "                // If DeviceKey is set for this device, validate provided key",
            "lineNumber": 663
          },
          {
            "text": "                if (storedKey !== null &amp;&amp; storedKey !== undefined) {",
            "lineNumber": 664
          },
          {
            "text": "                    // DeviceKey is required when it's set",
            "lineNumber": 665
          },
          {
            "text": "                    if (!providedDeviceKey || providedDeviceKey === null || providedDeviceKey === '') {",
            "lineNumber": 666
          },
          {
            "text": "                        return done(new errors.ForbiddenError('DeviceKey is required for this device'));",
            "lineNumber": 667
          },
          {
            "text": "                    }",
            "lineNumber": 668
          },
          {
            "lineNumber": 669
          },
          {
            "text": "                    // Validate provided key matches stored key",
            "lineNumber": 670
          },
          {
            "text": "                    deviceKeyUtils.validateDeviceKey(deviceId, providedDeviceKey, function(error2, isValid) {",
            "lineNumber": 671
          },
          {
            "text": "                        if (error2) {",
            "lineNumber": 672
          },
          {
            "text": "                            return done(error2);",
            "lineNumber": 673
          },
          {
            "text": "                        }",
            "lineNumber": 674
          },
          {
            "lineNumber": 675
          },
          {
            "text": "                        if (!isValid) {",
            "lineNumber": 676
          },
          {
            "text": "                            return done(new errors.ForbiddenError('DeviceKey does not match'));",
            "lineNumber": 677
          },
          {
            "text": "                        }",
            "lineNumber": 678
          },
          {
            "lineNumber": 679
          },
          {
            "text": "                        done();",
            "lineNumber": 680
          },
          {
            "text": "                    });",
            "lineNumber": 681
          },
          {
            "text": "                } else {",
            "lineNumber": 682
          },
          {
            "text": "                    // No DeviceKey set, proceed normally (backward compatible)",
            "lineNumber": 683
          },
          {
            "text": "                    done();",
            "lineNumber": 684
          },
          {
            "text": "                }",
            "lineNumber": 685
          },
          {
            "text": "            });",
            "lineNumber": 686
          },
          {
            "text": "        })",
            "lineNumber": 687
          },
          {
            "text": "        .par('listLength', function() {",
            "lineNumber": 688
          },
          {
            "text": "            db.llen(key, this);",
            "lineNumber": 689
          },
          {
            "text": "        })",
            "lineNumber": 690
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 691
          },
          {
            "text": "            var done = this;",
            "lineNumber": 692
          },
          {
            "text": "            var vars = done.vars = done.vars || {};",
            "lineNumber": 693
          },
          {
            "lineNumber": 717
          },
          {
            "lineNumber": 740
          },
          {
            "lineNumber": 746
          },
          {
            "text": "}",
            "lineNumber": 747,
            "isSignature": true
          }
        ]
      },
      "score": 0.3954353928565979
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/WHATS_NEW_V2.md",
        "range": {
          "startPosition": {
            "line": 572
          },
          "endPosition": {
            "line": 618
          }
        },
        "contents": "### Compatibility Matrix\n\n| Feature | v1.0 Client | v1.1 Client (No Security) | v1.1 Client (With Security) |\n|---------|------------|---------------------------|------------------------------|\n| UpdateLocation |  Works |  Works |  Works (with DeviceKey) |\n| GetLocation |  Works |  Works |  Works (with access control) |\n| GetLocationHistory |  Works |  Works |  Works (with access control) |\n| GetVisitorHistory |  Works |  Works |  Works (with DeviceKey) |\n| GetLocationGeoJSON |  Works |  Works |  401 (DeviceKey set) |\n| DeleteLocation |  Works |  Works |  Works |\n\n### Graceful Degradation\n\n- **Missing DeviceKey**: When DeviceKey is required but not provided, operation fails with 403\n- **Not in Allowed List**: When access control is enabled, unauthorized devices receive no data (no error)\n- **Security Disabled**: All features work exactly as v1.0 when security is not enabled\n\n## Security Considerations\n\n### DeviceKey Security\n\n- **Storage**: DeviceKeys are stored securely in Redis (not logged)\n- **Validation**: Constant-time comparison prevents timing attacks\n- **Length**: Maximum 256 Unicode characters for flexibility\n- **Management**: Keys can be changed by providing current key\n\n### Access Control Security\n\n- **Privacy-First**: Default behavior hides location from unauthorized devices\n- **No Information Leakage**: Unauthorized devices don't receive error messages\n- **Granular Permissions**: Separate control for current location vs. history\n- **DeviceKey Protected**: Access control configuration requires DeviceKey\n\n### Rate Limiting\n\nExisting rate limiting applies to new endpoints:\n- &#96;/v1/setDeviceKey&#96; - Protected by HTTP rate limiting\n- &#96;/v1/setAllowedDeviceList&#96; - Protected by HTTP rate limiting\n- All endpoints continue to use existing rate limiting configuration\n\n### Best Practices\n\n1. **Use Strong DeviceKeys**: Use cryptographically secure random keys\n2. **Store Keys Securely**: Never log or expose DeviceKeys\n3. **Rotate Keys Periodically**: Change DeviceKeys regularly for enhanced security\n4. **Minimize Allowed Devices**: Only grant access to trusted devices",
        "signatures": {},
        "detailedLines": [
          {
            "text": "### Compatibility Matrix",
            "lineNumber": 573
          },
          {
            "lineNumber": 574
          },
          {
            "text": "| Feature | v1.0 Client | v1.1 Client (No Security) | v1.1 Client (With Security) |",
            "lineNumber": 575
          },
          {
            "text": "|---------|------------|---------------------------|------------------------------|",
            "lineNumber": 576
          },
          {
            "text": "| UpdateLocation |  Works |  Works |  Works (with DeviceKey) |",
            "lineNumber": 577
          },
          {
            "text": "| GetLocation |  Works |  Works |  Works (with access control) |",
            "lineNumber": 578
          },
          {
            "text": "| GetLocationHistory |  Works |  Works |  Works (with access control) |",
            "lineNumber": 579
          },
          {
            "text": "| GetVisitorHistory |  Works |  Works |  Works (with DeviceKey) |",
            "lineNumber": 580
          },
          {
            "text": "| GetLocationGeoJSON |  Works |  Works |  401 (DeviceKey set) |",
            "lineNumber": 581
          },
          {
            "text": "| DeleteLocation |  Works |  Works |  Works |",
            "lineNumber": 582
          },
          {
            "lineNumber": 583
          },
          {
            "text": "### Graceful Degradation",
            "lineNumber": 584
          },
          {
            "lineNumber": 585
          },
          {
            "text": "- **Missing DeviceKey**: When DeviceKey is required but not provided, operation fails with 403",
            "lineNumber": 586
          },
          {
            "text": "- **Not in Allowed List**: When access control is enabled, unauthorized devices receive no data (no error)",
            "lineNumber": 587
          },
          {
            "text": "- **Security Disabled**: All features work exactly as v1.0 when security is not enabled",
            "lineNumber": 588
          },
          {
            "lineNumber": 589
          },
          {
            "text": "## Security Considerations",
            "lineNumber": 590
          },
          {
            "lineNumber": 591
          },
          {
            "text": "### DeviceKey Security",
            "lineNumber": 592
          },
          {
            "lineNumber": 593
          },
          {
            "text": "- **Storage**: DeviceKeys are stored securely in Redis (not logged)",
            "lineNumber": 594
          },
          {
            "text": "- **Validation**: Constant-time comparison prevents timing attacks",
            "lineNumber": 595
          },
          {
            "text": "- **Length**: Maximum 256 Unicode characters for flexibility",
            "lineNumber": 596
          },
          {
            "text": "- **Management**: Keys can be changed by providing current key",
            "lineNumber": 597
          },
          {
            "lineNumber": 598
          },
          {
            "text": "### Access Control Security",
            "lineNumber": 599
          },
          {
            "lineNumber": 600
          },
          {
            "text": "- **Privacy-First**: Default behavior hides location from unauthorized devices",
            "lineNumber": 601
          },
          {
            "text": "- **No Information Leakage**: Unauthorized devices don't receive error messages",
            "lineNumber": 602
          },
          {
            "text": "- **Granular Permissions**: Separate control for current location vs. history",
            "lineNumber": 603
          },
          {
            "text": "- **DeviceKey Protected**: Access control configuration requires DeviceKey",
            "lineNumber": 604
          },
          {
            "lineNumber": 605
          },
          {
            "text": "### Rate Limiting",
            "lineNumber": 606
          },
          {
            "lineNumber": 607
          },
          {
            "text": "Existing rate limiting applies to new endpoints:",
            "lineNumber": 608
          },
          {
            "text": "- &#96;/v1/setDeviceKey&#96; - Protected by HTTP rate limiting",
            "lineNumber": 609
          },
          {
            "text": "- &#96;/v1/setAllowedDeviceList&#96; - Protected by HTTP rate limiting",
            "lineNumber": 610
          },
          {
            "text": "- All endpoints continue to use existing rate limiting configuration",
            "lineNumber": 611
          },
          {
            "lineNumber": 612
          },
          {
            "text": "### Best Practices",
            "lineNumber": 613
          },
          {
            "lineNumber": 614
          },
          {
            "text": "1. **Use Strong DeviceKeys**: Use cryptographically secure random keys",
            "lineNumber": 615
          },
          {
            "text": "2. **Store Keys Securely**: Never log or expose DeviceKeys",
            "lineNumber": 616
          },
          {
            "text": "3. **Rotate Keys Periodically**: Change DeviceKeys regularly for enhanced security",
            "lineNumber": 617
          },
          {
            "text": "4. **Minimize Allowed Devices**: Only grant access to trusted devices",
            "lineNumber": 618
          }
        ]
      },
      "score": 0.3916724920272827
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/DELETE_LOCATION_API.md",
        "range": {
          "startPosition": {
            "line": 154
          },
          "endPosition": {
            "line": 196
          }
        },
        "contents": "## Security Considerations\n\n- **No Authentication**: The current implementation does not include authentication\n- **Device ID Validation**: Device IDs are not validated for format or ownership\n- **Permanent Deletion**: Deleted data cannot be recovered\n- **No Audit Trail**: Deletion operations are not logged\n\n## Integration with Other APIs\n\n### Typical Workflow\n1. **UpdateLocation**: Store location data\n2. **GetLocation**: Retrieve current location\n3. **GetLocationHistory**: Retrieve location history\n4. **DeleteLocation**: Remove all data when no longer needed\n\n### Data Lifecycle\n&#96;&#96;&#96;\nCreate  Read  Update  Delete\n                        \nUpdateLocation  GetLocation  UpdateLocation  DeleteLocation\n&#96;&#96;&#96;\n\n## Testing\n\nThe DeleteLocation API is thoroughly tested with:\n\n- **Unit Tests**: Response model validation\n- **Integration Tests**: Complete API workflow testing\n- **Error Handling Tests**: Invalid request scenarios\n- **Workflow Tests**: End-to-end location lifecycle testing\n\nRun tests with:\n&#96;&#96;&#96;bash\nnpm test                    # Unit tests\nnpm run test:integration    # Integration tests\n&#96;&#96;&#96;\n\n## Version Compatibility\n\n- **v1 API**: &#96;/v1/DeleteLocation&#96; - Recommended for new implementations\n- **Legacy API**: &#96;/DeleteLocation&#96; - Maintained for backward compatibility\n- Both endpoints provide identical functionality",
        "signatures": {},
        "detailedLines": [
          {
            "text": "## Security Considerations",
            "lineNumber": 155
          },
          {
            "lineNumber": 156
          },
          {
            "text": "- **No Authentication**: The current implementation does not include authentication",
            "lineNumber": 157
          },
          {
            "text": "- **Device ID Validation**: Device IDs are not validated for format or ownership",
            "lineNumber": 158
          },
          {
            "text": "- **Permanent Deletion**: Deleted data cannot be recovered",
            "lineNumber": 159
          },
          {
            "text": "- **No Audit Trail**: Deletion operations are not logged",
            "lineNumber": 160
          },
          {
            "lineNumber": 161
          },
          {
            "text": "## Integration with Other APIs",
            "lineNumber": 162
          },
          {
            "lineNumber": 163
          },
          {
            "text": "### Typical Workflow",
            "lineNumber": 164
          },
          {
            "text": "1. **UpdateLocation**: Store location data",
            "lineNumber": 165
          },
          {
            "text": "2. **GetLocation**: Retrieve current location",
            "lineNumber": 166
          },
          {
            "text": "3. **GetLocationHistory**: Retrieve location history",
            "lineNumber": 167
          },
          {
            "text": "4. **DeleteLocation**: Remove all data when no longer needed",
            "lineNumber": 168
          },
          {
            "lineNumber": 169
          },
          {
            "text": "### Data Lifecycle",
            "lineNumber": 170
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 171
          },
          {
            "text": "Create  Read  Update  Delete",
            "lineNumber": 172
          },
          {
            "text": "                        ",
            "lineNumber": 173
          },
          {
            "text": "UpdateLocation  GetLocation  UpdateLocation  DeleteLocation",
            "lineNumber": 174
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 175
          },
          {
            "lineNumber": 176
          },
          {
            "text": "## Testing",
            "lineNumber": 177
          },
          {
            "lineNumber": 178
          },
          {
            "text": "The DeleteLocation API is thoroughly tested with:",
            "lineNumber": 179
          },
          {
            "lineNumber": 180
          },
          {
            "text": "- **Unit Tests**: Response model validation",
            "lineNumber": 181
          },
          {
            "text": "- **Integration Tests**: Complete API workflow testing",
            "lineNumber": 182
          },
          {
            "text": "- **Error Handling Tests**: Invalid request scenarios",
            "lineNumber": 183
          },
          {
            "text": "- **Workflow Tests**: End-to-end location lifecycle testing",
            "lineNumber": 184
          },
          {
            "lineNumber": 185
          },
          {
            "text": "Run tests with:",
            "lineNumber": 186
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 187
          },
          {
            "text": "npm test                    # Unit tests",
            "lineNumber": 188
          },
          {
            "text": "npm run test:integration    # Integration tests",
            "lineNumber": 189
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 190
          },
          {
            "lineNumber": 191
          },
          {
            "text": "## Version Compatibility",
            "lineNumber": 192
          },
          {
            "lineNumber": 193
          },
          {
            "text": "- **v1 API**: &#96;/v1/DeleteLocation&#96; - Recommended for new implementations",
            "lineNumber": 194
          },
          {
            "text": "- **Legacy API**: &#96;/DeleteLocation&#96; - Maintained for backward compatibility",
            "lineNumber": 195
          },
          {
            "text": "- Both endpoints provide identical functionality",
            "lineNumber": 196
          }
        ]
      },
      "score": 0.3883573114871979
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/TECHNICAL_SPECIFICATION.md",
        "range": {
          "startPosition": {
            "line": 191
          },
          "endPosition": {
            "line": 211
          }
        },
        "contents": "- **Primary path**:\n  - **Detailed ON**: Each access &#96;LPUSH&#96;es a new entry and &#96;LTRIM&#96;s to the maximum count. (Evidence: lib/routes/location/v1/location.js; tests/integration/recordDetailedVisitorHistory.tests.js)\n  - **Detailed OFF**: Existing entries are deduplicated by DeviceID, updated, sorted by timestamp (newest first), and capped by unique device count. (Evidence: lib/routes/location/v1/location.js; tests/integration/recordDetailedVisitorHistory.tests.js)\n- **Alternate paths**: Unknown visitor IDs are dropped when configured to disallow empty IDs. (Evidence: lib/models/RequestConfigGetLocation.js; config/default.js)\n- **Error paths**: Malformed visitor history entries are skipped and logged. (Evidence: lib/routes/location/v1/location.js)\n- **Retry/recovery**: Visitor logging is asynchronous (fire-and-forget); errors are logged but do not fail the main response. (Evidence: lib/routes/location/v1/location.js)\n\n### 4.7 DeleteLocation\n- **Primary path**:\n  1. Parse device ID. (Evidence: lib/routes/location/v1/inputParser.js; lib/models/RequestDevice.js)\n  2. Delete &#96;last&#96;, &#96;hist&#96;, and &#96;visit&#96; keys in parallel. (Evidence: lib/routes/location/v1/location.js)\n  3. Return &#96;ACK&#96; with count of deleted keys. (Evidence: lib/models/ResponseDeleteLocation.js; docs/DELETE_LOCATION_API.md)\n- **Alternate paths**: Legacy &#96;/DeleteLocation&#96; behaves like &#96;/v1/DeleteLocation&#96;. (Evidence: lib/routes/location/index.js; tests/integration/deleteLocation.tests.js)\n- **Error paths**: Missing device yields 400; non-existent device returns ACK with &#96;MiataruDeletedCount: 0&#96;. (Evidence: tests/integration/deleteLocation.tests.js)\n- **Retry/recovery**: Safe to retry; deletions are idempotent. (Evidence: lib/routes/location/v1/location.js)\n\n### 4.8 Error handling and logging\n- **Primary path**: Errors are logged with severity based on status; 404/405 are info, others warn/error. (Evidence: server.js; tests/unit/serverErrorHandling.tests.js)\n- **Alternate paths**: JSON parse failures include raw body previews and content-length mismatch warnings. (Evidence: server.js; .specstory/history/2026-01-19_20-26Z-miataru-getlocationhistory-json-error.md)\n- **Error paths**: Response payload is &#96;{ error: &lt;message&gt; }&#96;. (Evidence: server.js)",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- **Primary path**:",
            "lineNumber": 192
          },
          {
            "text": "  - **Detailed ON**: Each access &#96;LPUSH&#96;es a new entry and &#96;LTRIM&#96;s to the maximum count. (Evidence: lib/routes/location/v1/location.js; tests/integration/recordDetailedVisitorHistory.tests.js)",
            "lineNumber": 193
          },
          {
            "text": "  - **Detailed OFF**: Existing entries are deduplicated by DeviceID, updated, sorted by timestamp (newest first), and capped by unique device count. (Evidence: lib/routes/location/v1/location.js; tests/integration/recordDetailedVisitorHistory.tests.js)",
            "lineNumber": 194
          },
          {
            "text": "- **Alternate paths**: Unknown visitor IDs are dropped when configured to disallow empty IDs. (Evidence: lib/models/RequestConfigGetLocation.js; config/default.js)",
            "lineNumber": 195
          },
          {
            "text": "- **Error paths**: Malformed visitor history entries are skipped and logged. (Evidence: lib/routes/location/v1/location.js)",
            "lineNumber": 196
          },
          {
            "text": "- **Retry/recovery**: Visitor logging is asynchronous (fire-and-forget); errors are logged but do not fail the main response. (Evidence: lib/routes/location/v1/location.js)",
            "lineNumber": 197
          },
          {
            "lineNumber": 198
          },
          {
            "text": "### 4.7 DeleteLocation",
            "lineNumber": 199
          },
          {
            "text": "- **Primary path**:",
            "lineNumber": 200
          },
          {
            "text": "  1. Parse device ID. (Evidence: lib/routes/location/v1/inputParser.js; lib/models/RequestDevice.js)",
            "lineNumber": 201
          },
          {
            "text": "  2. Delete &#96;last&#96;, &#96;hist&#96;, and &#96;visit&#96; keys in parallel. (Evidence: lib/routes/location/v1/location.js)",
            "lineNumber": 202
          },
          {
            "text": "  3. Return &#96;ACK&#96; with count of deleted keys. (Evidence: lib/models/ResponseDeleteLocation.js; docs/DELETE_LOCATION_API.md)",
            "lineNumber": 203
          },
          {
            "text": "- **Alternate paths**: Legacy &#96;/DeleteLocation&#96; behaves like &#96;/v1/DeleteLocation&#96;. (Evidence: lib/routes/location/index.js; tests/integration/deleteLocation.tests.js)",
            "lineNumber": 204
          },
          {
            "text": "- **Error paths**: Missing device yields 400; non-existent device returns ACK with &#96;MiataruDeletedCount: 0&#96;. (Evidence: tests/integration/deleteLocation.tests.js)",
            "lineNumber": 205
          },
          {
            "text": "- **Retry/recovery**: Safe to retry; deletions are idempotent. (Evidence: lib/routes/location/v1/location.js)",
            "lineNumber": 206
          },
          {
            "lineNumber": 207
          },
          {
            "text": "### 4.8 Error handling and logging",
            "lineNumber": 208
          },
          {
            "text": "- **Primary path**: Errors are logged with severity based on status; 404/405 are info, others warn/error. (Evidence: server.js; tests/unit/serverErrorHandling.tests.js)",
            "lineNumber": 209
          },
          {
            "text": "- **Alternate paths**: JSON parse failures include raw body previews and content-length mismatch warnings. (Evidence: server.js; .specstory/history/2026-01-19_20-26Z-miataru-getlocationhistory-json-error.md)",
            "lineNumber": 210
          },
          {
            "text": "- **Error paths**: Response payload is &#96;{ error: &lt;message&gt; }&#96;. (Evidence: server.js)",
            "lineNumber": 211
          }
        ]
      },
      "score": 0.38675248622894287
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/inputParser.js",
        "range": {
          "startPosition": {
            "column": 61
          },
          "endPosition": {
            "line": 71,
            "column": 1
          }
        },
        "contents": "var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\nvar RequestLocation = require('../../../models/RequestLocation');\nvar RequestDevice = require('../../../models/RequestDevice');\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\nvar RequestSetDeviceKey = require('../../../models/RequestSetDeviceKey');\nvar RequestSetAllowedDeviceList = require('../../../models/RequestSetAllowedDeviceList');\n\nmodule.exports = function(req, res, next) {\n    req.MIATARU = req.MIATARU || {};\n\n    var nextError;\n\n    try {\n        switch(req.path) {\n            case '/UpdateLocation':\n            case '/v1/UpdateLocation':\n                parseUpdateLocation(req);\n                break;\n            case '/GetLocation':\n            case '/v1/GetLocation':\n                parseGetLocations(req);\n                break;\n            case '/GetLocationGeoJSON':\n            case '/v1/GetLocationGeoJSON':\n                parseGetLocationsGeoJSON(req);\n                break;\n            case '/GetLocationHistory':\n            case '/v1/GetLocationHistory':\n                parseGetLocationHistory(req);\n                break;\n            case '/v1/GetVisitorHistory':\n            case '/GetVisitorHistory':\n                parseGetVisitorHistory(req);\n                break;\n            case '/DeleteLocation':\n            case '/v1/DeleteLocation':\n                parseDeleteLocation(req);\n                break;\n            case '/setDeviceKey':\n            case '/v1/setDeviceKey':\n                parseSetDeviceKey(req);\n                break;\n            case '/setAllowedDeviceList':\n            case '/v1/setAllowedDeviceList':\n                parseSetAllowedDeviceList(req);\n                break;\n        }\n    }\n    catch(error) {\n        nextError = error;\n    }\n\n    next(nextError);\n};\n\nfunction parseUpdateLocation(req) {\n    var locations = req.body['MiataruLocation'];\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');",
            "lineNumber": 2
          },
          {
            "text": "var RequestLocation = require('../../../models/RequestLocation');",
            "lineNumber": 3
          },
          {
            "text": "var RequestDevice = require('../../../models/RequestDevice');",
            "lineNumber": 4
          },
          {
            "text": "var RequestLocationHistory = require('../../../models/RequestLocationHistory');",
            "lineNumber": 5
          },
          {
            "text": "var RequestVisitorHistory = require('../../../models/RequestVisitorHistory');",
            "lineNumber": 6
          },
          {
            "text": "var RequestSetDeviceKey = require('../../../models/RequestSetDeviceKey');",
            "lineNumber": 7
          },
          {
            "text": "var RequestSetAllowedDeviceList = require('../../../models/RequestSetAllowedDeviceList');",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "module.exports = function(req, res, next) {",
            "lineNumber": 10
          },
          {
            "text": "    req.MIATARU = req.MIATARU || {};",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "    var nextError;",
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "text": "    try {",
            "lineNumber": 15
          },
          {
            "text": "        switch(req.path) {",
            "lineNumber": 16
          },
          {
            "text": "            case '/UpdateLocation':",
            "lineNumber": 17
          },
          {
            "text": "            case '/v1/UpdateLocation':",
            "lineNumber": 18
          },
          {
            "text": "                parseUpdateLocation(req);",
            "lineNumber": 19
          },
          {
            "text": "                break;",
            "lineNumber": 20
          },
          {
            "text": "            case '/GetLocation':",
            "lineNumber": 21
          },
          {
            "text": "            case '/v1/GetLocation':",
            "lineNumber": 22
          },
          {
            "text": "                parseGetLocations(req);",
            "lineNumber": 23
          },
          {
            "text": "                break;",
            "lineNumber": 24
          },
          {
            "text": "            case '/GetLocationGeoJSON':",
            "lineNumber": 25
          },
          {
            "text": "            case '/v1/GetLocationGeoJSON':",
            "lineNumber": 26
          },
          {
            "text": "                parseGetLocationsGeoJSON(req);",
            "lineNumber": 27
          },
          {
            "text": "                break;",
            "lineNumber": 28
          },
          {
            "text": "            case '/GetLocationHistory':",
            "lineNumber": 29
          },
          {
            "text": "            case '/v1/GetLocationHistory':",
            "lineNumber": 30
          },
          {
            "text": "                parseGetLocationHistory(req);",
            "lineNumber": 31
          },
          {
            "text": "                break;",
            "lineNumber": 32
          },
          {
            "text": "            case '/v1/GetVisitorHistory':",
            "lineNumber": 33
          },
          {
            "text": "            case '/GetVisitorHistory':",
            "lineNumber": 34
          },
          {
            "text": "                parseGetVisitorHistory(req);",
            "lineNumber": 35
          },
          {
            "text": "                break;",
            "lineNumber": 36
          },
          {
            "text": "            case '/DeleteLocation':",
            "lineNumber": 37
          },
          {
            "text": "            case '/v1/DeleteLocation':",
            "lineNumber": 38
          },
          {
            "text": "                parseDeleteLocation(req);",
            "lineNumber": 39
          },
          {
            "text": "                break;",
            "lineNumber": 40
          },
          {
            "text": "            case '/setDeviceKey':",
            "lineNumber": 41
          },
          {
            "text": "            case '/v1/setDeviceKey':",
            "lineNumber": 42
          },
          {
            "text": "                parseSetDeviceKey(req);",
            "lineNumber": 43
          },
          {
            "text": "                break;",
            "lineNumber": 44
          },
          {
            "text": "            case '/setAllowedDeviceList':",
            "lineNumber": 45
          },
          {
            "text": "            case '/v1/setAllowedDeviceList':",
            "lineNumber": 46
          },
          {
            "text": "                parseSetAllowedDeviceList(req);",
            "lineNumber": 47
          },
          {
            "text": "                break;",
            "lineNumber": 48
          },
          {
            "text": "        }",
            "lineNumber": 49
          },
          {
            "text": "    }",
            "lineNumber": 50
          },
          {
            "text": "    catch(error) {",
            "lineNumber": 51
          },
          {
            "text": "        nextError = error;",
            "lineNumber": 52
          },
          {
            "text": "    }",
            "lineNumber": 53
          },
          {
            "lineNumber": 54
          },
          {
            "text": "    next(nextError);",
            "lineNumber": 55
          },
          {
            "text": "};",
            "lineNumber": 56
          },
          {
            "lineNumber": 57
          },
          {
            "text": "function parseUpdateLocation(req) {",
            "lineNumber": 58,
            "isSignature": true
          },
          {
            "text": "    var locations = req.body['MiataruLocation'];",
            "lineNumber": 59
          },
          {
            "text": "}",
            "lineNumber": 72,
            "isSignature": true
          }
        ]
      },
      "score": 0.38475465774536133
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./dev/Triggers/DeleteLocation.sh",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 76
          }
        },
        "contents": "#!/bin/bash\n\n# DeleteLocation API Test Script\n# This script demonstrates the DeleteLocation API functionality\n\nSERVER_URL=\"http://localhost:8080\"\nDEVICE_ID=\"test-delete-device-$(date +%s)\"\n\necho \"=== DeleteLocation API Test ===\"\necho \"Server: $SERVER_URL\"\necho \"Test Device ID: $DEVICE_ID\"\necho \"\"\n\n# Step 1: Add some location data\necho \"Step 1: Adding location data...\"\ncurl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/UpdateLocation\" \\\n  -d \"{\n    \\\"MiataruConfig\\\": {\n      \\\"EnableLocationHistory\\\": \\\"True\\\",\n      \\\"LocationDataRetentionTime\\\": \\\"15\\\"\n    },\n    \\\"MiataruLocation\\\": [{\n      \\\"Device\\\": \\\"$DEVICE_ID\\\",\n      \\\"Timestamp\\\": \\\"$(date +%s)000\\\",\n      \\\"Longitude\\\": \\\"10.837502\\\",\n      \\\"Latitude\\\": \\\"49.828925\\\",\n      \\\"HorizontalAccuracy\\\": \\\"50.00\\\"\n    }]\n  }\" | jq '.'\n\necho \"\"\n\n# Step 2: Verify location data exists\necho \"Step 2: Verifying location data exists...\"\ncurl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/GetLocation\" \\\n  -d \"{\n    \\\"MiataruGetLocation\\\": [{\n      \\\"Device\\\": \\\"$DEVICE_ID\\\"\n    }]\n  }\" | jq '.'\n\necho \"\"\n\n# Step 3: Delete location data\necho \"Step 3: Deleting location data...\"\ncurl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/DeleteLocation\" \\\n  -d \"{\n    \\\"MiataruDeleteLocation\\\": {\n      \\\"Device\\\": \\\"$DEVICE_ID\\\"\n    }\n  }\" | jq '.'\n\necho \"\"\n\n# Step 4: Verify data is deleted\necho \"Step 4: Verifying data is deleted...\"\ncurl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/GetLocation\" \\\n  -d \"{\n    \\\"MiataruGetLocation\\\": [{\n      \\\"Device\\\": \\\"$DEVICE_ID\\\"\n    }]\n  }\" | jq '.'\n\necho \"\"\n\n# Step 5: Test deleting non-existent device\necho \"Step 5: Testing deletion of non-existent device...\"\ncurl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/DeleteLocation\" \\\n  -d \"{\n    \\\"MiataruDeleteLocation\\\": {\n      \\\"Device\\\": \\\"non-existent-device\\\"\n    }\n  }\" | jq '.'\n\necho \"\"\necho \"=== Test Complete ===\"",
        "signatures": {},
        "detailedLines": [
          {
            "text": "#!/bin/bash",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "# DeleteLocation API Test Script",
            "lineNumber": 3
          },
          {
            "text": "# This script demonstrates the DeleteLocation API functionality",
            "lineNumber": 4
          },
          {
            "lineNumber": 5
          },
          {
            "text": "SERVER_URL=\"http://localhost:8080\"",
            "lineNumber": 6
          },
          {
            "text": "DEVICE_ID=\"test-delete-device-$(date +%s)\"",
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "echo \"=== DeleteLocation API Test ===\"",
            "lineNumber": 9
          },
          {
            "text": "echo \"Server: $SERVER_URL\"",
            "lineNumber": 10
          },
          {
            "text": "echo \"Test Device ID: $DEVICE_ID\"",
            "lineNumber": 11
          },
          {
            "text": "echo \"\"",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "# Step 1: Add some location data",
            "lineNumber": 14
          },
          {
            "text": "echo \"Step 1: Adding location data...\"",
            "lineNumber": 15
          },
          {
            "text": "curl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/UpdateLocation\" \\",
            "lineNumber": 16
          },
          {
            "text": "  -d \"{",
            "lineNumber": 17
          },
          {
            "text": "    \\\"MiataruConfig\\\": {",
            "lineNumber": 18
          },
          {
            "text": "      \\\"EnableLocationHistory\\\": \\\"True\\\",",
            "lineNumber": 19
          },
          {
            "text": "      \\\"LocationDataRetentionTime\\\": \\\"15\\\"",
            "lineNumber": 20
          },
          {
            "text": "    },",
            "lineNumber": 21
          },
          {
            "text": "    \\\"MiataruLocation\\\": [{",
            "lineNumber": 22
          },
          {
            "text": "      \\\"Device\\\": \\\"$DEVICE_ID\\\",",
            "lineNumber": 23
          },
          {
            "text": "      \\\"Timestamp\\\": \\\"$(date +%s)000\\\",",
            "lineNumber": 24
          },
          {
            "text": "      \\\"Longitude\\\": \\\"10.837502\\\",",
            "lineNumber": 25
          },
          {
            "text": "      \\\"Latitude\\\": \\\"49.828925\\\",",
            "lineNumber": 26
          },
          {
            "text": "      \\\"HorizontalAccuracy\\\": \\\"50.00\\\"",
            "lineNumber": 27
          },
          {
            "text": "    }]",
            "lineNumber": 28
          },
          {
            "text": "  }\" | jq '.'",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "echo \"\"",
            "lineNumber": 31
          },
          {
            "lineNumber": 32
          },
          {
            "text": "# Step 2: Verify location data exists",
            "lineNumber": 33
          },
          {
            "text": "echo \"Step 2: Verifying location data exists...\"",
            "lineNumber": 34
          },
          {
            "text": "curl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/GetLocation\" \\",
            "lineNumber": 35
          },
          {
            "text": "  -d \"{",
            "lineNumber": 36
          },
          {
            "text": "    \\\"MiataruGetLocation\\\": [{",
            "lineNumber": 37
          },
          {
            "text": "      \\\"Device\\\": \\\"$DEVICE_ID\\\"",
            "lineNumber": 38
          },
          {
            "text": "    }]",
            "lineNumber": 39
          },
          {
            "text": "  }\" | jq '.'",
            "lineNumber": 40
          },
          {
            "lineNumber": 41
          },
          {
            "text": "echo \"\"",
            "lineNumber": 42
          },
          {
            "lineNumber": 43
          },
          {
            "text": "# Step 3: Delete location data",
            "lineNumber": 44
          },
          {
            "text": "echo \"Step 3: Deleting location data...\"",
            "lineNumber": 45
          },
          {
            "text": "curl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/DeleteLocation\" \\",
            "lineNumber": 46
          },
          {
            "text": "  -d \"{",
            "lineNumber": 47
          },
          {
            "text": "    \\\"MiataruDeleteLocation\\\": {",
            "lineNumber": 48
          },
          {
            "text": "      \\\"Device\\\": \\\"$DEVICE_ID\\\"",
            "lineNumber": 49
          },
          {
            "text": "    }",
            "lineNumber": 50
          },
          {
            "text": "  }\" | jq '.'",
            "lineNumber": 51
          },
          {
            "lineNumber": 52
          },
          {
            "text": "echo \"\"",
            "lineNumber": 53
          },
          {
            "lineNumber": 54
          },
          {
            "text": "# Step 4: Verify data is deleted",
            "lineNumber": 55
          },
          {
            "text": "echo \"Step 4: Verifying data is deleted...\"",
            "lineNumber": 56
          },
          {
            "text": "curl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/GetLocation\" \\",
            "lineNumber": 57
          },
          {
            "text": "  -d \"{",
            "lineNumber": 58
          },
          {
            "text": "    \\\"MiataruGetLocation\\\": [{",
            "lineNumber": 59
          },
          {
            "text": "      \\\"Device\\\": \\\"$DEVICE_ID\\\"",
            "lineNumber": 60
          },
          {
            "text": "    }]",
            "lineNumber": 61
          },
          {
            "text": "  }\" | jq '.'",
            "lineNumber": 62
          },
          {
            "lineNumber": 63
          },
          {
            "text": "echo \"\"",
            "lineNumber": 64
          },
          {
            "lineNumber": 65
          },
          {
            "text": "# Step 5: Test deleting non-existent device",
            "lineNumber": 66
          },
          {
            "text": "echo \"Step 5: Testing deletion of non-existent device...\"",
            "lineNumber": 67
          },
          {
            "text": "curl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/DeleteLocation\" \\",
            "lineNumber": 68
          },
          {
            "text": "  -d \"{",
            "lineNumber": 69
          },
          {
            "text": "    \\\"MiataruDeleteLocation\\\": {",
            "lineNumber": 70
          },
          {
            "text": "      \\\"Device\\\": \\\"non-existent-device\\\"",
            "lineNumber": 71
          },
          {
            "text": "    }",
            "lineNumber": 72
          },
          {
            "text": "  }\" | jq '.'",
            "lineNumber": 73
          },
          {
            "lineNumber": 74
          },
          {
            "text": "echo \"\"",
            "lineNumber": 75
          },
          {
            "text": "echo \"=== Test Complete ===\"",
            "lineNumber": 76
          }
        ]
      },
      "score": 0.3785780668258667
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/DECISION_LOG.md",
        "range": {
          "startPosition": {
            "line": 79
          },
          "endPosition": {
            "line": 101
          }
        },
        "contents": "- **Why alternatives were rejected**: Conflicting operator needs (audit trail vs. storage efficiency). (Evidence: .specstory/history/2026-01-22_13-59Z-visitor-history-recording-configuration.md)\n- **Consequences**:\n  - **Positive**: Configurable balance between storage and auditability. (Evidence: README.md; tests/integration/recordDetailedVisitorHistory.tests.js)\n  - **Negative**: More complex visitor history logic. (Evidence: lib/routes/location/v1/location.js)\n- **Follow-ups**: Document configuration and default. (Evidence: README.md)\n- **Evidence pointers**: .specstory/history/2026-01-22_13-59Z-visitor-history-recording-configuration.md; config/default.js; tests/integration/recordDetailedVisitorHistory.tests.js.\n\n### ADR-007: DeleteLocation endpoint for full data removal\n- **Context**: Operators need a way to remove all data for a device. (Evidence: README.md; docs/DELETE_LOCATION_API.md)\n- **Decision**: Provide &#96;/v1/DeleteLocation&#96; and legacy &#96;/DeleteLocation&#96; to delete last, history, and visitor keys. (Evidence: lib/routes/location/v1/location.js; docs/DELETE_LOCATION_API.md)\n- **Alternatives considered**: Require manual Redis operations; only delete last location.\n- **Why alternatives were rejected**: Incomplete deletion and higher operational burden. (Evidence: docs/DELETE_LOCATION_API.md)\n- **Consequences**:\n  - **Positive**: API-level deletion for all data types. (Evidence: tests/integration/deleteLocation.tests.js)\n  - **Negative**: No authentication is enforced. (Evidence: docs/DELETE_LOCATION_API.md)\n- **Follow-ups**: Document deletion semantics and counts. (Evidence: docs/DELETE_LOCATION_API.md)\n- **Evidence pointers**: docs/DELETE_LOCATION_API.md; lib/routes/location/v1/location.js; tests/integration/deleteLocation.tests.js.\n\n### ADR-008: GeoJSON endpoint for location rendering\n- **Context**: Clients need a GeoJSON representation for mapping tools. (Evidence: README.md; docs/PRD.md)\n- **Decision**: Provide GeoJSON response with a single Feature; return &#96;{}&#96; when coordinates missing. (Evidence: lib/models/ResponseLocationGeoJSON.js; tests/unit/responseLocationGeoJSON.tests.js)\n- **Alternatives considered**: Always return a list of features; error when missing coordinates.",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- **Why alternatives were rejected**: Conflicting operator needs (audit trail vs. storage efficiency). (Evidence: .specstory/history/2026-01-22_13-59Z-visitor-history-recording-configuration.md)",
            "lineNumber": 80
          },
          {
            "text": "- **Consequences**:",
            "lineNumber": 81
          },
          {
            "text": "  - **Positive**: Configurable balance between storage and auditability. (Evidence: README.md; tests/integration/recordDetailedVisitorHistory.tests.js)",
            "lineNumber": 82
          },
          {
            "text": "  - **Negative**: More complex visitor history logic. (Evidence: lib/routes/location/v1/location.js)",
            "lineNumber": 83
          },
          {
            "text": "- **Follow-ups**: Document configuration and default. (Evidence: README.md)",
            "lineNumber": 84
          },
          {
            "text": "- **Evidence pointers**: .specstory/history/2026-01-22_13-59Z-visitor-history-recording-configuration.md; config/default.js; tests/integration/recordDetailedVisitorHistory.tests.js.",
            "lineNumber": 85
          },
          {
            "lineNumber": 86
          },
          {
            "text": "### ADR-007: DeleteLocation endpoint for full data removal",
            "lineNumber": 87
          },
          {
            "text": "- **Context**: Operators need a way to remove all data for a device. (Evidence: README.md; docs/DELETE_LOCATION_API.md)",
            "lineNumber": 88
          },
          {
            "text": "- **Decision**: Provide &#96;/v1/DeleteLocation&#96; and legacy &#96;/DeleteLocation&#96; to delete last, history, and visitor keys. (Evidence: lib/routes/location/v1/location.js; docs/DELETE_LOCATION_API.md)",
            "lineNumber": 89
          },
          {
            "text": "- **Alternatives considered**: Require manual Redis operations; only delete last location.",
            "lineNumber": 90
          },
          {
            "text": "- **Why alternatives were rejected**: Incomplete deletion and higher operational burden. (Evidence: docs/DELETE_LOCATION_API.md)",
            "lineNumber": 91
          },
          {
            "text": "- **Consequences**:",
            "lineNumber": 92
          },
          {
            "text": "  - **Positive**: API-level deletion for all data types. (Evidence: tests/integration/deleteLocation.tests.js)",
            "lineNumber": 93
          },
          {
            "text": "  - **Negative**: No authentication is enforced. (Evidence: docs/DELETE_LOCATION_API.md)",
            "lineNumber": 94
          },
          {
            "text": "- **Follow-ups**: Document deletion semantics and counts. (Evidence: docs/DELETE_LOCATION_API.md)",
            "lineNumber": 95
          },
          {
            "text": "- **Evidence pointers**: docs/DELETE_LOCATION_API.md; lib/routes/location/v1/location.js; tests/integration/deleteLocation.tests.js.",
            "lineNumber": 96
          },
          {
            "lineNumber": 97
          },
          {
            "text": "### ADR-008: GeoJSON endpoint for location rendering",
            "lineNumber": 98
          },
          {
            "text": "- **Context**: Clients need a GeoJSON representation for mapping tools. (Evidence: README.md; docs/PRD.md)",
            "lineNumber": 99
          },
          {
            "text": "- **Decision**: Provide GeoJSON response with a single Feature; return &#96;{}&#96; when coordinates missing. (Evidence: lib/models/ResponseLocationGeoJSON.js; tests/unit/responseLocationGeoJSON.tests.js)",
            "lineNumber": 100
          },
          {
            "text": "- **Alternatives considered**: Always return a list of features; error when missing coordinates.",
            "lineNumber": 101
          }
        ]
      },
      "score": 0.37488049268722534
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./README.md",
        "range": {
          "startPosition": {
            "line": 28
          },
          "endPosition": {
            "line": 69
          }
        },
        "contents": "By default Miataru does only store the last known location. And it only does that for a pre-defined amount of time. Nothing is written to any disk, everything is in-memory only and only available for a pre-defined time-window.\n\nWith it's simple API it allows you to use Miataru to your own needs and practices.\n\n## API Endpoints\n\nThe Miataru server provides both versioned (v1) and legacy API endpoints for maximum compatibility:\n\n### Version 1 API (Recommended)\n- **POST** &#96;/v1/UpdateLocation&#96; - Store location data\n- **POST** &#96;/v1/GetLocation&#96; - Retrieve current location\n- **POST** &#96;/v1/GetLocationGeoJSON&#96; - Get location in GeoJSON format\n- **GET** &#96;/v1/GetLocationGeoJSON/:id?&#96; - Get location in GeoJSON format via GET\n- **POST** &#96;/v1/GetLocationHistory&#96; - Retrieve location history\n- **POST** &#96;/v1/GetVisitorHistory&#96; - Retrieve visitor history\n- **POST** &#96;/v1/DeleteLocation&#96; - Delete all location data for a device\n- **POST** &#96;/v1/setDeviceKey&#96; - Set or change device key (API 1.1)\n- **POST** &#96;/v1/setAllowedDeviceList&#96; - Manage allowed devices list (API 1.1)\n\n### Legacy API (Backward Compatibility)\n- **POST** &#96;/UpdateLocation&#96; - Store location data\n- **POST** &#96;/GetLocation&#96; - Retrieve current location\n- **POST** &#96;/GetLocationGeoJSON&#96; - Get location in GeoJSON format\n- **GET** &#96;/GetLocationGeoJSON/:id?&#96; - Get location in GeoJSON format via GET\n- **POST** &#96;/GetLocationHistory&#96; - Retrieve location history\n- **POST** &#96;/GetVisitorHistory&#96; - Retrieve visitor history\n- **POST** &#96;/DeleteLocation&#96; - Delete all location data for a device\n- **POST** &#96;/setDeviceKey&#96; - Set or change device key (API 1.1)\n- **POST** &#96;/setAllowedDeviceList&#96; - Manage allowed devices list (API 1.1)\n\n## Security Features (API 1.1)\n\n### DeviceKey Authentication\n\nDeviceKey provides authentication for write operations and visitor history access. Once set, devices must provide the correct DeviceKey to:\n- Update location data\n- Access visitor history\n\nSee [API 1.1 Security Documentation](docs/API_1.1_SECURITY.md) for details.",
        "signatures": {},
        "detailedLines": [
          {
            "text": "By default Miataru does only store the last known location. And it only does that for a pre-defined amount of time. Nothing is written to any disk, everything is in-memory only and only available for a pre-defined time-window.",
            "lineNumber": 30
          },
          {
            "lineNumber": 31
          },
          {
            "text": "With it's simple API it allows you to use Miataru to your own needs and practices.",
            "lineNumber": 32
          },
          {
            "lineNumber": 33
          },
          {
            "text": "## API Endpoints",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "The Miataru server provides both versioned (v1) and legacy API endpoints for maximum compatibility:",
            "lineNumber": 36
          },
          {
            "lineNumber": 37
          },
          {
            "text": "### Version 1 API (Recommended)",
            "lineNumber": 38
          },
          {
            "text": "- **POST** &#96;/v1/UpdateLocation&#96; - Store location data",
            "lineNumber": 39
          },
          {
            "text": "- **POST** &#96;/v1/GetLocation&#96; - Retrieve current location",
            "lineNumber": 40
          },
          {
            "text": "- **POST** &#96;/v1/GetLocationGeoJSON&#96; - Get location in GeoJSON format",
            "lineNumber": 41
          },
          {
            "text": "- **GET** &#96;/v1/GetLocationGeoJSON/:id?&#96; - Get location in GeoJSON format via GET",
            "lineNumber": 42
          },
          {
            "text": "- **POST** &#96;/v1/GetLocationHistory&#96; - Retrieve location history",
            "lineNumber": 43
          },
          {
            "text": "- **POST** &#96;/v1/GetVisitorHistory&#96; - Retrieve visitor history",
            "lineNumber": 44
          },
          {
            "text": "- **POST** &#96;/v1/DeleteLocation&#96; - Delete all location data for a device",
            "lineNumber": 45
          },
          {
            "text": "- **POST** &#96;/v1/setDeviceKey&#96; - Set or change device key (API 1.1)",
            "lineNumber": 46
          },
          {
            "text": "- **POST** &#96;/v1/setAllowedDeviceList&#96; - Manage allowed devices list (API 1.1)",
            "lineNumber": 47
          },
          {
            "lineNumber": 48
          },
          {
            "text": "### Legacy API (Backward Compatibility)",
            "lineNumber": 49
          },
          {
            "text": "- **POST** &#96;/UpdateLocation&#96; - Store location data",
            "lineNumber": 50
          },
          {
            "text": "- **POST** &#96;/GetLocation&#96; - Retrieve current location",
            "lineNumber": 51
          },
          {
            "text": "- **POST** &#96;/GetLocationGeoJSON&#96; - Get location in GeoJSON format",
            "lineNumber": 52
          },
          {
            "text": "- **GET** &#96;/GetLocationGeoJSON/:id?&#96; - Get location in GeoJSON format via GET",
            "lineNumber": 53
          },
          {
            "text": "- **POST** &#96;/GetLocationHistory&#96; - Retrieve location history",
            "lineNumber": 54
          },
          {
            "text": "- **POST** &#96;/GetVisitorHistory&#96; - Retrieve visitor history",
            "lineNumber": 55
          },
          {
            "text": "- **POST** &#96;/DeleteLocation&#96; - Delete all location data for a device",
            "lineNumber": 56
          },
          {
            "text": "- **POST** &#96;/setDeviceKey&#96; - Set or change device key (API 1.1)",
            "lineNumber": 57
          },
          {
            "text": "- **POST** &#96;/setAllowedDeviceList&#96; - Manage allowed devices list (API 1.1)",
            "lineNumber": 58
          },
          {
            "lineNumber": 59
          },
          {
            "text": "## Security Features (API 1.1)",
            "lineNumber": 60
          },
          {
            "lineNumber": 61
          },
          {
            "text": "### DeviceKey Authentication",
            "lineNumber": 62
          },
          {
            "lineNumber": 63
          },
          {
            "text": "DeviceKey provides authentication for write operations and visitor history access. Once set, devices must provide the correct DeviceKey to:",
            "lineNumber": 64
          },
          {
            "text": "- Update location data",
            "lineNumber": 65
          },
          {
            "text": "- Access visitor history",
            "lineNumber": 66
          },
          {
            "lineNumber": 67
          },
          {
            "text": "See [API 1.1 Security Documentation](docs/API_1.1_SECURITY.md) for details.",
            "lineNumber": 68
          }
        ]
      },
      "score": 0.36889779567718506
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./tests/integration/deleteLocation.tests.js",
        "range": {
          "startPosition": {
            "line": 6
          },
          "endPosition": {
            "line": 293,
            "column": 3
          }
        },
        "contents": "getLocationRequest = {\n\n                    };\n\n                    request(app)\n                        .post('/v1/GetLocation')\n                        .send(getLocationRequest)\n                        .expect(200)\n                        .end(function(err, res) {\n                            if (err) return done(err);\n                            expect(res.body.MiataruLocation[0]).to.have.property('Device', deviceId);\n\n                            // Step 3: Delete location data\n                            var deleteRequest = {\n                                \"MiataruDeleteLocation\": {\n                                    \"Device\": deviceId\n                                }\n                            };\n\n                            request(app)\n                                .post('/v1/DeleteLocation')\n                                .send(deleteRequest)\n                                .expect(200)\n                                .expect(function(res) {\n                                    expect(res.body.MiataruResponse).to.equal('ACK');\n                                    expect(res.body.MiataruDeletedCount).to.be.at.least(1);\n                                })\n                                .end(function(err) {\n                                    if (err) return done(err);\n\n                                    // Step 4: Verify data is deleted\n                                    request(app)\n                                        .post('/v1/GetLocation')\n                                        .send(getLocationRequest)\n                                        .expect(200)\n                                        .expect(function(res) {\n                                            expect(res.body.MiataruLocation[0]).to.be.null;\n                                        })\n                                        .end(done);\n                                });\n                        });\n                });\n        });\n    });\n});",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 7,
                "column": 1
              },
              "endPosition": {
                "line": 7,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 226,
                "column": 5
              },
              "endPosition": {
                "line": 226,
                "column": 5
              }
            },
            {
              "startPosition": {
                "line": 227,
                "column": 9
              },
              "endPosition": {
                "line": 227,
                "column": 9
              }
            },
            {
              "startPosition": {
                "line": 239,
                "column": 13
              },
              "endPosition": {
                "line": 239,
                "column": 13
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "getLocationRequest = {",
            "lineNumber": 247
          },
          {
            "lineNumber": 251
          },
          {
            "text": "                    };",
            "lineNumber": 252
          },
          {
            "lineNumber": 253
          },
          {
            "text": "                    request(app)",
            "lineNumber": 254
          },
          {
            "text": "                        .post('/v1/GetLocation')",
            "lineNumber": 255
          },
          {
            "text": "                        .send(getLocationRequest)",
            "lineNumber": 256
          },
          {
            "text": "                        .expect(200)",
            "lineNumber": 257
          },
          {
            "text": "                        .end(function(err, res) {",
            "lineNumber": 258
          },
          {
            "text": "                            if (err) return done(err);",
            "lineNumber": 259
          },
          {
            "text": "                            expect(res.body.MiataruLocation[0]).to.have.property('Device', deviceId);",
            "lineNumber": 260
          },
          {
            "lineNumber": 261
          },
          {
            "text": "                            // Step 3: Delete location data",
            "lineNumber": 262
          },
          {
            "text": "                            var deleteRequest = {",
            "lineNumber": 263
          },
          {
            "text": "                                \"MiataruDeleteLocation\": {",
            "lineNumber": 264
          },
          {
            "text": "                                    \"Device\": deviceId",
            "lineNumber": 265
          },
          {
            "text": "                                }",
            "lineNumber": 266
          },
          {
            "text": "                            };",
            "lineNumber": 267
          },
          {
            "lineNumber": 268
          },
          {
            "text": "                            request(app)",
            "lineNumber": 269
          },
          {
            "text": "                                .post('/v1/DeleteLocation')",
            "lineNumber": 270
          },
          {
            "text": "                                .send(deleteRequest)",
            "lineNumber": 271
          },
          {
            "text": "                                .expect(200)",
            "lineNumber": 272
          },
          {
            "text": "                                .expect(function(res) {",
            "lineNumber": 273
          },
          {
            "text": "                                    expect(res.body.MiataruResponse).to.equal('ACK');",
            "lineNumber": 274
          },
          {
            "text": "                                    expect(res.body.MiataruDeletedCount).to.be.at.least(1);",
            "lineNumber": 275
          },
          {
            "text": "                                })",
            "lineNumber": 276
          },
          {
            "text": "                                .end(function(err) {",
            "lineNumber": 277
          },
          {
            "text": "                                    if (err) return done(err);",
            "lineNumber": 278
          },
          {
            "lineNumber": 279
          },
          {
            "text": "                                    // Step 4: Verify data is deleted",
            "lineNumber": 280
          },
          {
            "text": "                                    request(app)",
            "lineNumber": 281
          },
          {
            "text": "                                        .post('/v1/GetLocation')",
            "lineNumber": 282
          },
          {
            "text": "                                        .send(getLocationRequest)",
            "lineNumber": 283
          },
          {
            "text": "                                        .expect(200)",
            "lineNumber": 284
          },
          {
            "text": "                                        .expect(function(res) {",
            "lineNumber": 285
          },
          {
            "text": "                                            expect(res.body.MiataruLocation[0]).to.be.null;",
            "lineNumber": 286
          },
          {
            "text": "                                        })",
            "lineNumber": 287
          },
          {
            "text": "                                        .end(done);",
            "lineNumber": 288
          },
          {
            "text": "                                });",
            "lineNumber": 289
          },
          {
            "text": "                        });",
            "lineNumber": 290
          },
          {
            "text": "                });",
            "lineNumber": 291
          },
          {
            "text": "        });",
            "lineNumber": 292
          },
          {
            "text": "    });",
            "lineNumber": 293
          },
          {
            "text": "});",
            "lineNumber": 294
          }
        ]
      },
      "score": 0.3645496964454651
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./tests/integration/deleteLocation.tests.js",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 293
          }
        },
        "contents": "var expect = require('chai').expect;\nvar request = require('supertest');\n\nvar app = require('../../server');\nvar calls = require('../testFiles/calls');\n\ndescribe('DeleteLocation', function() {\n    var TEST_DEVICE = 'test-delete-device';\n\n    beforeEach(function(done) {\n        // Clean up any existing data for test device\n        var deleteRequest = {\n            \"MiataruDeleteLocation\": {\n                \"Device\": TEST_DEVICE\n            }\n        };\n\n        request(app)\n            .post('/v1/DeleteLocation')\n            .send(deleteRequest)\n            .end(function() {\n                done();\n            });\n    });\n\n    describe('Basic DeleteLocation functionality', function() {\n        it('should return ACK when deleting location data for existing device', function(done) {\n            // First, add some location data\n            var updateData = calls.locationUpdateCall({\n                locations: [calls.location({device: TEST_DEVICE})]\n            });\n\n            request(app)\n                .post('/v1/UpdateLocation')\n                .send",
        "signatures": {},
        "detailedLines": [
          {
            "text": "var expect = require('chai').expect;",
            "lineNumber": 1
          },
          {
            "text": "var request = require('supertest');",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "var app = require('../../server');",
            "lineNumber": 4
          },
          {
            "text": "var calls = require('../testFiles/calls');",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "describe('DeleteLocation', function() {",
            "lineNumber": 7
          },
          {
            "text": "    var TEST_DEVICE = 'test-delete-device';",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "    beforeEach(function(done) {",
            "lineNumber": 10
          },
          {
            "text": "        // Clean up any existing data for test device",
            "lineNumber": 11
          },
          {
            "text": "        var deleteRequest = {",
            "lineNumber": 12
          },
          {
            "text": "            \"MiataruDeleteLocation\": {",
            "lineNumber": 13
          },
          {
            "text": "                \"Device\": TEST_DEVICE",
            "lineNumber": 14
          },
          {
            "text": "            }",
            "lineNumber": 15
          },
          {
            "text": "        };",
            "lineNumber": 16
          },
          {
            "lineNumber": 17
          },
          {
            "text": "        request(app)",
            "lineNumber": 18
          },
          {
            "text": "            .post('/v1/DeleteLocation')",
            "lineNumber": 19
          },
          {
            "text": "            .send(deleteRequest)",
            "lineNumber": 20
          },
          {
            "text": "            .end(function() {",
            "lineNumber": 21
          },
          {
            "text": "                done();",
            "lineNumber": 22
          },
          {
            "text": "            });",
            "lineNumber": 23
          },
          {
            "text": "    });",
            "lineNumber": 24
          },
          {
            "lineNumber": 25
          },
          {
            "text": "    describe('Basic DeleteLocation functionality', function() {",
            "lineNumber": 26
          },
          {
            "text": "        it('should return ACK when deleting location data for existing device', function(done) {",
            "lineNumber": 27
          },
          {
            "text": "            // First, add some location data",
            "lineNumber": 28
          },
          {
            "text": "            var updateData = calls.locationUpdateCall({",
            "lineNumber": 29
          },
          {
            "text": "                locations: [calls.location({device: TEST_DEVICE})]",
            "lineNumber": 30
          },
          {
            "text": "            });",
            "lineNumber": 31
          },
          {
            "lineNumber": 32
          },
          {
            "text": "            request(app)",
            "lineNumber": 33
          },
          {
            "text": "                .post('/v1/UpdateLocation')",
            "lineNumber": 34
          },
          {
            "text": "                .send",
            "lineNumber": 35
          }
        ]
      },
      "score": 0.3633737564086914
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/index.js",
        "range": {
          "startPosition": {
            "line": 33,
            "column": 79
          },
          "endPosition": {
            "line": 61,
            "column": 2
          }
        },
        "contents": "    ///////////////////////////////////////////\n    ///// non-Post /////////////////////////\n    ///////////////////////////////////////////\n    function handleUnsupportedMethod(req, res, next) {\n        if (req.method === 'OPTIONS') {\n            return res.status(204).end();\n        }\n\n        next(new errors.MethodNotSupportedError(req.method, req.path));\n    }\n\n    app.all('/v1/UpdateLocation', handleUnsupportedMethod);\n    app.all('/v1/GetLocation', handleUnsupportedMethod);\n    app.all('/v1/GetLocationGeoJSON', handleUnsupportedMethod);\n    app.all('/v1/GetLocationHistory', handleUnsupportedMethod);\n    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\n    app.all('/v1/setDeviceKey', handleUnsupportedMethod);\n    app.all('/v1/setAllowedDeviceList', handleUnsupportedMethod);\n    app.all('/UpdateLocation', handleUnsupportedMethod);\n    app.all('/GetLocation', handleUnsupportedMethod);\n    app.all('/GetLocationGeoJSON', handleUnsupportedMethod);\n    app.all('/GetLocationHistory', handleUnsupportedMethod);\n    app.all('/DeleteLocation', handleUnsupportedMethod);\n    app.all('/GetVisitorHistory', handleUnsupportedMethod);\n    app.all('/setDeviceKey', handleUnsupportedMethod);\n    app.all('/setAllowedDeviceList', handleUnsupportedMethod);\n};",
        "signatures": {},
        "detailedLines": [
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 36
          },
          {
            "text": "    ///// non-Post /////////////////////////",
            "lineNumber": 37
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 38
          },
          {
            "text": "    function handleUnsupportedMethod(req, res, next) {",
            "lineNumber": 39
          },
          {
            "text": "        if (req.method === 'OPTIONS') {",
            "lineNumber": 40
          },
          {
            "text": "            return res.status(204).end();",
            "lineNumber": 41
          },
          {
            "text": "        }",
            "lineNumber": 42
          },
          {
            "lineNumber": 43
          },
          {
            "text": "        next(new errors.MethodNotSupportedError(req.method, req.path));",
            "lineNumber": 44
          },
          {
            "text": "    }",
            "lineNumber": 45
          },
          {
            "lineNumber": 46
          },
          {
            "text": "    app.all('/v1/UpdateLocation', handleUnsupportedMethod);",
            "lineNumber": 47
          },
          {
            "text": "    app.all('/v1/GetLocation', handleUnsupportedMethod);",
            "lineNumber": 48
          },
          {
            "text": "    app.all('/v1/GetLocationGeoJSON', handleUnsupportedMethod);",
            "lineNumber": 49
          },
          {
            "text": "    app.all('/v1/GetLocationHistory', handleUnsupportedMethod);",
            "lineNumber": 50
          },
          {
            "text": "    app.all('/v1/DeleteLocation', handleUnsupportedMethod);",
            "lineNumber": 51
          },
          {
            "text": "    app.all('/v1/setDeviceKey', handleUnsupportedMethod);",
            "lineNumber": 52
          },
          {
            "text": "    app.all('/v1/setAllowedDeviceList', handleUnsupportedMethod);",
            "lineNumber": 53
          },
          {
            "text": "    app.all('/UpdateLocation', handleUnsupportedMethod);",
            "lineNumber": 54
          },
          {
            "text": "    app.all('/GetLocation', handleUnsupportedMethod);",
            "lineNumber": 55
          },
          {
            "text": "    app.all('/GetLocationGeoJSON', handleUnsupportedMethod);",
            "lineNumber": 56
          },
          {
            "text": "    app.all('/GetLocationHistory', handleUnsupportedMethod);",
            "lineNumber": 57
          },
          {
            "text": "    app.all('/DeleteLocation', handleUnsupportedMethod);",
            "lineNumber": 58
          },
          {
            "text": "    app.all('/GetVisitorHistory', handleUnsupportedMethod);",
            "lineNumber": 59
          },
          {
            "text": "    app.all('/setDeviceKey', handleUnsupportedMethod);",
            "lineNumber": 60
          },
          {
            "text": "    app.all('/setAllowedDeviceList', handleUnsupportedMethod);",
            "lineNumber": 61
          },
          {
            "text": "};",
            "lineNumber": 62
          }
        ]
      },
      "score": 0.3624005913734436
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/TECHNICAL_SPECIFICATION.md",
        "range": {
          "startPosition": {
            "line": 74
          },
          "endPosition": {
            "line": 87
          }
        },
        "contents": "- **Key logic**:\n  - **UpdateLocation**: If history enabled, pushes each location into &#96;hist&#96; list and trims; updates &#96;last&#96; on final entry. If history disabled, deletes history list and stores &#96;last&#96; with TTL. (Evidence: lib/routes/location/v1/location.js; config/default.js; tests/integration/api.tests.js)\n  - **GetLocation**: Reads &#96;last&#96; per device and returns null when missing; records visitor history when configured. (Evidence: lib/routes/location/v1/location.js; tests/integration/unknownDevice.tests.js; tests/integration/visitorHistoryFiltering.tests.js)\n  - **GetLocationHistory**: Reads list length, fetches up to requested amount, skips invalid JSON entries, and optionally records visitor history. (Evidence: lib/routes/location/v1/location.js; tests/integration/getLocationHistoryConfig.tests.js)\n  - **GetLocationGeoJSON**: Converts first location into GeoJSON Feature or returns &#96;{}&#96; if missing coordinates. (Evidence: lib/models/ResponseLocationGeoJSON.js; tests/unit/responseLocationGeoJSON.tests.js)\n  - **GetVisitorHistory**: Filters out entries where visitor device equals target device. (Evidence: lib/routes/location/v1/location.js; tests/integration/visitorHistoryFiltering.tests.js)\n  - **DeleteLocation**: Deletes &#96;last&#96;, &#96;hist&#96;, and &#96;visit&#96; keys in parallel and returns deleted key count. (Evidence: lib/routes/location/v1/location.js; docs/DELETE_LOCATION_API.md; tests/integration/deleteLocation.tests.js)\n- **State &amp; lifecycle**: Operates on Redis keys per device ID; location history and visitor history lists are trimmed to configured maxima. (Evidence: lib/routes/location/v1/location.js; config/default.js)\n- **Failure modes**: Redis errors wrap as &#96;InternalServerError&#96;; malformed JSON data yields error responses. (Evidence: lib/routes/location/v1/location.js; lib/errors.js)\n\n### 2.8 Storage adapter (&#96;lib/db.js&#96;)\n- **Responsibility**: Provide Redis client (real or fakeredis) with legacy callbacks, concurrency limits, and error translation. (Evidence: lib/db.js; tests/unit/db.redisCompatibility.tests.js)\n- **Interfaces**: Exposes Redis methods &#96;get&#96;, &#96;set&#96;, &#96;setex&#96;, &#96;lpush&#96;, &#96;ltrim&#96;, &#96;lrange&#96;, &#96;llen&#96;, &#96;del&#96;, etc. (Evidence: lib/db.js)",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- **Key logic**:",
            "lineNumber": 75
          },
          {
            "text": "  - **UpdateLocation**: If history enabled, pushes each location into &#96;hist&#96; list and trims; updates &#96;last&#96; on final entry. If history disabled, deletes history list and stores &#96;last&#96; with TTL. (Evidence: lib/routes/location/v1/location.js; config/default.js; tests/integration/api.tests.js)",
            "lineNumber": 76
          },
          {
            "text": "  - **GetLocation**: Reads &#96;last&#96; per device and returns null when missing; records visitor history when configured. (Evidence: lib/routes/location/v1/location.js; tests/integration/unknownDevice.tests.js; tests/integration/visitorHistoryFiltering.tests.js)",
            "lineNumber": 77
          },
          {
            "text": "  - **GetLocationHistory**: Reads list length, fetches up to requested amount, skips invalid JSON entries, and optionally records visitor history. (Evidence: lib/routes/location/v1/location.js; tests/integration/getLocationHistoryConfig.tests.js)",
            "lineNumber": 78
          },
          {
            "text": "  - **GetLocationGeoJSON**: Converts first location into GeoJSON Feature or returns &#96;{}&#96; if missing coordinates. (Evidence: lib/models/ResponseLocationGeoJSON.js; tests/unit/responseLocationGeoJSON.tests.js)",
            "lineNumber": 79
          },
          {
            "text": "  - **GetVisitorHistory**: Filters out entries where visitor device equals target device. (Evidence: lib/routes/location/v1/location.js; tests/integration/visitorHistoryFiltering.tests.js)",
            "lineNumber": 80
          },
          {
            "text": "  - **DeleteLocation**: Deletes &#96;last&#96;, &#96;hist&#96;, and &#96;visit&#96; keys in parallel and returns deleted key count. (Evidence: lib/routes/location/v1/location.js; docs/DELETE_LOCATION_API.md; tests/integration/deleteLocation.tests.js)",
            "lineNumber": 81
          },
          {
            "text": "- **State &amp; lifecycle**: Operates on Redis keys per device ID; location history and visitor history lists are trimmed to configured maxima. (Evidence: lib/routes/location/v1/location.js; config/default.js)",
            "lineNumber": 82
          },
          {
            "text": "- **Failure modes**: Redis errors wrap as &#96;InternalServerError&#96;; malformed JSON data yields error responses. (Evidence: lib/routes/location/v1/location.js; lib/errors.js)",
            "lineNumber": 83
          },
          {
            "lineNumber": 84
          },
          {
            "text": "### 2.8 Storage adapter (&#96;lib/db.js&#96;)",
            "lineNumber": 85
          },
          {
            "text": "- **Responsibility**: Provide Redis client (real or fakeredis) with legacy callbacks, concurrency limits, and error translation. (Evidence: lib/db.js; tests/unit/db.redisCompatibility.tests.js)",
            "lineNumber": 86
          },
          {
            "text": "- **Interfaces**: Exposes Redis methods &#96;get&#96;, &#96;set&#96;, &#96;setex&#96;, &#96;lpush&#96;, &#96;ltrim&#96;, &#96;lrange&#96;, &#96;llen&#96;, &#96;del&#96;, etc. (Evidence: lib/db.js)",
            "lineNumber": 87
          }
        ]
      },
      "score": 0.3616538941860199
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./tests/integration/deviceKey.tests.js",
        "range": {
          "startPosition": {
            "line": 8
          },
          "endPosition": {
            "line": 295
          }
        },
        "contents": "        });\n\n        it('should return 403 when DeviceKey does not match', function(done) {\n            // Set device key first\n            deviceKeyUtils.setDeviceKey(TEST_DEVICE, TEST_DEVICE_KEY, function(error) {\n                if (error) return done(error);\n\n                var updateData = calls.locationUpdateCall({\n                    locations: {\n                        Device: TEST_DEVICE,\n                        Timestamp: Date.now().toString(),\n                        Longitude: '10.0',\n                        Latitude: '50.0',\n                        HorizontalAccuracy: '5.0',\n                        DeviceKey: 'wrong-key'\n                    }\n                });\n\n                request(app)\n                    .post('/v1/UpdateLocation')\n                    .send(updateData)\n                    .expect(403)\n                    .expect(function(res) {\n                        expect(res.body.error).to.include('DeviceKey');\n                    })\n                    .end(done);\n            });\n        });\n\n        it('should return 403 when DeviceKey is missing but required', function(done) {\n            // Set device key first\n            deviceKeyUtils.setDeviceKey(TEST_DEVICE, TEST_DEVICE_KEY, function(error) {\n                if (error) return done(error);\n\n                var updateData = calls.locationUpdateCall({\n                    locations: calls.location({ device: TEST_DEVICE })\n                    // DeviceKey is missing\n                });\n\n                request(app)\n                    .post('/v1/UpdateLocation')\n                    .send(updateData)\n                    .expect(403)\n                    .expect(function(res) {\n                        expect(res.body.error).to.include('DeviceKey is required');\n                    })\n                    .end(done);\n            });\n        });\n    });\n\n    describe('getVisitorHistory with DeviceKey',",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 9,
                "column": 1
              },
              "endPosition": {
                "line": 9,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 119,
                "column": 5
              },
              "endPosition": {
                "line": 119,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "        });",
            "lineNumber": 160
          },
          {
            "lineNumber": 161
          },
          {
            "text": "        it('should return 403 when DeviceKey does not match', function(done) {",
            "lineNumber": 162
          },
          {
            "text": "            // Set device key first",
            "lineNumber": 163
          },
          {
            "text": "            deviceKeyUtils.setDeviceKey(TEST_DEVICE, TEST_DEVICE_KEY, function(error) {",
            "lineNumber": 164
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 165
          },
          {
            "lineNumber": 166
          },
          {
            "text": "                var updateData = calls.locationUpdateCall({",
            "lineNumber": 167
          },
          {
            "text": "                    locations: {",
            "lineNumber": 168
          },
          {
            "text": "                        Device: TEST_DEVICE,",
            "lineNumber": 169
          },
          {
            "text": "                        Timestamp: Date.now().toString(),",
            "lineNumber": 170
          },
          {
            "text": "                        Longitude: '10.0',",
            "lineNumber": 171
          },
          {
            "text": "                        Latitude: '50.0',",
            "lineNumber": 172
          },
          {
            "text": "                        HorizontalAccuracy: '5.0',",
            "lineNumber": 173
          },
          {
            "text": "                        DeviceKey: 'wrong-key'",
            "lineNumber": 174
          },
          {
            "text": "                    }",
            "lineNumber": 175
          },
          {
            "text": "                });",
            "lineNumber": 176
          },
          {
            "lineNumber": 177
          },
          {
            "text": "                request(app)",
            "lineNumber": 178
          },
          {
            "text": "                    .post('/v1/UpdateLocation')",
            "lineNumber": 179
          },
          {
            "text": "                    .send(updateData)",
            "lineNumber": 180
          },
          {
            "text": "                    .expect(403)",
            "lineNumber": 181
          },
          {
            "text": "                    .expect(function(res) {",
            "lineNumber": 182
          },
          {
            "text": "                        expect(res.body.error).to.include('DeviceKey');",
            "lineNumber": 183
          },
          {
            "text": "                    })",
            "lineNumber": 184
          },
          {
            "text": "                    .end(done);",
            "lineNumber": 185
          },
          {
            "text": "            });",
            "lineNumber": 186
          },
          {
            "text": "        });",
            "lineNumber": 187
          },
          {
            "lineNumber": 188
          },
          {
            "text": "        it('should return 403 when DeviceKey is missing but required', function(done) {",
            "lineNumber": 189
          },
          {
            "text": "            // Set device key first",
            "lineNumber": 190
          },
          {
            "text": "            deviceKeyUtils.setDeviceKey(TEST_DEVICE, TEST_DEVICE_KEY, function(error) {",
            "lineNumber": 191
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 192
          },
          {
            "lineNumber": 193
          },
          {
            "text": "                var updateData = calls.locationUpdateCall({",
            "lineNumber": 194
          },
          {
            "text": "                    locations: calls.location({ device: TEST_DEVICE })",
            "lineNumber": 195
          },
          {
            "text": "                    // DeviceKey is missing",
            "lineNumber": 196
          },
          {
            "text": "                });",
            "lineNumber": 197
          },
          {
            "lineNumber": 198
          },
          {
            "text": "                request(app)",
            "lineNumber": 199
          },
          {
            "text": "                    .post('/v1/UpdateLocation')",
            "lineNumber": 200
          },
          {
            "text": "                    .send(updateData)",
            "lineNumber": 201
          },
          {
            "text": "                    .expect(403)",
            "lineNumber": 202
          },
          {
            "text": "                    .expect(function(res) {",
            "lineNumber": 203
          },
          {
            "text": "                        expect(res.body.error).to.include('DeviceKey is required');",
            "lineNumber": 204
          },
          {
            "text": "                    })",
            "lineNumber": 205
          },
          {
            "text": "                    .end(done);",
            "lineNumber": 206
          },
          {
            "text": "            });",
            "lineNumber": 207
          },
          {
            "text": "        });",
            "lineNumber": 208
          },
          {
            "text": "    });",
            "lineNumber": 209
          },
          {
            "lineNumber": 210
          },
          {
            "text": "    describe('getVisitorHistory with DeviceKey',",
            "lineNumber": 211
          }
        ]
      },
      "score": 0.35701999068260193
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/API_1.1_SECURITY.md",
        "range": {
          "startPosition": {
            "line": 70
          },
          "endPosition": {
            "line": 156,
            "column": 4
          }
        },
        "contents": "- **UpdateLocation** - Writing location data to the server\n- **GetVisitorHistory** - Accessing visitor history information\n\n### Setting a DeviceKey\n\nUse the &#96;/v1/setDeviceKey&#96; endpoint to set or change a device key:\n\n**First-time setup (no existing key):**\n&#96;&#96;&#96;json\n{\n  \"MiataruSetDeviceKey\": {\n    \"DeviceID\": \"your-device-id\",\n    \"CurrentDeviceKey\": null,\n    \"NewDeviceKey\": \"your-secure-key-here\"\n  }\n}\n&#96;&#96;&#96;\n\n**Changing an existing key:**\n&#96;&#96;&#96;json\n{\n  \"MiataruSetDeviceKey\": {\n    \"DeviceID\": \"your-device-id\",\n    \"CurrentDeviceKey\": \"old-key\",\n    \"NewDeviceKey\": \"new-key\"\n  }\n}\n&#96;&#96;&#96;\n\n### Using DeviceKey in UpdateLocation\n\nWhen a DeviceKey is set for a device, it must be included in each &#96;MiataruLocation&#96; element:\n\n&#96;&#96;&#96;json\n{\n  \"MiataruLocation\": [\n    {\n      \"Device\": \"your-device-id\",\n      \"DeviceKey\": \"your-secure-key-here\",\n      \"Timestamp\": \"1376735651302\",\n      \"Longitude\": \"10.837502\",\n      \"Latitude\": \"49.828925\",\n      \"HorizontalAccuracy\": \"50.00\"\n    }\n  ]\n}\n&#96;&#96;&#96;\n\n**Important:** The DeviceKey parameter should be placed right under the Device parameter in the MiataruLocation array element.\n\n### Using DeviceKey in GetVisitorHistory\n\nWhen a DeviceKey is set for a device, it must be included in the request:\n\n&#96;&#96;&#96;json\n{\n  \"MiataruGetVisitorHistory\": {\n    \"Device\": \"your-device-id\",\n    \"Amount\": \"10\",\n    \"DeviceKey\": \"your-secure-key-here\"\n  }\n}\n&#96;&#96;&#96;\n\n### Error Responses\n\n- **403 Forbidden** - Returned when:\n  - DeviceKey is required but not provided\n  - DeviceKey does not match the stored key\n  - CurrentDeviceKey does not match when changing an existing key\n\n## Allowed Devices List\n\nThe allowed devices list controls which devices can access location and location history data for a specific device. This provides granular access control:\n\n- **hasCurrentLocationAccess** - Permission to access current location via GetLocation\n- **hasHistoryAccess** - Permission to access location history via GetLocationHistory\n\n### Setting Allowed Devices List\n\nUse the &#96;/v1/setAllowedDeviceList&#96; endpoint to set or update the allowed devices list:\n\n&#96;&#96;&#96;json\n{\n  \"MiataruSetAllowedDeviceList\": {\n    ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- **UpdateLocation** - Writing location data to the server",
            "lineNumber": 72
          },
          {
            "text": "- **GetVisitorHistory** - Accessing visitor history information",
            "lineNumber": 73
          },
          {
            "lineNumber": 74
          },
          {
            "text": "### Setting a DeviceKey",
            "lineNumber": 75
          },
          {
            "lineNumber": 76
          },
          {
            "text": "Use the &#96;/v1/setDeviceKey&#96; endpoint to set or change a device key:",
            "lineNumber": 77
          },
          {
            "lineNumber": 78
          },
          {
            "text": "**First-time setup (no existing key):**",
            "lineNumber": 79
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 80
          },
          {
            "text": "{",
            "lineNumber": 81
          },
          {
            "text": "  \"MiataruSetDeviceKey\": {",
            "lineNumber": 82
          },
          {
            "text": "    \"DeviceID\": \"your-device-id\",",
            "lineNumber": 83
          },
          {
            "text": "    \"CurrentDeviceKey\": null,",
            "lineNumber": 84
          },
          {
            "text": "    \"NewDeviceKey\": \"your-secure-key-here\"",
            "lineNumber": 85
          },
          {
            "text": "  }",
            "lineNumber": 86
          },
          {
            "text": "}",
            "lineNumber": 87
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 88
          },
          {
            "lineNumber": 89
          },
          {
            "text": "**Changing an existing key:**",
            "lineNumber": 90
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 91
          },
          {
            "text": "{",
            "lineNumber": 92
          },
          {
            "text": "  \"MiataruSetDeviceKey\": {",
            "lineNumber": 93
          },
          {
            "text": "    \"DeviceID\": \"your-device-id\",",
            "lineNumber": 94
          },
          {
            "text": "    \"CurrentDeviceKey\": \"old-key\",",
            "lineNumber": 95
          },
          {
            "text": "    \"NewDeviceKey\": \"new-key\"",
            "lineNumber": 96
          },
          {
            "text": "  }",
            "lineNumber": 97
          },
          {
            "text": "}",
            "lineNumber": 98
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 99
          },
          {
            "lineNumber": 100
          },
          {
            "text": "### Using DeviceKey in UpdateLocation",
            "lineNumber": 101
          },
          {
            "lineNumber": 102
          },
          {
            "text": "When a DeviceKey is set for a device, it must be included in each &#96;MiataruLocation&#96; element:",
            "lineNumber": 103
          },
          {
            "lineNumber": 104
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 105
          },
          {
            "text": "{",
            "lineNumber": 106
          },
          {
            "text": "  \"MiataruLocation\": [",
            "lineNumber": 107
          },
          {
            "text": "    {",
            "lineNumber": 108
          },
          {
            "text": "      \"Device\": \"your-device-id\",",
            "lineNumber": 109
          },
          {
            "text": "      \"DeviceKey\": \"your-secure-key-here\",",
            "lineNumber": 110
          },
          {
            "text": "      \"Timestamp\": \"1376735651302\",",
            "lineNumber": 111
          },
          {
            "text": "      \"Longitude\": \"10.837502\",",
            "lineNumber": 112
          },
          {
            "text": "      \"Latitude\": \"49.828925\",",
            "lineNumber": 113
          },
          {
            "text": "      \"HorizontalAccuracy\": \"50.00\"",
            "lineNumber": 114
          },
          {
            "text": "    }",
            "lineNumber": 115
          },
          {
            "text": "  ]",
            "lineNumber": 116
          },
          {
            "text": "}",
            "lineNumber": 117
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 118
          },
          {
            "lineNumber": 119
          },
          {
            "text": "**Important:** The DeviceKey parameter should be placed right under the Device parameter in the MiataruLocation array element.",
            "lineNumber": 120
          },
          {
            "lineNumber": 121
          },
          {
            "text": "### Using DeviceKey in GetVisitorHistory",
            "lineNumber": 122
          },
          {
            "lineNumber": 123
          },
          {
            "text": "When a DeviceKey is set for a device, it must be included in the request:",
            "lineNumber": 124
          },
          {
            "lineNumber": 125
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 126
          },
          {
            "text": "{",
            "lineNumber": 127
          },
          {
            "text": "  \"MiataruGetVisitorHistory\": {",
            "lineNumber": 128
          },
          {
            "text": "    \"Device\": \"your-device-id\",",
            "lineNumber": 129
          },
          {
            "text": "    \"Amount\": \"10\",",
            "lineNumber": 130
          },
          {
            "text": "    \"DeviceKey\": \"your-secure-key-here\"",
            "lineNumber": 131
          },
          {
            "text": "  }",
            "lineNumber": 132
          },
          {
            "text": "}",
            "lineNumber": 133
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 134
          },
          {
            "lineNumber": 135
          },
          {
            "text": "### Error Responses",
            "lineNumber": 136
          },
          {
            "lineNumber": 137
          },
          {
            "text": "- **403 Forbidden** - Returned when:",
            "lineNumber": 138
          },
          {
            "text": "  - DeviceKey is required but not provided",
            "lineNumber": 139
          },
          {
            "text": "  - DeviceKey does not match the stored key",
            "lineNumber": 140
          },
          {
            "text": "  - CurrentDeviceKey does not match when changing an existing key",
            "lineNumber": 141
          },
          {
            "lineNumber": 142
          },
          {
            "text": "## Allowed Devices List",
            "lineNumber": 143
          },
          {
            "lineNumber": 144
          },
          {
            "text": "The allowed devices list controls which devices can access location and location history data for a specific device. This provides granular access control:",
            "lineNumber": 145
          },
          {
            "lineNumber": 146
          },
          {
            "text": "- **hasCurrentLocationAccess** - Permission to access current location via GetLocation",
            "lineNumber": 147
          },
          {
            "text": "- **hasHistoryAccess** - Permission to access location history via GetLocationHistory",
            "lineNumber": 148
          },
          {
            "lineNumber": 149
          },
          {
            "text": "### Setting Allowed Devices List",
            "lineNumber": 150
          },
          {
            "lineNumber": 151
          },
          {
            "text": "Use the &#96;/v1/setAllowedDeviceList&#96; endpoint to set or update the allowed devices list:",
            "lineNumber": 152
          },
          {
            "lineNumber": 153
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 154
          },
          {
            "text": "{",
            "lineNumber": 155
          },
          {
            "text": "  \"MiataruSetAllowedDeviceList\": {",
            "lineNumber": 156
          },
          {
            "text": "    ",
            "lineNumber": 157
          }
        ]
      },
      "score": 0.35218170285224915
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/WHATS_NEW_V2.md",
        "range": {
          "startPosition": {
            "line": 294
          },
          "endPosition": {
            "line": 368
          }
        },
        "contents": "#### Request Format\n\n&#96;&#96;&#96;json\n{\n  \"MiataruGetLocationHistory\": [\n    {\n      \"Device\": \"target-device-id\",\n      \"RequestMiataruDeviceID\": \"requesting-device-id\"\n    }\n  ]\n}\n&#96;&#96;&#96;\n\n#### Behavior\n\n- **Allowed Devices Enabled**: Only devices with &#96;hasHistoryAccess: true&#96; can access history\n- **Not in List**: Devices not in the list or without history permission receive no history\n- **Allowed Devices Not Enabled**: Default behavior is privacy-first (history not returned by default)\n- **Backward Compatibility**: Existing behavior preserved when no allowed devices list is set\n\n### POST &#96;/v1/GetVisitorHistory&#96;\n\n**New Behavior**: When a DeviceKey is set for a device, the request must include the DeviceKey to retrieve visitor history.\n\n#### Request Format (with DeviceKey)\n\n&#96;&#96;&#96;json\n{\n  \"MiataruGetVisitorHistory\": {\n    \"Device\": \"device-id-here\",\n    \"DeviceKey\": \"your-device-key\"\n  }\n}\n&#96;&#96;&#96;\n\n#### Behavior\n\n- **DeviceKey Set**: DeviceKey must be provided and validated\n- **DeviceKey Not Set**: Works as before (backward compatible)\n- **Invalid DeviceKey**: Returns 403 Forbidden\n\n#### Error Response (403 Forbidden)\n\n&#96;&#96;&#96;json\n{\n  \"error\": \"DeviceKey validation failed for device: device-id-here\"\n}\n&#96;&#96;&#96;\n\n### POST &#96;/v1/GetLocationGeoJSON&#96; and GET &#96;/v1/GetLocationGeoJSON/:id?&#96;\n\n** BREAKING CHANGE**: These endpoints now return **401 Unauthorized** when a DeviceKey is set for any requested device.\n\n#### Behavior\n\n- **DeviceKey Set**: Returns 401 Unauthorized (breaking change)\n- **DeviceKey Not Set**: Works as before (backward compatible)\n\n#### Error Response (401 Unauthorized)\n\n&#96;&#96;&#96;json\n{\n  \"error\": \"GetLocationGeoJSON is not available for devices with DeviceKey authentication enabled\"\n}\n&#96;&#96;&#96;\n\n#### Rationale\n\nGeoJSON endpoints are designed for public or semi-public access. When DeviceKey authentication is enabled, it indicates the device owner wants enhanced security. GeoJSON access is disabled to prevent accidental exposure of location data through these less-secure endpoints.\n\n#### Migration Path\n\nClients using GeoJSON endpoints with DeviceKey-enabled devices should:",
        "signatures": {},
        "detailedLines": [
          {
            "text": "#### Request Format",
            "lineNumber": 296
          },
          {
            "lineNumber": 297
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 298
          },
          {
            "text": "{",
            "lineNumber": 299
          },
          {
            "text": "  \"MiataruGetLocationHistory\": [",
            "lineNumber": 300
          },
          {
            "text": "    {",
            "lineNumber": 301
          },
          {
            "text": "      \"Device\": \"target-device-id\",",
            "lineNumber": 302
          },
          {
            "text": "      \"RequestMiataruDeviceID\": \"requesting-device-id\"",
            "lineNumber": 303
          },
          {
            "text": "    }",
            "lineNumber": 304
          },
          {
            "text": "  ]",
            "lineNumber": 305
          },
          {
            "text": "}",
            "lineNumber": 306
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 307
          },
          {
            "lineNumber": 308
          },
          {
            "text": "#### Behavior",
            "lineNumber": 309
          },
          {
            "lineNumber": 310
          },
          {
            "text": "- **Allowed Devices Enabled**: Only devices with &#96;hasHistoryAccess: true&#96; can access history",
            "lineNumber": 311
          },
          {
            "text": "- **Not in List**: Devices not in the list or without history permission receive no history",
            "lineNumber": 312
          },
          {
            "text": "- **Allowed Devices Not Enabled**: Default behavior is privacy-first (history not returned by default)",
            "lineNumber": 313
          },
          {
            "text": "- **Backward Compatibility**: Existing behavior preserved when no allowed devices list is set",
            "lineNumber": 314
          },
          {
            "lineNumber": 315
          },
          {
            "text": "### POST &#96;/v1/GetVisitorHistory&#96;",
            "lineNumber": 316
          },
          {
            "lineNumber": 317
          },
          {
            "text": "**New Behavior**: When a DeviceKey is set for a device, the request must include the DeviceKey to retrieve visitor history.",
            "lineNumber": 318
          },
          {
            "lineNumber": 319
          },
          {
            "text": "#### Request Format (with DeviceKey)",
            "lineNumber": 320
          },
          {
            "lineNumber": 321
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 322
          },
          {
            "text": "{",
            "lineNumber": 323
          },
          {
            "text": "  \"MiataruGetVisitorHistory\": {",
            "lineNumber": 324
          },
          {
            "text": "    \"Device\": \"device-id-here\",",
            "lineNumber": 325
          },
          {
            "text": "    \"DeviceKey\": \"your-device-key\"",
            "lineNumber": 326
          },
          {
            "text": "  }",
            "lineNumber": 327
          },
          {
            "text": "}",
            "lineNumber": 328
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 329
          },
          {
            "lineNumber": 330
          },
          {
            "text": "#### Behavior",
            "lineNumber": 331
          },
          {
            "lineNumber": 332
          },
          {
            "text": "- **DeviceKey Set**: DeviceKey must be provided and validated",
            "lineNumber": 333
          },
          {
            "text": "- **DeviceKey Not Set**: Works as before (backward compatible)",
            "lineNumber": 334
          },
          {
            "text": "- **Invalid DeviceKey**: Returns 403 Forbidden",
            "lineNumber": 335
          },
          {
            "lineNumber": 336
          },
          {
            "text": "#### Error Response (403 Forbidden)",
            "lineNumber": 337
          },
          {
            "lineNumber": 338
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 339
          },
          {
            "text": "{",
            "lineNumber": 340
          },
          {
            "text": "  \"error\": \"DeviceKey validation failed for device: device-id-here\"",
            "lineNumber": 341
          },
          {
            "text": "}",
            "lineNumber": 342
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 343
          },
          {
            "lineNumber": 344
          },
          {
            "text": "### POST &#96;/v1/GetLocationGeoJSON&#96; and GET &#96;/v1/GetLocationGeoJSON/:id?&#96;",
            "lineNumber": 345
          },
          {
            "lineNumber": 346
          },
          {
            "text": "** BREAKING CHANGE**: These endpoints now return **401 Unauthorized** when a DeviceKey is set for any requested device.",
            "lineNumber": 347
          },
          {
            "lineNumber": 348
          },
          {
            "text": "#### Behavior",
            "lineNumber": 349
          },
          {
            "lineNumber": 350
          },
          {
            "text": "- **DeviceKey Set**: Returns 401 Unauthorized (breaking change)",
            "lineNumber": 351
          },
          {
            "text": "- **DeviceKey Not Set**: Works as before (backward compatible)",
            "lineNumber": 352
          },
          {
            "lineNumber": 353
          },
          {
            "text": "#### Error Response (401 Unauthorized)",
            "lineNumber": 354
          },
          {
            "lineNumber": 355
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 356
          },
          {
            "text": "{",
            "lineNumber": 357
          },
          {
            "text": "  \"error\": \"GetLocationGeoJSON is not available for devices with DeviceKey authentication enabled\"",
            "lineNumber": 358
          },
          {
            "text": "}",
            "lineNumber": 359
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 360
          },
          {
            "lineNumber": 361
          },
          {
            "text": "#### Rationale",
            "lineNumber": 362
          },
          {
            "lineNumber": 363
          },
          {
            "text": "GeoJSON endpoints are designed for public or semi-public access. When DeviceKey authentication is enabled, it indicates the device owner wants enhanced security. GeoJSON access is disabled to prevent accidental exposure of location data through these less-secure endpoints.",
            "lineNumber": 364
          },
          {
            "lineNumber": 365
          },
          {
            "text": "#### Migration Path",
            "lineNumber": 366
          },
          {
            "lineNumber": 367
          },
          {
            "text": "Clients using GeoJSON endpoints with DeviceKey-enabled devices should:",
            "lineNumber": 368
          }
        ]
      },
      "score": 0.3497883081436157
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 508,
            "column": 1
          },
          "endPosition": {
            "line": 581,
            "column": 3
          }
        },
        "contents": "/**\n * GetLocationGeoJSON\n * This is used to get the current location of a device encoded as GeoJSON\n *\n * @param req\n * @param res\n * @param next\n */\nfunction getLocationGeoJSON(req, res, next) {\n    var chain = seq();\n    var response = new models.ResponseLocationGeoJSON();\n\n    // Check if DeviceKey is set for any requested device\n    req.MIATARU.devices.forEach(function(device) {\n        chain.seq(function() {\n            var done = this;\n            var deviceId = device.device();\n\n            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {\n                if (error) {\n                    return done(error);\n                }\n\n                // If DeviceKey is set, return 401 Unauthorized\n                if (storedKey !== null &amp;&amp; storedKey !== undefined) {\n                    return done(new errors.UnauthorizedError('GetLocationGeoJSON is not available when DeviceKey is set'));\n                }\n\n                done();\n            });\n        });\n    });\n\n    req.MIATARU.devices.forEach(function(device) {\n        chain.par(function() {\n            var done = this;\n\n            db.get(kb.build(device.device(), KEY_LAST), function (error, reply) {\n                if(error)  return done(error);\n\n                if (reply != null) {\n                    try {\n                        response.pushLocation(JSON.parse(reply));\n                    } catch (parseError) {\n                        return done(new errors.InternalServerError('Invalid location data format'));\n                    }\n                } else {\n                    response.pushLocation(null);\n                }\n                done();\n            });\n        });\n    });\n\n    chain.seq(function() {\n        res.send(response.data());\n    })\n    .catch(function(error) {\n        if (error instanceof errors.UnauthorizedError) {\n            return next(error);\n        }\n        next(error);\n    });\n}\n\n/**\n * GetLocationGeoJSONGET\n * This is used to get the current location of a device encoded as GeoJSON, but this time as a one-shot request for just one device\n * @param req\n * @param res\n * @param next\n */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 511
          },
          {
            "text": " * GetLocationGeoJSON",
            "lineNumber": 512
          },
          {
            "text": " * This is used to get the current location of a device encoded as GeoJSON",
            "lineNumber": 513
          },
          {
            "text": " *",
            "lineNumber": 514
          },
          {
            "text": " * @param req",
            "lineNumber": 515
          },
          {
            "text": " * @param res",
            "lineNumber": 516
          },
          {
            "text": " * @param next",
            "lineNumber": 517
          },
          {
            "text": " */",
            "lineNumber": 518
          },
          {
            "text": "function getLocationGeoJSON(req, res, next) {",
            "lineNumber": 519,
            "isSignature": true
          },
          {
            "text": "    var chain = seq();",
            "lineNumber": 520
          },
          {
            "text": "    var response = new models.ResponseLocationGeoJSON();",
            "lineNumber": 521
          },
          {
            "lineNumber": 522
          },
          {
            "text": "    // Check if DeviceKey is set for any requested device",
            "lineNumber": 523
          },
          {
            "text": "    req.MIATARU.devices.forEach(function(device) {",
            "lineNumber": 524
          },
          {
            "text": "        chain.seq(function() {",
            "lineNumber": 525
          },
          {
            "text": "            var done = this;",
            "lineNumber": 526
          },
          {
            "text": "            var deviceId = device.device();",
            "lineNumber": 527
          },
          {
            "lineNumber": 528
          },
          {
            "text": "            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {",
            "lineNumber": 529
          },
          {
            "text": "                if (error) {",
            "lineNumber": 530
          },
          {
            "text": "                    return done(error);",
            "lineNumber": 531
          },
          {
            "text": "                }",
            "lineNumber": 532
          },
          {
            "lineNumber": 533
          },
          {
            "text": "                // If DeviceKey is set, return 401 Unauthorized",
            "lineNumber": 534
          },
          {
            "text": "                if (storedKey !== null &amp;&amp; storedKey !== undefined) {",
            "lineNumber": 535
          },
          {
            "text": "                    return done(new errors.UnauthorizedError('GetLocationGeoJSON is not available when DeviceKey is set'));",
            "lineNumber": 536
          },
          {
            "text": "                }",
            "lineNumber": 537
          },
          {
            "lineNumber": 538
          },
          {
            "text": "                done();",
            "lineNumber": 539
          },
          {
            "text": "            });",
            "lineNumber": 540
          },
          {
            "text": "        });",
            "lineNumber": 541
          },
          {
            "text": "    });",
            "lineNumber": 542
          },
          {
            "lineNumber": 543
          },
          {
            "text": "    req.MIATARU.devices.forEach(function(device) {",
            "lineNumber": 544
          },
          {
            "text": "        chain.par(function() {",
            "lineNumber": 545
          },
          {
            "text": "            var done = this;",
            "lineNumber": 546
          },
          {
            "lineNumber": 547
          },
          {
            "text": "            db.get(kb.build(device.device(), KEY_LAST), function (error, reply) {",
            "lineNumber": 548
          },
          {
            "text": "                if(error)  return done(error);",
            "lineNumber": 549
          },
          {
            "lineNumber": 550
          },
          {
            "text": "                if (reply != null) {",
            "lineNumber": 551
          },
          {
            "text": "                    try {",
            "lineNumber": 552
          },
          {
            "text": "                        response.pushLocation(JSON.parse(reply));",
            "lineNumber": 553
          },
          {
            "text": "                    } catch (parseError) {",
            "lineNumber": 554
          },
          {
            "text": "                        return done(new errors.InternalServerError('Invalid location data format'));",
            "lineNumber": 555
          },
          {
            "text": "                    }",
            "lineNumber": 556
          },
          {
            "text": "                } else {",
            "lineNumber": 557
          },
          {
            "text": "                    response.pushLocation(null);",
            "lineNumber": 558
          },
          {
            "text": "                }",
            "lineNumber": 559
          },
          {
            "text": "                done();",
            "lineNumber": 560
          },
          {
            "text": "            });",
            "lineNumber": 561
          },
          {
            "text": "        });",
            "lineNumber": 562
          },
          {
            "text": "    });",
            "lineNumber": 563
          },
          {
            "lineNumber": 564
          },
          {
            "text": "    chain.seq(function() {",
            "lineNumber": 565
          },
          {
            "text": "        res.send(response.data());",
            "lineNumber": 566
          },
          {
            "text": "    })",
            "lineNumber": 567
          },
          {
            "text": "    .catch(function(error) {",
            "lineNumber": 568
          },
          {
            "text": "        if (error instanceof errors.UnauthorizedError) {",
            "lineNumber": 569
          },
          {
            "text": "            return next(error);",
            "lineNumber": 570
          },
          {
            "text": "        }",
            "lineNumber": 571
          },
          {
            "text": "        next(error);",
            "lineNumber": 572
          },
          {
            "text": "    });",
            "lineNumber": 573
          },
          {
            "text": "}",
            "lineNumber": 574,
            "isSignature": true
          },
          {
            "lineNumber": 575
          },
          {
            "text": "/**",
            "lineNumber": 576
          },
          {
            "text": " * GetLocationGeoJSONGET",
            "lineNumber": 577
          },
          {
            "text": " * This is used to get the current location of a device encoded as GeoJSON, but this time as a one-shot request for just one device",
            "lineNumber": 578
          },
          {
            "text": " * @param req",
            "lineNumber": 579
          },
          {
            "text": " * @param res",
            "lineNumber": 580
          },
          {
            "text": " * @param next",
            "lineNumber": 581
          },
          {
            "text": " */",
            "lineNumber": 582
          }
        ]
      },
      "score": 0.3493342399597168
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/WHATS_NEW_V2.md",
        "range": {
          "startPosition": {
            "line": 229
          },
          "endPosition": {
            "line": 300,
            "column": 4
          }
        },
        "contents": "{\n  \"MiataruConfig\": {\n    \"EnableLocationHistory\": \"True\",\n    \"LocationDataRetentionTime\": \"15\"\n  },\n  \"MiataruLocation\": [\n    {\n      \"Device\": \"device-id-here\",\n      \"DeviceKey\": \"your-device-key\",\n      \"Timestamp\": \"1376735651302\",\n      \"Longitude\": \"10.837502\",\n      \"Latitude\": \"49.828925\",\n      \"HorizontalAccuracy\": \"50.00\"\n    }\n  ]\n}\n&#96;&#96;&#96;\n\n#### Behavior\n\n- **DeviceKey Set**: If a DeviceKey exists for the device, it must be provided and validated\n- **DeviceKey Not Set**: If no DeviceKey exists, the endpoint works as before (backward compatible)\n- **Invalid DeviceKey**: Returns 403 Forbidden if provided key doesn't match stored key\n\n#### Error Response (403 Forbidden)\n\n&#96;&#96;&#96;json\n{\n  \"error\": \"DeviceKey validation failed for device: device-id-here\"\n}\n&#96;&#96;&#96;\n\n### POST &#96;/v1/GetLocation&#96;\n\n**New Behavior**: When an allowed devices list is enabled for a device, only devices with &#96;hasCurrentLocationAccess&#96; permission can retrieve the location.\n\n#### Request Format\n\n&#96;&#96;&#96;json\n{\n  \"MiataruGetLocation\": [\n    {\n      \"Device\": \"target-device-id\",\n      \"RequestMiataruDeviceID\": \"requesting-device-id\"\n    }\n  ]\n}\n&#96;&#96;&#96;\n\n#### Behavior\n\n- **Allowed Devices Enabled**: Only devices in the allowed list with &#96;hasCurrentLocationAccess: true&#96; can access location\n- **Not in List**: Devices not in the allowed list receive no location data (as if device doesn't exist)\n- **Allowed Devices Not Enabled**: Works as before - all devices can access location (backward compatible)\n\n#### Privacy Protection\n\nWhen allowed devices list is enabled:\n- Devices not in the list cannot see that the target device exists\n- No error message is returned - location is simply omitted\n- This prevents information leakage about device existence\n\n### POST &#96;/v1/GetLocationHistory&#96;\n\n**New Behavior**: When an allowed devices list is enabled, only devices with &#96;hasHistoryAccess&#96; permission can retrieve location history. **Privacy-first default**: When enabled, history is not returned unless explicitly permitted.\n\n#### Request Format\n\n&#96;&#96;&#96;json\n{\n  \"MiataruGetLocationHistory\": [\n    ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "{",
            "lineNumber": 230
          },
          {
            "text": "  \"MiataruConfig\": {",
            "lineNumber": 231
          },
          {
            "text": "    \"EnableLocationHistory\": \"True\",",
            "lineNumber": 232
          },
          {
            "text": "    \"LocationDataRetentionTime\": \"15\"",
            "lineNumber": 233
          },
          {
            "text": "  },",
            "lineNumber": 234
          },
          {
            "text": "  \"MiataruLocation\": [",
            "lineNumber": 235
          },
          {
            "text": "    {",
            "lineNumber": 236
          },
          {
            "text": "      \"Device\": \"device-id-here\",",
            "lineNumber": 237
          },
          {
            "text": "      \"DeviceKey\": \"your-device-key\",",
            "lineNumber": 238
          },
          {
            "text": "      \"Timestamp\": \"1376735651302\",",
            "lineNumber": 239
          },
          {
            "text": "      \"Longitude\": \"10.837502\",",
            "lineNumber": 240
          },
          {
            "text": "      \"Latitude\": \"49.828925\",",
            "lineNumber": 241
          },
          {
            "text": "      \"HorizontalAccuracy\": \"50.00\"",
            "lineNumber": 242
          },
          {
            "text": "    }",
            "lineNumber": 243
          },
          {
            "text": "  ]",
            "lineNumber": 244
          },
          {
            "text": "}",
            "lineNumber": 245
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 246
          },
          {
            "lineNumber": 247
          },
          {
            "text": "#### Behavior",
            "lineNumber": 248
          },
          {
            "lineNumber": 249
          },
          {
            "text": "- **DeviceKey Set**: If a DeviceKey exists for the device, it must be provided and validated",
            "lineNumber": 250
          },
          {
            "text": "- **DeviceKey Not Set**: If no DeviceKey exists, the endpoint works as before (backward compatible)",
            "lineNumber": 251
          },
          {
            "text": "- **Invalid DeviceKey**: Returns 403 Forbidden if provided key doesn't match stored key",
            "lineNumber": 252
          },
          {
            "lineNumber": 253
          },
          {
            "text": "#### Error Response (403 Forbidden)",
            "lineNumber": 254
          },
          {
            "lineNumber": 255
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 256
          },
          {
            "text": "{",
            "lineNumber": 257
          },
          {
            "text": "  \"error\": \"DeviceKey validation failed for device: device-id-here\"",
            "lineNumber": 258
          },
          {
            "text": "}",
            "lineNumber": 259
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 260
          },
          {
            "lineNumber": 261
          },
          {
            "text": "### POST &#96;/v1/GetLocation&#96;",
            "lineNumber": 262
          },
          {
            "lineNumber": 263
          },
          {
            "text": "**New Behavior**: When an allowed devices list is enabled for a device, only devices with &#96;hasCurrentLocationAccess&#96; permission can retrieve the location.",
            "lineNumber": 264
          },
          {
            "lineNumber": 265
          },
          {
            "text": "#### Request Format",
            "lineNumber": 266
          },
          {
            "lineNumber": 267
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 268
          },
          {
            "text": "{",
            "lineNumber": 269
          },
          {
            "text": "  \"MiataruGetLocation\": [",
            "lineNumber": 270
          },
          {
            "text": "    {",
            "lineNumber": 271
          },
          {
            "text": "      \"Device\": \"target-device-id\",",
            "lineNumber": 272
          },
          {
            "text": "      \"RequestMiataruDeviceID\": \"requesting-device-id\"",
            "lineNumber": 273
          },
          {
            "text": "    }",
            "lineNumber": 274
          },
          {
            "text": "  ]",
            "lineNumber": 275
          },
          {
            "text": "}",
            "lineNumber": 276
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 277
          },
          {
            "lineNumber": 278
          },
          {
            "text": "#### Behavior",
            "lineNumber": 279
          },
          {
            "lineNumber": 280
          },
          {
            "text": "- **Allowed Devices Enabled**: Only devices in the allowed list with &#96;hasCurrentLocationAccess: true&#96; can access location",
            "lineNumber": 281
          },
          {
            "text": "- **Not in List**: Devices not in the allowed list receive no location data (as if device doesn't exist)",
            "lineNumber": 282
          },
          {
            "text": "- **Allowed Devices Not Enabled**: Works as before - all devices can access location (backward compatible)",
            "lineNumber": 283
          },
          {
            "lineNumber": 284
          },
          {
            "text": "#### Privacy Protection",
            "lineNumber": 285
          },
          {
            "lineNumber": 286
          },
          {
            "text": "When allowed devices list is enabled:",
            "lineNumber": 287
          },
          {
            "text": "- Devices not in the list cannot see that the target device exists",
            "lineNumber": 288
          },
          {
            "text": "- No error message is returned - location is simply omitted",
            "lineNumber": 289
          },
          {
            "text": "- This prevents information leakage about device existence",
            "lineNumber": 290
          },
          {
            "lineNumber": 291
          },
          {
            "text": "### POST &#96;/v1/GetLocationHistory&#96;",
            "lineNumber": 292
          },
          {
            "lineNumber": 293
          },
          {
            "text": "**New Behavior**: When an allowed devices list is enabled, only devices with &#96;hasHistoryAccess&#96; permission can retrieve location history. **Privacy-first default**: When enabled, history is not returned unless explicitly permitted.",
            "lineNumber": 294
          },
          {
            "lineNumber": 295
          },
          {
            "text": "#### Request Format",
            "lineNumber": 296
          },
          {
            "lineNumber": 297
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 298
          },
          {
            "text": "{",
            "lineNumber": 299
          },
          {
            "text": "  \"MiataruGetLocationHistory\": [",
            "lineNumber": 300
          },
          {
            "text": "    ",
            "lineNumber": 301
          }
        ]
      },
      "score": 0.3483726382255554
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/INTENT_AND_PROBLEM_RECONSTRUCTION.md",
        "range": {
          "startPosition": {
            "line": 84
          },
          "endPosition": {
            "line": 94
          }
        },
        "contents": "- **Location history list order is newest-first and capped**; the API expects clients to interpret list ordering accordingly. (Evidence: lib/routes/location/v1/location.js L303-L311; tests/integration/newFields.tests.js L218-L239)\n- **Error logging should avoid over-reporting non-errors** (404/405 should not trigger error-level logging). (Evidence: server.js L65-L73; tests/unit/serverErrorHandling.tests.js L15-L52)\n- **Redis key naming and namespacing must remain stable** to allow operational tooling and deletion. (Evidence: lib/utils/keyBuilder.js L1-L9; docs/DELETE_LOCATION_API.md L101-L115)\n- **Backward compatibility requires tolerant parsing (e.g., single-object update requests)** to avoid breaking older clients. (Evidence: lib/routes/location/v1/inputParser.js L48-L56; tests/integration/backwardCompatibility.tests.js L12-L88)\n\n## 8. Open Questions &amp; Reconstruction Assumptions\n- **Missing specification.md**: The request required scanning &#96;specification.md&#96;, but no such file exists in the repository; assumptions here are reconstructed from README, tests, and code. (Evidence: README.md L1-L433; lib/routes/location/v1/location.js L179-L595)\n- **Missing docs/PROJECT_MAP_AND_EVIDENCE_INDEX.md**: The required evidence index document does not exist; this reconstruction uses source, tests, and .specstory history instead. (Evidence: repository tree; README.md L434-L480)\n- **Authentication and authorization scope**: The DeleteLocation doc states no authentication and no device ownership validation, but it is unclear whether other endpoints are intended to remain unauthenticated long-term. (Evidence: docs/DELETE_LOCATION_API.md L155-L160)\n- **Persistence model**: README says everything is in-memory only, yet Redis can be configured as a persistent store; actual persistence expectations in production remain ambiguous. (Evidence: README.md L19-L20; config/default.js L13-L25; lib/db.js L1-L30)",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- **Location history list order is newest-first and capped**; the API expects clients to interpret list ordering accordingly. (Evidence: lib/routes/location/v1/location.js L303-L311; tests/integration/newFields.tests.js L218-L239)",
            "lineNumber": 85
          },
          {
            "text": "- **Error logging should avoid over-reporting non-errors** (404/405 should not trigger error-level logging). (Evidence: server.js L65-L73; tests/unit/serverErrorHandling.tests.js L15-L52)",
            "lineNumber": 86
          },
          {
            "text": "- **Redis key naming and namespacing must remain stable** to allow operational tooling and deletion. (Evidence: lib/utils/keyBuilder.js L1-L9; docs/DELETE_LOCATION_API.md L101-L115)",
            "lineNumber": 87
          },
          {
            "text": "- **Backward compatibility requires tolerant parsing (e.g., single-object update requests)** to avoid breaking older clients. (Evidence: lib/routes/location/v1/inputParser.js L48-L56; tests/integration/backwardCompatibility.tests.js L12-L88)",
            "lineNumber": 88
          },
          {
            "lineNumber": 89
          },
          {
            "text": "## 8. Open Questions &amp; Reconstruction Assumptions",
            "lineNumber": 90
          },
          {
            "text": "- **Missing specification.md**: The request required scanning &#96;specification.md&#96;, but no such file exists in the repository; assumptions here are reconstructed from README, tests, and code. (Evidence: README.md L1-L433; lib/routes/location/v1/location.js L179-L595)",
            "lineNumber": 91
          },
          {
            "text": "- **Missing docs/PROJECT_MAP_AND_EVIDENCE_INDEX.md**: The required evidence index document does not exist; this reconstruction uses source, tests, and .specstory history instead. (Evidence: repository tree; README.md L434-L480)",
            "lineNumber": 92
          },
          {
            "text": "- **Authentication and authorization scope**: The DeleteLocation doc states no authentication and no device ownership validation, but it is unclear whether other endpoints are intended to remain unauthenticated long-term. (Evidence: docs/DELETE_LOCATION_API.md L155-L160)",
            "lineNumber": 93
          },
          {
            "text": "- **Persistence model**: README says everything is in-memory only, yet Redis can be configured as a persistent store; actual persistence expectations in production remain ambiguous. (Evidence: README.md L19-L20; config/default.js L13-L25; lib/db.js L1-L30)",
            "lineNumber": 94
          }
        ]
      },
      "score": 0.3478553891181946
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 573,
            "column": 1
          },
          "endPosition": {
            "line": 646,
            "column": 3
          }
        },
        "contents": "/**\n * GetLocationGeoJSONGET\n * This is used to get the current location of a device encoded as GeoJSON, but this time as a one-shot request for just one device\n * @param req\n * @param res\n * @param next\n */\nfunction getLocationGeoJSONGET(id, res, next) {\n    var chain = seq();\n    var response = new models.ResponseLocationGeoJSON();\n\n    chain.seq(function() {\n        var done = this;\n\n        // Check if DeviceKey is set for this device\n        deviceKeyUtils.getDeviceKey(id, function(error, storedKey) {\n            if (error) {\n                return done(error);\n            }\n\n            // If DeviceKey is set, return 401 Unauthorized\n            if (storedKey !== null &amp;&amp; storedKey !== undefined) {\n                return done(new errors.UnauthorizedError('GetLocationGeoJSON is not available when DeviceKey is set'));\n            }\n\n            done();\n        });\n    });\n\n    chain.par(function() {\n        var done = this;\n\n        db.get(kb.build(id, KEY_LAST), function (error, reply) {\n            if(error)  return done(error);\n\n            if (reply != null) {\n                try {\n                    response.pushLocation(JSON.parse(reply));\n                } catch (parseError) {\n                    return done(new errors.InternalServerError('Invalid location data format'));\n                }\n            } else {\n                response.pushLocation(null);\n            }\n            done();\n        });\n    })\n\n    chain.seq(function() {\n        res.send(response.data());\n    }).catch(function(error) {\n        if (next) {\n            if (error instanceof errors.UnauthorizedError) {\n                return next(error);\n            }\n            return next(error);\n        } else {\n            // Handle error directly if next is not provided (GET route handler)\n            var statusCode = (error &amp;&amp; typeof error.statusCode === 'number') ? error.statusCode : 500;\n            var errorMessage = error &amp;&amp; error.message ? error.message : 'Internal Server Error';\n            res.status(statusCode).json({error: errorMessage});\n        }\n    });\n}\n\n/**\n * GetVisitorHistory\n * Retrieves the complete visitor history\n * @param req\n * @param res\n * @param next\n */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 576
          },
          {
            "text": " * GetLocationGeoJSONGET",
            "lineNumber": 577
          },
          {
            "text": " * This is used to get the current location of a device encoded as GeoJSON, but this time as a one-shot request for just one device",
            "lineNumber": 578
          },
          {
            "text": " * @param req",
            "lineNumber": 579
          },
          {
            "text": " * @param res",
            "lineNumber": 580
          },
          {
            "text": " * @param next",
            "lineNumber": 581
          },
          {
            "text": " */",
            "lineNumber": 582
          },
          {
            "text": "function getLocationGeoJSONGET(id, res, next) {",
            "lineNumber": 583,
            "isSignature": true
          },
          {
            "text": "    var chain = seq();",
            "lineNumber": 584
          },
          {
            "text": "    var response = new models.ResponseLocationGeoJSON();",
            "lineNumber": 585
          },
          {
            "lineNumber": 586
          },
          {
            "text": "    chain.seq(function() {",
            "lineNumber": 587
          },
          {
            "text": "        var done = this;",
            "lineNumber": 588
          },
          {
            "lineNumber": 589
          },
          {
            "text": "        // Check if DeviceKey is set for this device",
            "lineNumber": 590
          },
          {
            "text": "        deviceKeyUtils.getDeviceKey(id, function(error, storedKey) {",
            "lineNumber": 591
          },
          {
            "text": "            if (error) {",
            "lineNumber": 592
          },
          {
            "text": "                return done(error);",
            "lineNumber": 593
          },
          {
            "text": "            }",
            "lineNumber": 594
          },
          {
            "lineNumber": 595
          },
          {
            "text": "            // If DeviceKey is set, return 401 Unauthorized",
            "lineNumber": 596
          },
          {
            "text": "            if (storedKey !== null &amp;&amp; storedKey !== undefined) {",
            "lineNumber": 597
          },
          {
            "text": "                return done(new errors.UnauthorizedError('GetLocationGeoJSON is not available when DeviceKey is set'));",
            "lineNumber": 598
          },
          {
            "text": "            }",
            "lineNumber": 599
          },
          {
            "lineNumber": 600
          },
          {
            "text": "            done();",
            "lineNumber": 601
          },
          {
            "text": "        });",
            "lineNumber": 602
          },
          {
            "text": "    });",
            "lineNumber": 603
          },
          {
            "lineNumber": 604
          },
          {
            "text": "    chain.par(function() {",
            "lineNumber": 605
          },
          {
            "text": "        var done = this;",
            "lineNumber": 606
          },
          {
            "lineNumber": 607
          },
          {
            "text": "        db.get(kb.build(id, KEY_LAST), function (error, reply) {",
            "lineNumber": 608
          },
          {
            "text": "            if(error)  return done(error);",
            "lineNumber": 609
          },
          {
            "lineNumber": 610
          },
          {
            "text": "            if (reply != null) {",
            "lineNumber": 611
          },
          {
            "text": "                try {",
            "lineNumber": 612
          },
          {
            "text": "                    response.pushLocation(JSON.parse(reply));",
            "lineNumber": 613
          },
          {
            "text": "                } catch (parseError) {",
            "lineNumber": 614
          },
          {
            "text": "                    return done(new errors.InternalServerError('Invalid location data format'));",
            "lineNumber": 615
          },
          {
            "text": "                }",
            "lineNumber": 616
          },
          {
            "text": "            } else {",
            "lineNumber": 617
          },
          {
            "text": "                response.pushLocation(null);",
            "lineNumber": 618
          },
          {
            "text": "            }",
            "lineNumber": 619
          },
          {
            "text": "            done();",
            "lineNumber": 620
          },
          {
            "text": "        });",
            "lineNumber": 621
          },
          {
            "text": "    })",
            "lineNumber": 622
          },
          {
            "lineNumber": 623
          },
          {
            "text": "    chain.seq(function() {",
            "lineNumber": 624
          },
          {
            "text": "        res.send(response.data());",
            "lineNumber": 625
          },
          {
            "text": "    }).catch(function(error) {",
            "lineNumber": 626
          },
          {
            "text": "        if (next) {",
            "lineNumber": 627
          },
          {
            "text": "            if (error instanceof errors.UnauthorizedError) {",
            "lineNumber": 628
          },
          {
            "text": "                return next(error);",
            "lineNumber": 629
          },
          {
            "text": "            }",
            "lineNumber": 630
          },
          {
            "text": "            return next(error);",
            "lineNumber": 631
          },
          {
            "text": "        } else {",
            "lineNumber": 632
          },
          {
            "text": "            // Handle error directly if next is not provided (GET route handler)",
            "lineNumber": 633
          },
          {
            "text": "            var statusCode = (error &amp;&amp; typeof error.statusCode === 'number') ? error.statusCode : 500;",
            "lineNumber": 634
          },
          {
            "text": "            var errorMessage = error &amp;&amp; error.message ? error.message : 'Internal Server Error';",
            "lineNumber": 635
          },
          {
            "text": "            res.status(statusCode).json({error: errorMessage});",
            "lineNumber": 636
          },
          {
            "text": "        }",
            "lineNumber": 637
          },
          {
            "text": "    });",
            "lineNumber": 638
          },
          {
            "text": "}",
            "lineNumber": 639,
            "isSignature": true
          },
          {
            "lineNumber": 640
          },
          {
            "text": "/**",
            "lineNumber": 641
          },
          {
            "text": " * GetVisitorHistory",
            "lineNumber": 642
          },
          {
            "text": " * Retrieves the complete visitor history",
            "lineNumber": 643
          },
          {
            "text": " * @param req",
            "lineNumber": 644
          },
          {
            "text": " * @param res",
            "lineNumber": 645
          },
          {
            "text": " * @param next",
            "lineNumber": 646
          },
          {
            "text": " */",
            "lineNumber": 647
          }
        ]
      },
      "score": 0.34692999720573425
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "DeleteLocation",
  "caseInsensitive": true
}
```
Result:

```json
{
  "success": {
    "pattern": "DeleteLocation",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/bietiekay/code/miataru-server": {
        "content": {
          "matches": [
            {
              "file": "./docs/COMPATIBILITY_ASSESSMENT.md",
              "matches": [
                {
                  "lineNumber": 19,
                  "content": "| &#96;/v1/DeleteLocation&#96; | Works as before | Works as before |  Yes |"
                },
                {
                  "lineNumber": 49,
                  "content": "- **None** for UpdateLocation, GetVisitorHistory, DeleteLocation, and other endpoints"
                },
                {
                  "lineNumber": 153,
                  "content": "-  &#96;/v1/DeleteLocation&#96; - Unchanged"
                }
              ]
            },
            {
              "file": "./README.md",
              "matches": [
                {
                  "lineNumber": 45,
                  "content": "- **POST** &#96;/v1/DeleteLocation&#96; - Delete all location data for a device"
                },
                {
                  "lineNumber": 56,
                  "content": "- **POST** &#96;/DeleteLocation&#96; - Delete all location data for a device"
                },
                {
                  "lineNumber": 151,
                  "content": "curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\"
                },
                {
                  "lineNumber": 152,
                  "content": "  -d '{\"MiataruDeleteLocation\":{\"Device\":\"7b8e6e0ee5296db345162dc2ef652c1350761823\"}}'"
                },
                {
                  "lineNumber": 161,
                  "content": "## DeleteLocation API"
                },
                {
                  "lineNumber": 163,
                  "content": "The DeleteLocation API allows you to permanently delete all location data associated with a specific device."
                },
                {
                  "lineNumber": 168,
                  "content": "  \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 191,
                  "content": "curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\"
                },
                {
                  "lineNumber": 192,
                  "content": "  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'"
                },
                {
                  "lineNumber": 530,
                  "content": "- **DeleteLocation Tests**: Data deletion functionality"
                },
                {
                  "lineNumber": 541,
                  "content": "    responseDeleteLocation.tests.js"
                },
                {
                  "lineNumber": 551,
                  "content": "    deleteLocation.tests.js"
                },
                {
                  "lineNumber": 621,
                  "content": "- **DeleteLocation API**: Complete data deletion functionality for devices"
                },
                {
                  "lineNumber": 641,
                  "content": "- **New Endpoints**: &#96;/v1/DeleteLocation&#96; for data management"
                }
              ]
            },
            {
              "file": "./docs/MIGRATION_REQUESTMIATARUDEVICEID.md",
              "matches": [
                {
                  "lineNumber": 38,
                  "content": "- Other endpoints (UpdateLocation, GetVisitorHistory, DeleteLocation) are **not affected**"
                }
              ]
            },
            {
              "file": "./.specstory/history/2026-01-25_12-50Z-miataru-api-v1-1-security-and-access-control.md",
              "matches": [
                {
                  "lineNumber": 168,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 234,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 285,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 796,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 929,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 933,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 937,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 2060,
                  "content": "        \"contents\": \"var location = require('./location');\\n\\nmodule.exports = {\\n    inputParser: inputParser,\\n    updateLocation: location.updateLocation,\\n    getLocation: location.getLocation,\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\n    getLocationHistory: location.getLocationHistory,\\n    getVisitorHistory: location.getVisitorHistory,\\n    deleteLocation: location.deleteLocation\\n};\","
                },
                {
                  "lineNumber": 2103,
                  "content": "            \"text\": \"    deleteLocation: location.deleteLocation\","
                },
                {
                  "lineNumber": 2677,
                  "content": "        \"contents\": \"- **POST** &amp;#96;/v1/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/v1/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n### Legacy API (Backward Compatibility)\\n- **POST** &amp;#96;/UpdateLocation&amp;#96; - Store location data\\n- **POST** &amp;#96;/GetLocation&amp;#96; - Retrieve current location\\n- **POST** &amp;#96;/GetLocationGeoJSON&amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;#96;/GetLocationGeoJSON/:id?&amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;#96;/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n## Run the Server\\n\\nCheck out the repo:  \\n&amp;#96;git clone git@github.com:miataru/miataru-server.git&amp;#96;\\n\\nInstall dependencies:  \\n&amp;#96;npm install&amp;#96;\\n\\nRun the tests:  \\n&amp;#96;npm run test:all&amp;#96; (or  [... omitted end of long line]"
                },
                {
                  "lineNumber": 2689,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 2724,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 2861,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 2865,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}}'\","
                },
                {
                  "lineNumber": 3221,
                  "content": "        \"contents\": \"module.exports = {\\n    updateLocation: updateLocation,\\n    getLocation: getLocation,\\n    getLocationGeoJSON: getLocationGeoJSON,\\n    getLocationGeoJSONGET: getLocationGeoJSONGET,\\n    getLocationHistory: getLocationHistory,\\n    getVisitorHistory: getVisitorHistory,\\n    deleteLocation: deleteLocation\\n};\","
                },
                {
                  "lineNumber": 3253,
                  "content": "            \"text\": \"    deleteLocation: deleteLocation\","
                },
                {
                  "lineNumber": 3274,
                  "content": "        \"contents\": \"# DeleteLocation API Documentation\\n\\n## Overview\\n\\nThe DeleteLocation API endpoint allows you to permanently delete all location data associated with a specific device. This includes:\\n\\n- Current/last known location data\\n- Complete location history\\n- Visitor history data\\n\\n## Endpoints\\n\\n### Version 1 API\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96;\\n\\n### Default API (Legacy)\\n- **POST** &amp;#96;/DeleteLocation&amp;#96;\\n\\n## Request Format\\n\\n### Request Body Structure\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruDeleteLocation\\\": {\\n    \\\"Device\\\": \\\"device-id-here\\\"\\n  }\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### Parameters\\n\\n| Parameter | Type | Required | Description |\\n|-----------|------|----------|-------------|\\n| &amp;#96;MiataruDeleteLocation&amp;#96; | Object | Yes | Container object for delete request |\\n| &amp;#96;Device&amp;#96; | String | Yes | Unique identifier of the device whose location data should be deleted |\\n\\n## Response Format\\n\\n### Success Response\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"Mi [... omitted end of long line]"
                },
                {
                  "lineNumber": 3278,
                  "content": "            \"text\": \"# DeleteLocation API Documentation\","
                },
                {
                  "lineNumber": 3292,
                  "content": "            \"text\": \"The DeleteLocation API endpoint allows you to permanently delete all location data associated with a specific device. This includes:\","
                },
                {
                  "lineNumber": 3325,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96;\","
                },
                {
                  "lineNumber": 3336,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96;\","
                },
                {
                  "lineNumber": 3362,
                  "content": "            \"text\": \"  \\\"MiataruDeleteLocation\\\": {\","
                },
                {
                  "lineNumber": 3400,
                  "content": "            \"text\": \"| &amp;#96;MiataruDeleteLocation&amp;#96; | Object | Yes | Container object for delete request |\","
                },
                {
                  "lineNumber": 3536,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 3540,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"my-device-123\\\"}}'\","
                },
                {
                  "lineNumber": 3559,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 3563,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"my-device-123\\\"}}'\","
                },
                {
                  "lineNumber": 3582,
                  "content": "            \"text\": \"const deleteLocationData = async (deviceId) =&amp;gt; {\","
                },
                {
                  "lineNumber": 3586,
                  "content": "            \"text\": \"  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\","
                },
                {
                  "lineNumber": 4081,
                  "content": "        \"contents\": \"    app.all('/v1/GetLocation', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationGeoJSON', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationHistory', handleUnsupportedMethod);\\n    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\\n    app.all('/UpdateLocation', handleUnsupportedMethod);\\n    app.all('/GetLocation', handleUnsupportedMethod);\\n    app.all('/GetLocationGeoJSON', handleUnsupportedMethod);\\n    app.all('/GetLocationHistory', handleUnsupportedMethod);\\n    app.all('/DeleteLocation', handleUnsupportedMethod);\\n    app.all('/GetVisitorHistory', handleUnsupportedMethod);\\n};\","
                },
                {
                  "lineNumber": 4097,
                  "content": "            \"text\": \"    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\","
                },
                {
                  "lineNumber": 4117,
                  "content": "            \"text\": \"    app.all('/DeleteLocation', handleUnsupportedMethod);\","
                },
                {
                  "lineNumber": 4627,
                  "content": "        \"contents\": \"function getVisitorHistory(req, res, next) {\\n\\n\\n);\\n        })\\n        .seq(function() {\\n\\n            try {\\n                var targetDeviceID = locationRequest.device();\\n                var parsedList = (this.vars.list || []).map(function(value) {\\n                    return JSON.parse(value);\\n                }).filter(function(visitor) {\\n                    // Filter out entries where visitor DeviceID equals the requested deviceID\\n                    return visitor.DeviceID !== targetDeviceID;\\n                });\\n\\n                // Recalculate the filtered list length for the response\\n                var filteredListLength = parsedList.length;\\n\\n                res.send((new models.ResponseVisitorHistory(\\n                    filteredListLength,\\n                    configuration.maximumNumberOfLocationVistors,\\n                    parsedList\\n                )).data());\\n            } catch (parseError) {\\n                next(new errors.Internal [... omitted end of long line]"
                },
                {
                  "lineNumber": 4796,
                  "content": "            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 4836,
                  "content": "        \"contents\": \"function parseGetVisitorHistory(req) {\\n    req.MIATARU.request = new RequestVisitorHistory(req.body['MiataruGetVisitorHistory'] || {});\\n}\\n\\nfunction parseDeleteLocation(req) {\\n    req.MIATARU.request = new RequestDevice(req.body['MiataruDeleteLocation'] || {})\\n}\","
                },
                {
                  "lineNumber": 4857,
                  "content": "            \"text\": \"function parseDeleteLocation(req) {\","
                },
                {
                  "lineNumber": 4862,
                  "content": "            \"text\": \"    req.MIATARU.request = new RequestDevice(req.body['MiataruDeleteLocation'] || {})\","
                },
                {
                  "lineNumber": 4884,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 4950,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 5001,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 5077,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 5210,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 5214,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 5218,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 5288,
                  "content": "        \"contents\": \" function() {\\n        it('should return empty visitor history for unknown device ID', function(done) {\\n            var getVisitorRequest = {\\n                \\\"MiataruGetVisitorHistory\\\": {\\n                    \\\"Device\\\": UNKNOWN_DEVICE_ID,\\n                    \\\"Amount\\\": 10\\n                }\\n            };\\n\\n            request(app)\\n                .post('/v1/GetVisitorHistory')\\n                .send(getVisitorRequest)\\n                .expect(200)\\n                .expect(function(res) {\\n                    expect(res.body.MiataruVisitors).to.be.an('array');\\n                    expect(res.body.MiataruVisitors).to.have.length(0);\\n                    expect(res.body.MiataruServerConfig.AvailableVisitorHistory).to.equal(0);\\n                    expect(res.body.MiataruServerConfig.MaximumNumberOfVisitorHistory).to.be.a('number');\\n                })\\n                .end(done);\\n        });\\n\\n        it('should return empty visitor history for unknown de [... omitted end of long line]"
                },
                {
                  "lineNumber": 5483,
                  "content": "            \"text\": \"    describe('DeleteLocation endpoint',\","
                },
                {
                  "lineNumber": 7079,
                  "content": "        \"contents\": \"var location = require('./location');\\n\\nmodule.exports = {\\n    inputParser: inputParser,\\n    updateLocation: location.updateLocation,\\n    getLocation: location.getLocation,\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\n    getLocationHistory: location.getLocationHistory,\\n    getVisitorHistory: location.getVisitorHistory,\\n    deleteLocation: location.deleteLocation\\n};\","
                },
                {
                  "lineNumber": 7122,
                  "content": "            \"text\": \"    deleteLocation: location.deleteLocation\","
                },
                {
                  "lineNumber": 7312,
                  "content": "        \"contents\": \"- **POST** &amp;#96;/v1/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/v1/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n### Legacy API (Backward Compatibility)\\n- **POST** &amp;#96;/UpdateLocation&amp;#96; - Store location data\\n- **POST** &amp;#96;/GetLocation&amp;#96; - Retrieve current location\\n- **POST** &amp;#96;/GetLocationGeoJSON&amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;#96;/GetLocationGeoJSON/:id?&amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;#96;/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n## Run the Server\\n\\nCheck out the repo:  \\n&amp;#96;git clone git@github.com:miataru/miataru-server.git&amp;#96;\\n\\nInstall dependencies:  \\n&amp;#96;npm install&amp;#96;\\n\\nRun the tests:  \\n&amp;#96;npm run test:all&amp;#96; (or  [... omitted end of long line]"
                },
                {
                  "lineNumber": 7324,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 7359,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 7496,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 7500,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}}'\","
                },
                {
                  "lineNumber": 8425,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 8491,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 8542,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 8618,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 8751,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 8755,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 8759,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 8830,
                  "content": "        \"contents\": \"var location = require('./location');\\n\\nmodule.exports = {\\n    inputParser: inputParser,\\n    updateLocation: location.updateLocation,\\n    getLocation: location.getLocation,\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\n    getLocationHistory: location.getLocationHistory,\\n    getVisitorHistory: location.getVisitorHistory,\\n    deleteLocation: location.deleteLocation\\n};\","
                },
                {
                  "lineNumber": 8873,
                  "content": "            \"text\": \"    deleteLocation: location.deleteLocation\","
                },
                {
                  "lineNumber": 9757,
                  "content": "        \"contents\": \"module.exports = {\\n    updateLocation: updateLocation,\\n    getLocation: getLocation,\\n    getLocationGeoJSON: getLocationGeoJSON,\\n    getLocationGeoJSONGET: getLocationGeoJSONGET,\\n    getLocationHistory: getLocationHistory,\\n    getVisitorHistory: getVisitorHistory,\\n    deleteLocation: deleteLocation\\n};\","
                },
                {
                  "lineNumber": 9789,
                  "content": "            \"text\": \"    deleteLocation: deleteLocation\","
                },
                {
                  "lineNumber": 9813,
                  "content": "        \"contents\": \"    app.all('/v1/GetLocation', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationGeoJSON', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationHistory', handleUnsupportedMethod);\\n    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\\n    app.all('/UpdateLocation', handleUnsupportedMethod);\\n    app.all('/GetLocation', handleUnsupportedMethod);\\n    app.all('/GetLocationGeoJSON', handleUnsupportedMethod);\\n    app.all('/GetLocationHistory', handleUnsupportedMethod);\\n    app.all('/DeleteLocation', handleUnsupportedMethod);\\n    app.all('/GetVisitorHistory', handleUnsupportedMethod);\\n};\","
                },
                {
                  "lineNumber": 9829,
                  "content": "            \"text\": \"    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\","
                },
                {
                  "lineNumber": 9849,
                  "content": "            \"text\": \"    app.all('/DeleteLocation', handleUnsupportedMethod);\","
                },
                {
                  "lineNumber": 9875,
                  "content": "        \"contents\": \"- **POST** &amp;#96;/v1/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/v1/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n### Legacy API (Backward Compatibility)\\n- **POST** &amp;#96;/UpdateLocation&amp;#96; - Store location data\\n- **POST** &amp;#96;/GetLocation&amp;#96; - Retrieve current location\\n- **POST** &amp;#96;/GetLocationGeoJSON&amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;#96;/GetLocationGeoJSON/:id?&amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;#96;/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n## Run the Server\\n\\nCheck out the repo:  \\n&amp;#96;git clone git@github.com:miataru/miataru-server.git&amp;#96;\\n\\nInstall dependencies:  \\n&amp;#96;npm install&amp;#96;\\n\\nRun the tests:  \\n&amp;#96;npm run test:all&amp;#96; (or  [... omitted end of long line]"
                },
                {
                  "lineNumber": 9887,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 9922,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 10059,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 10063,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}}'\","
                },
                {
                  "lineNumber": 10250,
                  "content": "        \"contents\": \"function getLocationHistory(device, amount) {\\n    return {\\n        \\\"MiataruGetLocationHistory\\\": {\\n            \\\"Device\\\": device || \\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\",\\n            \\\"Amount\\\": amount || \\\"25\\\"\\n        }\\n    }\\n}\\n\\nfunction deleteLocation(deviceName) {\\n    return\\n}\","
                },
                {
                  "lineNumber": 10291,
                  "content": "            \"text\": \"function deleteLocation(deviceName) {\","
                },
                {
                  "lineNumber": 11249,
                  "content": "        \"contents\": \"&amp;#96;&amp;#96;&amp;#96;\\n\\n**Get location in GeoJSON format:**\\n&amp;#96;&amp;#96;&amp;#96;bash\\ncurl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/GetLocationGeoJSON' \\\\\\n  -d '{\\\"MiataruGetLocation\\\":[{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}]}'\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## DeleteLocation API\\n\\nThe DeleteLocation API allows you to permanently delete all location data associated with a specific device.\\n\\n### Request Format\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruDeleteLocation\\\": {\\n    \\\"Device\\\": \\\"device-id-here\\\"\\n  }\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### Response Format\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruResponse\\\": \\\"ACK\\\",\\n  \\\"MiataruVerboseResponse\\\": \\\"Location data deleted for device: device-id-here\\\",\\n  \\\"MiataruDeletedCount\\\": 3\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### What Gets Deleted\\n- **Last Known Location**: Current location data\\n- **Location History**: Complete location history (if enabled)\\n- **Visitor History**: Visitor tracking data\\n\\n### Example Usa [... omitted end of long line]"
                },
                {
                  "lineNumber": 11283,
                  "content": "            \"text\": \"## DeleteLocation API\","
                },
                {
                  "lineNumber": 11290,
                  "content": "            \"text\": \"The DeleteLocation API allows you to permanently delete all location data associated with a specific device.\","
                },
                {
                  "lineNumber": 11309,
                  "content": "            \"text\": \"  \\\"MiataruDeleteLocation\\\": {\","
                },
                {
                  "lineNumber": 11398,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 11402,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"my-device-123\\\"}}'\","
                },
                {
                  "lineNumber": 12114,
                  "content": "        \"contents\": \"# DeleteLocation API Documentation\\n\\n## Overview\\n\\nThe DeleteLocation API endpoint allows you to permanently delete all location data associated with a specific device. This includes:\\n\\n- Current/last known location data\\n- Complete location history\\n- Visitor history data\\n\\n## Endpoints\\n\\n### Version 1 API\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96;\\n\\n### Default API (Legacy)\\n- **POST** &amp;#96;/DeleteLocation&amp;#96;\\n\\n## Request Format\\n\\n### Request Body Structure\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruDeleteLocation\\\": {\\n    \\\"Device\\\": \\\"device-id-here\\\"\\n  }\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### Parameters\\n\\n| Parameter | Type | Required | Description |\\n|-----------|------|----------|-------------|\\n| &amp;#96;MiataruDeleteLocation&amp;#96; | Object | Yes | Container object for delete request |\\n| &amp;#96;Device&amp;#96; | String | Yes | Unique identifier of the device whose location data should be deleted |\\n\\n## Response Format\\n\\n### Success Response\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"Mi [... omitted end of long line]"
                },
                {
                  "lineNumber": 12118,
                  "content": "            \"text\": \"# DeleteLocation API Documentation\","
                },
                {
                  "lineNumber": 12132,
                  "content": "            \"text\": \"The DeleteLocation API endpoint allows you to permanently delete all location data associated with a specific device. This includes:\","
                },
                {
                  "lineNumber": 12165,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96;\","
                },
                {
                  "lineNumber": 12176,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96;\","
                },
                {
                  "lineNumber": 12202,
                  "content": "            \"text\": \"  \\\"MiataruDeleteLocation\\\": {\","
                },
                {
                  "lineNumber": 12240,
                  "content": "            \"text\": \"| &amp;#96;MiataruDeleteLocation&amp;#96; | Object | Yes | Container object for delete request |\","
                },
                {
                  "lineNumber": 12376,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 12380,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"my-device-123\\\"}}'\","
                },
                {
                  "lineNumber": 12399,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 12403,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"my-device-123\\\"}}'\","
                },
                {
                  "lineNumber": 12422,
                  "content": "            \"text\": \"const deleteLocationData = async (deviceId) =&amp;gt; {\","
                },
                {
                  "lineNumber": 12426,
                  "content": "            \"text\": \"  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\","
                },
                {
                  "lineNumber": 12523,
                  "content": "        \"contents\": \"- **New field behavior** remains unchanged (default to &amp;#96;-1&amp;#96; when omitted)\\n\\n### Migration Notes\\n\\nExisting clients do not need any changes. The server will:\\n\\n1. Accept requests in the old format without new fields\\n2. Accept requests with &amp;#96;false&amp;#96; values for required properties  \\n3. Continue to validate missing properties and throw appropriate errors\\n4. Handle new fields gracefully when provided\\n\\n## Testing\\n\\nThe Miataru server includes comprehensive test suites covering all functionality:\\n\\n### Test Commands\\n&amp;#96;&amp;#96;&amp;#96;bash\\n# Run all tests\\nnpm run test:all\\n\\n# Run only unit tests\\nnpm test\\n\\n# Run only integration tests\\nnpm run test:integration\\n\\n# Run tests with Makefile (legacy)\\nmake run-all-tests\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### Test Coverage\\n- **Unit Tests**: Model validation, data handling, response generation\\n- **Integration Tests**: Complete API workflow testing\\n- **Backward Compatibility Tests**: Legacy client support verific [... omitted end of long line]"
                },
                {
                  "lineNumber": 12661,
                  "content": "            \"text\": \"- **DeleteLocation Tests**: Data deletion functionality\","
                },
                {
                  "lineNumber": 12700,
                  "content": "            \"text\": \"    responseDeleteLocation.tests.js\","
                },
                {
                  "lineNumber": 12724,
                  "content": "            \"text\": \"    deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 14250,
                  "content": "        \"contents\": \"#### API Enhancements\\n- **New Endpoints**: &amp;#96;/v1/DeleteLocation&amp;#96; for data management\\n- **GeoJSON Support**: Enhanced GeoJSON responses with new fields\\n- **Input Validation**: Robust validation with backward compatibility\\n- **Response Models**: Improved response structures and error handling\\n\\n#### Testing &amp;amp; Quality\\n- **Unit Tests**: 200+ unit tests for all components\\n- **Integration Tests**: 300+ integration tests for API workflows\\n- **Backward Compatibility Tests**: Legacy client support verification\\n- **CORS Tests**: Cross-origin request handling validation\\n- **Error Handling Tests**: Comprehensive error scenario coverage\","
                },
                {
                  "lineNumber": 14258,
                  "content": "            \"text\": \"- **New Endpoints**: &amp;#96;/v1/DeleteLocation&amp;#96; for data management\","
                },
                {
                  "lineNumber": 14766,
                  "content": "        \"contents\": \"- **Express.js**: ^4.18.2 (web framework)\\n- **Redis**: ^4.6.10 (data storage with modern Redis v4+ compatibility)\\n- **FakeRedis**: ^2.0.0 (testing and development)\\n\\n### Additional Dependencies\\n- **CORS**: ^2.8.5 (cross-origin resource sharing)\\n- **Body-Parser**: ^1.20.2 (request parsing)\\n- **Yargs**: ^17.7.2 (command line argument parsing)\\n- **Moment.js**: ^2.29.4 (date/time handling)\\n- **EJS**: ^3.1.9 (template engine)\\n- **Stylus**: ^0.59.0 (CSS preprocessing)\\n\\n### Development Dependencies\\n- **Mocha**: ^10.2.0 (test framework)\\n- **Chai**: ^4.3.10 (assertion library)\\n- **Supertest**: ^7.1.4 (HTTP testing)\\n\\n### Security Updates\\n- **Replaced Optimist**: Critical security vulnerabilities fixed by replacing with Yargs\\n- **Redis v4+ Support**: Updated Redis client for modern Redis versions\\n- **Dependency Updates**: All dependencies updated to latest secure versions\\n\\n## Changelog\\n\\n### Version 1.1.0 (Latest)\\n\\n#### New Features\\n- **DeleteLocation [... omitted end of long line]"
                },
                {
                  "lineNumber": 14872,
                  "content": "            \"text\": \"- **DeleteLocation API**: Complete data deletion functionality for devices\","
                },
                {
                  "lineNumber": 14949,
                  "content": "            \"text\": \"- **New Endpoints**: &amp;#96;/v1/DeleteLocation&amp;#96; for data management\","
                },
                {
                  "lineNumber": 15842,
                  "content": "        \"contents\": \"## Security Considerations\\n\\n- **No Authentication**: The current implementation does not include authentication\\n- **Device ID Validation**: Device IDs are not validated for format or ownership\\n- **Permanent Deletion**: Deleted data cannot be recovered\\n- **No Audit Trail**: Deletion operations are not logged\\n\\n## Integration with Other APIs\\n\\n### Typical Workflow\\n1. **UpdateLocation**: Store location data\\n2. **GetLocation**: Retrieve current location\\n3. **GetLocationHistory**: Retrieve location history\\n4. **DeleteLocation**: Remove all data when no longer needed\\n\\n### Data Lifecycle\\n&amp;#96;&amp;#96;&amp;#96;\\nCreate  Read  Update  Delete\\n                        \\nUpdateLocation  GetLocation  UpdateLocation  DeleteLocation\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## Testing\\n\\nThe DeleteLocation API is thoroughly tested with:\\n\\n- **Unit Tests**: Response model validation\\n- **Integration Tests**: Complete API workflow testing\\n- **Error Handling Tests**: Invalid request sc [... omitted end of long line]"
                },
                {
                  "lineNumber": 15895,
                  "content": "            \"text\": \"4. **DeleteLocation**: Remove all data when no longer needed\","
                },
                {
                  "lineNumber": 15918,
                  "content": "            \"text\": \"UpdateLocation  GetLocation  UpdateLocation  DeleteLocation\","
                },
                {
                  "lineNumber": 15936,
                  "content": "            \"text\": \"The DeleteLocation API is thoroughly tested with:\","
                },
                {
                  "lineNumber": 15992,
                  "content": "            \"text\": \"- **v1 API**: &amp;#96;/v1/DeleteLocation&amp;#96; - Recommended for new implementations\","
                },
                {
                  "lineNumber": 15996,
                  "content": "            \"text\": \"- **Legacy API**: &amp;#96;/DeleteLocation&amp;#96; - Maintained for backward compatibility\","
                },
                {
                  "lineNumber": 17755,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 17888,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 17892,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 17896,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 21579,
                  "content": "      \"path\": \"/Users/bietiekay/code/miataru-server/lib/models/ResponseDeleteLocation.js\","
                },
                {
                  "lineNumber": 28502,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 28696,
                  "content": "    DeleteLocation endpoint"
                },
                {
                  "lineNumber": 28802,
                  "content": "  DeleteLocation"
                },
                {
                  "lineNumber": 28803,
                  "content": "    Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 28813,
                  "content": "       should handle missing MiataruDeleteLocation object"
                },
                {
                  "lineNumber": 29785,
                  "content": "  67) DeleteLocation"
                },
                {
                  "lineNumber": 29786,
                  "content": "       Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 29789,
                  "content": "      at Context.&amp;lt;anonymous&amp;gt; (tests/integration/deleteLocation.tests.js:36:18)"
                },
                {
                  "lineNumber": 29803,
                  "content": "  68) DeleteLocation"
                },
                {
                  "lineNumber": 29804,
                  "content": "       Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 29807,
                  "content": "      at Context.&amp;lt;anonymous&amp;gt; (tests/integration/deleteLocation.tests.js:93:18)"
                },
                {
                  "lineNumber": 29821,
                  "content": "  69) DeleteLocation"
                },
                {
                  "lineNumber": 29825,
                  "content": "      at Context.&amp;lt;anonymous&amp;gt; (tests/integration/deleteLocation.tests.js:239:18)"
                },
                {
                  "lineNumber": 30407,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 30522,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 32969,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n    app.post('/v1/setDeviceKey', v1.inputParser, v1.setDeviceKey);\\n    app.post('/v1/setAllowedDeviceList', v1.inputParser, v1.setAllowed [... omitted end of long line]"
                },
                {
                  "lineNumber": 33035,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 33094,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 33148,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\nvar RequestSetDeviceKey = require('../../../models/RequestSetDeviceKey');\\nvar RequestSetAllowedDeviceList = require('../../../models/RequestSetAllowedDeviceList');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n           [... omitted end of long line]"
                },
                {
                  "lineNumber": 33289,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 33293,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 33297,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 33877,
                  "content": "        \"contents\": \"    ///////////////////////////////////////////\\n    ///// non-Post /////////////////////////\\n    ///////////////////////////////////////////\\n    function handleUnsupportedMethod(req, res, next) {\\n        if (req.method === 'OPTIONS') {\\n            return res.status(204).end();\\n        }\\n\\n        next(new errors.MethodNotSupportedError(req.method, req.path));\\n    }\\n\\n    app.all('/v1/UpdateLocation', handleUnsupportedMethod);\\n    app.all('/v1/GetLocation', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationGeoJSON', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationHistory', handleUnsupportedMethod);\\n    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\\n    app.all('/v1/setDeviceKey', handleUnsupportedMethod);\\n    app.all('/v1/setAllowedDeviceList', handleUnsupportedMethod);\\n    app.all('/UpdateLocation', handleUnsupportedMethod);\\n    app.all('/GetLocation', handleUnsupportedMethod);\\n    app.all('/GetLocationGeoJSON', handleUnsupporte [... omitted end of long line]"
                },
                {
                  "lineNumber": 33939,
                  "content": "            \"text\": \"    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\","
                },
                {
                  "lineNumber": 33967,
                  "content": "            \"text\": \"    app.all('/DeleteLocation', handleUnsupportedMethod);\","
                },
                {
                  "lineNumber": 34159,
                  "content": "        \"contents\": \"- **Key logic**:\\n  - UpdateLocation accepts a single object or array for backward compatibility. (Evidence: lib/routes/location/v1/inputParser.js; tests/integration/backwardCompatibility.tests.js)\\n  - GetLocation/GetGeoJSON expect &amp;#96;MiataruGetLocation&amp;#96; array; otherwise defaults to &amp;#96;[{}]&amp;#96; (which triggers validation errors). (Evidence: lib/routes/location/v1/inputParser.js; tests/integration/updateLocation.tests.js)\\n- **Failure modes**: Invalid requests throw &amp;#96;BadRequestError&amp;#96; and return 400. (Evidence: lib/errors.js; tests/integration/updateLocation.tests.js)\\n\\n### 2.7 Location handler (&amp;#96;lib/routes/location/v1/location.js&amp;#96;)\\n- **Responsibility**: Implement UpdateLocation, GetLocation, GetLocationHistory, GetLocationGeoJSON (POST/GET), GetVisitorHistory, DeleteLocation, and visitor history recording. (Evidence: lib/routes/location/v1/location.js)\\n- **Interfaces**: Exported handler functions called by route registrations. (Evidence: [... omitted end of long line]"
                },
                {
                  "lineNumber": 34186,
                  "content": "            \"text\": \"- **Responsibility**: Implement UpdateLocation, GetLocation, GetLocationHistory, GetLocationGeoJSON (POST/GET), GetVisitorHistory, DeleteLocation, and visitor history recording. (Evidence: lib/routes/location/v1/location.js)\","
                },
                {
                  "lineNumber": 35375,
                  "content": "        \"contents\": \"function getVisitorHistory(req, res, next) {\\n\\nseq(function() {\\n            var done = this;\\n            var vars = done.vars = done.vars || {};\\n            var available = Number(vars.listLength) || 0;\\n            var requested = Number(locationRequest.amount());\\n\\n            if (!isFinite(requested) || requested &amp;lt;= 0) {\\n                vars.list = [];\\n                return done();\\n            }\\n\\n            var toFetch = Math.min(requested, available);\\n\\n            if (toFetch &amp;lt;= 0) {\\n                vars.list = [];\\n                return done();\\n            }\\n\\n            db.lrange(key, 0, toFetch - 1, function(error, list) {\\n                if (error) {\\n                    return done(error);\\n                }\\n\\n                vars.list = list || [];\\n                done();\\n            });\\n        })\\n        .seq(function() {\\n\\n            try {\\n                var targetDeviceID = locationRequest.device();\\n                 [... omitted end of long line]"
                },
                {
                  "lineNumber": 35658,
                  "content": "            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 35918,
                  "content": "        \"contents\": \"- **Key logic**:\\n  - **UpdateLocation**: If history enabled, pushes each location into &amp;#96;hist&amp;#96; list and trims; updates &amp;#96;last&amp;#96; on final entry. If history disabled, deletes history list and stores &amp;#96;last&amp;#96; with TTL. (Evidence: lib/routes/location/v1/location.js; config/default.js; tests/integration/api.tests.js)\\n  - **GetLocation**: Reads &amp;#96;last&amp;#96; per device and returns null when missing; records visitor history when configured. (Evidence: lib/routes/location/v1/location.js; tests/integration/unknownDevice.tests.js; tests/integration/visitorHistoryFiltering.tests.js)\\n  - **GetLocationHistory**: Reads list length, fetches up to requested amount, skips invalid JSON entries, and optionally records visitor history. (Evidence: lib/routes/location/v1/location.js; tests/integration/getLocationHistoryConfig.tests.js)\\n  - **GetLocationGeoJSON**: Converts first location into GeoJSON Feature or returns &amp;#96;{}&amp;#96; if missing coordinates. (Evidenc [... omitted end of long line]"
                },
                {
                  "lineNumber": 35946,
                  "content": "            \"text\": \"  - **DeleteLocation**: Deletes &amp;#96;last&amp;#96;, &amp;#96;hist&amp;#96;, and &amp;#96;visit&amp;#96; keys in parallel and returns deleted key count. (Evidence: lib/routes/location/v1/location.js; docs/DELETE_LOCATION_API.md; tests/integration/deleteLocation.tests.js)\","
                },
                {
                  "lineNumber": 36619,
                  "content": "        \"contents\": \"var location = require('./location');\\n\\nmodule.exports = {\\n    inputParser: inputParser,\\n    updateLocation: location.updateLocation,\\n    getLocation: location.getLocation,\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\n    getLocationHistory: location.getLocationHistory,\\n    getVisitorHistory: location.getVisitorHistory,\\n    deleteLocation: location.deleteLocation,\\n    setDeviceKey: location.setDeviceKey,\\n    setAllowedDeviceList: location.setAllowedDeviceList\\n};\","
                },
                {
                  "lineNumber": 36662,
                  "content": "            \"text\": \"    deleteLocation: location.deleteLocation,\","
                },
                {
                  "lineNumber": 36795,
                  "content": "        \"contents\": \"With it's simple API it allows you to use Miataru to your own needs and practices.\\n\\n## API Endpoints\\n\\nThe Miataru server provides both versioned (v1) and legacy API endpoints for maximum compatibility:\\n\\n### Version 1 API (Recommended)\\n- **POST** &amp;#96;/v1/UpdateLocation&amp;#96; - Store location data\\n- **POST** &amp;#96;/v1/GetLocation&amp;#96; - Retrieve current location\\n- **POST** &amp;#96;/v1/GetLocationGeoJSON&amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;#96;/v1/GetLocationGeoJSON/:id?&amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;#96;/v1/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/v1/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\\n- **POST** &amp;#96;/v1/setDeviceKey&amp;#96; - Set or change device key (API 1.1)\\n- **POST** &amp;#96;/v1/setAllowedDeviceList&amp;#96; - Manage allowed devices list (API 1.1)\\n\\n### Legacy API (Backward Compatibility)\\n- **POST* [... omitted end of long line]"
                },
                {
                  "lineNumber": 36848,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 36891,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 37836,
                  "content": "       should handle missing MiataruDeleteLocation object"
                },
                {
                  "lineNumber": 38106,
                  "content": "    DeleteLocation endpoint"
                },
                {
                  "lineNumber": 38262,
                  "content": "  10) DeleteLocation"
                },
                {
                  "lineNumber": 38263,
                  "content": "       Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 38267,
                  "content": "  11) DeleteLocation"
                },
                {
                  "lineNumber": 38456,
                  "content": "  \"path\": \"/Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 38466,
                  "content": "  \"path\": \"/Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 38472,
                  "content": "      \"uri\": \"tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 38526,
                  "content": "Updating &#96;deleteLocation.tests.js&#96; and &#96;interoperability.tests.js&#96;:"
                },
                {
                  "lineNumber": 38532,
                  "content": "&lt;details&gt;&lt;summary&gt;Tool use: **read_file_v2**  Read file: /Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js&lt;/summary&gt;"
                },
                {
                  "lineNumber": 38540,
                  "content": "&lt;details&gt;&lt;summary&gt;Tool use: **read_file_v2**  Read file: /Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js&lt;/summary&gt;"
                },
                {
                  "lineNumber": 38602,
                  "content": "&lt;details&gt;&lt;summary&gt;Tool use: **edit_file_v2**  Edit file: /Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js&lt;/summary&gt;"
                },
                {
                  "lineNumber": 38612,
                  "content": "&lt;details&gt;&lt;summary&gt;Tool use: **edit_file_v2**  Edit file: /Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js&lt;/summary&gt;"
                },
                {
                  "lineNumber": 38630,
                  "content": "  \"path\": \"/Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 38641,
                  "content": "  \"path\": \"/Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 38647,
                  "content": "      \"uri\": \"tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 38722,
                  "content": "&lt;details&gt;&lt;summary&gt;Tool use: **run_terminal_command_v2**  Run command: cd /Users/bietiekay/code/miataru-server &amp;&amp; NODE_ENV=test npx mocha tests/integration/backwardCompatibility.tests.js tests/integration/deleteLocation.tests.js tests/integration/interoperability.tests.js --reporter spec 2&gt;&amp;1 | tail -10&lt;/summary&gt;"
                },
                {
                  "lineNumber": 38725,
                  "content": "cd /Users/bietiekay/code/miataru-server &amp;&amp; NODE_ENV=test npx mocha tests/integration/backwardCompatibility.tests.js tests/integration/deleteLocation.tests.js tests/integration/interoperability.tests.js --reporter spec 2&gt;&amp;1 | tail -10"
                },
                {
                  "lineNumber": 38746,
                  "content": "Fixing the remaining &#96;getLocationRequest&#96; in &#96;deleteLocation.tests.js&#96;:"
                },
                {
                  "lineNumber": 38752,
                  "content": "&lt;details&gt;&lt;summary&gt;Tool use: **read_file_v2**  Read file: /Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js&lt;/summary&gt;"
                },
                {
                  "lineNumber": 38769,
                  "content": "  \"path\": \"/Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 38781,
                  "content": "  \"path\": \"/Users/bietiekay/code/miataru-server/tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 38787,
                  "content": "      \"uri\": \"tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 38854,
                  "content": "3. **&#96;tests/integration/deleteLocation.tests.js&#96;**:"
                },
                {
                  "lineNumber": 39830,
                  "content": "      \"uri\": \"./tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 39931,
                  "content": "- &#96;tests/integration/deleteLocation.tests.js&#96;: Added &#96;RequestMiataruDeviceID&#96; to &#96;GetLocation&#96; requests"
                }
              ]
            },
            {
              "file": "./tests/testFiles/calls.js",
              "matches": [
                {
                  "lineNumber": 78,
                  "content": "function deleteLocation(deviceName) {"
                },
                {
                  "lineNumber": 80,
                  "content": "        \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 90,
                  "content": "    deleteLocationCall: deleteLocation,"
                }
              ]
            },
            {
              "file": "./tests/integration/unknownDevice.tests.js",
              "matches": [
                {
                  "lineNumber": 224,
                  "content": "    describe('DeleteLocation endpoint', function() {"
                },
                {
                  "lineNumber": 227,
                  "content": "                \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 233,
                  "content": "                .post('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 246,
                  "content": "                \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 252,
                  "content": "                .post('/DeleteLocation')"
                },
                {
                  "lineNumber": 319,
                  "content": "                \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 325,
                  "content": "                .post('/v1/DeleteLocation')"
                }
              ]
            },
            {
              "file": "./tests/integration/deleteLocation.tests.js",
              "matches": [
                {
                  "lineNumber": 7,
                  "content": "describe('DeleteLocation', function() {"
                },
                {
                  "lineNumber": 13,
                  "content": "            \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 19,
                  "content": "            .post('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 26,
                  "content": "    describe('Basic DeleteLocation functionality', function() {"
                },
                {
                  "lineNumber": 42,
                  "content": "                        \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 48,
                  "content": "                        .post('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 63,
                  "content": "                \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 69,
                  "content": "                .post('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 116,
                  "content": "                                \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 122,
                  "content": "                                .post('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 147,
                  "content": "                \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 153,
                  "content": "                .post('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 164,
                  "content": "                \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 170,
                  "content": "                .post('/DeleteLocation')"
                },
                {
                  "lineNumber": 181,
                  "content": "                \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 187,
                  "content": "                .get('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 197,
                  "content": "                \"MiataruDeleteLocation\": {}"
                },
                {
                  "lineNumber": 201,
                  "content": "                .post('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 207,
                  "content": "        it('should handle missing MiataruDeleteLocation object', function(done) {"
                },
                {
                  "lineNumber": 211,
                  "content": "                .post('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 219,
                  "content": "                .post('/v1/DeleteLocation')"
                },
                {
                  "lineNumber": 264,
                  "content": "                                \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 270,
                  "content": "                                .post('/v1/DeleteLocation')"
                }
              ]
            },
            {
              "file": "./lib/routes/location/v1/location.js",
              "matches": [
                {
                  "lineNumber": 750,
                  "content": " * DeleteLocation"
                },
                {
                  "lineNumber": 756,
                  "content": "function deleteLocation(req, res, next) {"
                },
                {
                  "lineNumber": 795,
                  "content": "            res.send((new models.ResponseDeleteLocation(deviceId, deletedCount)).data());"
                },
                {
                  "lineNumber": 939,
                  "content": "    deleteLocation: deleteLocation,"
                }
              ]
            },
            {
              "file": "./lib/routes/location/v1/inputParser.js",
              "matches": [
                {
                  "lineNumber": 37,
                  "content": "            case '/DeleteLocation':"
                },
                {
                  "lineNumber": 38,
                  "content": "            case '/v1/DeleteLocation':"
                },
                {
                  "lineNumber": 39,
                  "content": "                parseDeleteLocation(req);"
                },
                {
                  "lineNumber": 108,
                  "content": "function parseDeleteLocation(req) {"
                },
                {
                  "lineNumber": 109,
                  "content": "    req.MIATARU.request = new RequestDevice(req.body['MiataruDeleteLocation'] || {});"
                }
              ]
            },
            {
              "file": "./lib/routes/location/v1/index.js",
              "matches": [
                {
                  "lineNumber": 12,
                  "content": "    deleteLocation: location.deleteLocation,"
                }
              ]
            },
            {
              "file": "./lib/routes/location/index.js",
              "matches": [
                {
                  "lineNumber": 17,
                  "content": "    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);"
                },
                {
                  "lineNumber": 32,
                  "content": "    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);"
                },
                {
                  "lineNumber": 51,
                  "content": "    app.all('/v1/DeleteLocation', handleUnsupportedMethod);"
                },
                {
                  "lineNumber": 58,
                  "content": "    app.all('/DeleteLocation', handleUnsupportedMethod);"
                }
              ]
            },
            {
              "file": "./docs/TECHNICAL_SPECIFICATION.md",
              "matches": [
                {
                  "lineNumber": 11,
                  "content": "- **Response models**: Response objects format API output for location, history, GeoJSON, visitor history, update ACKs, and delete ACKs. (Evidence: lib/models/ResponseLocation*.js; lib/models/ResponseUpdateLocation.js; lib/models/ResponseDeleteLocation.js; tests/unit/responseLocationGeoJSON.tests.js)"
                },
                {
                  "lineNumber": 73,
                  "content": "- **Responsibility**: Implement UpdateLocation, GetLocation, GetLocationHistory, GetLocationGeoJSON (POST/GET), GetVisitorHistory, DeleteLocation, and visitor history recording. (Evidence: lib/routes/location/v1/location.js)"
                },
                {
                  "lineNumber": 81,
                  "content": "  - **DeleteLocation**: Deletes &#96;last&#96;, &#96;hist&#96;, and &#96;visit&#96; keys in parallel and returns deleted key count. (Evidence: lib/routes/location/v1/location.js; docs/DELETE_LOCATION_API.md; tests/integration/deleteLocation.tests.js)"
                },
                {
                  "lineNumber": 138,
                  "content": "- **ResponseDeleteLocation**: ACK with deleted key count. (Evidence: lib/models/ResponseDeleteLocation.js; tests/integration/deleteLocation.tests.js)"
                },
                {
                  "lineNumber": 199,
                  "content": "### 4.7 DeleteLocation"
                },
                {
                  "lineNumber": 203,
                  "content": "  3. Return &#96;ACK&#96; with count of deleted keys. (Evidence: lib/models/ResponseDeleteLocation.js; docs/DELETE_LOCATION_API.md)"
                },
                {
                  "lineNumber": 204,
                  "content": "- **Alternate paths**: Legacy &#96;/DeleteLocation&#96; behaves like &#96;/v1/DeleteLocation&#96;. (Evidence: lib/routes/location/index.js; tests/integration/deleteLocation.tests.js)"
                },
                {
                  "lineNumber": 205,
                  "content": "- **Error paths**: Missing device yields 400; non-existent device returns ACK with &#96;MiataruDeletedCount: 0&#96;. (Evidence: tests/integration/deleteLocation.tests.js)"
                },
                {
                  "lineNumber": 268,
                  "content": "- **FR-006 DeleteLocation**  DeleteLocation handler and response. (Evidence: lib/routes/location/v1/location.js; lib/models/ResponseDeleteLocation.js; tests/integration/deleteLocation.tests.js; docs/PRD.md)"
                }
              ]
            },
            {
              "file": "./docs/REIMPLEMENTATION_ROADMAP_AND_EVOLUTION.md",
              "matches": [
                {
                  "lineNumber": 67,
                  "content": "- **Goal**: Implement UpdateLocation, GetLocation, GetLocationHistory, and DeleteLocation behavior."
                },
                {
                  "lineNumber": 72,
                  "content": "  - DeleteLocation (last/history/visitor deletion)."
                },
                {
                  "lineNumber": 135,
                  "content": "  - Core integration tests for UpdateLocation/GetLocation/GetLocationHistory/DeleteLocation."
                }
              ]
            },
            {
              "file": "./docs/PRD.md",
              "matches": [
                {
                  "lineNumber": 6,
                  "content": "  - HTTP API endpoints for UpdateLocation, GetLocation, GetLocationHistory, GetLocationGeoJSON (POST + GET variant), GetVisitorHistory, and DeleteLocation. (Evidence: README.md L27-L43; lib/routes/location/index.js L9-L30)"
                },
                {
                  "lineNumber": 39,
                  "content": "  - If a device has no stored location, entry is &#96;null&#96;. (Evidence: lib/routes/location/v1/location.js L380-L388; tests/integration/deleteLocation.tests.js L125-L134)"
                },
                {
                  "lineNumber": 77,
                  "content": "- **Inputs / Triggers**: HTTP POST &#96;/v1/DeleteLocation&#96; or &#96;/DeleteLocation&#96; with &#96;MiataruDeleteLocation.Device&#96;. (Evidence: README.md L90-L124; lib/routes/location/index.js L17-L30; lib/routes/location/v1/inputParser.js L98-L100)"
                },
                {
                  "lineNumber": 78,
                  "content": "- **Outputs / Effects**: Deletes up to three Redis keys and returns deleted count. (Evidence: lib/routes/location/v1/location.js L551-L595; lib/models/ResponseDeleteLocation.js L6-L11)"
                },
                {
                  "lineNumber": 80,
                  "content": "  - Returns ACK and &#96;MiataruDeletedCount&#96; reflecting deleted keys. (Evidence: tests/integration/deleteLocation.tests.js L27-L77)"
                },
                {
                  "lineNumber": 81,
                  "content": "  - Returns ACK with 0 for non-existent device data. (Evidence: tests/integration/deleteLocation.tests.js L61-L77)"
                },
                {
                  "lineNumber": 82,
                  "content": "- **Evidence pointers**: docs/DELETE_LOCATION_API.md L101-L129; tests/integration/deleteLocation.tests.js L7-L138."
                },
                {
                  "lineNumber": 141,
                  "content": "- **Sources**: Client-provided JSON payloads over HTTP (UpdateLocation, GetLocation, History, VisitorHistory, DeleteLocation). (Evidence: README.md L64-L124)"
                },
                {
                  "lineNumber": 167,
                  "content": "- **Data lifecycle**: DeleteLocation removes last/history/visitor keys and returns counts. (Evidence: tests/integration/deleteLocation.tests.js L80-L138)"
                },
                {
                  "lineNumber": 187,
                  "content": "- **FR-006**  tests/integration/deleteLocation.tests.js; docs/DELETE_LOCATION_API.md; lib/routes/location/v1/location.js. (Evidence: tests/integration/deleteLocation.tests.js L7-L138; docs/DELETE_LOCATION_API.md L101-L129; lib/routes/location/v1/location.js L551-L595)"
                }
              ]
            },
            {
              "file": "./docs/INTENT_AND_PROBLEM_RECONSTRUCTION.md",
              "matches": [
                {
                  "lineNumber": 12,
                  "content": "  - Provide data deletion and lifecycle management for devices. (Evidence: README.md L90-L124; docs/DELETE_LOCATION_API.md L1-L129; lib/routes/location/v1/location.js L544-L595; tests/integration/deleteLocation.tests.js L7-L138)"
                },
                {
                  "lineNumber": 20,
                  "content": "- **Client application developers** integrating Miataru APIs (UpdateLocation, GetLocation, GetLocationHistory, GeoJSON, DeleteLocation). (Evidence: README.md L27-L88, L90-L124; lib/routes/location/index.js L9-L30)"
                },
                {
                  "lineNumber": 64,
                  "content": "   - **Description**: Provide a DeleteLocation endpoint to purge current, history, and visitor data."
                },
                {
                  "lineNumber": 66,
                  "content": "   - **Evidence pointers**: lib/routes/location/v1/location.js L544-L595; tests/integration/deleteLocation.tests.js L7-L138."
                },
                {
                  "lineNumber": 77,
                  "content": "9. **DeleteLocation endpoint formalized**  API docs and tests specify deletion of current, history, and visitor data. (Evidence: README.md L90-L124; docs/DELETE_LOCATION_API.md L1-L129; tests/integration/deleteLocation.tests.js L7-L138)"
                },
                {
                  "lineNumber": 93,
                  "content": "- **Authentication and authorization scope**: The DeleteLocation doc states no authentication and no device ownership validation, but it is unclear whether other endpoints are intended to remain unauthenticated long-term. (Evidence: docs/DELETE_LOCATION_API.md L155-L160)"
                }
              ]
            },
            {
              "file": "./docs/DECISION_LOG.md",
              "matches": [
                {
                  "lineNumber": 10,
                  "content": "- **ADR-007**: Add DeleteLocation endpoint to remove last/history/visitor data  **Accepted**. Evidence: README.md; docs/DELETE_LOCATION_API.md; tests/integration/deleteLocation.tests.js."
                },
                {
                  "lineNumber": 87,
                  "content": "### ADR-007: DeleteLocation endpoint for full data removal"
                },
                {
                  "lineNumber": 89,
                  "content": "- **Decision**: Provide &#96;/v1/DeleteLocation&#96; and legacy &#96;/DeleteLocation&#96; to delete last, history, and visitor keys. (Evidence: lib/routes/location/v1/location.js; docs/DELETE_LOCATION_API.md)"
                },
                {
                  "lineNumber": 93,
                  "content": "  - **Positive**: API-level deletion for all data types. (Evidence: tests/integration/deleteLocation.tests.js)"
                },
                {
                  "lineNumber": 96,
                  "content": "- **Evidence pointers**: docs/DELETE_LOCATION_API.md; lib/routes/location/v1/location.js; tests/integration/deleteLocation.tests.js."
                }
              ]
            },
            {
              "file": "./docs/COMPLETENESS_AUDIT.md",
              "matches": [
                {
                  "lineNumber": 24,
                  "content": "| DeleteLocation workflow | FR-006 | &#96;lib/routes/location/v1/location.js&#96;, &#96;docs/DELETE_LOCATION_API.md&#96;, &#96;tests/integration/deleteLocation.tests.js&#96; | Complete | Response fields validated in tests. |"
                }
              ]
            },
            {
              "file": "./docs/WHATS_NEW_V2.md",
              "matches": [
                {
                  "lineNumber": 582,
                  "content": "| DeleteLocation |  Works |  Works |  Works |"
                }
              ]
            },
            {
              "file": "./.specstory/history/2026-01-22_17-05Z-repository-changes-description-and-commit.md",
              "matches": [
                {
                  "lineNumber": 1179,
                  "content": "+        \"contents\": \"- **POST** &amp;amp;#96;/v1/GetLocationHistory&amp;amp;#96; - Retrieve location history\\n- **POST** &amp;amp;#96;/v1/GetVisitorHistory&amp;amp;#96; - Retrieve visitor history\\n- **POST** &amp;amp;#96;/v1/DeleteLocation&amp;amp;#96; - Delete all location data for a device\\n\\n### Legacy API (Backward Compatibility)\\n- **POST** &amp;amp;#96;/UpdateLocation&amp;amp;#96; - Store location data\\n- **POST** &amp;amp;#96;/GetLocation&amp;amp;#96; - Retrieve current location\\n- **POST** &amp;amp;#96;/GetLocationGeoJSON&amp;amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;amp;#96;/GetLocationGeoJSON/:id?&amp;amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;amp;#96;/GetLocationHistory&amp;amp;#96; - Retrieve location history\\n- **POST** &amp;amp;#96;/GetVisitorHistory&amp;amp;#96; - Retrieve visitor history\\n- **POST** &amp;amp;#96;/DeleteLocation&amp;amp;#96; - Delete all location data for a device\\n\\n## Run the Server\\n\\nCheck out the repo:  \\n&amp;amp;#96;git clone git@github.com:miataru/miataru-server.git&amp;amp;#96;\\n\\nInstall de [... omitted end of long line]"
                },
                {
                  "lineNumber": 1191,
                  "content": "+            \"text\": \"- **POST** &amp;amp;#96;/v1/DeleteLocation&amp;amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 1226,
                  "content": "+            \"text\": \"- **POST** &amp;amp;#96;/DeleteLocation&amp;amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 1363,
                  "content": "+            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 1367,
                  "content": "+            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}}'\","
                },
                {
                  "lineNumber": 2848,
                  "content": "+        \"contents\": \"&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;\\n\\n**Get location in GeoJSON format:**\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;bash\\ncurl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/GetLocationGeoJSON' \\\\\\n  -d '{\\\"MiataruGetLocation\\\":[{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}]}'\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;\\n\\n## DeleteLocation API\\n\\nThe DeleteLocation API allows you to permanently delete all location data associated with a specific device.\\n\\n### Request Format\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;json\\n{\\n  \\\"MiataruDeleteLocation\\\": {\\n    \\\"Device\\\": \\\"device-id-here\\\"\\n  }\\n}\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;\\n\\n### Response Format\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;json\\n{\\n  \\\"MiataruResponse\\\": \\\"ACK\\\",\\n  \\\"MiataruVerboseResponse\\\": \\\"Location data deleted for device: device-id-here\\\",\\n  \\\"MiataruDeletedCount\\\": 3\\n}\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;\\n\\n### What Gets Deleted\\n- **Last Known Location**: Current location data\\n- **Location History**: Complete location  [... omitted end of long line]"
                },
                {
                  "lineNumber": 2882,
                  "content": "+            \"text\": \"## DeleteLocation API\","
                },
                {
                  "lineNumber": 2889,
                  "content": "+            \"text\": \"The DeleteLocation API allows you to permanently delete all location data associated with a specific device.\","
                },
                {
                  "lineNumber": 2908,
                  "content": "+            \"text\": \"  \\\"MiataruDeleteLocation\\\": {\","
                },
                {
                  "lineNumber": 2997,
                  "content": "+            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 3001,
                  "content": "+            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"my-device-123\\\"}}'\","
                },
                {
                  "lineNumber": 3544,
                  "content": "+        \"contents\": \" function() {\\n        it('should return empty visitor history for unknown device ID', function(done) {\\n            var getVisitorRequest = {\\n                \\\"MiataruGetVisitorHistory\\\": {\\n                    \\\"Device\\\": UNKNOWN_DEVICE_ID,\\n                    \\\"Amount\\\": 10\\n                }\\n            };\\n\\n            request(app)\\n                .post('/v1/GetVisitorHistory')\\n                .send(getVisitorRequest)\\n                .expect(200)\\n                .expect(function(res) {\\n                    expect(res.body.MiataruVisitors).to.be.an('array');\\n                    expect(res.body.MiataruVisitors).to.have.length(0);\\n                    expect(res.body.MiataruServerConfig.AvailableVisitorHistory).to.equal(0);\\n                    expect(res.body.MiataruServerConfig.MaximumNumberOfVisitorHistory).to.be.a('number');\\n                })\\n                .end(done);\\n        });\\n\\n        it('should return empty visitor history for unknown d [... omitted end of long line]"
                },
                {
                  "lineNumber": 3739,
                  "content": "+            \"text\": \"    describe('DeleteLocation endpoint',\","
                },
                {
                  "lineNumber": 3802,
                  "content": "+        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ///////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 3868,
                  "content": "+            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 3919,
                  "content": "+            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 3995,
                  "content": "+        \"contents\": \"function getVisitorHistory(req, res, next) {\\n\\n\\n);\\n        })\\n        .seq(function() {\\n\\n            try {\\n                var targetDeviceID = locationRequest.device();\\n                var parsedList = (this.vars.list || []).map(function(value) {\\n                    return JSON.parse(value);\\n                }).filter(function(visitor) {\\n                    // Filter out entries where visitor DeviceID equals the requested deviceID\\n                    return visitor.DeviceID !== targetDeviceID;\\n                });\\n\\n                // Recalculate the filtered list length for the response\\n                var filteredListLength = parsedList.length;\\n\\n                res.send((new models.ResponseVisitorHistory(\\n                    filteredListLength,\\n                    configuration.maximumNumberOfLocationVistors,\\n                    parsedList\\n                )).data());\\n            } catch (parseError) {\\n                next(new errors.Interna [... omitted end of long line]"
                },
                {
                  "lineNumber": 4164,
                  "content": "+            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 4286,
                  "content": "+        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case ' [... omitted end of long line]"
                },
                {
                  "lineNumber": 4419,
                  "content": "+            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 4423,
                  "content": "+            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 4427,
                  "content": "+            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 7706,
                  "content": "        \"contents\": \"function getVisitorHistory(req, res, next) {\\n\\n\\n);\\n        })\\n        .seq(function() {\\n\\n            try {\\n                var targetDeviceID = locationRequest.device();\\n                var parsedList = (this.vars.list || []).map(function(value) {\\n                    return JSON.parse(value);\\n                }).filter(function(visitor) {\\n                    // Filter out entries where visitor DeviceID equals the requested deviceID\\n                    return visitor.DeviceID !== targetDeviceID;\\n                });\\n\\n                // Recalculate the filtered list length for the response\\n                var filteredListLength = parsedList.length;\\n\\n                res.send((new models.ResponseVisitorHistory(\\n                    filteredListLength,\\n                    configuration.maximumNumberOfLocationVistors,\\n                    parsedList\\n                )).data());\\n            } catch (parseError) {\\n                next(new errors.Internal [... omitted end of long line]"
                },
                {
                  "lineNumber": 7875,
                  "content": "            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 14415,
                  "content": "        \"contents\": \" function() {\\n        it('should return empty visitor history for unknown device ID', function(done) {\\n            var getVisitorRequest = {\\n                \\\"MiataruGetVisitorHistory\\\": {\\n                    \\\"Device\\\": UNKNOWN_DEVICE_ID,\\n                    \\\"Amount\\\": 10\\n                }\\n            };\\n\\n            request(app)\\n                .post('/v1/GetVisitorHistory')\\n                .send(getVisitorRequest)\\n                .expect(200)\\n                .expect(function(res) {\\n                    expect(res.body.MiataruVisitors).to.be.an('array');\\n                    expect(res.body.MiataruVisitors).to.have.length(0);\\n                    expect(res.body.MiataruServerConfig.AvailableVisitorHistory).to.equal(0);\\n                    expect(res.body.MiataruServerConfig.MaximumNumberOfVisitorHistory).to.be.a('number');\\n                })\\n                .end(done);\\n        });\\n\\n        it('should return empty visitor history for unknown de [... omitted end of long line]"
                },
                {
                  "lineNumber": 14610,
                  "content": "            \"text\": \"    describe('DeleteLocation endpoint',\","
                },
                {
                  "lineNumber": 15270,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 15400,
                  "content": "  DeleteLocation"
                },
                {
                  "lineNumber": 15401,
                  "content": "    Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 15411,
                  "content": "       should handle missing MiataruDeleteLocation object"
                },
                {
                  "lineNumber": 15512,
                  "content": "    DeleteLocation endpoint"
                }
              ]
            },
            {
              "file": "./.specstory/history/2026-01-23_18-02Z-device-history-storage-and-removal-in-redis.md",
              "matches": [
                {
                  "lineNumber": 2545,
                  "content": "        \"contents\": \"### JavaScript Example\\n&amp;#96;&amp;#96;&amp;#96;javascript\\nconst deleteLocationData = async (deviceId) =&amp;gt; {\\n  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\\n    method: 'POST',\\n    headers: {\\n      'Content-Type': 'application/json'\\n    },\\n    body: JSON.stringify({\\n      MiataruDeleteLocation: {\\n        Device: deviceId\\n      }\\n    })\\n  });\\n  \\n  const result = await response.json();\\n  console.log(&amp;#96;Deleted ${result.MiataruDeletedCount} data entries for device ${deviceId}&amp;#96;);\\n  return result;\\n};\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## What Gets Deleted\\n\\nThe DeleteLocation operation removes the following Redis keys for the specified device:\\n\\n1. **Last Known Location**: &amp;#96;miad:{device-id}:last&amp;#96;\\n   - Contains the most recent location data\\n   - May have TTL (time-to-live) if location history is disabled\\n\\n2. **Location History**: &amp;#96;miad:{device-id}:hist&amp;#96;\\n   - Contains the complete location history as a Redis list\\n   - O [... omitted end of long line]"
                },
                {
                  "lineNumber": 2557,
                  "content": "            \"text\": \"const deleteLocationData = async (deviceId) =&amp;gt; {\","
                },
                {
                  "lineNumber": 2561,
                  "content": "            \"text\": \"  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\","
                },
                {
                  "lineNumber": 2585,
                  "content": "            \"text\": \"      MiataruDeleteLocation: {\","
                },
                {
                  "lineNumber": 2639,
                  "content": "            \"text\": \"The DeleteLocation operation removes the following Redis keys for the specified device:\","
                },
                {
                  "lineNumber": 2861,
                  "content": "        \"contents\": \"/**\\n * DeleteLocation\\n * Deletes all location data (current and historical) for a device\\n * @param req\\n * @param res\\n * @param next\\n */\\nfunction deleteLocation(req, res, next) {\\n    var locationRequest = req.MIATARU.request;\\n    var deviceId = locationRequest.device();\\n    \\n    var lastKey = kb.build(deviceId, KEY_LAST);\\n    var historyKey = kb.build(deviceId, KEY_HISTORY);\\n    var visitKey = kb.build(deviceId, KEY_VISIT);\\n    \\n    var deletedCount = 0;\\n\\n    seq()\\n        // Delete last known location\\n        .par(function() {\\n            var done = this;\\n            db.del(lastKey, function(error, reply) {\\n                if (error) return done(error);\\n                if (reply &amp;gt; 0) deletedCount++;\\n                done();\\n            });\\n        })\\n        // Delete location history\\n        .par(function() {\\n            var done = this;\\n            db.del(historyKey, function(error, reply) {\\n                if (error) return done( [... omitted end of long line]"
                },
                {
                  "lineNumber": 2869,
                  "content": "            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 2893,
                  "content": "            \"text\": \"function deleteLocation(req, res, next) {\","
                },
                {
                  "lineNumber": 3049,
                  "content": "            \"text\": \"            res.send((new models.ResponseDeleteLocation(deviceId, deletedCount)).data());\","
                },
                {
                  "lineNumber": 5140,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"### JavaScript Example\\\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;javascript\\\\nconst deleteLocationData = async (deviceId) =&amp;amp;gt; {\\\\n  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\\\\n    method: 'POST',\\\\n    headers: {\\\\n      'Content-Type': 'application/json'\\\\n    },\\\\n    body: JSON.stringify({\\\\n      MiataruDeleteLocation: {\\\\n        Device: deviceId\\\\n      }\\\\n    })\\\\n  });\\\\n  \\\\n  const result = await response.json();\\\\n  console.log(&amp;amp;#96;Deleted ${result.MiataruDeletedCount} data entries for device ${deviceId}&amp;amp;#96;);\\\\n  return result;\\\\n};\\\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;\\\\n\\\\n## What Gets Deleted\\\\n\\\\nThe DeleteLocation operation removes the following Redis keys for the specified device:\\\\n\\\\n1. **Last Known Location**: &amp;amp;#96;miad:{device-id}:last&amp;amp;#96;\\\\n   - Contains the most recent location data\\\\n   - May have TTL (time-to-live) if location history is disabled\\\\n\\\\n2. **Location Histo [... omitted end of long line]"
                },
                {
                  "lineNumber": 5144,
                  "content": "                  \"content\": \"            \\\"text\\\": \\\"The DeleteLocation operation removes the following Redis keys for the specified device:\\\",\""
                },
                {
                  "lineNumber": 5706,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"- **Backward Compatibility**: Full support for legacy clients\\\\n\\\\n#### Technical Updates\\\\n- **Express.js 4.18.2**: Updated web framework\\\\n- **Redis 4.6.10**: Modern Redis client with compatibility layer\\\\n- **Yargs 17.7.2**: Secure command-line argument parsing\\\\n- **Comprehensive CORS**: Origin validation, credentials support, preflight handling\\\\n\\\\n#### API Enhancements\\\\n- **New Endpoints**: &amp;amp;#96;/v1/DeleteLocation&amp;amp;#96; for data management\\\\n- **GeoJSON Support**: Enhanced GeoJSON responses with new fields\\\\n- **Input Validation**: Robust validation with backward compatibility\\\\n- **Response Models**: Improved response structures and error handling\\\\n\\\\n#### Testing &amp;amp;amp; Quality\\\\n- **Unit Tests**: 200+ unit tests for all components\\\\n- **Integration Tests**: 300+ integration tests for API workflows\\\\n- **Backward Compatibility Tests**: Legacy client support verification\\\\n- **CORS Tests**: Cross-origin request h [... omitted end of long line]"
                },
                {
                  "lineNumber": 5734,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"    cors.tests.js\\\\n    deleteLocation.tests.js\\\\n    newFields.tests.js\\\\n    unknownDevice.tests.js\\\\n testFiles/              # Test utilities and mock data\\\\n     calls.js\\\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;\\\\n\\\\n## Dependencies\\\\n\\\\n### Core Dependencies\\\\n- **Node.js**: &amp;amp;gt;= 18.0.0 (modernized for current LTS)\\\\n- **Express.js**: ^4.18.2 (web framework)\\\\n- **Redis**: ^4.6.10 (data storage with modern Redis v4+ compatibility)\\\\n- **FakeRedis**: ^2.0.0 (testing and development)\\\\n\\\\n### Additional Dependencies\\\\n- **CORS**: ^2.8.5 (cross-origin resource sharing)\\\\n- **Body-Parser**: ^1.20.2 (request parsing)\\\\n- **Yargs**: ^17.7.2 (command line argument parsing)\\\\n- **Moment.js**: ^2.29.4 (date/time handling)\\\\n- **EJS**: ^3.1.9 (template engine)\\\\n- **Stylus**: ^0.59.0 (CSS preprocessing)\\\\n\\\\n### Development Dependencies\\\\n- **Mocha**: ^10.2.0 (test framework)\\\\n- **Chai**: ^4.3.10 (assertion library)\\\\n- [... omitted end of long line]"
                },
                {
                  "lineNumber": 5786,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"- **Backward Compatibility**: Full support for legacy clients\\\\n\\\\n#### Technical Updates\\\\n- **Express.js 4.18.2**: Updated web framework\\\\n- **Redis 4.6.10**: Modern Redis client with compatibility layer\\\\n- **Yargs 17.7.2**: Secure command-line argument parsing\\\\n- **Comprehensive CORS**: Origin validation, credentials support, preflight handling\\\\n\\\\n#### API Enhancements\\\\n- **New Endpoints**: &amp;amp;#96;/v1/DeleteLocation&amp;amp;#96; for data management\\\\n- **GeoJSON Support**: Enhanced GeoJSON responses with new fields\\\\n- **Input Validation**: Robust validation with backward compatibility\\\\n- **Response Models**: Improved response structures and error handling\\\\n\\\\n#### Testing &amp;amp;amp; Quality\\\\n- **Unit Tests**: 200+ unit tests for all components\\\\n- **Integration Tests**: 300+ integration tests for API workflows\\\\n- **Backward Compatibility Tests**: Legacy client support verification\\\\n- **CORS Tests**: Cross-origin request h [... omitted end of long line]"
                },
                {
                  "lineNumber": 5838,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"    cors.tests.js\\\\n    deleteLocation.tests.js\\\\n    newFields.tests.js\\\\n    unknownDevice.tests.js\\\\n testFiles/              # Test utilities and mock data\\\\n     calls.js\\\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;\\\\n\\\\n## Dependencies\\\\n\\\\n### Core Dependencies\\\\n- **Node.js**: &amp;amp;gt;= 18.0.0 (modernized for current LTS)\\\\n- **Express.js**: ^4.18.2 (web framework)\\\\n- **Redis**: ^4.6.10 (data storage with modern Redis v4+ compatibility)\\\\n- **FakeRedis**: ^2.0.0 (testing and development)\\\\n\\\\n### Additional Dependencies\\\\n- **CORS**: ^2.8.5 (cross-origin resource sharing)\\\\n- **Body-Parser**: ^1.20.2 (request parsing)\\\\n- **Yargs**: ^17.7.2 (command line argument parsing)\\\\n- **Moment.js**: ^2.29.4 (date/time handling)\\\\n- **EJS**: ^3.1.9 (template engine)\\\\n- **Stylus**: ^0.59.0 (CSS preprocessing)\\\\n\\\\n### Development Dependencies\\\\n- **Mocha**: ^10.2.0 (test framework)\\\\n- **Chai**: ^4.3.10 (assertion library)\\\\n- [... omitted end of long line]"
                },
                {
                  "lineNumber": 6030,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"    cors.tests.js\\\\n    deleteLocation.tests.js\\\\n    newFields.tests.js\\\\n    unknownDevice.tests.js\\\\n testFiles/              # Test utilities and mock data\\\\n     calls.js\\\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;\\\\n\\\\n## Dependencies\\\\n\\\\n### Core Dependencies\\\\n- **Node.js**: &amp;amp;gt;= 18.0.0 (modernized for current LTS)\\\\n- **Express.js**: ^4.18.2 (web framework)\\\\n- **Redis**: ^4.6.10 (data storage with modern Redis v4+ compatibility)\\\\n- **FakeRedis**: ^2.0.0 (testing and development)\\\\n\\\\n### Additional Dependencies\\\\n- **CORS**: ^2.8.5 (cross-origin resource sharing)\\\\n- **Body-Parser**: ^1.20.2 (request parsing)\\\\n- **Yargs**: ^17.7.2 (command line argument parsing)\\\\n- **Moment.js**: ^2.29.4 (date/time handling)\\\\n- **EJS**: ^3.1.9 (template engine)\\\\n- **Stylus**: ^0.59.0 (CSS preprocessing)\\\\n\\\\n### Development Dependencies\\\\n- **Mocha**: ^10.2.0 (test framework)\\\\n- **Chai**: ^4.3.10 (assertion library)\\\\n- [... omitted end of long line]"
                },
                {
                  "lineNumber": 6114,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"    cors.tests.js\\\\n    deleteLocation.tests.js\\\\n    newFields.tests.js\\\\n    unknownDevice.tests.js\\\\n testFiles/              # Test utilities and mock data\\\\n     calls.js\\\\n&amp;amp;#96;&amp;amp;#96;&amp;amp;#96;\\\\n\\\\n## Dependencies\\\\n\\\\n### Core Dependencies\\\\n- **Node.js**: &amp;amp;gt;= 18.0.0 (modernized for current LTS)\\\\n- **Express.js**: ^4.18.2 (web framework)\\\\n- **Redis**: ^4.6.10 (data storage with modern Redis v4+ compatibility)\\\\n- **FakeRedis**: ^2.0.0 (testing and development)\\\\n\\\\n### Additional Dependencies\\\\n- **CORS**: ^2.8.5 (cross-origin resource sharing)\\\\n- **Body-Parser**: ^1.20.2 (request parsing)\\\\n- **Yargs**: ^17.7.2 (command line argument parsing)\\\\n- **Moment.js**: ^2.29.4 (date/time handling)\\\\n- **EJS**: ^3.1.9 (template engine)\\\\n- **Stylus**: ^0.59.0 (CSS preprocessing)\\\\n\\\\n### Development Dependencies\\\\n- **Mocha**: ^10.2.0 (test framework)\\\\n- **Chai**: ^4.3.10 (assertion library)\\\\n- [... omitted end of long line]"
                },
                {
                  "lineNumber": 6760,
                  "content": "                  \"content\": \"The DeleteLocation operation removes the following Redis keys for the specified device:\""
                },
                {
                  "lineNumber": 8153,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 8219,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 8270,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 8621,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 8754,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 8758,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 8762,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 9040,
                  "content": "        \"contents\": \"function getVisitorHistory(req, res, next) {\\n\\n\\n);\\n        })\\n        .seq(function() {\\n\\n            try {\\n                var targetDeviceID = locationRequest.device();\\n                var parsedList = (this.vars.list || []).map(function(value) {\\n                    return JSON.parse(value);\\n                }).filter(function(visitor) {\\n                    // Filter out entries where visitor DeviceID equals the requested deviceID\\n                    return visitor.DeviceID !== targetDeviceID;\\n                });\\n\\n                // Recalculate the filtered list length for the response\\n                var filteredListLength = parsedList.length;\\n\\n                res.send((new models.ResponseVisitorHistory(\\n                    filteredListLength,\\n                    configuration.maximumNumberOfLocationVistors,\\n                    parsedList\\n                )).data());\\n            } catch (parseError) {\\n                next(new errors.Internal [... omitted end of long line]"
                },
                {
                  "lineNumber": 9209,
                  "content": "            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 9507,
                  "content": "        \"contents\": \"### JavaScript Example\\n&amp;#96;&amp;#96;&amp;#96;javascript\\nconst deleteLocationData = async (deviceId) =&amp;gt; {\\n  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\\n    method: 'POST',\\n    headers: {\\n      'Content-Type': 'application/json'\\n    },\\n    body: JSON.stringify({\\n      MiataruDeleteLocation: {\\n        Device: deviceId\\n      }\\n    })\\n  });\\n  \\n  const result = await response.json();\\n  console.log(&amp;#96;Deleted ${result.MiataruDeletedCount} data entries for device ${deviceId}&amp;#96;);\\n  return result;\\n};\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## What Gets Deleted\\n\\nThe DeleteLocation operation removes the following Redis keys for the specified device:\\n\\n1. **Last Known Location**: &amp;#96;miad:{device-id}:last&amp;#96;\\n   - Contains the most recent location data\\n   - May have TTL (time-to-live) if location history is disabled\\n\\n2. **Location History**: &amp;#96;miad:{device-id}:hist&amp;#96;\\n   - Contains the complete location history as a Redis list\\n   - O [... omitted end of long line]"
                },
                {
                  "lineNumber": 9519,
                  "content": "            \"text\": \"const deleteLocationData = async (deviceId) =&amp;gt; {\","
                },
                {
                  "lineNumber": 9523,
                  "content": "            \"text\": \"  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\","
                },
                {
                  "lineNumber": 9547,
                  "content": "            \"text\": \"      MiataruDeleteLocation: {\","
                },
                {
                  "lineNumber": 9601,
                  "content": "            \"text\": \"The DeleteLocation operation removes the following Redis keys for the specified device:\","
                },
                {
                  "lineNumber": 10960,
                  "content": "        \"contents\": \"var location = require('./location');\\n\\nmodule.exports = {\\n    inputParser: inputParser,\\n    updateLocation: location.updateLocation,\\n    getLocation: location.getLocation,\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\n    getLocationHistory: location.getLocationHistory,\\n    getVisitorHistory: location.getVisitorHistory,\\n    deleteLocation: location.deleteLocation\\n};\","
                },
                {
                  "lineNumber": 11003,
                  "content": "            \"text\": \"    deleteLocation: location.deleteLocation\","
                },
                {
                  "lineNumber": 11027,
                  "content": "        \"contents\": \"/**\\n * DeleteLocation\\n * Deletes all location data (current and historical) for a device\\n * @param req\\n * @param res\\n * @param next\\n */\\nfunction deleteLocation(req, res, next) {\\n    var locationRequest = req.MIATARU.request;\\n    var deviceId = locationRequest.device();\\n    \\n    var lastKey = kb.build(deviceId, KEY_LAST);\\n    var historyKey = kb.build(deviceId, KEY_HISTORY);\\n    var visitKey = kb.build(deviceId, KEY_VISIT);\\n    \\n    var deletedCount = 0;\\n\\n    seq()\\n        // Delete last known location\\n        .par(function() {\\n            var done = this;\\n            db.del(lastKey, function(error, reply) {\\n                if (error) return done(error);\\n                if (reply &amp;gt; 0) deletedCount++;\\n                done();\\n            });\\n        })\\n        // Delete location history\\n        .par(function() {\\n            var done = this;\\n            db.del(historyKey, function(error, reply) {\\n                if (error) return done( [... omitted end of long line]"
                },
                {
                  "lineNumber": 11035,
                  "content": "            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 11059,
                  "content": "            \"text\": \"function deleteLocation(req, res, next) {\","
                },
                {
                  "lineNumber": 11215,
                  "content": "            \"text\": \"            res.send((new models.ResponseDeleteLocation(deviceId, deletedCount)).data());\","
                },
                {
                  "lineNumber": 11268,
                  "content": "        \"contents\": \"- **POST** &amp;#96;/v1/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/v1/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n### Legacy API (Backward Compatibility)\\n- **POST** &amp;#96;/UpdateLocation&amp;#96; - Store location data\\n- **POST** &amp;#96;/GetLocation&amp;#96; - Retrieve current location\\n- **POST** &amp;#96;/GetLocationGeoJSON&amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;#96;/GetLocationGeoJSON/:id?&amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;#96;/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n## Run the Server\\n\\nCheck out the repo:  \\n&amp;#96;git clone git@github.com:miataru/miataru-server.git&amp;#96;\\n\\nInstall dependencies:  \\n&amp;#96;npm install&amp;#96;\\n\\nRun the tests:  \\n&amp;#96;npm run test:all&amp;#96; (or  [... omitted end of long line]"
                },
                {
                  "lineNumber": 11280,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 11315,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 11452,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 11456,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}}'\","
                }
              ]
            },
            {
              "file": "./.specstory/history/2026-01-22_13-59Z-visitor-history-recording-configuration.md",
              "matches": [
                {
                  "lineNumber": 1203,
                  "content": "        \"contents\": \"function getVisitorHistory(req, res, next) {\\n\\n\\n);\\n        })\\n        .seq(function() {\\n\\n            try {\\n                var targetDeviceID = locationRequest.device();\\n                var parsedList = (this.vars.list || []).map(function(value) {\\n                    return JSON.parse(value);\\n                }).filter(function(visitor) {\\n                    // Filter out entries where visitor DeviceID equals the requested deviceID\\n                    return visitor.DeviceID !== targetDeviceID;\\n                });\\n\\n                // Recalculate the filtered list length for the response\\n                var filteredListLength = parsedList.length;\\n\\n                res.send((new models.ResponseVisitorHistory(\\n                    filteredListLength,\\n                    configuration.maximumNumberOfLocationVistors,\\n                    parsedList\\n                )).data());\\n            } catch (parseError) {\\n                next(new errors.Internal [... omitted end of long line]"
                },
                {
                  "lineNumber": 1372,
                  "content": "            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 1412,
                  "content": "        \"contents\": \"/**\\n * DeleteLocation\\n * Deletes all location data (current and historical) for a device\\n * @param req\\n * @param res\\n * @param next\\n */\\nfunction deleteLocation(req, res, next) {\\n    var locationRequest = req.MIATARU.request;\\n    var deviceId = locationRequest.device();\\n    \\n    var lastKey = kb.build(deviceId, KEY_LAST);\\n    var historyKey = kb.build(deviceId, KEY_HISTORY);\\n    var visitKey = kb.build(deviceId, KEY_VISIT);\\n    \\n    var deletedCount = 0;\\n\\n    seq()\\n        // Delete last known location\\n        .par(function() {\\n            var done = this;\\n            db.del(lastKey, function(error, reply) {\\n                if (error) return done(error);\\n                if (reply &amp;gt; 0) deletedCount++;\\n                done();\\n            });\\n        })\\n        // Delete location history\\n        .par(function() {\\n            var done = this;\\n            db.del(historyKey, function(error, reply) {\\n                if (error) return done( [... omitted end of long line]"
                },
                {
                  "lineNumber": 1420,
                  "content": "            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 1444,
                  "content": "            \"text\": \"function deleteLocation(req, res, next) {\","
                },
                {
                  "lineNumber": 1600,
                  "content": "            \"text\": \"            res.send((new models.ResponseDeleteLocation(deviceId, deletedCount)).data());\","
                },
                {
                  "lineNumber": 1654,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 1787,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 1791,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 1795,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 2455,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 2521,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 2572,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 2647,
                  "content": "        \"contents\": \"### JavaScript Example\\n&amp;#96;&amp;#96;&amp;#96;javascript\\nconst deleteLocationData = async (deviceId) =&amp;gt; {\\n  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\\n    method: 'POST',\\n    headers: {\\n      'Content-Type': 'application/json'\\n    },\\n    body: JSON.stringify({\\n      MiataruDeleteLocation: {\\n        Device: deviceId\\n      }\\n    })\\n  });\\n  \\n  const result = await response.json();\\n  console.log(&amp;#96;Deleted ${result.MiataruDeletedCount} data entries for device ${deviceId}&amp;#96;);\\n  return result;\\n};\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## What Gets Deleted\\n\\nThe DeleteLocation operation removes the following Redis keys for the specified device:\\n\\n1. **Last Known Location**: &amp;#96;miad:{device-id}:last&amp;#96;\\n   - Contains the most recent location data\\n   - May have TTL (time-to-live) if location history is disabled\\n\\n2. **Location History**: &amp;#96;miad:{device-id}:hist&amp;#96;\\n   - Contains the complete location history as a Redis list\\n   - O [... omitted end of long line]"
                },
                {
                  "lineNumber": 2659,
                  "content": "            \"text\": \"const deleteLocationData = async (deviceId) =&amp;gt; {\","
                },
                {
                  "lineNumber": 2663,
                  "content": "            \"text\": \"  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\","
                },
                {
                  "lineNumber": 2687,
                  "content": "            \"text\": \"      MiataruDeleteLocation: {\","
                },
                {
                  "lineNumber": 2741,
                  "content": "            \"text\": \"The DeleteLocation operation removes the following Redis keys for the specified device:\","
                },
                {
                  "lineNumber": 4327,
                  "content": "        \"contents\": \"- **POST** &amp;#96;/v1/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/v1/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n### Legacy API (Backward Compatibility)\\n- **POST** &amp;#96;/UpdateLocation&amp;#96; - Store location data\\n- **POST** &amp;#96;/GetLocation&amp;#96; - Retrieve current location\\n- **POST** &amp;#96;/GetLocationGeoJSON&amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;#96;/GetLocationGeoJSON/:id?&amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;#96;/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n## Run the Server\\n\\nCheck out the repo:  \\n&amp;#96;git clone git@github.com:miataru/miataru-server.git&amp;#96;\\n\\nInstall dependencies:  \\n&amp;#96;npm install&amp;#96;\\n\\nRun the tests:  \\n&amp;#96;npm run test:all&amp;#96; (or  [... omitted end of long line]"
                },
                {
                  "lineNumber": 4339,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 4374,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 4511,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 4515,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}}'\","
                },
                {
                  "lineNumber": 4672,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"var v1 = require('./v1');\\\\nvar errors = require('../../errors');\\\\n\\\\nmodule.exports.install = function(app) {\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API Version 1 ///////////////////////\\\\n    ///////////////////////////////////////////\\\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\\\n    });\\\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API current ///////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 4704,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"var v1 = require('./v1');\\\\nvar errors = require('../../errors');\\\\n\\\\nmodule.exports.install = function(app) {\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API Version 1 ///////////////////////\\\\n    ///////////////////////////////////////////\\\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\\\n    });\\\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API current ///////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 4744,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"    app.all('/v1/GetLocation', handleUnsupportedMethod);\\\\n    app.all('/v1/GetLocationGeoJSON', handleUnsupportedMethod);\\\\n    app.all('/v1/GetLocationHistory', handleUnsupportedMethod);\\\\n    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\\\\n    app.all('/UpdateLocation', handleUnsupportedMethod);\\\\n    app.all('/GetLocation', handleUnsupportedMethod);\\\\n    app.all('/GetLocationGeoJSON', handleUnsupportedMethod);\\\\n    app.all('/GetLocationHistory', handleUnsupportedMethod);\\\\n    app.all('/DeleteLocation', handleUnsupportedMethod);\\\\n    app.all('/GetVisitorHistory', handleUnsupportedMethod);\\\\n};\\\",\""
                },
                {
                  "lineNumber": 4752,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"var location = require('./location');\\\\n\\\\nmodule.exports = {\\\\n    inputParser: inputParser,\\\\n    updateLocation: location.updateLocation,\\\\n    getLocation: location.getLocation,\\\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\\\n    getLocationHistory: location.getLocationHistory,\\\\n    getVisitorHistory: location.getVisitorHistory,\\\\n    deleteLocation: location.deleteLocation\\\\n};\\\",\""
                },
                {
                  "lineNumber": 4760,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"- **POST** &amp;amp;#96;/v1/GetLocationHistory&amp;amp;#96; - Retrieve location history\\\\n- **POST** &amp;amp;#96;/v1/GetVisitorHistory&amp;amp;#96; - Retrieve visitor history\\\\n- **POST** &amp;amp;#96;/v1/DeleteLocation&amp;amp;#96; - Delete all location data for a device\\\\n\\\\n### Legacy API (Backward Compatibility)\\\\n- **POST** &amp;amp;#96;/UpdateLocation&amp;amp;#96; - Store location data\\\\n- **POST** &amp;amp;#96;/GetLocation&amp;amp;#96; - Retrieve current location\\\\n- **POST** &amp;amp;#96;/GetLocationGeoJSON&amp;amp;#96; - Get location in GeoJSON format\\\\n- **GET** &amp;amp;#96;/GetLocationGeoJSON/:id?&amp;amp;#96; - Get location in GeoJSON format via GET\\\\n- **POST** &amp;amp;#96;/GetLocationHistory&amp;amp;#96; - Retrieve location history\\\\n- **POST** &amp;amp;#96;/GetVisitorHistory&amp;amp;#96; - Retrieve visitor history\\\\n- **POST** &amp;amp;#96;/DeleteLocation&amp;amp;#96; - Delete all location data for a device\\\\n\\\\n## Run the Server\\\\n\\\\nCheck out the repo:  \\\\n&amp;amp;#96;git clone git@github.com:m [... omitted end of long line]"
                },
                {
                  "lineNumber": 4784,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"function parseGetVisitorHistory(req) {\\\\n    req.MIATARU.request = new RequestVisitorHistory(req.body['MiataruGetVisitorHistory'] || {});\\\\n}\\\\n\\\\nfunction parseDeleteLocation(req) {\\\\n    req.MIATARU.request = new RequestDevice(req.body['MiataruDeleteLocation'] || {})\\\\n}\\\",\""
                },
                {
                  "lineNumber": 4796,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"module.exports = {\\\\n    updateLocation: updateLocation,\\\\n    getLocation: getLocation,\\\\n    getLocationGeoJSON: getLocationGeoJSON,\\\\n    getLocationGeoJSONGET: getLocationGeoJSONGET,\\\\n    getLocationHistory: getLocationHistory,\\\\n    getVisitorHistory: getVisitorHistory,\\\\n    deleteLocation: deleteLocation\\\\n};\\\",\""
                },
                {
                  "lineNumber": 4824,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"var v1 = require('./v1');\\\\nvar errors = require('../../errors');\\\\n\\\\nmodule.exports.install = function(app) {\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API Version 1 ///////////////////////\\\\n    ///////////////////////////////////////////\\\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\\\n    });\\\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API current ///////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 4900,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"var v1 = require('./v1');\\\\nvar errors = require('../../errors');\\\\n\\\\nmodule.exports.install = function(app) {\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API Version 1 ///////////////////////\\\\n    ///////////////////////////////////////////\\\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\\\n    });\\\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API current ///////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 4932,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"var v1 = require('./v1');\\\\nvar errors = require('../../errors');\\\\n\\\\nmodule.exports.install = function(app) {\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API Version 1 ///////////////////////\\\\n    ///////////////////////////////////////////\\\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\\\n    });\\\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API current ///////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 4972,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"var v1 = require('./v1');\\\\nvar errors = require('../../errors');\\\\n\\\\nmodule.exports.install = function(app) {\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API Version 1 ///////////////////////\\\\n    ///////////////////////////////////////////\\\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\\\n    });\\\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\\\n\\\\n    ///////////////////////////////////////////\\\\n    ///// API current ///////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 4984,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"function parseGetVisitorHistory(req) {\\\\n    req.MIATARU.request = new RequestVisitorHistory(req.body['MiataruGetVisitorHistory'] || {});\\\\n}\\\\n\\\\nfunction parseDeleteLocation(req) {\\\\n    req.MIATARU.request = new RequestDevice(req.body['MiataruDeleteLocation'] || {})\\\\n}\\\",\""
                },
                {
                  "lineNumber": 4996,
                  "content": "                  \"content\": \"        \\\"contents\\\": \\\"var location = require('./location');\\\\n\\\\nmodule.exports = {\\\\n    inputParser: inputParser,\\\\n    updateLocation: location.updateLocation,\\\\n    getLocation: location.getLocation,\\\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\\\n    getLocationHistory: location.getLocationHistory,\\\\n    getVisitorHistory: location.getVisitorHistory,\\\\n    deleteLocation: location.deleteLocation\\\\n};\\\",\""
                },
                {
                  "lineNumber": 10219,
                  "content": "        \"contents\": \"- **POST** &amp;#96;/v1/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/v1/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n### Legacy API (Backward Compatibility)\\n- **POST** &amp;#96;/UpdateLocation&amp;#96; - Store location data\\n- **POST** &amp;#96;/GetLocation&amp;#96; - Retrieve current location\\n- **POST** &amp;#96;/GetLocationGeoJSON&amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;#96;/GetLocationGeoJSON/:id?&amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;#96;/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n## Run the Server\\n\\nCheck out the repo:  \\n&amp;#96;git clone git@github.com:miataru/miataru-server.git&amp;#96;\\n\\nInstall dependencies:  \\n&amp;#96;npm install&amp;#96;\\n\\nRun the tests:  \\n&amp;#96;npm run test:all&amp;#96; (or  [... omitted end of long line]"
                },
                {
                  "lineNumber": 10231,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 10266,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 10403,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 10407,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}}'\","
                },
                {
                  "lineNumber": 11888,
                  "content": "        \"contents\": \"&amp;#96;&amp;#96;&amp;#96;\\n\\n**Get location in GeoJSON format:**\\n&amp;#96;&amp;#96;&amp;#96;bash\\ncurl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/GetLocationGeoJSON' \\\\\\n  -d '{\\\"MiataruGetLocation\\\":[{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}]}'\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## DeleteLocation API\\n\\nThe DeleteLocation API allows you to permanently delete all location data associated with a specific device.\\n\\n### Request Format\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruDeleteLocation\\\": {\\n    \\\"Device\\\": \\\"device-id-here\\\"\\n  }\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### Response Format\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruResponse\\\": \\\"ACK\\\",\\n  \\\"MiataruVerboseResponse\\\": \\\"Location data deleted for device: device-id-here\\\",\\n  \\\"MiataruDeletedCount\\\": 3\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### What Gets Deleted\\n- **Last Known Location**: Current location data\\n- **Location History**: Complete location history (if enabled)\\n- **Visitor History**: Visitor tracking data\\n\\n### Example Usa [... omitted end of long line]"
                },
                {
                  "lineNumber": 11922,
                  "content": "            \"text\": \"## DeleteLocation API\","
                },
                {
                  "lineNumber": 11929,
                  "content": "            \"text\": \"The DeleteLocation API allows you to permanently delete all location data associated with a specific device.\","
                },
                {
                  "lineNumber": 11948,
                  "content": "            \"text\": \"  \\\"MiataruDeleteLocation\\\": {\","
                },
                {
                  "lineNumber": 12037,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 12041,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"my-device-123\\\"}}'\","
                },
                {
                  "lineNumber": 12584,
                  "content": "        \"contents\": \" function() {\\n        it('should return empty visitor history for unknown device ID', function(done) {\\n            var getVisitorRequest = {\\n                \\\"MiataruGetVisitorHistory\\\": {\\n                    \\\"Device\\\": UNKNOWN_DEVICE_ID,\\n                    \\\"Amount\\\": 10\\n                }\\n            };\\n\\n            request(app)\\n                .post('/v1/GetVisitorHistory')\\n                .send(getVisitorRequest)\\n                .expect(200)\\n                .expect(function(res) {\\n                    expect(res.body.MiataruVisitors).to.be.an('array');\\n                    expect(res.body.MiataruVisitors).to.have.length(0);\\n                    expect(res.body.MiataruServerConfig.AvailableVisitorHistory).to.equal(0);\\n                    expect(res.body.MiataruServerConfig.MaximumNumberOfVisitorHistory).to.be.a('number');\\n                })\\n                .end(done);\\n        });\\n\\n        it('should return empty visitor history for unknown de [... omitted end of long line]"
                },
                {
                  "lineNumber": 12779,
                  "content": "            \"text\": \"    describe('DeleteLocation endpoint',\","
                },
                {
                  "lineNumber": 12842,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 12908,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 12959,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 13035,
                  "content": "        \"contents\": \"function getVisitorHistory(req, res, next) {\\n\\n\\n);\\n        })\\n        .seq(function() {\\n\\n            try {\\n                var targetDeviceID = locationRequest.device();\\n                var parsedList = (this.vars.list || []).map(function(value) {\\n                    return JSON.parse(value);\\n                }).filter(function(visitor) {\\n                    // Filter out entries where visitor DeviceID equals the requested deviceID\\n                    return visitor.DeviceID !== targetDeviceID;\\n                });\\n\\n                // Recalculate the filtered list length for the response\\n                var filteredListLength = parsedList.length;\\n\\n                res.send((new models.ResponseVisitorHistory(\\n                    filteredListLength,\\n                    configuration.maximumNumberOfLocationVistors,\\n                    parsedList\\n                )).data());\\n            } catch (parseError) {\\n                next(new errors.Internal [... omitted end of long line]"
                },
                {
                  "lineNumber": 13204,
                  "content": "            \"text\": \" * DeleteLocation\","
                },
                {
                  "lineNumber": 13326,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 13459,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 13463,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 13467,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 19207,
                  "content": "        \"name\": \"deleteLocation.tests.js\""
                },
                {
                  "lineNumber": 19421,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 19543,
                  "content": "    DeleteLocation endpoint"
                },
                {
                  "lineNumber": 19634,
                  "content": "  DeleteLocation"
                },
                {
                  "lineNumber": 19635,
                  "content": "    Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 19645,
                  "content": "       should handle missing MiataruDeleteLocation object"
                },
                {
                  "lineNumber": 20357,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 20479,
                  "content": "    DeleteLocation endpoint"
                },
                {
                  "lineNumber": 20570,
                  "content": "  DeleteLocation"
                },
                {
                  "lineNumber": 20571,
                  "content": "    Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 20581,
                  "content": "       should handle missing MiataruDeleteLocation object"
                }
              ]
            },
            {
              "file": "./.specstory/history/2026-01-19_20-26Z-miataru-getlocationhistory-json-error.md",
              "matches": [
                {
                  "lineNumber": 1062,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 1128,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 1179,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 1921,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 2054,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 2058,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 2062,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 3058,
                  "content": "        \"contents\": \"- **Backward Compatibility**: Full support for legacy clients\\n\\n#### Technical Updates\\n- **Express.js 4.18.2**: Updated web framework\\n- **Redis 4.6.10**: Modern Redis client with compatibility layer\\n- **Yargs 17.7.2**: Secure command-line argument parsing\\n- **Comprehensive CORS**: Origin validation, credentials support, preflight handling\\n\\n#### API Enhancements\\n- **New Endpoints**: &amp;#96;/v1/DeleteLocation&amp;#96; for data management\\n- **GeoJSON Support**: Enhanced GeoJSON responses with new fields\\n- **Input Validation**: Robust validation with backward compatibility\\n- **Response Models**: Improved response structures and error handling\\n\\n#### Testing &amp;amp; Quality\\n- **Unit Tests**: 200+ unit tests for all components\\n- **Integration Tests**: 300+ integration tests for API workflows\\n- **Backward Compatibility Tests**: Legacy client support verification\\n- **CORS Tests**: Cross-origin request handling validation\\n- **Error Handling Tests**: Comprehensive e [... omitted end of long line]"
                },
                {
                  "lineNumber": 3096,
                  "content": "            \"text\": \"- **New Endpoints**: &amp;#96;/v1/DeleteLocation&amp;#96; for data management\","
                },
                {
                  "lineNumber": 3663,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 3729,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 3780,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 3856,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 3989,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 3993,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 3997,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 4671,
                  "content": "        \"contents\": \"    app.all('/v1/GetLocation', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationGeoJSON', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationHistory', handleUnsupportedMethod);\\n    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\\n    app.all('/UpdateLocation', handleUnsupportedMethod);\\n    app.all('/GetLocation', handleUnsupportedMethod);\\n    app.all('/GetLocationGeoJSON', handleUnsupportedMethod);\\n    app.all('/GetLocationHistory', handleUnsupportedMethod);\\n    app.all('/DeleteLocation', handleUnsupportedMethod);\\n    app.all('/GetVisitorHistory', handleUnsupportedMethod);\\n};\","
                },
                {
                  "lineNumber": 4687,
                  "content": "            \"text\": \"    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\","
                },
                {
                  "lineNumber": 4707,
                  "content": "            \"text\": \"    app.all('/DeleteLocation', handleUnsupportedMethod);\","
                },
                {
                  "lineNumber": 4734,
                  "content": "        \"contents\": \"var location = require('./location');\\n\\nmodule.exports = {\\n    inputParser: inputParser,\\n    updateLocation: location.updateLocation,\\n    getLocation: location.getLocation,\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\n    getLocationHistory: location.getLocationHistory,\\n    getVisitorHistory: location.getVisitorHistory,\\n    deleteLocation: location.deleteLocation\\n};\","
                },
                {
                  "lineNumber": 4777,
                  "content": "            \"text\": \"    deleteLocation: location.deleteLocation\","
                },
                {
                  "lineNumber": 4799,
                  "content": "        \"contents\": \"- **POST** &amp;#96;/v1/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/v1/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n### Legacy API (Backward Compatibility)\\n- **POST** &amp;#96;/UpdateLocation&amp;#96; - Store location data\\n- **POST** &amp;#96;/GetLocation&amp;#96; - Retrieve current location\\n- **POST** &amp;#96;/GetLocationGeoJSON&amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;#96;/GetLocationGeoJSON/:id?&amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;#96;/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\\n\\n## Run the Server\\n\\nCheck out the repo:  \\n&amp;#96;git clone git@github.com:miataru/miataru-server.git&amp;#96;\\n\\nInstall dependencies:  \\n&amp;#96;npm install&amp;#96;\\n\\nRun the tests:  \\n&amp;#96;npm run test:all&amp;#96; (or  [... omitted end of long line]"
                },
                {
                  "lineNumber": 4811,
                  "content": "            \"text\": \"- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 4846,
                  "content": "            \"text\": \"- **POST** &amp;#96;/DeleteLocation&amp;#96; - Delete all location data for a device\","
                },
                {
                  "lineNumber": 4983,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 4987,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}}'\","
                },
                {
                  "lineNumber": 6730,
                  "content": "        \"contents\": \"function parseGetVisitorHistory(req) {\\n    req.MIATARU.request = new RequestVisitorHistory(req.body['MiataruGetVisitorHistory'] || {});\\n}\\n\\nfunction parseDeleteLocation(req) {\\n    req.MIATARU.request = new RequestDevice(req.body['MiataruDeleteLocation'] || {})\\n}\","
                },
                {
                  "lineNumber": 6751,
                  "content": "            \"text\": \"function parseDeleteLocation(req) {\","
                },
                {
                  "lineNumber": 6756,
                  "content": "            \"text\": \"    req.MIATARU.request = new RequestDevice(req.body['MiataruDeleteLocation'] || {})\","
                },
                {
                  "lineNumber": 7418,
                  "content": "        \"contents\": \"module.exports = {\\n    updateLocation: updateLocation,\\n    getLocation: getLocation,\\n    getLocationGeoJSON: getLocationGeoJSON,\\n    getLocationGeoJSONGET: getLocationGeoJSONGET,\\n    getLocationHistory: getLocationHistory,\\n    getVisitorHistory: getVisitorHistory,\\n    deleteLocation: deleteLocation\\n};\","
                },
                {
                  "lineNumber": 7450,
                  "content": "            \"text\": \"    deleteLocation: deleteLocation\","
                },
                {
                  "lineNumber": 8154,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 8287,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 8291,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 8295,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 8406,
                  "content": "        \"contents\": \"    cors.tests.js\\n    deleteLocation.tests.js\\n    newFields.tests.js\\n    unknownDevice.tests.js\\n testFiles/              # Test utilities and mock data\\n     calls.js\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## Dependencies\\n\\n### Core Dependencies\\n- **Node.js**: &amp;gt;= 18.0.0 (modernized for current LTS)\\n- **Express.js**: ^4.18.2 (web framework)\\n- **Redis**: ^4.6.10 (data storage with modern Redis v4+ compatibility)\\n- **FakeRedis**: ^2.0.0 (testing and development)\\n\\n### Additional Dependencies\\n- **CORS**: ^2.8.5 (cross-origin resource sharing)\\n- **Body-Parser**: ^1.20.2 (request parsing)\\n- **Yargs**: ^17.7.2 (command line argument parsing)\\n- **Moment.js**: ^2.29.4 (date/time handling)\\n- **EJS**: ^3.1.9 (template engine)\\n- **Stylus**: ^0.59.0 (CSS preprocessing)\\n\\n### Development Dependencies\\n- **Mocha**: ^10.2.0 (test framework)\\n- **Chai**: ^4.3.10 (assertion library)\\n- **Supertest**: ^7.1.4 (HTTP testing)\\n\\n### Security Updates\\n- **Replaced  [... omitted end of long line]"
                },
                {
                  "lineNumber": 8414,
                  "content": "            \"text\": \"    deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 8558,
                  "content": "            \"text\": \"- **DeleteLocation API**: Complete data deletion functionality for devices\","
                },
                {
                  "lineNumber": 8715,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 8781,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 8832,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 9695,
                  "content": "        \"contents\": \"&amp;#96;&amp;#96;&amp;#96;\\n\\n**Get location in GeoJSON format:**\\n&amp;#96;&amp;#96;&amp;#96;bash\\ncurl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/GetLocationGeoJSON' \\\\\\n  -d '{\\\"MiataruGetLocation\\\":[{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}]}'\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## DeleteLocation API\\n\\nThe DeleteLocation API allows you to permanently delete all location data associated with a specific device.\\n\\n### Request Format\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruDeleteLocation\\\": {\\n    \\\"Device\\\": \\\"device-id-here\\\"\\n  }\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### Response Format\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruResponse\\\": \\\"ACK\\\",\\n  \\\"MiataruVerboseResponse\\\": \\\"Location data deleted for device: device-id-here\\\",\\n  \\\"MiataruDeletedCount\\\": 3\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### What Gets Deleted\\n- **Last Known Location**: Current location data\\n- **Location History**: Complete location history (if enabled)\\n- **Visitor History**: Visitor tracking data\\n\\n### Example Usa [... omitted end of long line]"
                },
                {
                  "lineNumber": 9729,
                  "content": "            \"text\": \"## DeleteLocation API\","
                },
                {
                  "lineNumber": 9736,
                  "content": "            \"text\": \"The DeleteLocation API allows you to permanently delete all location data associated with a specific device.\","
                },
                {
                  "lineNumber": 9755,
                  "content": "            \"text\": \"  \\\"MiataruDeleteLocation\\\": {\","
                },
                {
                  "lineNumber": 9844,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 9848,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"my-device-123\\\"}}'\","
                },
                {
                  "lineNumber": 10790,
                  "content": "        \"contents\": \"- **Backward Compatibility**: Full support for legacy clients\\n\\n#### Technical Updates\\n- **Express.js 4.18.2**: Updated web framework\\n- **Redis 4.6.10**: Modern Redis client with compatibility layer\\n- **Yargs 17.7.2**: Secure command-line argument parsing\\n- **Comprehensive CORS**: Origin validation, credentials support, preflight handling\\n\\n#### API Enhancements\\n- **New Endpoints**: &amp;#96;/v1/DeleteLocation&amp;#96; for data management\\n- **GeoJSON Support**: Enhanced GeoJSON responses with new fields\\n- **Input Validation**: Robust validation with backward compatibility\\n- **Response Models**: Improved response structures and error handling\\n\\n#### Testing &amp;amp; Quality\\n- **Unit Tests**: 200+ unit tests for all components\\n- **Integration Tests**: 300+ integration tests for API workflows\\n- **Backward Compatibility Tests**: Legacy client support verification\\n- **CORS Tests**: Cross-origin request handling validation\\n- **Error Handling Tests**: Comprehensive e [... omitted end of long line]"
                },
                {
                  "lineNumber": 10828,
                  "content": "            \"text\": \"- **New Endpoints**: &amp;#96;/v1/DeleteLocation&amp;#96; for data management\","
                },
                {
                  "lineNumber": 12368,
                  "content": "        \"contents\": \"    cors.tests.js\\n    deleteLocation.tests.js\\n    newFields.tests.js\\n    unknownDevice.tests.js\\n testFiles/              # Test utilities and mock data\\n     calls.js\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## Dependencies\\n\\n### Core Dependencies\\n- **Node.js**: &amp;gt;= 18.0.0 (modernized for current LTS)\\n- **Express.js**: ^4.18.2 (web framework)\\n- **Redis**: ^4.6.10 (data storage with modern Redis v4+ compatibility)\\n- **FakeRedis**: ^2.0.0 (testing and development)\\n\\n### Additional Dependencies\\n- **CORS**: ^2.8.5 (cross-origin resource sharing)\\n- **Body-Parser**: ^1.20.2 (request parsing)\\n- **Yargs**: ^17.7.2 (command line argument parsing)\\n- **Moment.js**: ^2.29.4 (date/time handling)\\n- **EJS**: ^3.1.9 (template engine)\\n- **Stylus**: ^0.59.0 (CSS preprocessing)\\n\\n### Development Dependencies\\n- **Mocha**: ^10.2.0 (test framework)\\n- **Chai**: ^4.3.10 (assertion library)\\n- **Supertest**: ^7.1.4 (HTTP testing)\\n\\n### Security Updates\\n- **Replaced  [... omitted end of long line]"
                },
                {
                  "lineNumber": 12376,
                  "content": "            \"text\": \"    deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 12520,
                  "content": "            \"text\": \"- **DeleteLocation API**: Complete data deletion functionality for devices\","
                },
                {
                  "lineNumber": 13235,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 13368,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 13372,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 13376,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 14319,
                  "content": "        \"contents\": \"&amp;#96;&amp;#96;&amp;#96;\\n\\n**Get location in GeoJSON format:**\\n&amp;#96;&amp;#96;&amp;#96;bash\\ncurl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/GetLocationGeoJSON' \\\\\\n  -d '{\\\"MiataruGetLocation\\\":[{\\\"Device\\\":\\\"7b8e6e0ee5296db345162dc2ef652c1350761823\\\"}]}'\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## DeleteLocation API\\n\\nThe DeleteLocation API allows you to permanently delete all location data associated with a specific device.\\n\\n### Request Format\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruDeleteLocation\\\": {\\n    \\\"Device\\\": \\\"device-id-here\\\"\\n  }\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### Response Format\\n&amp;#96;&amp;#96;&amp;#96;json\\n{\\n  \\\"MiataruResponse\\\": \\\"ACK\\\",\\n  \\\"MiataruVerboseResponse\\\": \\\"Location data deleted for device: device-id-here\\\",\\n  \\\"MiataruDeletedCount\\\": 3\\n}\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n### What Gets Deleted\\n- **Last Known Location**: Current location data\\n- **Location History**: Complete location history (if enabled)\\n- **Visitor History**: Visitor tracking data\\n\\n### Example Usa [... omitted end of long line]"
                },
                {
                  "lineNumber": 14353,
                  "content": "            \"text\": \"## DeleteLocation API\","
                },
                {
                  "lineNumber": 14360,
                  "content": "            \"text\": \"The DeleteLocation API allows you to permanently delete all location data associated with a specific device.\","
                },
                {
                  "lineNumber": 14379,
                  "content": "            \"text\": \"  \\\"MiataruDeleteLocation\\\": {\","
                },
                {
                  "lineNumber": 14468,
                  "content": "            \"text\": \"curl -H 'Content-Type: application/json' -X POST 'http://localhost:8090/v1/DeleteLocation' \\\\\","
                },
                {
                  "lineNumber": 14472,
                  "content": "            \"text\": \"  -d '{\\\"MiataruDeleteLocation\\\":{\\\"Device\\\":\\\"my-device-123\\\"}}'\","
                },
                {
                  "lineNumber": 14772,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 14838,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 14889,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 15454,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 16518,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 16651,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 16655,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 16659,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 17005,
                  "content": "        \"contents\": \"    cors.tests.js\\n    deleteLocation.tests.js\\n    newFields.tests.js\\n    unknownDevice.tests.js\\n testFiles/              # Test utilities and mock data\\n     calls.js\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## Dependencies\\n\\n### Core Dependencies\\n- **Node.js**: &amp;gt;= 18.0.0 (modernized for current LTS)\\n- **Express.js**: ^4.18.2 (web framework)\\n- **Redis**: ^4.6.10 (data storage with modern Redis v4+ compatibility)\\n- **FakeRedis**: ^2.0.0 (testing and development)\\n\\n### Additional Dependencies\\n- **CORS**: ^2.8.5 (cross-origin resource sharing)\\n- **Body-Parser**: ^1.20.2 (request parsing)\\n- **Yargs**: ^17.7.2 (command line argument parsing)\\n- **Moment.js**: ^2.29.4 (date/time handling)\\n- **EJS**: ^3.1.9 (template engine)\\n- **Stylus**: ^0.59.0 (CSS preprocessing)\\n\\n### Development Dependencies\\n- **Mocha**: ^10.2.0 (test framework)\\n- **Chai**: ^4.3.10 (assertion library)\\n- **Supertest**: ^7.1.4 (HTTP testing)\\n\\n### Security Updates\\n- **Replaced  [... omitted end of long line]"
                },
                {
                  "lineNumber": 17013,
                  "content": "            \"text\": \"    deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 17157,
                  "content": "            \"text\": \"- **DeleteLocation API**: Complete data deletion functionality for devices\","
                },
                {
                  "lineNumber": 17679,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 17745,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 17796,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 19121,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 19474,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n            case '/GetLocationGeoJSON':\\n            case '/v1/GetLocationGeoJSON':\\n                parseGetLocationsGeoJSON(req);\\n                break;\\n            case '/ [... omitted end of long line]"
                },
                {
                  "lineNumber": 19607,
                  "content": "            \"text\": \"            case '/DeleteLocation':\","
                },
                {
                  "lineNumber": 19611,
                  "content": "            \"text\": \"            case '/v1/DeleteLocation':\","
                },
                {
                  "lineNumber": 19615,
                  "content": "            \"text\": \"                parseDeleteLocation(req);\","
                },
                {
                  "lineNumber": 20121,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n\\n    ///////////////////////////////////////////\\n    ///// API current /////////////////////////\\n    ////////////////////////////////// [... omitted end of long line]"
                },
                {
                  "lineNumber": 20187,
                  "content": "            \"text\": \"    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 20238,
                  "content": "            \"text\": \"    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\","
                },
                {
                  "lineNumber": 20893,
                  "content": "        \"contents\": \"    cors.tests.js\\n    deleteLocation.tests.js\\n    newFields.tests.js\\n    unknownDevice.tests.js\\n testFiles/              # Test utilities and mock data\\n     calls.js\\n&amp;#96;&amp;#96;&amp;#96;\\n\\n## Dependencies\\n\\n### Core Dependencies\\n- **Node.js**: &amp;gt;= 18.0.0 (modernized for current LTS)\\n- **Express.js**: ^4.18.2 (web framework)\\n- **Redis**: ^4.6.10 (data storage with modern Redis v4+ compatibility)\\n- **FakeRedis**: ^2.0.0 (testing and development)\\n\\n### Additional Dependencies\\n- **CORS**: ^2.8.5 (cross-origin resource sharing)\\n- **Body-Parser**: ^1.20.2 (request parsing)\\n- **Yargs**: ^17.7.2 (command line argument parsing)\\n- **Moment.js**: ^2.29.4 (date/time handling)\\n- **EJS**: ^3.1.9 (template engine)\\n- **Stylus**: ^0.59.0 (CSS preprocessing)\\n\\n### Development Dependencies\\n- **Mocha**: ^10.2.0 (test framework)\\n- **Chai**: ^4.3.10 (assertion library)\\n- **Supertest**: ^7.1.4 (HTTP testing)\\n\\n### Security Updates\\n- **Replaced  [... omitted end of long line]"
                },
                {
                  "lineNumber": 20901,
                  "content": "            \"text\": \"    deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 21045,
                  "content": "            \"text\": \"- **DeleteLocation API**: Complete data deletion functionality for devices\","
                },
                {
                  "lineNumber": 21723,
                  "content": "        \"contents\": \"function parseGetVisitorHistory(req) {\\n    req.MIATARU.request = new RequestVisitorHistory(req.body['MiataruGetVisitorHistory'] || {});\\n}\\n\\nfunction parseDeleteLocation(req) {\\n    req.MIATARU.request = new RequestDevice(req.body['MiataruDeleteLocation'] || {})\\n}\","
                },
                {
                  "lineNumber": 21744,
                  "content": "            \"text\": \"function parseDeleteLocation(req) {\","
                },
                {
                  "lineNumber": 21749,
                  "content": "            \"text\": \"    req.MIATARU.request = new RequestDevice(req.body['MiataruDeleteLocation'] || {})\","
                },
                {
                  "lineNumber": 21929,
                  "content": "        \"contents\": \"var location = require('./location');\\n\\nmodule.exports = {\\n    inputParser: inputParser,\\n    updateLocation: location.updateLocation,\\n    getLocation: location.getLocation,\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\n    getLocationHistory: location.getLocationHistory,\\n    getVisitorHistory: location.getVisitorHistory,\\n    deleteLocation: location.deleteLocation\\n};\","
                },
                {
                  "lineNumber": 21972,
                  "content": "            \"text\": \"    deleteLocation: location.deleteLocation\","
                },
                {
                  "lineNumber": 22468,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 22590,
                  "content": "    DeleteLocation endpoint"
                },
                {
                  "lineNumber": 22669,
                  "content": "  DeleteLocation"
                },
                {
                  "lineNumber": 22670,
                  "content": "    Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 22680,
                  "content": "       should handle missing MiataruDeleteLocation object"
                },
                {
                  "lineNumber": 23028,
                  "content": "              \"file\": \"tests/integration/deleteLocation.tests.js\","
                },
                {
                  "lineNumber": 23569,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 23748,
                  "content": "  ResponseDeleteLocation"
                }
              ]
            },
            {
              "file": "./.specstory/history/2026-01-19_20-04Z-npm-warnings-in-docker-build.md",
              "matches": [
                {
                  "lineNumber": 429,
                  "content": "            \"name\": \"deleteLocation.tests.js\""
                },
                {
                  "lineNumber": 557,
                  "content": "            \"name\": \"responseDeleteLocation.tests.js\""
                },
                {
                  "lineNumber": 710,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 832,
                  "content": "    DeleteLocation endpoint"
                },
                {
                  "lineNumber": 905,
                  "content": "  DeleteLocation"
                },
                {
                  "lineNumber": 906,
                  "content": "    Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 916,
                  "content": "       should handle missing MiataruDeleteLocation object"
                }
              ]
            },
            {
              "file": "./.specstory/history/2026-01-19_19-52Z-visitor-history-self-request-exclusion.md",
              "matches": [
                {
                  "lineNumber": 154,
                  "content": "| &#96;./tests/integration/deleteLocation.tests.js&#96; | &#96;it('should delete all location data types (current, history, visitor)', function(done) \\{&#96; | L80 |"
                },
                {
                  "lineNumber": 1420,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 1524,
                  "content": "  DeleteLocation"
                },
                {
                  "lineNumber": 1525,
                  "content": "    Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 1535,
                  "content": "       should handle missing MiataruDeleteLocation object"
                },
                {
                  "lineNumber": 1617,
                  "content": "    DeleteLocation endpoint"
                },
                {
                  "lineNumber": 2319,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 2423,
                  "content": "  DeleteLocation"
                },
                {
                  "lineNumber": 2424,
                  "content": "    Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 2434,
                  "content": "       should handle missing MiataruDeleteLocation object"
                },
                {
                  "lineNumber": 2516,
                  "content": "    DeleteLocation endpoint"
                },
                {
                  "lineNumber": 3001,
                  "content": "  ResponseDeleteLocation"
                },
                {
                  "lineNumber": 3105,
                  "content": "  DeleteLocation"
                },
                {
                  "lineNumber": 3106,
                  "content": "    Basic DeleteLocation functionality"
                },
                {
                  "lineNumber": 3116,
                  "content": "       should handle missing MiataruDeleteLocation object"
                },
                {
                  "lineNumber": 3198,
                  "content": "    DeleteLocation endpoint"
                }
              ]
            },
            {
              "file": "./tests/unit/responseDeleteLocation.tests.js",
              "matches": [
                {
                  "lineNumber": 2,
                  "content": "var ResponseDeleteLocation = require('../../lib/models/ResponseDeleteLocation');"
                },
                {
                  "lineNumber": 4,
                  "content": "describe('ResponseDeleteLocation', function() {"
                },
                {
                  "lineNumber": 7,
                  "content": "            var response = new ResponseDeleteLocation('test-device', 3);"
                },
                {
                  "lineNumber": 16,
                  "content": "            var response = new ResponseDeleteLocation('test-device', 2);"
                },
                {
                  "lineNumber": 26,
                  "content": "            var response = new ResponseDeleteLocation('non-existent-device', 0);"
                },
                {
                  "lineNumber": 35,
                  "content": "            var response = new ResponseDeleteLocation('device-with-history', 3);"
                },
                {
                  "lineNumber": 45,
                  "content": "            var response = new ResponseDeleteLocation(specialDeviceId, 1);"
                }
              ]
            },
            {
              "file": "./lib/models/ResponseDeleteLocation.js",
              "matches": [
                {
                  "lineNumber": 1,
                  "content": "function ResponseDeleteLocation(deviceId, deletedCount) {"
                },
                {
                  "lineNumber": 6,
                  "content": "ResponseDeleteLocation.prototype.data = function() {"
                },
                {
                  "lineNumber": 14,
                  "content": "module.exports = ResponseDeleteLocation;"
                }
              ]
            },
            {
              "file": "./docs/DELETE_LOCATION_API.md",
              "matches": [
                {
                  "lineNumber": 1,
                  "content": "# DeleteLocation API Documentation"
                },
                {
                  "lineNumber": 5,
                  "content": "The DeleteLocation API endpoint allows you to permanently delete all location data associated with a specific device. This includes:"
                },
                {
                  "lineNumber": 14,
                  "content": "- **POST** &#96;/v1/DeleteLocation&#96;"
                },
                {
                  "lineNumber": 17,
                  "content": "- **POST** &#96;/DeleteLocation&#96;"
                },
                {
                  "lineNumber": 24,
                  "content": "  \"MiataruDeleteLocation\": {"
                },
                {
                  "lineNumber": 34,
                  "content": "| &#96;MiataruDeleteLocation&#96; | Object | Yes | Container object for delete request |"
                },
                {
                  "lineNumber": 70,
                  "content": "curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/v1/DeleteLocation' \\"
                },
                {
                  "lineNumber": 71,
                  "content": "  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'"
                },
                {
                  "lineNumber": 76,
                  "content": "curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/DeleteLocation' \\"
                },
                {
                  "lineNumber": 77,
                  "content": "  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'"
                },
                {
                  "lineNumber": 82,
                  "content": "const deleteLocationData = async (deviceId) =&gt; {"
                },
                {
                  "lineNumber": 83,
                  "content": "  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {"
                },
                {
                  "lineNumber": 89,
                  "content": "      MiataruDeleteLocation: {"
                },
                {
                  "lineNumber": 103,
                  "content": "The DeleteLocation operation removes the following Redis keys for the specified device:"
                },
                {
                  "lineNumber": 168,
                  "content": "4. **DeleteLocation**: Remove all data when no longer needed"
                },
                {
                  "lineNumber": 174,
                  "content": "UpdateLocation  GetLocation  UpdateLocation  DeleteLocation"
                },
                {
                  "lineNumber": 179,
                  "content": "The DeleteLocation API is thoroughly tested with:"
                },
                {
                  "lineNumber": 194,
                  "content": "- **v1 API**: &#96;/v1/DeleteLocation&#96; - Recommended for new implementations"
                },
                {
                  "lineNumber": 195,
                  "content": "- **Legacy API**: &#96;/DeleteLocation&#96; - Maintained for backward compatibility"
                }
              ]
            },
            {
              "file": "./dev/Triggers/DeleteLocation.sh",
              "matches": [
                {
                  "lineNumber": 3,
                  "content": "# DeleteLocation API Test Script"
                },
                {
                  "lineNumber": 4,
                  "content": "# This script demonstrates the DeleteLocation API functionality"
                },
                {
                  "lineNumber": 9,
                  "content": "echo \"=== DeleteLocation API Test ===\""
                },
                {
                  "lineNumber": 46,
                  "content": "curl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/DeleteLocation\" \\"
                },
                {
                  "lineNumber": 48,
                  "content": "    \\\"MiataruDeleteLocation\\\": {"
                },
                {
                  "lineNumber": 68,
                  "content": "curl -s -H 'Content-Type: application/json' -X POST \"$SERVER_URL/v1/DeleteLocation\" \\"
                },
                {
                  "lineNumber": 70,
                  "content": "    \\\"MiataruDeleteLocation\\\": {"
                }
              ]
            }
          ],
          "totalLines": 577,
          "totalMatchedLines": 577
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/bietiekay/code/miataru-server/docs/DELETE_LOCATION_API.md</summary>

</details>
</tool-use>

---


Checking the request model and security documentation for DeviceKey support:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/bietiekay/code/miataru-server/lib/routes/location/v1/location.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/bietiekay/code/miataru-server/lib/models/RequestDevice.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/bietiekay/code/miataru-server/docs/API_1.1_SECURITY.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "DeviceKey.*DeleteLocation|DeleteLocation.*DeviceKey",
  "caseInsensitive": true
}
```
Result:

```json
{
  "success": {
    "pattern": "DeviceKey.*DeleteLocation|DeleteLocation.*DeviceKey",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/bietiekay/code/miataru-server": {
        "content": {
          "matches": [
            {
              "file": "./.specstory/history/2026-01-25_12-50Z-miataru-api-v1-1-security-and-access-control.md",
              "matches": [
                {
                  "lineNumber": 32969,
                  "content": "        \"contents\": \"var v1 = require('./v1');\\nvar errors = require('../../errors');\\n\\nmodule.exports.install = function(app) {\\n\\n    ///////////////////////////////////////////\\n    ///// API Version 1 ///////////////////////\\n    ///////////////////////////////////////////\\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\\n    });\\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\\n    app.post('/v1/setDeviceKey', v1.inputParser, v1.setDeviceKey);\\n    app.post('/v1/setAllowedDeviceList', v1.inputParser, v1.setAllowed [... omitted end of long line]"
                },
                {
                  "lineNumber": 33148,
                  "content": "        \"contents\": \"var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\\nvar RequestLocation = require('../../../models/RequestLocation');\\nvar RequestDevice = require('../../../models/RequestDevice');\\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\\nvar RequestSetDeviceKey = require('../../../models/RequestSetDeviceKey');\\nvar RequestSetAllowedDeviceList = require('../../../models/RequestSetAllowedDeviceList');\\n\\nmodule.exports = function(req, res, next) {\\n    req.MIATARU = req.MIATARU || {};\\n\\n    var nextError;\\n\\n    try {\\n        switch(req.path) {\\n            case '/UpdateLocation':\\n            case '/v1/UpdateLocation':\\n                parseUpdateLocation(req);\\n                break;\\n            case '/GetLocation':\\n            case '/v1/GetLocation':\\n                parseGetLocations(req);\\n                break;\\n           [... omitted end of long line]"
                },
                {
                  "lineNumber": 33877,
                  "content": "        \"contents\": \"    ///////////////////////////////////////////\\n    ///// non-Post /////////////////////////\\n    ///////////////////////////////////////////\\n    function handleUnsupportedMethod(req, res, next) {\\n        if (req.method === 'OPTIONS') {\\n            return res.status(204).end();\\n        }\\n\\n        next(new errors.MethodNotSupportedError(req.method, req.path));\\n    }\\n\\n    app.all('/v1/UpdateLocation', handleUnsupportedMethod);\\n    app.all('/v1/GetLocation', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationGeoJSON', handleUnsupportedMethod);\\n    app.all('/v1/GetLocationHistory', handleUnsupportedMethod);\\n    app.all('/v1/DeleteLocation', handleUnsupportedMethod);\\n    app.all('/v1/setDeviceKey', handleUnsupportedMethod);\\n    app.all('/v1/setAllowedDeviceList', handleUnsupportedMethod);\\n    app.all('/UpdateLocation', handleUnsupportedMethod);\\n    app.all('/GetLocation', handleUnsupportedMethod);\\n    app.all('/GetLocationGeoJSON', handleUnsupporte [... omitted end of long line]"
                },
                {
                  "lineNumber": 36619,
                  "content": "        \"contents\": \"var location = require('./location');\\n\\nmodule.exports = {\\n    inputParser: inputParser,\\n    updateLocation: location.updateLocation,\\n    getLocation: location.getLocation,\\n    getLocationGeoJSON: location.getLocationGeoJSON,\\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\\n    getLocationHistory: location.getLocationHistory,\\n    getVisitorHistory: location.getVisitorHistory,\\n    deleteLocation: location.deleteLocation,\\n    setDeviceKey: location.setDeviceKey,\\n    setAllowedDeviceList: location.setAllowedDeviceList\\n};\","
                },
                {
                  "lineNumber": 36795,
                  "content": "        \"contents\": \"With it's simple API it allows you to use Miataru to your own needs and practices.\\n\\n## API Endpoints\\n\\nThe Miataru server provides both versioned (v1) and legacy API endpoints for maximum compatibility:\\n\\n### Version 1 API (Recommended)\\n- **POST** &amp;#96;/v1/UpdateLocation&amp;#96; - Store location data\\n- **POST** &amp;#96;/v1/GetLocation&amp;#96; - Retrieve current location\\n- **POST** &amp;#96;/v1/GetLocationGeoJSON&amp;#96; - Get location in GeoJSON format\\n- **GET** &amp;#96;/v1/GetLocationGeoJSON/:id?&amp;#96; - Get location in GeoJSON format via GET\\n- **POST** &amp;#96;/v1/GetLocationHistory&amp;#96; - Retrieve location history\\n- **POST** &amp;#96;/v1/GetVisitorHistory&amp;#96; - Retrieve visitor history\\n- **POST** &amp;#96;/v1/DeleteLocation&amp;#96; - Delete all location data for a device\\n- **POST** &amp;#96;/v1/setDeviceKey&amp;#96; - Set or change device key (API 1.1)\\n- **POST** &amp;#96;/v1/setAllowedDeviceList&amp;#96; - Manage allowed devices list (API 1.1)\\n\\n### Legacy API (Backward Compatibility)\\n- **POST* [... omitted end of long line]"
                }
              ]
            }
          ],
          "totalLines": 5,
          "totalMatchedLines": 5
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


Checking how DeleteLocation requests are parsed:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/bietiekay/code/miataru-server/lib/routes/location/v1/inputParser.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "writing operations DeviceKey required UpdateLocation DeleteLocation",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 324,
            "column": 1
          },
          "endPosition": {
            "line": 433,
            "column": 1
          }
        },
        "contents": "/**\n * UpdateLocation\n * api endpoint that updates the currentLocation and a arbitrary number of history locations\n *\n * @param req\n * @param res\n * @param next\n */\nfunction updateLocation(req, res, next) {\n    var MIATARU = req.MIATARU;\n    var requestConfig = MIATARU.config;\n    var locations = MIATARU.locations;\n\n    var chain = seq();\n\n    // Validate DeviceKey for each location if DeviceKey is set for the device\n    locations.forEach(function(loc, idx) {\n        var deviceId = loc.device();\n        var providedDeviceKey = loc.deviceKey();\n\n        chain.seq(function() {\n            var done = this;\n            // Check if DeviceKey is set for this device\n            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {\n                if (error) {\n                    return done(error);\n                }\n\n                // If DeviceKey is set for this device, validate provided key\n                if (storedKey !== null &amp;&amp; storedKey !== undefined) {\n                    // DeviceKey is required when it's set\n                    if (!providedDeviceKey || providedDeviceKey === null || providedDeviceKey === '') {\n                        return done(new errors.ForbiddenError('DeviceKey is required for this device'));\n                    }\n\n                    // Validate provided key matches stored key\n                    deviceKeyUtils.validateDeviceKey(deviceId, providedDeviceKey, function(error2, isValid) {\n                        if (error2) {\n                            return done(error2);\n                        }\n\n                        if (!isValid) {\n                            return done(new errors.ForbiddenError('DeviceKey does not match'));\n                        }\n\n                        done();\n                    });\n                } else {\n                    // No DeviceKey set, proceed normally (backward compatible)\n                    done();\n                }\n            });\n        });\n    });\n\n    if(requestConfig.enableLocationHistory())\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 327
          },
          {
            "text": " * UpdateLocation",
            "lineNumber": 328
          },
          {
            "text": " * api endpoint that updates the currentLocation and a arbitrary number of history locations",
            "lineNumber": 329
          },
          {
            "text": " *",
            "lineNumber": 330
          },
          {
            "text": " * @param req",
            "lineNumber": 331
          },
          {
            "text": " * @param res",
            "lineNumber": 332
          },
          {
            "text": " * @param next",
            "lineNumber": 333
          },
          {
            "text": " */",
            "lineNumber": 334
          },
          {
            "text": "function updateLocation(req, res, next) {",
            "lineNumber": 335,
            "isSignature": true
          },
          {
            "text": "    var MIATARU = req.MIATARU;",
            "lineNumber": 336
          },
          {
            "text": "    var requestConfig = MIATARU.config;",
            "lineNumber": 337
          },
          {
            "text": "    var locations = MIATARU.locations;",
            "lineNumber": 338
          },
          {
            "lineNumber": 339
          },
          {
            "text": "    var chain = seq();",
            "lineNumber": 340
          },
          {
            "lineNumber": 341
          },
          {
            "text": "    // Validate DeviceKey for each location if DeviceKey is set for the device",
            "lineNumber": 342
          },
          {
            "text": "    locations.forEach(function(loc, idx) {",
            "lineNumber": 343
          },
          {
            "text": "        var deviceId = loc.device();",
            "lineNumber": 344
          },
          {
            "text": "        var providedDeviceKey = loc.deviceKey();",
            "lineNumber": 345
          },
          {
            "lineNumber": 346
          },
          {
            "text": "        chain.seq(function() {",
            "lineNumber": 347
          },
          {
            "text": "            var done = this;",
            "lineNumber": 348
          },
          {
            "text": "            // Check if DeviceKey is set for this device",
            "lineNumber": 349
          },
          {
            "text": "            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {",
            "lineNumber": 350
          },
          {
            "text": "                if (error) {",
            "lineNumber": 351
          },
          {
            "text": "                    return done(error);",
            "lineNumber": 352
          },
          {
            "text": "                }",
            "lineNumber": 353
          },
          {
            "lineNumber": 354
          },
          {
            "text": "                // If DeviceKey is set for this device, validate provided key",
            "lineNumber": 355
          },
          {
            "text": "                if (storedKey !== null &amp;&amp; storedKey !== undefined) {",
            "lineNumber": 356
          },
          {
            "text": "                    // DeviceKey is required when it's set",
            "lineNumber": 357
          },
          {
            "text": "                    if (!providedDeviceKey || providedDeviceKey === null || providedDeviceKey === '') {",
            "lineNumber": 358
          },
          {
            "text": "                        return done(new errors.ForbiddenError('DeviceKey is required for this device'));",
            "lineNumber": 359
          },
          {
            "text": "                    }",
            "lineNumber": 360
          },
          {
            "lineNumber": 361
          },
          {
            "text": "                    // Validate provided key matches stored key",
            "lineNumber": 362
          },
          {
            "text": "                    deviceKeyUtils.validateDeviceKey(deviceId, providedDeviceKey, function(error2, isValid) {",
            "lineNumber": 363
          },
          {
            "text": "                        if (error2) {",
            "lineNumber": 364
          },
          {
            "text": "                            return done(error2);",
            "lineNumber": 365
          },
          {
            "text": "                        }",
            "lineNumber": 366
          },
          {
            "lineNumber": 367
          },
          {
            "text": "                        if (!isValid) {",
            "lineNumber": 368
          },
          {
            "text": "                            return done(new errors.ForbiddenError('DeviceKey does not match'));",
            "lineNumber": 369
          },
          {
            "text": "                        }",
            "lineNumber": 370
          },
          {
            "lineNumber": 371
          },
          {
            "text": "                        done();",
            "lineNumber": 372
          },
          {
            "text": "                    });",
            "lineNumber": 373
          },
          {
            "text": "                } else {",
            "lineNumber": 374
          },
          {
            "text": "                    // No DeviceKey set, proceed normally (backward compatible)",
            "lineNumber": 375
          },
          {
            "text": "                    done();",
            "lineNumber": 376
          },
          {
            "text": "                }",
            "lineNumber": 377
          },
          {
            "text": "            });",
            "lineNumber": 378
          },
          {
            "text": "        });",
            "lineNumber": 379
          },
          {
            "text": "    });",
            "lineNumber": 380
          },
          {
            "lineNumber": 381
          },
          {
            "text": "    if(requestConfig.enableLocationHistory())",
            "lineNumber": 382
          },
          {
            "text": "}",
            "lineNumber": 434,
            "isSignature": true
          }
        ]
      },
      "score": 0.521754264831543
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 799,
            "column": 1
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "/**\n * SetDeviceKey\n * Sets or changes the device key for a device\n * @param req\n * @param res\n * @param next\n */\nfunction setDeviceKey(req, res, next) {\n    var request = req.MIATARU.request;\n    var deviceId = request.deviceId();\n    var currentDeviceKey = request.currentDeviceKey();\n    var newDeviceKey = request.newDeviceKey();\n\n    seq()\n        .seq(function() {\n            var done = this;\n            // Check if device already has a key set\n            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {\n                if (error) {\n                    return done(error);\n                }\n\n                done.vars = done.vars || {};\n                done.vars.storedKey = storedKey;\n                done();\n            });\n        })\n        .seq(function() {\n            var done = this;\n            var storedKey = (done.vars || {}).storedKey;\n\n            // If a key exists, validate CurrentDeviceKey\n            if (storedKey !== null &amp;&amp; storedKey !== undefined) {\n                // Key exists, so CurrentDeviceKey must be provided and match\n                if (!currentDeviceKey || currentDeviceKey === null || currentDeviceKey === '') {\n                    return done(new errors.ForbiddenError('CurrentDeviceKey is required to change existing key'));\n                }\n\n                // Validate CurrentDeviceKey matches stored key\n                deviceKeyUtils.validateDeviceKey(deviceId, currentDeviceKey, function(error, isValid) {\n                    if (error) {\n                        return done(error);\n                    }\n\n                    if (!isValid) {\n                        return done(new errors.ForbiddenError('CurrentDeviceKey does not match'));\n                    }\n\n                    done();\n                });\n            } else {\n                // No key exists, so CurrentDeviceKey should be null/empty (first-time setup)\n                // This is allowed, proceed\n                done();\n            }\n        })\n        .seq(function() {\n            var done = this;\n            // Set the new key\n            deviceKeyUtils.setDeviceKey\n\n\n\n\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 802
          },
          {
            "text": " * SetDeviceKey",
            "lineNumber": 803
          },
          {
            "text": " * Sets or changes the device key for a device",
            "lineNumber": 804
          },
          {
            "text": " * @param req",
            "lineNumber": 805
          },
          {
            "text": " * @param res",
            "lineNumber": 806
          },
          {
            "text": " * @param next",
            "lineNumber": 807
          },
          {
            "text": " */",
            "lineNumber": 808
          },
          {
            "text": "function setDeviceKey(req, res, next) {",
            "lineNumber": 809,
            "isSignature": true
          },
          {
            "text": "    var request = req.MIATARU.request;",
            "lineNumber": 810
          },
          {
            "text": "    var deviceId = request.deviceId();",
            "lineNumber": 811
          },
          {
            "text": "    var currentDeviceKey = request.currentDeviceKey();",
            "lineNumber": 812
          },
          {
            "text": "    var newDeviceKey = request.newDeviceKey();",
            "lineNumber": 813
          },
          {
            "lineNumber": 814
          },
          {
            "text": "    seq()",
            "lineNumber": 815
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 816
          },
          {
            "text": "            var done = this;",
            "lineNumber": 817
          },
          {
            "text": "            // Check if device already has a key set",
            "lineNumber": 818
          },
          {
            "text": "            deviceKeyUtils.getDeviceKey(deviceId, function(error, storedKey) {",
            "lineNumber": 819
          },
          {
            "text": "                if (error) {",
            "lineNumber": 820
          },
          {
            "text": "                    return done(error);",
            "lineNumber": 821
          },
          {
            "text": "                }",
            "lineNumber": 822
          },
          {
            "lineNumber": 823
          },
          {
            "text": "                done.vars = done.vars || {};",
            "lineNumber": 824
          },
          {
            "text": "                done.vars.storedKey = storedKey;",
            "lineNumber": 825
          },
          {
            "text": "                done();",
            "lineNumber": 826
          },
          {
            "text": "            });",
            "lineNumber": 827
          },
          {
            "text": "        })",
            "lineNumber": 828
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 829
          },
          {
            "text": "            var done = this;",
            "lineNumber": 830
          },
          {
            "text": "            var storedKey = (done.vars || {}).storedKey;",
            "lineNumber": 831
          },
          {
            "lineNumber": 832
          },
          {
            "text": "            // If a key exists, validate CurrentDeviceKey",
            "lineNumber": 833
          },
          {
            "text": "            if (storedKey !== null &amp;&amp; storedKey !== undefined) {",
            "lineNumber": 834
          },
          {
            "text": "                // Key exists, so CurrentDeviceKey must be provided and match",
            "lineNumber": 835
          },
          {
            "text": "                if (!currentDeviceKey || currentDeviceKey === null || currentDeviceKey === '') {",
            "lineNumber": 836
          },
          {
            "text": "                    return done(new errors.ForbiddenError('CurrentDeviceKey is required to change existing key'));",
            "lineNumber": 837
          },
          {
            "text": "                }",
            "lineNumber": 838
          },
          {
            "lineNumber": 839
          },
          {
            "text": "                // Validate CurrentDeviceKey matches stored key",
            "lineNumber": 840
          },
          {
            "text": "                deviceKeyUtils.validateDeviceKey(deviceId, currentDeviceKey, function(error, isValid) {",
            "lineNumber": 841
          },
          {
            "text": "                    if (error) {",
            "lineNumber": 842
          },
          {
            "text": "                        return done(error);",
            "lineNumber": 843
          },
          {
            "text": "                    }",
            "lineNumber": 844
          },
          {
            "lineNumber": 845
          },
          {
            "text": "                    if (!isValid) {",
            "lineNumber": 846
          },
          {
            "text": "                        return done(new errors.ForbiddenError('CurrentDeviceKey does not match'));",
            "lineNumber": 847
          },
          {
            "text": "                    }",
            "lineNumber": 848
          },
          {
            "lineNumber": 849
          },
          {
            "text": "                    done();",
            "lineNumber": 850
          },
          {
            "text": "                });",
            "lineNumber": 851
          },
          {
            "text": "            } else {",
            "lineNumber": 852
          },
          {
            "text": "                // No key exists, so CurrentDeviceKey should be null/empty (first-time setup)",
            "lineNumber": 853
          },
          {
            "text": "                // This is allowed, proceed",
            "lineNumber": 854
          },
          {
            "text": "                done();",
            "lineNumber": 855
          },
          {
            "text": "            }",
            "lineNumber": 856
          },
          {
            "text": "        })",
            "lineNumber": 857
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 858
          },
          {
            "text": "            var done = this;",
            "lineNumber": 859
          },
          {
            "text": "            // Set the new key",
            "lineNumber": 860
          },
          {
            "text": "            deviceKeyUtils.setDeviceKey",
            "lineNumber": 861
          },
          {
            "lineNumber": 867
          },
          {
            "lineNumber": 868
          },
          {
            "lineNumber": 871
          },
          {
            "lineNumber": 877
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.41278359293937683
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/API_1.1_SECURITY.md",
        "range": {
          "startPosition": {
            "line": 70
          },
          "endPosition": {
            "line": 156,
            "column": 4
          }
        },
        "contents": "- **UpdateLocation** - Writing location data to the server\n- **GetVisitorHistory** - Accessing visitor history information\n\n### Setting a DeviceKey\n\nUse the &#96;/v1/setDeviceKey&#96; endpoint to set or change a device key:\n\n**First-time setup (no existing key):**\n&#96;&#96;&#96;json\n{\n  \"MiataruSetDeviceKey\": {\n    \"DeviceID\": \"your-device-id\",\n    \"CurrentDeviceKey\": null,\n    \"NewDeviceKey\": \"your-secure-key-here\"\n  }\n}\n&#96;&#96;&#96;\n\n**Changing an existing key:**\n&#96;&#96;&#96;json\n{\n  \"MiataruSetDeviceKey\": {\n    \"DeviceID\": \"your-device-id\",\n    \"CurrentDeviceKey\": \"old-key\",\n    \"NewDeviceKey\": \"new-key\"\n  }\n}\n&#96;&#96;&#96;\n\n### Using DeviceKey in UpdateLocation\n\nWhen a DeviceKey is set for a device, it must be included in each &#96;MiataruLocation&#96; element:\n\n&#96;&#96;&#96;json\n{\n  \"MiataruLocation\": [\n    {\n      \"Device\": \"your-device-id\",\n      \"DeviceKey\": \"your-secure-key-here\",\n      \"Timestamp\": \"1376735651302\",\n      \"Longitude\": \"10.837502\",\n      \"Latitude\": \"49.828925\",\n      \"HorizontalAccuracy\": \"50.00\"\n    }\n  ]\n}\n&#96;&#96;&#96;\n\n**Important:** The DeviceKey parameter should be placed right under the Device parameter in the MiataruLocation array element.\n\n### Using DeviceKey in GetVisitorHistory\n\nWhen a DeviceKey is set for a device, it must be included in the request:\n\n&#96;&#96;&#96;json\n{\n  \"MiataruGetVisitorHistory\": {\n    \"Device\": \"your-device-id\",\n    \"Amount\": \"10\",\n    \"DeviceKey\": \"your-secure-key-here\"\n  }\n}\n&#96;&#96;&#96;\n\n### Error Responses\n\n- **403 Forbidden** - Returned when:\n  - DeviceKey is required but not provided\n  - DeviceKey does not match the stored key\n  - CurrentDeviceKey does not match when changing an existing key\n\n## Allowed Devices List\n\nThe allowed devices list controls which devices can access location and location history data for a specific device. This provides granular access control:\n\n- **hasCurrentLocationAccess** - Permission to access current location via GetLocation\n- **hasHistoryAccess** - Permission to access location history via GetLocationHistory\n\n### Setting Allowed Devices List\n\nUse the &#96;/v1/setAllowedDeviceList&#96; endpoint to set or update the allowed devices list:\n\n&#96;&#96;&#96;json\n{\n  \"MiataruSetAllowedDeviceList\": {\n    ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- **UpdateLocation** - Writing location data to the server",
            "lineNumber": 72
          },
          {
            "text": "- **GetVisitorHistory** - Accessing visitor history information",
            "lineNumber": 73
          },
          {
            "lineNumber": 74
          },
          {
            "text": "### Setting a DeviceKey",
            "lineNumber": 75
          },
          {
            "lineNumber": 76
          },
          {
            "text": "Use the &#96;/v1/setDeviceKey&#96; endpoint to set or change a device key:",
            "lineNumber": 77
          },
          {
            "lineNumber": 78
          },
          {
            "text": "**First-time setup (no existing key):**",
            "lineNumber": 79
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 80
          },
          {
            "text": "{",
            "lineNumber": 81
          },
          {
            "text": "  \"MiataruSetDeviceKey\": {",
            "lineNumber": 82
          },
          {
            "text": "    \"DeviceID\": \"your-device-id\",",
            "lineNumber": 83
          },
          {
            "text": "    \"CurrentDeviceKey\": null,",
            "lineNumber": 84
          },
          {
            "text": "    \"NewDeviceKey\": \"your-secure-key-here\"",
            "lineNumber": 85
          },
          {
            "text": "  }",
            "lineNumber": 86
          },
          {
            "text": "}",
            "lineNumber": 87
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 88
          },
          {
            "lineNumber": 89
          },
          {
            "text": "**Changing an existing key:**",
            "lineNumber": 90
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 91
          },
          {
            "text": "{",
            "lineNumber": 92
          },
          {
            "text": "  \"MiataruSetDeviceKey\": {",
            "lineNumber": 93
          },
          {
            "text": "    \"DeviceID\": \"your-device-id\",",
            "lineNumber": 94
          },
          {
            "text": "    \"CurrentDeviceKey\": \"old-key\",",
            "lineNumber": 95
          },
          {
            "text": "    \"NewDeviceKey\": \"new-key\"",
            "lineNumber": 96
          },
          {
            "text": "  }",
            "lineNumber": 97
          },
          {
            "text": "}",
            "lineNumber": 98
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 99
          },
          {
            "lineNumber": 100
          },
          {
            "text": "### Using DeviceKey in UpdateLocation",
            "lineNumber": 101
          },
          {
            "lineNumber": 102
          },
          {
            "text": "When a DeviceKey is set for a device, it must be included in each &#96;MiataruLocation&#96; element:",
            "lineNumber": 103
          },
          {
            "lineNumber": 104
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 105
          },
          {
            "text": "{",
            "lineNumber": 106
          },
          {
            "text": "  \"MiataruLocation\": [",
            "lineNumber": 107
          },
          {
            "text": "    {",
            "lineNumber": 108
          },
          {
            "text": "      \"Device\": \"your-device-id\",",
            "lineNumber": 109
          },
          {
            "text": "      \"DeviceKey\": \"your-secure-key-here\",",
            "lineNumber": 110
          },
          {
            "text": "      \"Timestamp\": \"1376735651302\",",
            "lineNumber": 111
          },
          {
            "text": "      \"Longitude\": \"10.837502\",",
            "lineNumber": 112
          },
          {
            "text": "      \"Latitude\": \"49.828925\",",
            "lineNumber": 113
          },
          {
            "text": "      \"HorizontalAccuracy\": \"50.00\"",
            "lineNumber": 114
          },
          {
            "text": "    }",
            "lineNumber": 115
          },
          {
            "text": "  ]",
            "lineNumber": 116
          },
          {
            "text": "}",
            "lineNumber": 117
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 118
          },
          {
            "lineNumber": 119
          },
          {
            "text": "**Important:** The DeviceKey parameter should be placed right under the Device parameter in the MiataruLocation array element.",
            "lineNumber": 120
          },
          {
            "lineNumber": 121
          },
          {
            "text": "### Using DeviceKey in GetVisitorHistory",
            "lineNumber": 122
          },
          {
            "lineNumber": 123
          },
          {
            "text": "When a DeviceKey is set for a device, it must be included in the request:",
            "lineNumber": 124
          },
          {
            "lineNumber": 125
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 126
          },
          {
            "text": "{",
            "lineNumber": 127
          },
          {
            "text": "  \"MiataruGetVisitorHistory\": {",
            "lineNumber": 128
          },
          {
            "text": "    \"Device\": \"your-device-id\",",
            "lineNumber": 129
          },
          {
            "text": "    \"Amount\": \"10\",",
            "lineNumber": 130
          },
          {
            "text": "    \"DeviceKey\": \"your-secure-key-here\"",
            "lineNumber": 131
          },
          {
            "text": "  }",
            "lineNumber": 132
          },
          {
            "text": "}",
            "lineNumber": 133
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 134
          },
          {
            "lineNumber": 135
          },
          {
            "text": "### Error Responses",
            "lineNumber": 136
          },
          {
            "lineNumber": 137
          },
          {
            "text": "- **403 Forbidden** - Returned when:",
            "lineNumber": 138
          },
          {
            "text": "  - DeviceKey is required but not provided",
            "lineNumber": 139
          },
          {
            "text": "  - DeviceKey does not match the stored key",
            "lineNumber": 140
          },
          {
            "text": "  - CurrentDeviceKey does not match when changing an existing key",
            "lineNumber": 141
          },
          {
            "lineNumber": 142
          },
          {
            "text": "## Allowed Devices List",
            "lineNumber": 143
          },
          {
            "lineNumber": 144
          },
          {
            "text": "The allowed devices list controls which devices can access location and location history data for a specific device. This provides granular access control:",
            "lineNumber": 145
          },
          {
            "lineNumber": 146
          },
          {
            "text": "- **hasCurrentLocationAccess** - Permission to access current location via GetLocation",
            "lineNumber": 147
          },
          {
            "text": "- **hasHistoryAccess** - Permission to access location history via GetLocationHistory",
            "lineNumber": 148
          },
          {
            "lineNumber": 149
          },
          {
            "text": "### Setting Allowed Devices List",
            "lineNumber": 150
          },
          {
            "lineNumber": 151
          },
          {
            "text": "Use the &#96;/v1/setAllowedDeviceList&#96; endpoint to set or update the allowed devices list:",
            "lineNumber": 152
          },
          {
            "lineNumber": 153
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 154
          },
          {
            "text": "{",
            "lineNumber": 155
          },
          {
            "text": "  \"MiataruSetAllowedDeviceList\": {",
            "lineNumber": 156
          },
          {
            "text": "    ",
            "lineNumber": 157
          }
        ]
      },
      "score": 0.40408676862716675
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/index.js",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 44,
            "column": 5
          }
        },
        "contents": "var v1 = require('./v1');\nvar errors = require('../../errors');\n\nmodule.exports.install = function(app) {\n\n    ///////////////////////////////////////////\n    ///// API Version 1 ///////////////////////\n    ///////////////////////////////////////////\n    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);\n    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);\n    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\n    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\n    });\n    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\n    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\n    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);\n    app.post('/v1/setDeviceKey', v1.inputParser, v1.setDeviceKey);\n    app.post('/v1/setAllowedDeviceList', v1.inputParser, v1.setAllowedDeviceList);\n\n    ///////////////////////////////////////////\n    ///// API current /////////////////////////\n    ///////////////////////////////////////////\n    app.post('/UpdateLocation', v1.inputParser, v1.updateLocation);\n    app.post('/GetLocation', v1.inputParser, v1.getLocation);\n    app.post('/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);\n    app.get('/GetLocationGeoJSON/:id?',  function(req, res){\n        v1.getLocationGeoJSONGET(req.params.id, res,null);\n    });\n    app.post('/GetLocationHistory', v1.inputParser, v1.getLocationHistory);\n    app.post('/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);\n    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);\n    app.post('/setDeviceKey', v1.inputParser, v1.setDeviceKey);\n    app.post('/setAllowedDeviceList', v1.inputParser, v1.setAllowedDeviceList);\n\n    ///////////////////////////////////////////\n    ///// non-Post /////////////////////////\n    ///////////////////////////////////////////\n    function handleUnsupportedMethod(req, res, next) {\n        if\n    }",
        "signatures": {},
        "detailedLines": [
          {
            "text": "var v1 = require('./v1');",
            "lineNumber": 1
          },
          {
            "text": "var errors = require('../../errors');",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "module.exports.install = function(app) {",
            "lineNumber": 4
          },
          {
            "lineNumber": 5
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 6
          },
          {
            "text": "    ///// API Version 1 ///////////////////////",
            "lineNumber": 7
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 8
          },
          {
            "text": "    app.post('/v1/UpdateLocation', v1.inputParser, v1.updateLocation);",
            "lineNumber": 9
          },
          {
            "text": "    app.post('/v1/GetLocation', v1.inputParser, v1.getLocation);",
            "lineNumber": 10
          },
          {
            "text": "    app.post('/v1/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);",
            "lineNumber": 11
          },
          {
            "text": "    app.get('/v1/GetLocationGeoJSON/:id?',  function(req, res){",
            "lineNumber": 12
          },
          {
            "text": "        v1.getLocationGeoJSONGET(req.params.id, res,null);",
            "lineNumber": 13
          },
          {
            "text": "    });",
            "lineNumber": 14
          },
          {
            "text": "    app.post('/v1/GetLocationHistory', v1.inputParser, v1.getLocationHistory);",
            "lineNumber": 15
          },
          {
            "text": "    app.post('/v1/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);",
            "lineNumber": 16
          },
          {
            "text": "    app.post('/v1/DeleteLocation', v1.inputParser, v1.deleteLocation);",
            "lineNumber": 17
          },
          {
            "text": "    app.post('/v1/setDeviceKey', v1.inputParser, v1.setDeviceKey);",
            "lineNumber": 18
          },
          {
            "text": "    app.post('/v1/setAllowedDeviceList', v1.inputParser, v1.setAllowedDeviceList);",
            "lineNumber": 19
          },
          {
            "lineNumber": 20
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 21
          },
          {
            "text": "    ///// API current /////////////////////////",
            "lineNumber": 22
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 23
          },
          {
            "text": "    app.post('/UpdateLocation', v1.inputParser, v1.updateLocation);",
            "lineNumber": 24
          },
          {
            "text": "    app.post('/GetLocation', v1.inputParser, v1.getLocation);",
            "lineNumber": 25
          },
          {
            "text": "    app.post('/GetLocationGeoJSON', v1.inputParser, v1.getLocationGeoJSON);",
            "lineNumber": 26
          },
          {
            "text": "    app.get('/GetLocationGeoJSON/:id?',  function(req, res){",
            "lineNumber": 27
          },
          {
            "text": "        v1.getLocationGeoJSONGET(req.params.id, res,null);",
            "lineNumber": 28
          },
          {
            "text": "    });",
            "lineNumber": 29
          },
          {
            "text": "    app.post('/GetLocationHistory', v1.inputParser, v1.getLocationHistory);",
            "lineNumber": 30
          },
          {
            "text": "    app.post('/GetVisitorHistory', v1.inputParser, v1.getVisitorHistory);",
            "lineNumber": 31
          },
          {
            "text": "    app.post('/DeleteLocation', v1.inputParser, v1.deleteLocation);",
            "lineNumber": 32
          },
          {
            "text": "    app.post('/setDeviceKey', v1.inputParser, v1.setDeviceKey);",
            "lineNumber": 33
          },
          {
            "text": "    app.post('/setAllowedDeviceList', v1.inputParser, v1.setAllowedDeviceList);",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 36
          },
          {
            "text": "    ///// non-Post /////////////////////////",
            "lineNumber": 37
          },
          {
            "text": "    ///////////////////////////////////////////",
            "lineNumber": 38
          },
          {
            "text": "    function handleUnsupportedMethod(req, res, next) {",
            "lineNumber": 39
          },
          {
            "text": "        if",
            "lineNumber": 40
          },
          {
            "text": "    }",
            "lineNumber": 45
          }
        ]
      },
      "score": 0.4025717079639435
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/inputParser.js",
        "range": {
          "startPosition": {
            "column": 61
          },
          "endPosition": {
            "line": 71,
            "column": 1
          }
        },
        "contents": "var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');\nvar RequestLocation = require('../../../models/RequestLocation');\nvar RequestDevice = require('../../../models/RequestDevice');\nvar RequestLocationHistory = require('../../../models/RequestLocationHistory');\nvar RequestVisitorHistory = require('../../../models/RequestVisitorHistory');\nvar RequestSetDeviceKey = require('../../../models/RequestSetDeviceKey');\nvar RequestSetAllowedDeviceList = require('../../../models/RequestSetAllowedDeviceList');\n\nmodule.exports = function(req, res, next) {\n    req.MIATARU = req.MIATARU || {};\n\n    var nextError;\n\n    try {\n        switch(req.path) {\n            case '/UpdateLocation':\n            case '/v1/UpdateLocation':\n                parseUpdateLocation(req);\n                break;\n            case '/GetLocation':\n            case '/v1/GetLocation':\n                parseGetLocations(req);\n                break;\n            case '/GetLocationGeoJSON':\n            case '/v1/GetLocationGeoJSON':\n                parseGetLocationsGeoJSON(req);\n                break;\n            case '/GetLocationHistory':\n            case '/v1/GetLocationHistory':\n                parseGetLocationHistory(req);\n                break;\n            case '/v1/GetVisitorHistory':\n            case '/GetVisitorHistory':\n                parseGetVisitorHistory(req);\n                break;\n            case '/DeleteLocation':\n            case '/v1/DeleteLocation':\n                parseDeleteLocation(req);\n                break;\n            case '/setDeviceKey':\n            case '/v1/setDeviceKey':\n                parseSetDeviceKey(req);\n                break;\n            case '/setAllowedDeviceList':\n            case '/v1/setAllowedDeviceList':\n                parseSetAllowedDeviceList(req);\n                break;\n        }\n    }\n    catch(error) {\n        nextError = error;\n    }\n\n    next(nextError);\n};\n\nfunction parseUpdateLocation(req) {\n    var locations = req.body['MiataruLocation'];\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "var RequestConfigGetLocation = require('../../../models/RequestConfigGetLocation');",
            "lineNumber": 2
          },
          {
            "text": "var RequestLocation = require('../../../models/RequestLocation');",
            "lineNumber": 3
          },
          {
            "text": "var RequestDevice = require('../../../models/RequestDevice');",
            "lineNumber": 4
          },
          {
            "text": "var RequestLocationHistory = require('../../../models/RequestLocationHistory');",
            "lineNumber": 5
          },
          {
            "text": "var RequestVisitorHistory = require('../../../models/RequestVisitorHistory');",
            "lineNumber": 6
          },
          {
            "text": "var RequestSetDeviceKey = require('../../../models/RequestSetDeviceKey');",
            "lineNumber": 7
          },
          {
            "text": "var RequestSetAllowedDeviceList = require('../../../models/RequestSetAllowedDeviceList');",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "module.exports = function(req, res, next) {",
            "lineNumber": 10
          },
          {
            "text": "    req.MIATARU = req.MIATARU || {};",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "    var nextError;",
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "text": "    try {",
            "lineNumber": 15
          },
          {
            "text": "        switch(req.path) {",
            "lineNumber": 16
          },
          {
            "text": "            case '/UpdateLocation':",
            "lineNumber": 17
          },
          {
            "text": "            case '/v1/UpdateLocation':",
            "lineNumber": 18
          },
          {
            "text": "                parseUpdateLocation(req);",
            "lineNumber": 19
          },
          {
            "text": "                break;",
            "lineNumber": 20
          },
          {
            "text": "            case '/GetLocation':",
            "lineNumber": 21
          },
          {
            "text": "            case '/v1/GetLocation':",
            "lineNumber": 22
          },
          {
            "text": "                parseGetLocations(req);",
            "lineNumber": 23
          },
          {
            "text": "                break;",
            "lineNumber": 24
          },
          {
            "text": "            case '/GetLocationGeoJSON':",
            "lineNumber": 25
          },
          {
            "text": "            case '/v1/GetLocationGeoJSON':",
            "lineNumber": 26
          },
          {
            "text": "                parseGetLocationsGeoJSON(req);",
            "lineNumber": 27
          },
          {
            "text": "                break;",
            "lineNumber": 28
          },
          {
            "text": "            case '/GetLocationHistory':",
            "lineNumber": 29
          },
          {
            "text": "            case '/v1/GetLocationHistory':",
            "lineNumber": 30
          },
          {
            "text": "                parseGetLocationHistory(req);",
            "lineNumber": 31
          },
          {
            "text": "                break;",
            "lineNumber": 32
          },
          {
            "text": "            case '/v1/GetVisitorHistory':",
            "lineNumber": 33
          },
          {
            "text": "            case '/GetVisitorHistory':",
            "lineNumber": 34
          },
          {
            "text": "                parseGetVisitorHistory(req);",
            "lineNumber": 35
          },
          {
            "text": "                break;",
            "lineNumber": 36
          },
          {
            "text": "            case '/DeleteLocation':",
            "lineNumber": 37
          },
          {
            "text": "            case '/v1/DeleteLocation':",
            "lineNumber": 38
          },
          {
            "text": "                parseDeleteLocation(req);",
            "lineNumber": 39
          },
          {
            "text": "                break;",
            "lineNumber": 40
          },
          {
            "text": "            case '/setDeviceKey':",
            "lineNumber": 41
          },
          {
            "text": "            case '/v1/setDeviceKey':",
            "lineNumber": 42
          },
          {
            "text": "                parseSetDeviceKey(req);",
            "lineNumber": 43
          },
          {
            "text": "                break;",
            "lineNumber": 44
          },
          {
            "text": "            case '/setAllowedDeviceList':",
            "lineNumber": 45
          },
          {
            "text": "            case '/v1/setAllowedDeviceList':",
            "lineNumber": 46
          },
          {
            "text": "                parseSetAllowedDeviceList(req);",
            "lineNumber": 47
          },
          {
            "text": "                break;",
            "lineNumber": 48
          },
          {
            "text": "        }",
            "lineNumber": 49
          },
          {
            "text": "    }",
            "lineNumber": 50
          },
          {
            "text": "    catch(error) {",
            "lineNumber": 51
          },
          {
            "text": "        nextError = error;",
            "lineNumber": 52
          },
          {
            "text": "    }",
            "lineNumber": 53
          },
          {
            "lineNumber": 54
          },
          {
            "text": "    next(nextError);",
            "lineNumber": 55
          },
          {
            "text": "};",
            "lineNumber": 56
          },
          {
            "lineNumber": 57
          },
          {
            "text": "function parseUpdateLocation(req) {",
            "lineNumber": 58,
            "isSignature": true
          },
          {
            "text": "    var locations = req.body['MiataruLocation'];",
            "lineNumber": 59
          },
          {
            "text": "}",
            "lineNumber": 72,
            "isSignature": true
          }
        ]
      },
      "score": 0.3988243043422699
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 746,
            "column": 1
          },
          "endPosition": {
            "line": 807,
            "column": 3
          }
        },
        "contents": "/**\n * DeleteLocation\n * Deletes all location data (current and historical) for a device\n * @param req\n * @param res\n * @param next\n */\nfunction deleteLocation(req, res, next) {\n    var locationRequest = req.MIATARU.request;\n    var deviceId = locationRequest.device();\n    \n    var lastKey = kb.build(deviceId, KEY_LAST);\n    var historyKey = kb.build(deviceId, KEY_HISTORY);\n    var visitKey = kb.build(deviceId, KEY_VISIT);\n    \n    var deletedCount = 0;\n\n    seq()\n        // Delete last known location\n        .par(function() {\n            var done = this;\n            db.del(lastKey, function(error, reply) {\n                if (error) return done(error);\n                if (reply &gt; 0) deletedCount++;\n                done();\n            });\n        })\n        // Delete location history\n        .par(function() {\n            var done = this;\n            db.del(historyKey, function(error, reply) {\n                if (error) return done(error);\n                if (reply &gt; 0) deletedCount++;\n                done();\n            });\n        })\n        // Delete visitor history\n        .par(function() {\n            var done = this;\n            db.del(visitKey, function(error, reply) {\n                if (error) return done(error);\n                if (reply &gt; 0) deletedCount++;\n                done();\n            });\n        })\n        .seq(function() {\n            res.send((new models.ResponseDeleteLocation(deviceId, deletedCount)).data());\n        })\n        .catch(function(error) {\n            next(new errors.InternalServerError(error));\n        });\n}\n\n/**\n * SetDeviceKey\n * Sets or changes the device key for a device\n * @param req\n * @param res\n * @param next\n */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 749
          },
          {
            "text": " * DeleteLocation",
            "lineNumber": 750
          },
          {
            "text": " * Deletes all location data (current and historical) for a device",
            "lineNumber": 751
          },
          {
            "text": " * @param req",
            "lineNumber": 752
          },
          {
            "text": " * @param res",
            "lineNumber": 753
          },
          {
            "text": " * @param next",
            "lineNumber": 754
          },
          {
            "text": " */",
            "lineNumber": 755
          },
          {
            "text": "function deleteLocation(req, res, next) {",
            "lineNumber": 756,
            "isSignature": true
          },
          {
            "text": "    var locationRequest = req.MIATARU.request;",
            "lineNumber": 757
          },
          {
            "text": "    var deviceId = locationRequest.device();",
            "lineNumber": 758
          },
          {
            "text": "    ",
            "lineNumber": 759
          },
          {
            "text": "    var lastKey = kb.build(deviceId, KEY_LAST);",
            "lineNumber": 760
          },
          {
            "text": "    var historyKey = kb.build(deviceId, KEY_HISTORY);",
            "lineNumber": 761
          },
          {
            "text": "    var visitKey = kb.build(deviceId, KEY_VISIT);",
            "lineNumber": 762
          },
          {
            "text": "    ",
            "lineNumber": 763
          },
          {
            "text": "    var deletedCount = 0;",
            "lineNumber": 764
          },
          {
            "lineNumber": 765
          },
          {
            "text": "    seq()",
            "lineNumber": 766
          },
          {
            "text": "        // Delete last known location",
            "lineNumber": 767
          },
          {
            "text": "        .par(function() {",
            "lineNumber": 768
          },
          {
            "text": "            var done = this;",
            "lineNumber": 769
          },
          {
            "text": "            db.del(lastKey, function(error, reply) {",
            "lineNumber": 770
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 771
          },
          {
            "text": "                if (reply &gt; 0) deletedCount++;",
            "lineNumber": 772
          },
          {
            "text": "                done();",
            "lineNumber": 773
          },
          {
            "text": "            });",
            "lineNumber": 774
          },
          {
            "text": "        })",
            "lineNumber": 775
          },
          {
            "text": "        // Delete location history",
            "lineNumber": 776
          },
          {
            "text": "        .par(function() {",
            "lineNumber": 777
          },
          {
            "text": "            var done = this;",
            "lineNumber": 778
          },
          {
            "text": "            db.del(historyKey, function(error, reply) {",
            "lineNumber": 779
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 780
          },
          {
            "text": "                if (reply &gt; 0) deletedCount++;",
            "lineNumber": 781
          },
          {
            "text": "                done();",
            "lineNumber": 782
          },
          {
            "text": "            });",
            "lineNumber": 783
          },
          {
            "text": "        })",
            "lineNumber": 784
          },
          {
            "text": "        // Delete visitor history",
            "lineNumber": 785
          },
          {
            "text": "        .par(function() {",
            "lineNumber": 786
          },
          {
            "text": "            var done = this;",
            "lineNumber": 787
          },
          {
            "text": "            db.del(visitKey, function(error, reply) {",
            "lineNumber": 788
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 789
          },
          {
            "text": "                if (reply &gt; 0) deletedCount++;",
            "lineNumber": 790
          },
          {
            "text": "                done();",
            "lineNumber": 791
          },
          {
            "text": "            });",
            "lineNumber": 792
          },
          {
            "text": "        })",
            "lineNumber": 793
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 794
          },
          {
            "text": "            res.send((new models.ResponseDeleteLocation(deviceId, deletedCount)).data());",
            "lineNumber": 795
          },
          {
            "text": "        })",
            "lineNumber": 796
          },
          {
            "text": "        .catch(function(error) {",
            "lineNumber": 797
          },
          {
            "text": "            next(new errors.InternalServerError(error));",
            "lineNumber": 798
          },
          {
            "text": "        });",
            "lineNumber": 799
          },
          {
            "text": "}",
            "lineNumber": 800,
            "isSignature": true
          },
          {
            "lineNumber": 801
          },
          {
            "text": "/**",
            "lineNumber": 802
          },
          {
            "text": " * SetDeviceKey",
            "lineNumber": 803
          },
          {
            "text": " * Sets or changes the device key for a device",
            "lineNumber": 804
          },
          {
            "text": " * @param req",
            "lineNumber": 805
          },
          {
            "text": " * @param res",
            "lineNumber": 806
          },
          {
            "text": " * @param next",
            "lineNumber": 807
          },
          {
            "text": " */",
            "lineNumber": 808
          }
        ]
      },
      "score": 0.3952929973602295
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/swagger.yaml",
        "range": {
          "startPosition": {
            "line": 29
          },
          "endPosition": {
            "line": 76
          }
        },
        "contents": "paths:\n /UpdateLocation:\n  post:\n   tags:\n   - updateLocation\n   description: |\n     This method is used to update the location of a device. The device does not need to be known already to the Miataru server but it rather creates a unique identifier for itself in the client application. This unique identifier, or device ID is then used to address this particular device.\n     \n     API 1.1: If a DeviceKey has been set for a device (via /setDeviceKey), the DeviceKey parameter must be provided in each MiataruLocation element and must match the stored key. If the keys do not match, a 403 Forbidden error is returned.\n   operationId: updateLocation\n   produces:\n   - application/json\n   parameters:\n   - name: body\n     in: body\n     description: the body of this UpdateLocation POST request contains the JSON formatted parameters.\n     required: true\n     schema:\n      $ref: '#/definitions/MiataruUpdateLocationRequest'\n   responses:\n    200:\n     description: successful request\n     schema:\n      $ref: '#/definitions/ACK'\n    403:\n     description: Forbidden - DeviceKey mismatch or missing when required\n     schema:\n      $ref: '#/definitions/Error'\n /GetLocation:\n  post:\n   tags:\n   - getLocation\n   description: |\n     To retrieve a specific devices latest known location the /GetLocation method is used.\n     \n     API 1.1 BREAKING CHANGE: RequestMiataruDeviceID is now mandatory. Requests without RequestMiataruDeviceID will return 400 Bad Request.\n     \n     RequestMiataruDeviceID should be the ID of the device the request is sent from (or an identifier like an URL). This is used for access control and visitor history tracking.\n     \n     API 1.1: If an allowed devices list has been set for a device (via /setAllowedDeviceList), only devices with hasCurrentLocationAccess permission will receive location data. Devices without permission will receive the location as if the device doesn't exist.\n   operationId: getLocation\n   produces:\n   - application/json\n   parameters:\n   - name: body\n     in: body\n     description: the complex JSON formatted datastructure to get the location of one or more devices.",
        "signatures": {},
        "detailedLines": [
          {
            "text": "paths:",
            "lineNumber": 30
          },
          {
            "text": " /UpdateLocation:",
            "lineNumber": 31
          },
          {
            "text": "  post:",
            "lineNumber": 32
          },
          {
            "text": "   tags:",
            "lineNumber": 33
          },
          {
            "text": "   - updateLocation",
            "lineNumber": 34
          },
          {
            "text": "   description: |",
            "lineNumber": 35
          },
          {
            "text": "     This method is used to update the location of a device. The device does not need to be known already to the Miataru server but it rather creates a unique identifier for itself in the client application. This unique identifier, or device ID is then used to address this particular device.",
            "lineNumber": 36
          },
          {
            "text": "     ",
            "lineNumber": 37
          },
          {
            "text": "     API 1.1: If a DeviceKey has been set for a device (via /setDeviceKey), the DeviceKey parameter must be provided in each MiataruLocation element and must match the stored key. If the keys do not match, a 403 Forbidden error is returned.",
            "lineNumber": 38
          },
          {
            "text": "   operationId: updateLocation",
            "lineNumber": 39
          },
          {
            "text": "   produces:",
            "lineNumber": 40
          },
          {
            "text": "   - application/json",
            "lineNumber": 41
          },
          {
            "text": "   parameters:",
            "lineNumber": 42
          },
          {
            "text": "   - name: body",
            "lineNumber": 43
          },
          {
            "text": "     in: body",
            "lineNumber": 44
          },
          {
            "text": "     description: the body of this UpdateLocation POST request contains the JSON formatted parameters.",
            "lineNumber": 45
          },
          {
            "text": "     required: true",
            "lineNumber": 46
          },
          {
            "text": "     schema:",
            "lineNumber": 47
          },
          {
            "text": "      $ref: '#/definitions/MiataruUpdateLocationRequest'",
            "lineNumber": 48
          },
          {
            "text": "   responses:",
            "lineNumber": 49
          },
          {
            "text": "    200:",
            "lineNumber": 50
          },
          {
            "text": "     description: successful request",
            "lineNumber": 51
          },
          {
            "text": "     schema:",
            "lineNumber": 52
          },
          {
            "text": "      $ref: '#/definitions/ACK'",
            "lineNumber": 53
          },
          {
            "text": "    403:",
            "lineNumber": 54
          },
          {
            "text": "     description: Forbidden - DeviceKey mismatch or missing when required",
            "lineNumber": 55
          },
          {
            "text": "     schema:",
            "lineNumber": 56
          },
          {
            "text": "      $ref: '#/definitions/Error'",
            "lineNumber": 57
          },
          {
            "text": " /GetLocation:",
            "lineNumber": 58
          },
          {
            "text": "  post:",
            "lineNumber": 59
          },
          {
            "text": "   tags:",
            "lineNumber": 60
          },
          {
            "text": "   - getLocation",
            "lineNumber": 61
          },
          {
            "text": "   description: |",
            "lineNumber": 62
          },
          {
            "text": "     To retrieve a specific devices latest known location the /GetLocation method is used.",
            "lineNumber": 63
          },
          {
            "text": "     ",
            "lineNumber": 64
          },
          {
            "text": "     API 1.1 BREAKING CHANGE: RequestMiataruDeviceID is now mandatory. Requests without RequestMiataruDeviceID will return 400 Bad Request.",
            "lineNumber": 65
          },
          {
            "text": "     ",
            "lineNumber": 66
          },
          {
            "text": "     RequestMiataruDeviceID should be the ID of the device the request is sent from (or an identifier like an URL). This is used for access control and visitor history tracking.",
            "lineNumber": 67
          },
          {
            "text": "     ",
            "lineNumber": 68
          },
          {
            "text": "     API 1.1: If an allowed devices list has been set for a device (via /setAllowedDeviceList), only devices with hasCurrentLocationAccess permission will receive location data. Devices without permission will receive the location as if the device doesn't exist.",
            "lineNumber": 69
          },
          {
            "text": "   operationId: getLocation",
            "lineNumber": 70
          },
          {
            "text": "   produces:",
            "lineNumber": 71
          },
          {
            "text": "   - application/json",
            "lineNumber": 72
          },
          {
            "text": "   parameters:",
            "lineNumber": 73
          },
          {
            "text": "   - name: body",
            "lineNumber": 74
          },
          {
            "text": "     in: body",
            "lineNumber": 75
          },
          {
            "text": "     description: the complex JSON formatted datastructure to get the location of one or more devices.",
            "lineNumber": 76
          }
        ]
      },
      "score": 0.3865061104297638
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./README.md",
        "range": {
          "startPosition": {
            "line": 28
          },
          "endPosition": {
            "line": 69
          }
        },
        "contents": "By default Miataru does only store the last known location. And it only does that for a pre-defined amount of time. Nothing is written to any disk, everything is in-memory only and only available for a pre-defined time-window.\n\nWith it's simple API it allows you to use Miataru to your own needs and practices.\n\n## API Endpoints\n\nThe Miataru server provides both versioned (v1) and legacy API endpoints for maximum compatibility:\n\n### Version 1 API (Recommended)\n- **POST** &#96;/v1/UpdateLocation&#96; - Store location data\n- **POST** &#96;/v1/GetLocation&#96; - Retrieve current location\n- **POST** &#96;/v1/GetLocationGeoJSON&#96; - Get location in GeoJSON format\n- **GET** &#96;/v1/GetLocationGeoJSON/:id?&#96; - Get location in GeoJSON format via GET\n- **POST** &#96;/v1/GetLocationHistory&#96; - Retrieve location history\n- **POST** &#96;/v1/GetVisitorHistory&#96; - Retrieve visitor history\n- **POST** &#96;/v1/DeleteLocation&#96; - Delete all location data for a device\n- **POST** &#96;/v1/setDeviceKey&#96; - Set or change device key (API 1.1)\n- **POST** &#96;/v1/setAllowedDeviceList&#96; - Manage allowed devices list (API 1.1)\n\n### Legacy API (Backward Compatibility)\n- **POST** &#96;/UpdateLocation&#96; - Store location data\n- **POST** &#96;/GetLocation&#96; - Retrieve current location\n- **POST** &#96;/GetLocationGeoJSON&#96; - Get location in GeoJSON format\n- **GET** &#96;/GetLocationGeoJSON/:id?&#96; - Get location in GeoJSON format via GET\n- **POST** &#96;/GetLocationHistory&#96; - Retrieve location history\n- **POST** &#96;/GetVisitorHistory&#96; - Retrieve visitor history\n- **POST** &#96;/DeleteLocation&#96; - Delete all location data for a device\n- **POST** &#96;/setDeviceKey&#96; - Set or change device key (API 1.1)\n- **POST** &#96;/setAllowedDeviceList&#96; - Manage allowed devices list (API 1.1)\n\n## Security Features (API 1.1)\n\n### DeviceKey Authentication\n\nDeviceKey provides authentication for write operations and visitor history access. Once set, devices must provide the correct DeviceKey to:\n- Update location data\n- Access visitor history\n\nSee [API 1.1 Security Documentation](docs/API_1.1_SECURITY.md) for details.",
        "signatures": {},
        "detailedLines": [
          {
            "text": "By default Miataru does only store the last known location. And it only does that for a pre-defined amount of time. Nothing is written to any disk, everything is in-memory only and only available for a pre-defined time-window.",
            "lineNumber": 30
          },
          {
            "lineNumber": 31
          },
          {
            "text": "With it's simple API it allows you to use Miataru to your own needs and practices.",
            "lineNumber": 32
          },
          {
            "lineNumber": 33
          },
          {
            "text": "## API Endpoints",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "The Miataru server provides both versioned (v1) and legacy API endpoints for maximum compatibility:",
            "lineNumber": 36
          },
          {
            "lineNumber": 37
          },
          {
            "text": "### Version 1 API (Recommended)",
            "lineNumber": 38
          },
          {
            "text": "- **POST** &#96;/v1/UpdateLocation&#96; - Store location data",
            "lineNumber": 39
          },
          {
            "text": "- **POST** &#96;/v1/GetLocation&#96; - Retrieve current location",
            "lineNumber": 40
          },
          {
            "text": "- **POST** &#96;/v1/GetLocationGeoJSON&#96; - Get location in GeoJSON format",
            "lineNumber": 41
          },
          {
            "text": "- **GET** &#96;/v1/GetLocationGeoJSON/:id?&#96; - Get location in GeoJSON format via GET",
            "lineNumber": 42
          },
          {
            "text": "- **POST** &#96;/v1/GetLocationHistory&#96; - Retrieve location history",
            "lineNumber": 43
          },
          {
            "text": "- **POST** &#96;/v1/GetVisitorHistory&#96; - Retrieve visitor history",
            "lineNumber": 44
          },
          {
            "text": "- **POST** &#96;/v1/DeleteLocation&#96; - Delete all location data for a device",
            "lineNumber": 45
          },
          {
            "text": "- **POST** &#96;/v1/setDeviceKey&#96; - Set or change device key (API 1.1)",
            "lineNumber": 46
          },
          {
            "text": "- **POST** &#96;/v1/setAllowedDeviceList&#96; - Manage allowed devices list (API 1.1)",
            "lineNumber": 47
          },
          {
            "lineNumber": 48
          },
          {
            "text": "### Legacy API (Backward Compatibility)",
            "lineNumber": 49
          },
          {
            "text": "- **POST** &#96;/UpdateLocation&#96; - Store location data",
            "lineNumber": 50
          },
          {
            "text": "- **POST** &#96;/GetLocation&#96; - Retrieve current location",
            "lineNumber": 51
          },
          {
            "text": "- **POST** &#96;/GetLocationGeoJSON&#96; - Get location in GeoJSON format",
            "lineNumber": 52
          },
          {
            "text": "- **GET** &#96;/GetLocationGeoJSON/:id?&#96; - Get location in GeoJSON format via GET",
            "lineNumber": 53
          },
          {
            "text": "- **POST** &#96;/GetLocationHistory&#96; - Retrieve location history",
            "lineNumber": 54
          },
          {
            "text": "- **POST** &#96;/GetVisitorHistory&#96; - Retrieve visitor history",
            "lineNumber": 55
          },
          {
            "text": "- **POST** &#96;/DeleteLocation&#96; - Delete all location data for a device",
            "lineNumber": 56
          },
          {
            "text": "- **POST** &#96;/setDeviceKey&#96; - Set or change device key (API 1.1)",
            "lineNumber": 57
          },
          {
            "text": "- **POST** &#96;/setAllowedDeviceList&#96; - Manage allowed devices list (API 1.1)",
            "lineNumber": 58
          },
          {
            "lineNumber": 59
          },
          {
            "text": "## Security Features (API 1.1)",
            "lineNumber": 60
          },
          {
            "lineNumber": 61
          },
          {
            "text": "### DeviceKey Authentication",
            "lineNumber": 62
          },
          {
            "lineNumber": 63
          },
          {
            "text": "DeviceKey provides authentication for write operations and visitor history access. Once set, devices must provide the correct DeviceKey to:",
            "lineNumber": 64
          },
          {
            "text": "- Update location data",
            "lineNumber": 65
          },
          {
            "text": "- Access visitor history",
            "lineNumber": 66
          },
          {
            "lineNumber": 67
          },
          {
            "text": "See [API 1.1 Security Documentation](docs/API_1.1_SECURITY.md) for details.",
            "lineNumber": 68
          }
        ]
      },
      "score": 0.3842639923095703
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 37,
            "column": 3
          }
        },
        "contents": "/*\n\tUpdateLocation POST\n\n\tBy doing a HTTP Post on the /UpdateLocation method of this server you should\n\tbe able to trigger this method here.\n\n\tcurl -H \"Content-Type: application/json\" -X POST http://localhost:3000/UpdateLocation -d '{\"JSON\": \"HERE\"}'\n\n\tcurl -H \"Content-Type: application/json\" -X POST http://localhost:3000/UpdateLocation -d '{\"MiataruConfig\":{\"EnableLocationHistory\":\"Fa\":\"15\"},\"MiataruLocation\":[{\"Device\":\"7b8e6e0ee5296db345162dc2ef652c1350761823\",\"Timestamp\":\"1376735651302\",\"Longitude\":\"10.837502\",\"Latitude\":\"49.828925\",\"HorizontalAccuracy\":\"50.00\"}]}'\n\n\tTo store information Redis is used. The naming conventions are as follows:\n\n\tLast Known Location (expiring key-value): miad:$deviceid:last\n\tLocation History (non expiring list): miad:$deviceid:hist\n */\n\nvar seq = require('seq');\n\nvar configuration = require('../../../configuration');\nvar db = require('../../../db');\nvar kb = require('../../../utils/keyBuilder');\nvar models = require('../../../models');\nvar errors = require('../../../errors');\nvar logger = require('../../../logger');\nvar deviceKeyUtils = require('../../../utils/deviceKey');\nvar allowedDevicesUtils = require('../../../utils/allowedDevices');\n\nvar KEY_HISTORY = 'hist';\nvar KEY_LAST = 'last';\nvar KEY_VISIT = 'visit';\n\n/**\n * Record visitor history entry\n * Handles both detailed (every access) and non-detailed (update existing) modes\n * Executes the operation asynchronously (fire-and-forget)\n * @param {string} visitKey - Redis key for visitor history\n * @param {string} visitValue - JSON stringified visitor object\n */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/*",
            "lineNumber": 1
          },
          {
            "text": "\tUpdateLocation POST",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "\tBy doing a HTTP Post on the /UpdateLocation method of this server you should",
            "lineNumber": 4
          },
          {
            "text": "\tbe able to trigger this method here.",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "\tcurl -H \"Content-Type: application/json\" -X POST http://localhost:3000/UpdateLocation -d '{\"JSON\": \"HERE\"}'",
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "\tcurl -H \"Content-Type: application/json\" -X POST http://localhost:3000/UpdateLocation -d '{\"MiataruConfig\":{\"EnableLocationHistory\":\"Fa\":\"15\"},\"MiataruLocation\":[{\"Device\":\"7b8e6e0ee5296db345162dc2ef652c1350761823\",\"Timestamp\":\"1376735651302\",\"Longitude\":\"10.837502\",\"Latitude\":\"49.828925\",\"HorizontalAccuracy\":\"50.00\"}]}'",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "\tTo store information Redis is used. The naming conventions are as follows:",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "\tLast Known Location (expiring key-value): miad:$deviceid:last",
            "lineNumber": 13
          },
          {
            "text": "\tLocation History (non expiring list): miad:$deviceid:hist",
            "lineNumber": 14
          },
          {
            "text": " */",
            "lineNumber": 15
          },
          {
            "lineNumber": 16
          },
          {
            "text": "var seq = require('seq');",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "var configuration = require('../../../configuration');",
            "lineNumber": 19
          },
          {
            "text": "var db = require('../../../db');",
            "lineNumber": 20
          },
          {
            "text": "var kb = require('../../../utils/keyBuilder');",
            "lineNumber": 21
          },
          {
            "text": "var models = require('../../../models');",
            "lineNumber": 22
          },
          {
            "text": "var errors = require('../../../errors');",
            "lineNumber": 23
          },
          {
            "text": "var logger = require('../../../logger');",
            "lineNumber": 24
          },
          {
            "text": "var deviceKeyUtils = require('../../../utils/deviceKey');",
            "lineNumber": 25
          },
          {
            "text": "var allowedDevicesUtils = require('../../../utils/allowedDevices');",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "var KEY_HISTORY = 'hist';",
            "lineNumber": 28
          },
          {
            "text": "var KEY_LAST = 'last';",
            "lineNumber": 29
          },
          {
            "text": "var KEY_VISIT = 'visit';",
            "lineNumber": 30
          },
          {
            "lineNumber": 31
          },
          {
            "text": "/**",
            "lineNumber": 32
          },
          {
            "text": " * Record visitor history entry",
            "lineNumber": 33
          },
          {
            "text": " * Handles both detailed (every access) and non-detailed (update existing) modes",
            "lineNumber": 34
          },
          {
            "text": " * Executes the operation asynchronously (fire-and-forget)",
            "lineNumber": 35
          },
          {
            "text": " * @param {string} visitKey - Redis key for visitor history",
            "lineNumber": 36
          },
          {
            "text": " * @param {string} visitValue - JSON stringified visitor object",
            "lineNumber": 37
          },
          {
            "text": " */",
            "lineNumber": 38
          }
        ]
      },
      "score": 0.37985873222351074
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/CLIENT_ADOPTION_API_1.1.md",
        "range": {
          "startPosition": {
            "line": 211
          },
          "endPosition": {
            "line": 260,
            "column": 12
          }
        },
        "contents": "&#96;&#96;&#96;swift\nfunc setupDeviceKey(deviceID: String, completion: @escaping (Result&lt;String, Error&gt;) -&gt; Void) {\n    // Generate new key\n    let newKey = generateDeviceKey()\n    \n    // Set on server (first time, no CurrentDeviceKey)\n    setDeviceKey(deviceID: deviceID, currentKey: nil, newKey: newKey) { result in\n        switch result {\n        case .success:\n            completion(.success(newKey))\n        case .failure(let error):\n            completion(.failure(error))\n        }\n    }\n}\n&#96;&#96;&#96;\n\n## Step 3: Update UpdateLocation Request\n\n### 3.1 Modify UpdateLocation to Include DeviceKey\n\nUpdate your existing UpdateLocation method to include DeviceKey when available:\n\n&#96;&#96;&#96;swift\nfunc updateLocation(deviceID: String, location: Location, completion: @escaping (Result&lt;Void, Error&gt;) -&gt; Void) {\n    // Get DeviceKey from keychain\n    let deviceKey = DeviceKeyManager.shared.getDeviceKey(for: deviceID)\n    \n    var locationData: [String: Any] = [\n        \"Device\": deviceID,\n        \"Timestamp\": String(Int(location.timestamp.timeIntervalSince1970 * 1000)),\n        \"Longitude\": String(location.longitude),\n        \"Latitude\": String(location.latitude),\n        \"HorizontalAccuracy\": String(location.horizontalAccuracy)\n    ]\n    \n    // Add DeviceKey if available (API 1.1)\n    if let deviceKey = deviceKey {\n        locationData[\"DeviceKey\"] = deviceKey\n    }\n    \n    let requestBody: [String: Any] = [\n        \"MiataruLocation\": [locationData]\n    ]\n    \n    makeAPICall(endpoint: \"/v1/UpdateLocation\", method: \"POST\", body: requestBody) { result in\n        switch result {\n        case .success(let response):\n            ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "&#96;&#96;&#96;swift",
            "lineNumber": 213
          },
          {
            "text": "func setupDeviceKey(deviceID: String, completion: @escaping (Result&lt;String, Error&gt;) -&gt; Void) {",
            "lineNumber": 214
          },
          {
            "text": "    // Generate new key",
            "lineNumber": 215
          },
          {
            "text": "    let newKey = generateDeviceKey()",
            "lineNumber": 216
          },
          {
            "text": "    ",
            "lineNumber": 217
          },
          {
            "text": "    // Set on server (first time, no CurrentDeviceKey)",
            "lineNumber": 218
          },
          {
            "text": "    setDeviceKey(deviceID: deviceID, currentKey: nil, newKey: newKey) { result in",
            "lineNumber": 219
          },
          {
            "text": "        switch result {",
            "lineNumber": 220
          },
          {
            "text": "        case .success:",
            "lineNumber": 221
          },
          {
            "text": "            completion(.success(newKey))",
            "lineNumber": 222
          },
          {
            "text": "        case .failure(let error):",
            "lineNumber": 223
          },
          {
            "text": "            completion(.failure(error))",
            "lineNumber": 224
          },
          {
            "text": "        }",
            "lineNumber": 225
          },
          {
            "text": "    }",
            "lineNumber": 226
          },
          {
            "text": "}",
            "lineNumber": 227
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 228
          },
          {
            "lineNumber": 229
          },
          {
            "text": "## Step 3: Update UpdateLocation Request",
            "lineNumber": 230
          },
          {
            "lineNumber": 231
          },
          {
            "text": "### 3.1 Modify UpdateLocation to Include DeviceKey",
            "lineNumber": 232
          },
          {
            "lineNumber": 233
          },
          {
            "text": "Update your existing UpdateLocation method to include DeviceKey when available:",
            "lineNumber": 234
          },
          {
            "lineNumber": 235
          },
          {
            "text": "&#96;&#96;&#96;swift",
            "lineNumber": 236
          },
          {
            "text": "func updateLocation(deviceID: String, location: Location, completion: @escaping (Result&lt;Void, Error&gt;) -&gt; Void) {",
            "lineNumber": 237
          },
          {
            "text": "    // Get DeviceKey from keychain",
            "lineNumber": 238
          },
          {
            "text": "    let deviceKey = DeviceKeyManager.shared.getDeviceKey(for: deviceID)",
            "lineNumber": 239
          },
          {
            "text": "    ",
            "lineNumber": 240
          },
          {
            "text": "    var locationData: [String: Any] = [",
            "lineNumber": 241
          },
          {
            "text": "        \"Device\": deviceID,",
            "lineNumber": 242
          },
          {
            "text": "        \"Timestamp\": String(Int(location.timestamp.timeIntervalSince1970 * 1000)),",
            "lineNumber": 243
          },
          {
            "text": "        \"Longitude\": String(location.longitude),",
            "lineNumber": 244
          },
          {
            "text": "        \"Latitude\": String(location.latitude),",
            "lineNumber": 245
          },
          {
            "text": "        \"HorizontalAccuracy\": String(location.horizontalAccuracy)",
            "lineNumber": 246
          },
          {
            "text": "    ]",
            "lineNumber": 247
          },
          {
            "text": "    ",
            "lineNumber": 248
          },
          {
            "text": "    // Add DeviceKey if available (API 1.1)",
            "lineNumber": 249
          },
          {
            "text": "    if let deviceKey = deviceKey {",
            "lineNumber": 250
          },
          {
            "text": "        locationData[\"DeviceKey\"] = deviceKey",
            "lineNumber": 251
          },
          {
            "text": "    }",
            "lineNumber": 252
          },
          {
            "text": "    ",
            "lineNumber": 253
          },
          {
            "text": "    let requestBody: [String: Any] = [",
            "lineNumber": 254
          },
          {
            "text": "        \"MiataruLocation\": [locationData]",
            "lineNumber": 255
          },
          {
            "text": "    ]",
            "lineNumber": 256
          },
          {
            "text": "    ",
            "lineNumber": 257
          },
          {
            "text": "    makeAPICall(endpoint: \"/v1/UpdateLocation\", method: \"POST\", body: requestBody) { result in",
            "lineNumber": 258
          },
          {
            "text": "        switch result {",
            "lineNumber": 259
          },
          {
            "text": "        case .success(let response):",
            "lineNumber": 260
          },
          {
            "text": "            ",
            "lineNumber": 261
          }
        ]
      },
      "score": 0.37973785400390625
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/PRD.md",
        "range": {
          "startPosition": {
            "line": 16
          },
          "endPosition": {
            "line": 36
          }
        },
        "contents": "- **Operations/QA**: rely on tests and observability for stability under load. (Evidence: README.md L434-L480; tests/integration/httpRateLimiter.tests.js L10-L110; tests/unit/redisRateLimiter.tests.js L9-L123)\n\n## 3. Functional Requirements\n\n### FR-001: Update location data (current + optional history)\n- **Priority**: Must\n- **Description**: The server shall accept UpdateLocation requests and store the last known location, optionally storing history when enabled.\n- **Inputs / Triggers**: HTTP POST &#96;/v1/UpdateLocation&#96; or &#96;/UpdateLocation&#96; with &#96;MiataruLocation&#96; array and optional &#96;MiataruConfig&#96; containing &#96;EnableLocationHistory&#96; and &#96;LocationDataRetentionTime&#96;. (Evidence: README.md L27-L43, L64-L70; lib/routes/location/index.js L9-L23; lib/routes/location/v1/inputParser.js L48-L62)\n- **Outputs / Effects**: Writes to Redis last location key; when history enabled, appends to history list and trims to configured max; when disabled, deletes history and sets TTL on last location. (Evidence: lib/routes/location/v1/location.js L290-L335; config/default.js L31-L33)\n- **Acceptance Criteria**:\n  - When &#96;EnableLocationHistory&#96; is true, history list grows and is trimmed to &#96;maximumNumberOfHistoryItems&#96;. (Evidence: lib/routes/location/v1/location.js L297-L311; config/default.js L31-L33)\n  - When &#96;EnableLocationHistory&#96; is false, only last known location is stored with TTL derived from &#96;LocationDataRetentionTime&#96;. (Evidence: lib/routes/location/v1/location.js L320-L335; lib/models/RequestConfig.js L6-L34)\n  - Returns &#96;MiataruResponse: ACK&#96; on success. (Evidence: lib/models/ResponseUpdateLocation.js L5-L9; tests/integration/newFields.tests.js L9-L29)\n- **Evidence pointers**: README.md L64-L70; lib/routes/location/v1/location.js L290-L343; tests/integration/newFields.tests.js L9-L73.\n\n### FR-002: Get current location data\n- **Priority**: Must\n- **Description**: The server shall return the last known location for each requested device.\n- **Inputs / Triggers**: HTTP POST &#96;/v1/GetLocation&#96; or &#96;/GetLocation&#96; with &#96;MiataruGetLocation&#96; array; optional &#96;MiataruConfig.RequestMiataruDeviceID&#96; for visitor tracking. (Evidence: README.md L27-L43, L72-L76; lib/routes/location/index.js L10-L23; lib/routes/location/v1/inputParser.js L64-L75)\n- **Outputs / Effects**: Returns &#96;MiataruLocation&#96; array with entries or null if missing; may record visitor history per config. (Evidence: lib/routes/location/v1/location.js L354-L398; lib/models/ResponseLocation.js L9-L13)",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- **Operations/QA**: rely on tests and observability for stability under load. (Evidence: README.md L434-L480; tests/integration/httpRateLimiter.tests.js L10-L110; tests/unit/redisRateLimiter.tests.js L9-L123)",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "## 3. Functional Requirements",
            "lineNumber": 19
          },
          {
            "lineNumber": 20
          },
          {
            "text": "### FR-001: Update location data (current + optional history)",
            "lineNumber": 21
          },
          {
            "text": "- **Priority**: Must",
            "lineNumber": 22
          },
          {
            "text": "- **Description**: The server shall accept UpdateLocation requests and store the last known location, optionally storing history when enabled.",
            "lineNumber": 23
          },
          {
            "text": "- **Inputs / Triggers**: HTTP POST &#96;/v1/UpdateLocation&#96; or &#96;/UpdateLocation&#96; with &#96;MiataruLocation&#96; array and optional &#96;MiataruConfig&#96; containing &#96;EnableLocationHistory&#96; and &#96;LocationDataRetentionTime&#96;. (Evidence: README.md L27-L43, L64-L70; lib/routes/location/index.js L9-L23; lib/routes/location/v1/inputParser.js L48-L62)",
            "lineNumber": 24
          },
          {
            "text": "- **Outputs / Effects**: Writes to Redis last location key; when history enabled, appends to history list and trims to configured max; when disabled, deletes history and sets TTL on last location. (Evidence: lib/routes/location/v1/location.js L290-L335; config/default.js L31-L33)",
            "lineNumber": 25
          },
          {
            "text": "- **Acceptance Criteria**:",
            "lineNumber": 26
          },
          {
            "text": "  - When &#96;EnableLocationHistory&#96; is true, history list grows and is trimmed to &#96;maximumNumberOfHistoryItems&#96;. (Evidence: lib/routes/location/v1/location.js L297-L311; config/default.js L31-L33)",
            "lineNumber": 27
          },
          {
            "text": "  - When &#96;EnableLocationHistory&#96; is false, only last known location is stored with TTL derived from &#96;LocationDataRetentionTime&#96;. (Evidence: lib/routes/location/v1/location.js L320-L335; lib/models/RequestConfig.js L6-L34)",
            "lineNumber": 28
          },
          {
            "text": "  - Returns &#96;MiataruResponse: ACK&#96; on success. (Evidence: lib/models/ResponseUpdateLocation.js L5-L9; tests/integration/newFields.tests.js L9-L29)",
            "lineNumber": 29
          },
          {
            "text": "- **Evidence pointers**: README.md L64-L70; lib/routes/location/v1/location.js L290-L343; tests/integration/newFields.tests.js L9-L73.",
            "lineNumber": 30
          },
          {
            "lineNumber": 31
          },
          {
            "text": "### FR-002: Get current location data",
            "lineNumber": 32
          },
          {
            "text": "- **Priority**: Must",
            "lineNumber": 33
          },
          {
            "text": "- **Description**: The server shall return the last known location for each requested device.",
            "lineNumber": 34
          },
          {
            "text": "- **Inputs / Triggers**: HTTP POST &#96;/v1/GetLocation&#96; or &#96;/GetLocation&#96; with &#96;MiataruGetLocation&#96; array; optional &#96;MiataruConfig.RequestMiataruDeviceID&#96; for visitor tracking. (Evidence: README.md L27-L43, L72-L76; lib/routes/location/index.js L10-L23; lib/routes/location/v1/inputParser.js L64-L75)",
            "lineNumber": 35
          },
          {
            "text": "- **Outputs / Effects**: Returns &#96;MiataruLocation&#96; array with entries or null if missing; may record visitor history per config. (Evidence: lib/routes/location/v1/location.js L354-L398; lib/models/ResponseLocation.js L9-L13)",
            "lineNumber": 36
          }
        ]
      },
      "score": 0.3747568130493164
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/WHATS_NEW_V2.md",
        "range": {
          "startPosition": {
            "line": 572
          },
          "endPosition": {
            "line": 618
          }
        },
        "contents": "### Compatibility Matrix\n\n| Feature | v1.0 Client | v1.1 Client (No Security) | v1.1 Client (With Security) |\n|---------|------------|---------------------------|------------------------------|\n| UpdateLocation |  Works |  Works |  Works (with DeviceKey) |\n| GetLocation |  Works |  Works |  Works (with access control) |\n| GetLocationHistory |  Works |  Works |  Works (with access control) |\n| GetVisitorHistory |  Works |  Works |  Works (with DeviceKey) |\n| GetLocationGeoJSON |  Works |  Works |  401 (DeviceKey set) |\n| DeleteLocation |  Works |  Works |  Works |\n\n### Graceful Degradation\n\n- **Missing DeviceKey**: When DeviceKey is required but not provided, operation fails with 403\n- **Not in Allowed List**: When access control is enabled, unauthorized devices receive no data (no error)\n- **Security Disabled**: All features work exactly as v1.0 when security is not enabled\n\n## Security Considerations\n\n### DeviceKey Security\n\n- **Storage**: DeviceKeys are stored securely in Redis (not logged)\n- **Validation**: Constant-time comparison prevents timing attacks\n- **Length**: Maximum 256 Unicode characters for flexibility\n- **Management**: Keys can be changed by providing current key\n\n### Access Control Security\n\n- **Privacy-First**: Default behavior hides location from unauthorized devices\n- **No Information Leakage**: Unauthorized devices don't receive error messages\n- **Granular Permissions**: Separate control for current location vs. history\n- **DeviceKey Protected**: Access control configuration requires DeviceKey\n\n### Rate Limiting\n\nExisting rate limiting applies to new endpoints:\n- &#96;/v1/setDeviceKey&#96; - Protected by HTTP rate limiting\n- &#96;/v1/setAllowedDeviceList&#96; - Protected by HTTP rate limiting\n- All endpoints continue to use existing rate limiting configuration\n\n### Best Practices\n\n1. **Use Strong DeviceKeys**: Use cryptographically secure random keys\n2. **Store Keys Securely**: Never log or expose DeviceKeys\n3. **Rotate Keys Periodically**: Change DeviceKeys regularly for enhanced security\n4. **Minimize Allowed Devices**: Only grant access to trusted devices",
        "signatures": {},
        "detailedLines": [
          {
            "text": "### Compatibility Matrix",
            "lineNumber": 573
          },
          {
            "lineNumber": 574
          },
          {
            "text": "| Feature | v1.0 Client | v1.1 Client (No Security) | v1.1 Client (With Security) |",
            "lineNumber": 575
          },
          {
            "text": "|---------|------------|---------------------------|------------------------------|",
            "lineNumber": 576
          },
          {
            "text": "| UpdateLocation |  Works |  Works |  Works (with DeviceKey) |",
            "lineNumber": 577
          },
          {
            "text": "| GetLocation |  Works |  Works |  Works (with access control) |",
            "lineNumber": 578
          },
          {
            "text": "| GetLocationHistory |  Works |  Works |  Works (with access control) |",
            "lineNumber": 579
          },
          {
            "text": "| GetVisitorHistory |  Works |  Works |  Works (with DeviceKey) |",
            "lineNumber": 580
          },
          {
            "text": "| GetLocationGeoJSON |  Works |  Works |  401 (DeviceKey set) |",
            "lineNumber": 581
          },
          {
            "text": "| DeleteLocation |  Works |  Works |  Works |",
            "lineNumber": 582
          },
          {
            "lineNumber": 583
          },
          {
            "text": "### Graceful Degradation",
            "lineNumber": 584
          },
          {
            "lineNumber": 585
          },
          {
            "text": "- **Missing DeviceKey**: When DeviceKey is required but not provided, operation fails with 403",
            "lineNumber": 586
          },
          {
            "text": "- **Not in Allowed List**: When access control is enabled, unauthorized devices receive no data (no error)",
            "lineNumber": 587
          },
          {
            "text": "- **Security Disabled**: All features work exactly as v1.0 when security is not enabled",
            "lineNumber": 588
          },
          {
            "lineNumber": 589
          },
          {
            "text": "## Security Considerations",
            "lineNumber": 590
          },
          {
            "lineNumber": 591
          },
          {
            "text": "### DeviceKey Security",
            "lineNumber": 592
          },
          {
            "lineNumber": 593
          },
          {
            "text": "- **Storage**: DeviceKeys are stored securely in Redis (not logged)",
            "lineNumber": 594
          },
          {
            "text": "- **Validation**: Constant-time comparison prevents timing attacks",
            "lineNumber": 595
          },
          {
            "text": "- **Length**: Maximum 256 Unicode characters for flexibility",
            "lineNumber": 596
          },
          {
            "text": "- **Management**: Keys can be changed by providing current key",
            "lineNumber": 597
          },
          {
            "lineNumber": 598
          },
          {
            "text": "### Access Control Security",
            "lineNumber": 599
          },
          {
            "lineNumber": 600
          },
          {
            "text": "- **Privacy-First**: Default behavior hides location from unauthorized devices",
            "lineNumber": 601
          },
          {
            "text": "- **No Information Leakage**: Unauthorized devices don't receive error messages",
            "lineNumber": 602
          },
          {
            "text": "- **Granular Permissions**: Separate control for current location vs. history",
            "lineNumber": 603
          },
          {
            "text": "- **DeviceKey Protected**: Access control configuration requires DeviceKey",
            "lineNumber": 604
          },
          {
            "lineNumber": 605
          },
          {
            "text": "### Rate Limiting",
            "lineNumber": 606
          },
          {
            "lineNumber": 607
          },
          {
            "text": "Existing rate limiting applies to new endpoints:",
            "lineNumber": 608
          },
          {
            "text": "- &#96;/v1/setDeviceKey&#96; - Protected by HTTP rate limiting",
            "lineNumber": 609
          },
          {
            "text": "- &#96;/v1/setAllowedDeviceList&#96; - Protected by HTTP rate limiting",
            "lineNumber": 610
          },
          {
            "text": "- All endpoints continue to use existing rate limiting configuration",
            "lineNumber": 611
          },
          {
            "lineNumber": 612
          },
          {
            "text": "### Best Practices",
            "lineNumber": 613
          },
          {
            "lineNumber": 614
          },
          {
            "text": "1. **Use Strong DeviceKeys**: Use cryptographically secure random keys",
            "lineNumber": 615
          },
          {
            "text": "2. **Store Keys Securely**: Never log or expose DeviceKeys",
            "lineNumber": 616
          },
          {
            "text": "3. **Rotate Keys Periodically**: Change DeviceKeys regularly for enhanced security",
            "lineNumber": 617
          },
          {
            "text": "4. **Minimize Allowed Devices**: Only grant access to trusted devices",
            "lineNumber": 618
          }
        ]
      },
      "score": 0.36942023038864136
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/WHATS_NEW_V2.md",
        "range": {
          "startPosition": {
            "line": 428
          },
          "endPosition": {
            "line": 512,
            "column": 4
          }
        },
        "contents": "- DeviceKey is required for an operation but not provided correctly\n- Access denied due to allowed devices list restrictions\n\n**Response Format:**\n&#96;&#96;&#96;json\n{\n  \"error\": \"Error message description\"\n}\n&#96;&#96;&#96;\n\n## Migration Guide\n\n### For Server Administrators\n\n**No action required** - Version 2.0 is fully backward compatible. Existing deployments will continue to work without any changes.\n\n**Optional Steps:**\n1. Review new security features and decide if they should be enabled\n2. Update documentation to inform users about new features\n3. Monitor for clients using GetLocationGeoJSON with DeviceKey-enabled devices\n\n### For Client Developers\n\n#### Option 1: No Changes (Recommended for Most Clients)\n\nExisting v1.0 clients continue to work without modification. Security features are opt-in and don't affect existing functionality.\n\n#### Option 2: Adopt DeviceKey Authentication\n\n**Step 1: Set DeviceKey**\n&#96;&#96;&#96;javascript\n// First-time setup\nPOST /v1/setDeviceKey\n{\n  \"MiataruSetDeviceKey\": {\n    \"DeviceID\": \"your-device-id\",\n    \"NewDeviceKey\": \"your-secure-key\"\n  }\n}\n&#96;&#96;&#96;\n\n**Step 2: Include DeviceKey in Updates**\n&#96;&#96;&#96;javascript\n// Update location with DeviceKey\nPOST /v1/UpdateLocation\n{\n  \"MiataruLocation\": [{\n    \"Device\": \"your-device-id\",\n    \"DeviceKey\": \"your-secure-key\",\n    // ... other location fields\n  }]\n}\n&#96;&#96;&#96;\n\n**Step 3: Include DeviceKey for Visitor History**\n&#96;&#96;&#96;javascript\n// Get visitor history with DeviceKey\nPOST /v1/GetVisitorHistory\n{\n  \"MiataruGetVisitorHistory\": {\n    \"Device\": \"your-device-id\",\n    \"DeviceKey\": \"your-secure-key\"\n  }\n}\n&#96;&#96;&#96;\n\n#### Option 3: Adopt Allowed Devices Access Control\n\n**Step 1: Set DeviceKey** (required for access control)\n&#96;&#96;&#96;javascript\nPOST /v1/setDeviceKey\n{\n  \"MiataruSetDeviceKey\": {\n    \"DeviceID\": \"your-device-id\",\n    \"NewDeviceKey\": \"your-secure-key\"\n  }\n}\n&#96;&#96;&#96;\n\n**Step 2: Configure Allowed Devices**\n&#96;&#96;&#96;javascript\nPOST /v1/setAllowedDeviceList\n{\n  \"MiataruSetAllowedDeviceList\": {\n    ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- DeviceKey is required for an operation but not provided correctly",
            "lineNumber": 429
          },
          {
            "text": "- Access denied due to allowed devices list restrictions",
            "lineNumber": 430
          },
          {
            "lineNumber": 431
          },
          {
            "text": "**Response Format:**",
            "lineNumber": 432
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 433
          },
          {
            "text": "{",
            "lineNumber": 434
          },
          {
            "text": "  \"error\": \"Error message description\"",
            "lineNumber": 435
          },
          {
            "text": "}",
            "lineNumber": 436
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 437
          },
          {
            "lineNumber": 438
          },
          {
            "text": "## Migration Guide",
            "lineNumber": 439
          },
          {
            "lineNumber": 440
          },
          {
            "text": "### For Server Administrators",
            "lineNumber": 441
          },
          {
            "lineNumber": 442
          },
          {
            "text": "**No action required** - Version 2.0 is fully backward compatible. Existing deployments will continue to work without any changes.",
            "lineNumber": 443
          },
          {
            "lineNumber": 444
          },
          {
            "text": "**Optional Steps:**",
            "lineNumber": 445
          },
          {
            "text": "1. Review new security features and decide if they should be enabled",
            "lineNumber": 446
          },
          {
            "text": "2. Update documentation to inform users about new features",
            "lineNumber": 447
          },
          {
            "text": "3. Monitor for clients using GetLocationGeoJSON with DeviceKey-enabled devices",
            "lineNumber": 448
          },
          {
            "lineNumber": 449
          },
          {
            "text": "### For Client Developers",
            "lineNumber": 450
          },
          {
            "lineNumber": 451
          },
          {
            "text": "#### Option 1: No Changes (Recommended for Most Clients)",
            "lineNumber": 452
          },
          {
            "lineNumber": 453
          },
          {
            "text": "Existing v1.0 clients continue to work without modification. Security features are opt-in and don't affect existing functionality.",
            "lineNumber": 454
          },
          {
            "lineNumber": 455
          },
          {
            "text": "#### Option 2: Adopt DeviceKey Authentication",
            "lineNumber": 456
          },
          {
            "lineNumber": 457
          },
          {
            "text": "**Step 1: Set DeviceKey**",
            "lineNumber": 458
          },
          {
            "text": "&#96;&#96;&#96;javascript",
            "lineNumber": 459
          },
          {
            "text": "// First-time setup",
            "lineNumber": 460
          },
          {
            "text": "POST /v1/setDeviceKey",
            "lineNumber": 461
          },
          {
            "text": "{",
            "lineNumber": 462
          },
          {
            "text": "  \"MiataruSetDeviceKey\": {",
            "lineNumber": 463
          },
          {
            "text": "    \"DeviceID\": \"your-device-id\",",
            "lineNumber": 464
          },
          {
            "text": "    \"NewDeviceKey\": \"your-secure-key\"",
            "lineNumber": 465
          },
          {
            "text": "  }",
            "lineNumber": 466
          },
          {
            "text": "}",
            "lineNumber": 467
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 468
          },
          {
            "lineNumber": 469
          },
          {
            "text": "**Step 2: Include DeviceKey in Updates**",
            "lineNumber": 470
          },
          {
            "text": "&#96;&#96;&#96;javascript",
            "lineNumber": 471
          },
          {
            "text": "// Update location with DeviceKey",
            "lineNumber": 472
          },
          {
            "text": "POST /v1/UpdateLocation",
            "lineNumber": 473
          },
          {
            "text": "{",
            "lineNumber": 474
          },
          {
            "text": "  \"MiataruLocation\": [{",
            "lineNumber": 475
          },
          {
            "text": "    \"Device\": \"your-device-id\",",
            "lineNumber": 476
          },
          {
            "text": "    \"DeviceKey\": \"your-secure-key\",",
            "lineNumber": 477
          },
          {
            "text": "    // ... other location fields",
            "lineNumber": 478
          },
          {
            "text": "  }]",
            "lineNumber": 479
          },
          {
            "text": "}",
            "lineNumber": 480
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 481
          },
          {
            "lineNumber": 482
          },
          {
            "text": "**Step 3: Include DeviceKey for Visitor History**",
            "lineNumber": 483
          },
          {
            "text": "&#96;&#96;&#96;javascript",
            "lineNumber": 484
          },
          {
            "text": "// Get visitor history with DeviceKey",
            "lineNumber": 485
          },
          {
            "text": "POST /v1/GetVisitorHistory",
            "lineNumber": 486
          },
          {
            "text": "{",
            "lineNumber": 487
          },
          {
            "text": "  \"MiataruGetVisitorHistory\": {",
            "lineNumber": 488
          },
          {
            "text": "    \"Device\": \"your-device-id\",",
            "lineNumber": 489
          },
          {
            "text": "    \"DeviceKey\": \"your-secure-key\"",
            "lineNumber": 490
          },
          {
            "text": "  }",
            "lineNumber": 491
          },
          {
            "text": "}",
            "lineNumber": 492
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 493
          },
          {
            "lineNumber": 494
          },
          {
            "text": "#### Option 3: Adopt Allowed Devices Access Control",
            "lineNumber": 495
          },
          {
            "lineNumber": 496
          },
          {
            "text": "**Step 1: Set DeviceKey** (required for access control)",
            "lineNumber": 497
          },
          {
            "text": "&#96;&#96;&#96;javascript",
            "lineNumber": 498
          },
          {
            "text": "POST /v1/setDeviceKey",
            "lineNumber": 499
          },
          {
            "text": "{",
            "lineNumber": 500
          },
          {
            "text": "  \"MiataruSetDeviceKey\": {",
            "lineNumber": 501
          },
          {
            "text": "    \"DeviceID\": \"your-device-id\",",
            "lineNumber": 502
          },
          {
            "text": "    \"NewDeviceKey\": \"your-secure-key\"",
            "lineNumber": 503
          },
          {
            "text": "  }",
            "lineNumber": 504
          },
          {
            "text": "}",
            "lineNumber": 505
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 506
          },
          {
            "lineNumber": 507
          },
          {
            "text": "**Step 2: Configure Allowed Devices**",
            "lineNumber": 508
          },
          {
            "text": "&#96;&#96;&#96;javascript",
            "lineNumber": 509
          },
          {
            "text": "POST /v1/setAllowedDeviceList",
            "lineNumber": 510
          },
          {
            "text": "{",
            "lineNumber": 511
          },
          {
            "text": "  \"MiataruSetAllowedDeviceList\": {",
            "lineNumber": 512
          },
          {
            "text": "    ",
            "lineNumber": 513
          }
        ]
      },
      "score": 0.3630795478820801
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./tests/integration/deviceKey.tests.js",
        "range": {
          "startPosition": {
            "line": 8
          },
          "endPosition": {
            "line": 295
          }
        },
        "contents": "        });\n\n        it('should return 403 when DeviceKey does not match', function(done) {\n            // Set device key first\n            deviceKeyUtils.setDeviceKey(TEST_DEVICE, TEST_DEVICE_KEY, function(error) {\n                if (error) return done(error);\n\n                var updateData = calls.locationUpdateCall({\n                    locations: {\n                        Device: TEST_DEVICE,\n                        Timestamp: Date.now().toString(),\n                        Longitude: '10.0',\n                        Latitude: '50.0',\n                        HorizontalAccuracy: '5.0',\n                        DeviceKey: 'wrong-key'\n                    }\n                });\n\n                request(app)\n                    .post('/v1/UpdateLocation')\n                    .send(updateData)\n                    .expect(403)\n                    .expect(function(res) {\n                        expect(res.body.error).to.include('DeviceKey');\n                    })\n                    .end(done);\n            });\n        });\n\n        it('should return 403 when DeviceKey is missing but required', function(done) {\n            // Set device key first\n            deviceKeyUtils.setDeviceKey(TEST_DEVICE, TEST_DEVICE_KEY, function(error) {\n                if (error) return done(error);\n\n                var updateData = calls.locationUpdateCall({\n                    locations: calls.location({ device: TEST_DEVICE })\n                    // DeviceKey is missing\n                });\n\n                request(app)\n                    .post('/v1/UpdateLocation')\n                    .send(updateData)\n                    .expect(403)\n                    .expect(function(res) {\n                        expect(res.body.error).to.include('DeviceKey is required');\n                    })\n                    .end(done);\n            });\n        });\n    });\n\n    describe('getVisitorHistory with DeviceKey',",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 9,
                "column": 1
              },
              "endPosition": {
                "line": 9,
                "column": 1
              }
            },
            {
              "startPosition": {
                "line": 119,
                "column": 5
              },
              "endPosition": {
                "line": 119,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "        });",
            "lineNumber": 160
          },
          {
            "lineNumber": 161
          },
          {
            "text": "        it('should return 403 when DeviceKey does not match', function(done) {",
            "lineNumber": 162
          },
          {
            "text": "            // Set device key first",
            "lineNumber": 163
          },
          {
            "text": "            deviceKeyUtils.setDeviceKey(TEST_DEVICE, TEST_DEVICE_KEY, function(error) {",
            "lineNumber": 164
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 165
          },
          {
            "lineNumber": 166
          },
          {
            "text": "                var updateData = calls.locationUpdateCall({",
            "lineNumber": 167
          },
          {
            "text": "                    locations: {",
            "lineNumber": 168
          },
          {
            "text": "                        Device: TEST_DEVICE,",
            "lineNumber": 169
          },
          {
            "text": "                        Timestamp: Date.now().toString(),",
            "lineNumber": 170
          },
          {
            "text": "                        Longitude: '10.0',",
            "lineNumber": 171
          },
          {
            "text": "                        Latitude: '50.0',",
            "lineNumber": 172
          },
          {
            "text": "                        HorizontalAccuracy: '5.0',",
            "lineNumber": 173
          },
          {
            "text": "                        DeviceKey: 'wrong-key'",
            "lineNumber": 174
          },
          {
            "text": "                    }",
            "lineNumber": 175
          },
          {
            "text": "                });",
            "lineNumber": 176
          },
          {
            "lineNumber": 177
          },
          {
            "text": "                request(app)",
            "lineNumber": 178
          },
          {
            "text": "                    .post('/v1/UpdateLocation')",
            "lineNumber": 179
          },
          {
            "text": "                    .send(updateData)",
            "lineNumber": 180
          },
          {
            "text": "                    .expect(403)",
            "lineNumber": 181
          },
          {
            "text": "                    .expect(function(res) {",
            "lineNumber": 182
          },
          {
            "text": "                        expect(res.body.error).to.include('DeviceKey');",
            "lineNumber": 183
          },
          {
            "text": "                    })",
            "lineNumber": 184
          },
          {
            "text": "                    .end(done);",
            "lineNumber": 185
          },
          {
            "text": "            });",
            "lineNumber": 186
          },
          {
            "text": "        });",
            "lineNumber": 187
          },
          {
            "lineNumber": 188
          },
          {
            "text": "        it('should return 403 when DeviceKey is missing but required', function(done) {",
            "lineNumber": 189
          },
          {
            "text": "            // Set device key first",
            "lineNumber": 190
          },
          {
            "text": "            deviceKeyUtils.setDeviceKey(TEST_DEVICE, TEST_DEVICE_KEY, function(error) {",
            "lineNumber": 191
          },
          {
            "text": "                if (error) return done(error);",
            "lineNumber": 192
          },
          {
            "lineNumber": 193
          },
          {
            "text": "                var updateData = calls.locationUpdateCall({",
            "lineNumber": 194
          },
          {
            "text": "                    locations: calls.location({ device: TEST_DEVICE })",
            "lineNumber": 195
          },
          {
            "text": "                    // DeviceKey is missing",
            "lineNumber": 196
          },
          {
            "text": "                });",
            "lineNumber": 197
          },
          {
            "lineNumber": 198
          },
          {
            "text": "                request(app)",
            "lineNumber": 199
          },
          {
            "text": "                    .post('/v1/UpdateLocation')",
            "lineNumber": 200
          },
          {
            "text": "                    .send(updateData)",
            "lineNumber": 201
          },
          {
            "text": "                    .expect(403)",
            "lineNumber": 202
          },
          {
            "text": "                    .expect(function(res) {",
            "lineNumber": 203
          },
          {
            "text": "                        expect(res.body.error).to.include('DeviceKey is required');",
            "lineNumber": 204
          },
          {
            "text": "                    })",
            "lineNumber": 205
          },
          {
            "text": "                    .end(done);",
            "lineNumber": 206
          },
          {
            "text": "            });",
            "lineNumber": 207
          },
          {
            "text": "        });",
            "lineNumber": 208
          },
          {
            "text": "    });",
            "lineNumber": 209
          },
          {
            "lineNumber": 210
          },
          {
            "text": "    describe('getVisitorHistory with DeviceKey',",
            "lineNumber": 211
          }
        ]
      },
      "score": 0.35773780941963196
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/WHATS_NEW_V2.md",
        "range": {
          "startPosition": {
            "line": 34
          },
          "endPosition": {
            "line": 85,
            "column": 4
          }
        },
        "contents": "3. **Key Management**: DeviceKeys can be changed by providing the current key along with the new key\n\n#### Protected Operations\n\nThe following operations require DeviceKey authentication when a DeviceKey is set for the device:\n\n- **UpdateLocation** - Prevents unauthorized location updates\n- **GetVisitorHistory** - Protects access to visitor tracking data\n- **SetAllowedDeviceList** - Secures access control configuration\n\n#### Benefits\n\n- **Prevent Unauthorized Updates**: Only devices with the correct key can update location data\n- **Protect Sensitive Data**: Visitor history requires authentication\n- **Secure Configuration**: Access control settings are protected\n\n### Allowed Devices Access Control\n\nAllowed Devices provides fine-grained access control, allowing device owners to specify exactly which devices can access their location data and what type of access they have.\n\n#### How It Works\n\n1. **Enable Access Control**: Device owner sets an allowed devices list using &#96;/v1/setAllowedDeviceList&#96;\n2. **Permission Types**: Each allowed device can have two types of permissions:\n   - **Current Location Access** (&#96;hasCurrentLocationAccess&#96;) - Can retrieve current location\n   - **History Access** (&#96;hasHistoryAccess&#96;) - Can retrieve location history\n3. **Privacy-First Default**: When enabled, only devices in the list can access location data\n\n#### Access Control Behavior\n\n- **GetLocation**: Returns location only if requesting device has &#96;hasCurrentLocationAccess&#96; permission\n- **GetLocationHistory**: Returns history only if requesting device has &#96;hasHistoryAccess&#96; permission\n- **Default Behavior**: When no allowed devices list is set, behavior matches v1.0 (backward compatible)\n\n#### Benefits\n\n- **Granular Control**: Separate permissions for current location vs. history\n- **Privacy Protection**: Location data is hidden from unauthorized devices\n- **Flexible Sharing**: Easy to grant or revoke access to specific devices\n\n## New API Endpoints\n\n### POST &#96;/v1/setDeviceKey&#96;\n\nSet or change the DeviceKey for a device. This is the first step in enabling DeviceKey authentication.\n\n#### Request Format\n\n&#96;&#96;&#96;json\n{\n  \"MiataruSetDeviceKey\": {\n    ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "3. **Key Management**: DeviceKeys can be changed by providing the current key along with the new key",
            "lineNumber": 35
          },
          {
            "lineNumber": 36
          },
          {
            "text": "#### Protected Operations",
            "lineNumber": 37
          },
          {
            "lineNumber": 38
          },
          {
            "text": "The following operations require DeviceKey authentication when a DeviceKey is set for the device:",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "- **UpdateLocation** - Prevents unauthorized location updates",
            "lineNumber": 41
          },
          {
            "text": "- **GetVisitorHistory** - Protects access to visitor tracking data",
            "lineNumber": 42
          },
          {
            "text": "- **SetAllowedDeviceList** - Secures access control configuration",
            "lineNumber": 43
          },
          {
            "lineNumber": 44
          },
          {
            "text": "#### Benefits",
            "lineNumber": 45
          },
          {
            "lineNumber": 46
          },
          {
            "text": "- **Prevent Unauthorized Updates**: Only devices with the correct key can update location data",
            "lineNumber": 47
          },
          {
            "text": "- **Protect Sensitive Data**: Visitor history requires authentication",
            "lineNumber": 48
          },
          {
            "text": "- **Secure Configuration**: Access control settings are protected",
            "lineNumber": 49
          },
          {
            "lineNumber": 50
          },
          {
            "text": "### Allowed Devices Access Control",
            "lineNumber": 51
          },
          {
            "lineNumber": 52
          },
          {
            "text": "Allowed Devices provides fine-grained access control, allowing device owners to specify exactly which devices can access their location data and what type of access they have.",
            "lineNumber": 53
          },
          {
            "lineNumber": 54
          },
          {
            "text": "#### How It Works",
            "lineNumber": 55
          },
          {
            "lineNumber": 56
          },
          {
            "text": "1. **Enable Access Control**: Device owner sets an allowed devices list using &#96;/v1/setAllowedDeviceList&#96;",
            "lineNumber": 57
          },
          {
            "text": "2. **Permission Types**: Each allowed device can have two types of permissions:",
            "lineNumber": 58
          },
          {
            "text": "   - **Current Location Access** (&#96;hasCurrentLocationAccess&#96;) - Can retrieve current location",
            "lineNumber": 59
          },
          {
            "text": "   - **History Access** (&#96;hasHistoryAccess&#96;) - Can retrieve location history",
            "lineNumber": 60
          },
          {
            "text": "3. **Privacy-First Default**: When enabled, only devices in the list can access location data",
            "lineNumber": 61
          },
          {
            "lineNumber": 62
          },
          {
            "text": "#### Access Control Behavior",
            "lineNumber": 63
          },
          {
            "lineNumber": 64
          },
          {
            "text": "- **GetLocation**: Returns location only if requesting device has &#96;hasCurrentLocationAccess&#96; permission",
            "lineNumber": 65
          },
          {
            "text": "- **GetLocationHistory**: Returns history only if requesting device has &#96;hasHistoryAccess&#96; permission",
            "lineNumber": 66
          },
          {
            "text": "- **Default Behavior**: When no allowed devices list is set, behavior matches v1.0 (backward compatible)",
            "lineNumber": 67
          },
          {
            "lineNumber": 68
          },
          {
            "text": "#### Benefits",
            "lineNumber": 69
          },
          {
            "lineNumber": 70
          },
          {
            "text": "- **Granular Control**: Separate permissions for current location vs. history",
            "lineNumber": 71
          },
          {
            "text": "- **Privacy Protection**: Location data is hidden from unauthorized devices",
            "lineNumber": 72
          },
          {
            "text": "- **Flexible Sharing**: Easy to grant or revoke access to specific devices",
            "lineNumber": 73
          },
          {
            "lineNumber": 74
          },
          {
            "text": "## New API Endpoints",
            "lineNumber": 75
          },
          {
            "lineNumber": 76
          },
          {
            "text": "### POST &#96;/v1/setDeviceKey&#96;",
            "lineNumber": 77
          },
          {
            "lineNumber": 78
          },
          {
            "text": "Set or change the DeviceKey for a device. This is the first step in enabling DeviceKey authentication.",
            "lineNumber": 79
          },
          {
            "lineNumber": 80
          },
          {
            "text": "#### Request Format",
            "lineNumber": 81
          },
          {
            "lineNumber": 82
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 83
          },
          {
            "text": "{",
            "lineNumber": 84
          },
          {
            "text": "  \"MiataruSetDeviceKey\": {",
            "lineNumber": 85
          },
          {
            "text": "    ",
            "lineNumber": 86
          }
        ]
      },
      "score": 0.357651948928833
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/index.js",
        "range": {
          "startPosition": {
            "column": 43
          },
          "endPosition": {
            "line": 14,
            "column": 2
          }
        },
        "contents": "var location = require('./location');\n\nmodule.exports = {\n    inputParser: inputParser,\n    updateLocation: location.updateLocation,\n    getLocation: location.getLocation,\n    getLocationGeoJSON: location.getLocationGeoJSON,\n    getLocationGeoJSONGET: location.getLocationGeoJSONGET,\n    getLocationHistory: location.getLocationHistory,\n    getVisitorHistory: location.getVisitorHistory,\n    deleteLocation: location.deleteLocation,\n    setDeviceKey: location.setDeviceKey,\n    setAllowedDeviceList: location.setAllowedDeviceList\n};",
        "signatures": {},
        "detailedLines": [
          {
            "text": "var location = require('./location');",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "module.exports = {",
            "lineNumber": 4
          },
          {
            "text": "    inputParser: inputParser,",
            "lineNumber": 5
          },
          {
            "text": "    updateLocation: location.updateLocation,",
            "lineNumber": 6
          },
          {
            "text": "    getLocation: location.getLocation,",
            "lineNumber": 7
          },
          {
            "text": "    getLocationGeoJSON: location.getLocationGeoJSON,",
            "lineNumber": 8
          },
          {
            "text": "    getLocationGeoJSONGET: location.getLocationGeoJSONGET,",
            "lineNumber": 9
          },
          {
            "text": "    getLocationHistory: location.getLocationHistory,",
            "lineNumber": 10
          },
          {
            "text": "    getVisitorHistory: location.getVisitorHistory,",
            "lineNumber": 11
          },
          {
            "text": "    deleteLocation: location.deleteLocation,",
            "lineNumber": 12
          },
          {
            "text": "    setDeviceKey: location.setDeviceKey,",
            "lineNumber": 13
          },
          {
            "text": "    setAllowedDeviceList: location.setAllowedDeviceList",
            "lineNumber": 14
          },
          {
            "text": "};",
            "lineNumber": 15
          }
        ]
      },
      "score": 0.35560142993927
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/TECHNICAL_SPECIFICATION.md",
        "range": {
          "startPosition": {
            "line": 74
          },
          "endPosition": {
            "line": 87
          }
        },
        "contents": "- **Key logic**:\n  - **UpdateLocation**: If history enabled, pushes each location into &#96;hist&#96; list and trims; updates &#96;last&#96; on final entry. If history disabled, deletes history list and stores &#96;last&#96; with TTL. (Evidence: lib/routes/location/v1/location.js; config/default.js; tests/integration/api.tests.js)\n  - **GetLocation**: Reads &#96;last&#96; per device and returns null when missing; records visitor history when configured. (Evidence: lib/routes/location/v1/location.js; tests/integration/unknownDevice.tests.js; tests/integration/visitorHistoryFiltering.tests.js)\n  - **GetLocationHistory**: Reads list length, fetches up to requested amount, skips invalid JSON entries, and optionally records visitor history. (Evidence: lib/routes/location/v1/location.js; tests/integration/getLocationHistoryConfig.tests.js)\n  - **GetLocationGeoJSON**: Converts first location into GeoJSON Feature or returns &#96;{}&#96; if missing coordinates. (Evidence: lib/models/ResponseLocationGeoJSON.js; tests/unit/responseLocationGeoJSON.tests.js)\n  - **GetVisitorHistory**: Filters out entries where visitor device equals target device. (Evidence: lib/routes/location/v1/location.js; tests/integration/visitorHistoryFiltering.tests.js)\n  - **DeleteLocation**: Deletes &#96;last&#96;, &#96;hist&#96;, and &#96;visit&#96; keys in parallel and returns deleted key count. (Evidence: lib/routes/location/v1/location.js; docs/DELETE_LOCATION_API.md; tests/integration/deleteLocation.tests.js)\n- **State &amp; lifecycle**: Operates on Redis keys per device ID; location history and visitor history lists are trimmed to configured maxima. (Evidence: lib/routes/location/v1/location.js; config/default.js)\n- **Failure modes**: Redis errors wrap as &#96;InternalServerError&#96;; malformed JSON data yields error responses. (Evidence: lib/routes/location/v1/location.js; lib/errors.js)\n\n### 2.8 Storage adapter (&#96;lib/db.js&#96;)\n- **Responsibility**: Provide Redis client (real or fakeredis) with legacy callbacks, concurrency limits, and error translation. (Evidence: lib/db.js; tests/unit/db.redisCompatibility.tests.js)\n- **Interfaces**: Exposes Redis methods &#96;get&#96;, &#96;set&#96;, &#96;setex&#96;, &#96;lpush&#96;, &#96;ltrim&#96;, &#96;lrange&#96;, &#96;llen&#96;, &#96;del&#96;, etc. (Evidence: lib/db.js)",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- **Key logic**:",
            "lineNumber": 75
          },
          {
            "text": "  - **UpdateLocation**: If history enabled, pushes each location into &#96;hist&#96; list and trims; updates &#96;last&#96; on final entry. If history disabled, deletes history list and stores &#96;last&#96; with TTL. (Evidence: lib/routes/location/v1/location.js; config/default.js; tests/integration/api.tests.js)",
            "lineNumber": 76
          },
          {
            "text": "  - **GetLocation**: Reads &#96;last&#96; per device and returns null when missing; records visitor history when configured. (Evidence: lib/routes/location/v1/location.js; tests/integration/unknownDevice.tests.js; tests/integration/visitorHistoryFiltering.tests.js)",
            "lineNumber": 77
          },
          {
            "text": "  - **GetLocationHistory**: Reads list length, fetches up to requested amount, skips invalid JSON entries, and optionally records visitor history. (Evidence: lib/routes/location/v1/location.js; tests/integration/getLocationHistoryConfig.tests.js)",
            "lineNumber": 78
          },
          {
            "text": "  - **GetLocationGeoJSON**: Converts first location into GeoJSON Feature or returns &#96;{}&#96; if missing coordinates. (Evidence: lib/models/ResponseLocationGeoJSON.js; tests/unit/responseLocationGeoJSON.tests.js)",
            "lineNumber": 79
          },
          {
            "text": "  - **GetVisitorHistory**: Filters out entries where visitor device equals target device. (Evidence: lib/routes/location/v1/location.js; tests/integration/visitorHistoryFiltering.tests.js)",
            "lineNumber": 80
          },
          {
            "text": "  - **DeleteLocation**: Deletes &#96;last&#96;, &#96;hist&#96;, and &#96;visit&#96; keys in parallel and returns deleted key count. (Evidence: lib/routes/location/v1/location.js; docs/DELETE_LOCATION_API.md; tests/integration/deleteLocation.tests.js)",
            "lineNumber": 81
          },
          {
            "text": "- **State &amp; lifecycle**: Operates on Redis keys per device ID; location history and visitor history lists are trimmed to configured maxima. (Evidence: lib/routes/location/v1/location.js; config/default.js)",
            "lineNumber": 82
          },
          {
            "text": "- **Failure modes**: Redis errors wrap as &#96;InternalServerError&#96;; malformed JSON data yields error responses. (Evidence: lib/routes/location/v1/location.js; lib/errors.js)",
            "lineNumber": 83
          },
          {
            "lineNumber": 84
          },
          {
            "text": "### 2.8 Storage adapter (&#96;lib/db.js&#96;)",
            "lineNumber": 85
          },
          {
            "text": "- **Responsibility**: Provide Redis client (real or fakeredis) with legacy callbacks, concurrency limits, and error translation. (Evidence: lib/db.js; tests/unit/db.redisCompatibility.tests.js)",
            "lineNumber": 86
          },
          {
            "text": "- **Interfaces**: Exposes Redis methods &#96;get&#96;, &#96;set&#96;, &#96;setex&#96;, &#96;lpush&#96;, &#96;ltrim&#96;, &#96;lrange&#96;, &#96;llen&#96;, &#96;del&#96;, etc. (Evidence: lib/db.js)",
            "lineNumber": 87
          }
        ]
      },
      "score": 0.3518824577331543
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.cursor/plans/miataru_server_2.0_api_1.1_security_implementation_0d55c5ea.plan.md",
        "range": {
          "startPosition": {
            "line": 194
          },
          "endPosition": {
            "line": 248
          }
        },
        "contents": "- Add parsing for &#96;/v1/setDeviceKey&#96; endpoint\n- Add parsing for &#96;/v1/setAllowedDeviceList&#96; endpoint\n- Extend &#96;parseUpdateLocation&#96; to extract DeviceKey from MiataruLocation array elements\n- Extend &#96;parseGetVisitorHistory&#96; to extract DeviceKey from request body\n\n### Phase 4: Endpoint Implementations\n\n#### 4.1 setDeviceKey Endpoint\n\n**File**: &#96;lib/routes/location/v1/location.js&#96;\n\n- New function: &#96;setDeviceKey(req, res, next)&#96;\n- Validate CurrentDeviceKey if device already has a key set\n- If CurrentDeviceKey matches or no key exists, set NewDeviceKey\n- Return success response or 403 Forbidden if CurrentDeviceKey doesn't match\n- Store in Redis: &#96;miad:$deviceid:key&#96;\n\n#### 4.2 setAllowedDeviceList Endpoint\n\n**File**: &#96;lib/routes/location/v1/location.js&#96;\n\n- New function: &#96;setAllowedDeviceList(req, res, next)&#96;\n- Validate DeviceKey first (must match stored key)\n- Replace entire allowed devices list (client maintains full list)\n- Store as Redis hash: &#96;miad:$deviceid:allowed&#96;\n- Set flag: &#96;miad:$deviceid:allowed:enabled&#96; = \"1\"\n- Return success or 403 Forbidden if DeviceKey doesn't match\n\n#### 4.3 Modify updateLocation Function\n\n**File**: &#96;lib/routes/location/v1/location.js&#96;\n\n- Before updating location, check if DeviceKey is set for the device\n- If DeviceKey is set, validate provided DeviceKey matches stored key\n- If keys don't match, return 403 Forbidden\n- If no DeviceKey is set, proceed normally (backward compatible)\n- DeviceKey parameter is optional in MiataruLocation array elements\n\n#### 4.4 Modify getVisitorHistory Function\n\n**File**: &#96;lib/routes/location/v1/location.js&#96;\n\n- Before returning visitor history, check if DeviceKey is set for the device\n- If DeviceKey is set, validate provided DeviceKey matches stored key\n- If keys don't match, return 403 Forbidden\n- If no DeviceKey is set, proceed normally (backward compatible)\n\n#### 4.5 Modify getLocation Function\n\n**File**: &#96;lib/routes/location/v1/location.js&#96;\n\n- For each requested DeviceID, check if allowed devices list is enabled\n- If enabled, check if RequestMiataruDeviceID has &#96;hasCurrentLocationAccess&#96; permission",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- Add parsing for &#96;/v1/setDeviceKey&#96; endpoint",
            "lineNumber": 196
          },
          {
            "text": "- Add parsing for &#96;/v1/setAllowedDeviceList&#96; endpoint",
            "lineNumber": 197
          },
          {
            "text": "- Extend &#96;parseUpdateLocation&#96; to extract DeviceKey from MiataruLocation array elements",
            "lineNumber": 198
          },
          {
            "text": "- Extend &#96;parseGetVisitorHistory&#96; to extract DeviceKey from request body",
            "lineNumber": 199
          },
          {
            "lineNumber": 200
          },
          {
            "text": "### Phase 4: Endpoint Implementations",
            "lineNumber": 201
          },
          {
            "lineNumber": 202
          },
          {
            "text": "#### 4.1 setDeviceKey Endpoint",
            "lineNumber": 203
          },
          {
            "lineNumber": 204
          },
          {
            "text": "**File**: &#96;lib/routes/location/v1/location.js&#96;",
            "lineNumber": 205
          },
          {
            "lineNumber": 206
          },
          {
            "text": "- New function: &#96;setDeviceKey(req, res, next)&#96;",
            "lineNumber": 207
          },
          {
            "text": "- Validate CurrentDeviceKey if device already has a key set",
            "lineNumber": 208
          },
          {
            "text": "- If CurrentDeviceKey matches or no key exists, set NewDeviceKey",
            "lineNumber": 209
          },
          {
            "text": "- Return success response or 403 Forbidden if CurrentDeviceKey doesn't match",
            "lineNumber": 210
          },
          {
            "text": "- Store in Redis: &#96;miad:$deviceid:key&#96;",
            "lineNumber": 211
          },
          {
            "lineNumber": 212
          },
          {
            "text": "#### 4.2 setAllowedDeviceList Endpoint",
            "lineNumber": 213
          },
          {
            "lineNumber": 214
          },
          {
            "text": "**File**: &#96;lib/routes/location/v1/location.js&#96;",
            "lineNumber": 215
          },
          {
            "lineNumber": 216
          },
          {
            "text": "- New function: &#96;setAllowedDeviceList(req, res, next)&#96;",
            "lineNumber": 217
          },
          {
            "text": "- Validate DeviceKey first (must match stored key)",
            "lineNumber": 218
          },
          {
            "text": "- Replace entire allowed devices list (client maintains full list)",
            "lineNumber": 219
          },
          {
            "text": "- Store as Redis hash: &#96;miad:$deviceid:allowed&#96;",
            "lineNumber": 220
          },
          {
            "text": "- Set flag: &#96;miad:$deviceid:allowed:enabled&#96; = \"1\"",
            "lineNumber": 221
          },
          {
            "text": "- Return success or 403 Forbidden if DeviceKey doesn't match",
            "lineNumber": 222
          },
          {
            "lineNumber": 223
          },
          {
            "text": "#### 4.3 Modify updateLocation Function",
            "lineNumber": 224
          },
          {
            "lineNumber": 225
          },
          {
            "text": "**File**: &#96;lib/routes/location/v1/location.js&#96;",
            "lineNumber": 226
          },
          {
            "lineNumber": 227
          },
          {
            "text": "- Before updating location, check if DeviceKey is set for the device",
            "lineNumber": 228
          },
          {
            "text": "- If DeviceKey is set, validate provided DeviceKey matches stored key",
            "lineNumber": 229
          },
          {
            "text": "- If keys don't match, return 403 Forbidden",
            "lineNumber": 230
          },
          {
            "text": "- If no DeviceKey is set, proceed normally (backward compatible)",
            "lineNumber": 231
          },
          {
            "text": "- DeviceKey parameter is optional in MiataruLocation array elements",
            "lineNumber": 232
          },
          {
            "lineNumber": 233
          },
          {
            "text": "#### 4.4 Modify getVisitorHistory Function",
            "lineNumber": 234
          },
          {
            "lineNumber": 235
          },
          {
            "text": "**File**: &#96;lib/routes/location/v1/location.js&#96;",
            "lineNumber": 236
          },
          {
            "lineNumber": 237
          },
          {
            "text": "- Before returning visitor history, check if DeviceKey is set for the device",
            "lineNumber": 238
          },
          {
            "text": "- If DeviceKey is set, validate provided DeviceKey matches stored key",
            "lineNumber": 239
          },
          {
            "text": "- If keys don't match, return 403 Forbidden",
            "lineNumber": 240
          },
          {
            "text": "- If no DeviceKey is set, proceed normally (backward compatible)",
            "lineNumber": 241
          },
          {
            "lineNumber": 242
          },
          {
            "text": "#### 4.5 Modify getLocation Function",
            "lineNumber": 243
          },
          {
            "lineNumber": 244
          },
          {
            "text": "**File**: &#96;lib/routes/location/v1/location.js&#96;",
            "lineNumber": 245
          },
          {
            "lineNumber": 246
          },
          {
            "text": "- For each requested DeviceID, check if allowed devices list is enabled",
            "lineNumber": 247
          },
          {
            "text": "- If enabled, check if RequestMiataruDeviceID has &#96;hasCurrentLocationAccess&#96; permission",
            "lineNumber": 248
          }
        ]
      },
      "score": 0.3517669439315796
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 334
          },
          "endPosition": {
            "line": 433,
            "column": 1
          }
        },
        "contents": "function updateLocation(req, res, next) {\n\n\n    if(requestConfig.enableLocationHistory()) {\n        locations.forEach(function(loc, idx) {\n            var value = JSON.stringify(loc.data());\n            var historyKey = kb.build(loc.device(), KEY_HISTORY);\n            var lastKey = kb.build(loc.device(), KEY_LAST);\n\n            chain\n                // we do want to store location history, so check if we got, so lpush and trim\n                .seq(function() {\n                    db.lpush(historyKey, value, this);\n                })\n                // take care that the location history does not grow beyond the set range of maximumNumberOfHistoryItems\n                .seq(function() {\n                    db.ltrim(historyKey, 0, configuration.maximumNumberOfHistoryItems-1, this);\n                });\n\n            if(idx === locations.length - 1) {\n                // finally also update the last known location...\n                chain.seq(function() {\n                    db.set(lastKey, value, this);\n                });\n            }\n        });\n    } else {\n        //we're only interested in the last item as we're not saving a history\n        var loc = locations[locations.length-1];\n\n        var timeToKeep = requestConfig.locationDataRetentionTime() * 60;\n        var value = JSON.stringify(loc.data());\n\n        chain\n            // we do not want to save a location history, this means if there's one we delete it...\n            .par(function() {\n                db.del(kb.build(loc.device(), KEY_HISTORY), this);\n            })\n            // update the last known location\n            .par(function() {\n                db.setex(kb.build(loc.device(), KEY_LAST), timeToKeep, value, this);\n            });\n    }\n\n    chain\n        .seq\n\n\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 335,
                "column": 1
              },
              "endPosition": {
                "line": 336,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function updateLocation(req, res, next) {",
            "lineNumber": 335,
            "isSignature": true
          },
          {
            "lineNumber": 380
          },
          {
            "lineNumber": 381
          },
          {
            "text": "    if(requestConfig.enableLocationHistory()) {",
            "lineNumber": 382
          },
          {
            "text": "        locations.forEach(function(loc, idx) {",
            "lineNumber": 383
          },
          {
            "text": "            var value = JSON.stringify(loc.data());",
            "lineNumber": 384
          },
          {
            "text": "            var historyKey = kb.build(loc.device(), KEY_HISTORY);",
            "lineNumber": 385
          },
          {
            "text": "            var lastKey = kb.build(loc.device(), KEY_LAST);",
            "lineNumber": 386
          },
          {
            "lineNumber": 387
          },
          {
            "text": "            chain",
            "lineNumber": 388
          },
          {
            "text": "                // we do want to store location history, so check if we got, so lpush and trim",
            "lineNumber": 389
          },
          {
            "text": "                .seq(function() {",
            "lineNumber": 390
          },
          {
            "text": "                    db.lpush(historyKey, value, this);",
            "lineNumber": 391
          },
          {
            "text": "                })",
            "lineNumber": 392
          },
          {
            "text": "                // take care that the location history does not grow beyond the set range of maximumNumberOfHistoryItems",
            "lineNumber": 393
          },
          {
            "text": "                .seq(function() {",
            "lineNumber": 394
          },
          {
            "text": "                    db.ltrim(historyKey, 0, configuration.maximumNumberOfHistoryItems-1, this);",
            "lineNumber": 395
          },
          {
            "text": "                });",
            "lineNumber": 396
          },
          {
            "lineNumber": 397
          },
          {
            "text": "            if(idx === locations.length - 1) {",
            "lineNumber": 398
          },
          {
            "text": "                // finally also update the last known location...",
            "lineNumber": 399
          },
          {
            "text": "                chain.seq(function() {",
            "lineNumber": 400
          },
          {
            "text": "                    db.set(lastKey, value, this);",
            "lineNumber": 401
          },
          {
            "text": "                });",
            "lineNumber": 402
          },
          {
            "text": "            }",
            "lineNumber": 403
          },
          {
            "text": "        });",
            "lineNumber": 404
          },
          {
            "text": "    } else {",
            "lineNumber": 405
          },
          {
            "text": "        //we're only interested in the last item as we're not saving a history",
            "lineNumber": 406
          },
          {
            "text": "        var loc = locations[locations.length-1];",
            "lineNumber": 407
          },
          {
            "lineNumber": 408
          },
          {
            "text": "        var timeToKeep = requestConfig.locationDataRetentionTime() * 60;",
            "lineNumber": 409
          },
          {
            "text": "        var value = JSON.stringify(loc.data());",
            "lineNumber": 410
          },
          {
            "lineNumber": 411
          },
          {
            "text": "        chain",
            "lineNumber": 412
          },
          {
            "text": "            // we do not want to save a location history, this means if there's one we delete it...",
            "lineNumber": 413
          },
          {
            "text": "            .par(function() {",
            "lineNumber": 414
          },
          {
            "text": "                db.del(kb.build(loc.device(), KEY_HISTORY), this);",
            "lineNumber": 415
          },
          {
            "text": "            })",
            "lineNumber": 416
          },
          {
            "text": "            // update the last known location",
            "lineNumber": 417
          },
          {
            "text": "            .par(function() {",
            "lineNumber": 418
          },
          {
            "text": "                db.setex(kb.build(loc.device(), KEY_LAST), timeToKeep, value, this);",
            "lineNumber": 419
          },
          {
            "text": "            });",
            "lineNumber": 420
          },
          {
            "text": "    }",
            "lineNumber": 421
          },
          {
            "lineNumber": 422
          },
          {
            "text": "    chain",
            "lineNumber": 423
          },
          {
            "text": "        .seq",
            "lineNumber": 424
          },
          {
            "lineNumber": 427
          },
          {
            "lineNumber": 433
          },
          {
            "text": "}",
            "lineNumber": 434,
            "isSignature": true
          }
        ]
      },
      "score": 0.35034364461898804
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/COMPATIBILITY_ASSESSMENT.md",
        "range": {
          "startPosition": {
            "line": 142
          },
          "endPosition": {
            "line": 213,
            "column": 2
          }
        },
        "contents": "## Endpoint Status\n\n### Unchanged Endpoints\n\nThese endpoints work exactly as in API 1.0:\n\n-  &#96;/v1/UpdateLocation&#96; - Same behavior (DeviceKey optional)\n-  &#96;/v1/GetLocation&#96; - Same behavior (access control optional)\n-  &#96;/v1/GetLocationHistory&#96; - Same behavior (access control optional)\n-  &#96;/v1/GetVisitorHistory&#96; - Same behavior (DeviceKey optional)\n-  &#96;/v1/DeleteLocation&#96; - Unchanged\n\n### New Endpoints\n\nThese endpoints are new in API 1.1:\n\n-  &#96;/v1/setDeviceKey&#96; - Set or change device key\n-  &#96;/v1/setAllowedDeviceList&#96; - Manage allowed devices list\n\n### Modified Endpoints\n\nThese endpoints have modified behavior:\n\n-  &#96;/v1/GetLocationGeoJSON&#96; - Returns 401 when DeviceKey is set\n\n## Response Format Compatibility\n\nAll response formats remain unchanged:\n\n- **UpdateLocation Response**: Same ACK format\n- **GetLocation Response**: Same MiataruLocation array format\n- **GetLocationHistory Response**: Same format with MiataruServerConfig\n- **GetVisitorHistory Response**: Same format with MiataruVisitors\n- **Error Responses**: Same format (new 401/403 codes added)\n\n## Error Code Compatibility\n\n### Existing Error Codes (Unchanged)\n\n- **400 Bad Request** - Invalid input\n- **404 Not Found** - Endpoint not found\n- **405 Method Not Supported** - Wrong HTTP method\n- **500 Internal Server Error** - Server error\n\n### New Error Codes (API 1.1)\n\n- **401 Unauthorized** - GetLocationGeoJSON called when DeviceKey is set\n- **403 Forbidden** - DeviceKey mismatch or access denied\n\n**Note:** New error codes only apply when security features are enabled. Existing clients not using security features will never encounter these codes.\n\n## Data Format Compatibility\n\n### Request Formats\n\nAll existing request formats continue to work:\n\n&#96;&#96;&#96;json\n// API 1.0 format - still works\n{\n  \"MiataruLocation\": [{\n    \"Device\": \"device-id\",\n    \"Timestamp\": \"1376735651302\",\n    \"Longitude\": \"10.837502\",\n    \"Latitude\": \"49.828925\",\n    \"HorizontalAccuracy\": \"50.00\"\n  }]\n}\n\n// API 1.1 format - optional DeviceKey\n{\n  ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "## Endpoint Status",
            "lineNumber": 143
          },
          {
            "lineNumber": 144
          },
          {
            "text": "### Unchanged Endpoints",
            "lineNumber": 145
          },
          {
            "lineNumber": 146
          },
          {
            "text": "These endpoints work exactly as in API 1.0:",
            "lineNumber": 147
          },
          {
            "lineNumber": 148
          },
          {
            "text": "-  &#96;/v1/UpdateLocation&#96; - Same behavior (DeviceKey optional)",
            "lineNumber": 149
          },
          {
            "text": "-  &#96;/v1/GetLocation&#96; - Same behavior (access control optional)",
            "lineNumber": 150
          },
          {
            "text": "-  &#96;/v1/GetLocationHistory&#96; - Same behavior (access control optional)",
            "lineNumber": 151
          },
          {
            "text": "-  &#96;/v1/GetVisitorHistory&#96; - Same behavior (DeviceKey optional)",
            "lineNumber": 152
          },
          {
            "text": "-  &#96;/v1/DeleteLocation&#96; - Unchanged",
            "lineNumber": 153
          },
          {
            "lineNumber": 154
          },
          {
            "text": "### New Endpoints",
            "lineNumber": 155
          },
          {
            "lineNumber": 156
          },
          {
            "text": "These endpoints are new in API 1.1:",
            "lineNumber": 157
          },
          {
            "lineNumber": 158
          },
          {
            "text": "-  &#96;/v1/setDeviceKey&#96; - Set or change device key",
            "lineNumber": 159
          },
          {
            "text": "-  &#96;/v1/setAllowedDeviceList&#96; - Manage allowed devices list",
            "lineNumber": 160
          },
          {
            "lineNumber": 161
          },
          {
            "text": "### Modified Endpoints",
            "lineNumber": 162
          },
          {
            "lineNumber": 163
          },
          {
            "text": "These endpoints have modified behavior:",
            "lineNumber": 164
          },
          {
            "lineNumber": 165
          },
          {
            "text": "-  &#96;/v1/GetLocationGeoJSON&#96; - Returns 401 when DeviceKey is set",
            "lineNumber": 166
          },
          {
            "lineNumber": 167
          },
          {
            "text": "## Response Format Compatibility",
            "lineNumber": 168
          },
          {
            "lineNumber": 169
          },
          {
            "text": "All response formats remain unchanged:",
            "lineNumber": 170
          },
          {
            "lineNumber": 171
          },
          {
            "text": "- **UpdateLocation Response**: Same ACK format",
            "lineNumber": 172
          },
          {
            "text": "- **GetLocation Response**: Same MiataruLocation array format",
            "lineNumber": 173
          },
          {
            "text": "- **GetLocationHistory Response**: Same format with MiataruServerConfig",
            "lineNumber": 174
          },
          {
            "text": "- **GetVisitorHistory Response**: Same format with MiataruVisitors",
            "lineNumber": 175
          },
          {
            "text": "- **Error Responses**: Same format (new 401/403 codes added)",
            "lineNumber": 176
          },
          {
            "lineNumber": 177
          },
          {
            "text": "## Error Code Compatibility",
            "lineNumber": 178
          },
          {
            "lineNumber": 179
          },
          {
            "text": "### Existing Error Codes (Unchanged)",
            "lineNumber": 180
          },
          {
            "lineNumber": 181
          },
          {
            "text": "- **400 Bad Request** - Invalid input",
            "lineNumber": 182
          },
          {
            "text": "- **404 Not Found** - Endpoint not found",
            "lineNumber": 183
          },
          {
            "text": "- **405 Method Not Supported** - Wrong HTTP method",
            "lineNumber": 184
          },
          {
            "text": "- **500 Internal Server Error** - Server error",
            "lineNumber": 185
          },
          {
            "lineNumber": 186
          },
          {
            "text": "### New Error Codes (API 1.1)",
            "lineNumber": 187
          },
          {
            "lineNumber": 188
          },
          {
            "text": "- **401 Unauthorized** - GetLocationGeoJSON called when DeviceKey is set",
            "lineNumber": 189
          },
          {
            "text": "- **403 Forbidden** - DeviceKey mismatch or access denied",
            "lineNumber": 190
          },
          {
            "lineNumber": 191
          },
          {
            "text": "**Note:** New error codes only apply when security features are enabled. Existing clients not using security features will never encounter these codes.",
            "lineNumber": 192
          },
          {
            "lineNumber": 193
          },
          {
            "text": "## Data Format Compatibility",
            "lineNumber": 194
          },
          {
            "lineNumber": 195
          },
          {
            "text": "### Request Formats",
            "lineNumber": 196
          },
          {
            "lineNumber": 197
          },
          {
            "text": "All existing request formats continue to work:",
            "lineNumber": 198
          },
          {
            "lineNumber": 199
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 200
          },
          {
            "text": "// API 1.0 format - still works",
            "lineNumber": 201
          },
          {
            "text": "{",
            "lineNumber": 202
          },
          {
            "text": "  \"MiataruLocation\": [{",
            "lineNumber": 203
          },
          {
            "text": "    \"Device\": \"device-id\",",
            "lineNumber": 204
          },
          {
            "text": "    \"Timestamp\": \"1376735651302\",",
            "lineNumber": 205
          },
          {
            "text": "    \"Longitude\": \"10.837502\",",
            "lineNumber": 206
          },
          {
            "text": "    \"Latitude\": \"49.828925\",",
            "lineNumber": 207
          },
          {
            "text": "    \"HorizontalAccuracy\": \"50.00\"",
            "lineNumber": 208
          },
          {
            "text": "  }]",
            "lineNumber": 209
          },
          {
            "text": "}",
            "lineNumber": 210
          },
          {
            "lineNumber": 211
          },
          {
            "text": "// API 1.1 format - optional DeviceKey",
            "lineNumber": 212
          },
          {
            "text": "{",
            "lineNumber": 213
          },
          {
            "text": "  ",
            "lineNumber": 214
          }
        ]
      },
      "score": 0.35032859444618225
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/API_1.1_SECURITY.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 74
          }
        },
        "contents": "# Miataru API 1.1 Security Features\n\n## Overview\n\nAPI version 1.1 introduces security and privacy enhancements to the Miataru server while maintaining full backward compatibility with API 1.0 clients. These features include:\n\n1. **RequestMiataruDeviceID (Mandatory)** - Required identifier for all GetLocation and GetLocationHistory requests\n2. **DeviceKey Authentication** - Protects write operations and visitor history access\n3. **Allowed Devices List** - Granular access control for location data sharing\n\n## RequestMiataruDeviceID (Mandatory in API 1.1)\n\n**BREAKING CHANGE:** Starting with API 1.1, &#96;RequestMiataruDeviceID&#96; is now **mandatory** for all &#96;GetLocation&#96; and &#96;GetLocationHistory&#96; requests. Requests without this field will return a 400 Bad Request error.\n\n### Purpose\n\nThe &#96;RequestMiataruDeviceID&#96; identifies the device making the request. This is used for:\n- Access control (allowed devices list)\n- Visitor history tracking\n- Security auditing\n\n### Usage\n\nInclude &#96;RequestMiataruDeviceID&#96; in the &#96;MiataruConfig&#96; object:\n\n**GetLocation:**\n&#96;&#96;&#96;json\n{\n  \"MiataruConfig\": {\n    \"RequestMiataruDeviceID\": \"your-client-identifier\"\n  },\n  \"MiataruGetLocation\": [\n    {\n      \"Device\": \"target-device-id\"\n    }\n  ]\n}\n&#96;&#96;&#96;\n\n**GetLocationHistory:**\n&#96;&#96;&#96;json\n{\n  \"MiataruConfig\": {\n    \"RequestMiataruDeviceID\": \"your-client-identifier\"\n  },\n  \"MiataruGetLocationHistory\": {\n    \"Device\": \"target-device-id\",\n    \"Amount\": \"10\"\n  }\n}\n&#96;&#96;&#96;\n\n### Migration\n\n**For existing clients:** Update all &#96;GetLocation&#96; and &#96;GetLocationHistory&#96; requests to include &#96;RequestMiataruDeviceID&#96; in the &#96;MiataruConfig&#96; object. The identifier can be:\n- A unique device ID\n- An application identifier\n- A URL or domain name\n- Any string that identifies the requesting client\n\n**Error Response:**\n&#96;&#96;&#96;json\n{\n  \"error\": \"Bad Request: RequestMiataruDeviceID is required\"\n}\n&#96;&#96;&#96;\n\n## DeviceKey Concept\n\nThe DeviceKey is a 256-character unicode string that acts as a password for a device. Once set, it must be provided for:\n\n- **UpdateLocation** - Writing location data to the server\n- **GetVisitorHistory** - Accessing visitor history information",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Miataru API 1.1 Security Features",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "## Overview",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "API version 1.1 introduces security and privacy enhancements to the Miataru server while maintaining full backward compatibility with API 1.0 clients. These features include:",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "1. **RequestMiataruDeviceID (Mandatory)** - Required identifier for all GetLocation and GetLocationHistory requests",
            "lineNumber": 7
          },
          {
            "text": "2. **DeviceKey Authentication** - Protects write operations and visitor history access",
            "lineNumber": 8
          },
          {
            "text": "3. **Allowed Devices List** - Granular access control for location data sharing",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "## RequestMiataruDeviceID (Mandatory in API 1.1)",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "**BREAKING CHANGE:** Starting with API 1.1, &#96;RequestMiataruDeviceID&#96; is now **mandatory** for all &#96;GetLocation&#96; and &#96;GetLocationHistory&#96; requests. Requests without this field will return a 400 Bad Request error.",
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "text": "### Purpose",
            "lineNumber": 15
          },
          {
            "lineNumber": 16
          },
          {
            "text": "The &#96;RequestMiataruDeviceID&#96; identifies the device making the request. This is used for:",
            "lineNumber": 17
          },
          {
            "text": "- Access control (allowed devices list)",
            "lineNumber": 18
          },
          {
            "text": "- Visitor history tracking",
            "lineNumber": 19
          },
          {
            "text": "- Security auditing",
            "lineNumber": 20
          },
          {
            "lineNumber": 21
          },
          {
            "text": "### Usage",
            "lineNumber": 22
          },
          {
            "lineNumber": 23
          },
          {
            "text": "Include &#96;RequestMiataruDeviceID&#96; in the &#96;MiataruConfig&#96; object:",
            "lineNumber": 24
          },
          {
            "lineNumber": 25
          },
          {
            "text": "**GetLocation:**",
            "lineNumber": 26
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 27
          },
          {
            "text": "{",
            "lineNumber": 28
          },
          {
            "text": "  \"MiataruConfig\": {",
            "lineNumber": 29
          },
          {
            "text": "    \"RequestMiataruDeviceID\": \"your-client-identifier\"",
            "lineNumber": 30
          },
          {
            "text": "  },",
            "lineNumber": 31
          },
          {
            "text": "  \"MiataruGetLocation\": [",
            "lineNumber": 32
          },
          {
            "text": "    {",
            "lineNumber": 33
          },
          {
            "text": "      \"Device\": \"target-device-id\"",
            "lineNumber": 34
          },
          {
            "text": "    }",
            "lineNumber": 35
          },
          {
            "text": "  ]",
            "lineNumber": 36
          },
          {
            "text": "}",
            "lineNumber": 37
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 38
          },
          {
            "lineNumber": 39
          },
          {
            "text": "**GetLocationHistory:**",
            "lineNumber": 40
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 41
          },
          {
            "text": "{",
            "lineNumber": 42
          },
          {
            "text": "  \"MiataruConfig\": {",
            "lineNumber": 43
          },
          {
            "text": "    \"RequestMiataruDeviceID\": \"your-client-identifier\"",
            "lineNumber": 44
          },
          {
            "text": "  },",
            "lineNumber": 45
          },
          {
            "text": "  \"MiataruGetLocationHistory\": {",
            "lineNumber": 46
          },
          {
            "text": "    \"Device\": \"target-device-id\",",
            "lineNumber": 47
          },
          {
            "text": "    \"Amount\": \"10\"",
            "lineNumber": 48
          },
          {
            "text": "  }",
            "lineNumber": 49
          },
          {
            "text": "}",
            "lineNumber": 50
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 51
          },
          {
            "lineNumber": 52
          },
          {
            "text": "### Migration",
            "lineNumber": 53
          },
          {
            "lineNumber": 54
          },
          {
            "text": "**For existing clients:** Update all &#96;GetLocation&#96; and &#96;GetLocationHistory&#96; requests to include &#96;RequestMiataruDeviceID&#96; in the &#96;MiataruConfig&#96; object. The identifier can be:",
            "lineNumber": 55
          },
          {
            "text": "- A unique device ID",
            "lineNumber": 56
          },
          {
            "text": "- An application identifier",
            "lineNumber": 57
          },
          {
            "text": "- A URL or domain name",
            "lineNumber": 58
          },
          {
            "text": "- Any string that identifies the requesting client",
            "lineNumber": 59
          },
          {
            "lineNumber": 60
          },
          {
            "text": "**Error Response:**",
            "lineNumber": 61
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 62
          },
          {
            "text": "{",
            "lineNumber": 63
          },
          {
            "text": "  \"error\": \"Bad Request: RequestMiataruDeviceID is required\"",
            "lineNumber": 64
          },
          {
            "text": "}",
            "lineNumber": 65
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 66
          },
          {
            "lineNumber": 67
          },
          {
            "text": "## DeviceKey Concept",
            "lineNumber": 68
          },
          {
            "lineNumber": 69
          },
          {
            "text": "The DeviceKey is a 256-character unicode string that acts as a password for a device. Once set, it must be provided for:",
            "lineNumber": 70
          },
          {
            "lineNumber": 71
          },
          {
            "text": "- **UpdateLocation** - Writing location data to the server",
            "lineNumber": 72
          },
          {
            "text": "- **GetVisitorHistory** - Accessing visitor history information",
            "lineNumber": 73
          }
        ]
      },
      "score": 0.34707915782928467
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/API_1.1_SECURITY.md",
        "range": {
          "startPosition": {
            "line": 207
          },
          "endPosition": {
            "line": 250
          }
        },
        "contents": "1. **Required Update**: Add &#96;RequestMiataruDeviceID&#96; to all GetLocation and GetLocationHistory requests\n2. **Optional Migration**: Clients can opt-in to security features by setting DeviceKey\n3. **Gradual Rollout**: Set DeviceKey for devices that need protection\n\n## Breaking Changes\n\n### RequestMiataruDeviceID is Mandatory\n\n**BREAKING CHANGE:** &#96;RequestMiataruDeviceID&#96; is now mandatory for all &#96;GetLocation&#96; and &#96;GetLocationHistory&#96; requests. Requests without this field will return 400 Bad Request.\n\n**Impact:** All clients must update their GetLocation and GetLocationHistory requests to include &#96;RequestMiataruDeviceID&#96; in the &#96;MiataruConfig&#96; object.\n\n**Migration:** See the [RequestMiataruDeviceID section](#requestmiatarudeviceid-mandatory-in-api-11) above for details.\n\n### GetLocationGeoJSON\n\n**BREAKING CHANGE:** If a DeviceKey has been set for a device, the &#96;/v1/GetLocationGeoJSON&#96; endpoint (both POST and GET variants) will return **401 Unauthorized**.\n\nThis is a security measure to prevent unauthorized access to location data via the public GET endpoint when DeviceKey protection is enabled.\n\n**Workaround:** Use the &#96;/v1/GetLocation&#96; POST endpoint instead, which respects the allowed devices list.\n\n## Security Best Practices\n\n1. **DeviceKey Selection:**\n   - Use a strong, randomly generated key (256 characters recommended)\n   - Store the key securely on the client device\n   - Never log or expose the DeviceKey\n\n2. **Allowed Devices Management:**\n   - Regularly review and update the allowed devices list\n   - Remove access for devices that no longer need it\n   - Use granular permissions (separate currentLocation and history access)\n\n3. **Error Handling:**\n   - Handle 403 Forbidden errors gracefully\n   - Prompt user to re-enter DeviceKey if validation fails\n   - Don't expose DeviceKey in error messages or logs\n\n## Error Codes\n\n- **400 Bad Request** - Invalid input (missing required fields, invalid format)\n  - Missing or empty &#96;RequestMiataruDeviceID&#96; in GetLocation or GetLocationHistory",
        "signatures": {},
        "detailedLines": [
          {
            "text": "1. **Required Update**: Add &#96;RequestMiataruDeviceID&#96; to all GetLocation and GetLocationHistory requests",
            "lineNumber": 208
          },
          {
            "text": "2. **Optional Migration**: Clients can opt-in to security features by setting DeviceKey",
            "lineNumber": 209
          },
          {
            "text": "3. **Gradual Rollout**: Set DeviceKey for devices that need protection",
            "lineNumber": 210
          },
          {
            "lineNumber": 211
          },
          {
            "text": "## Breaking Changes",
            "lineNumber": 212
          },
          {
            "lineNumber": 213
          },
          {
            "text": "### RequestMiataruDeviceID is Mandatory",
            "lineNumber": 214
          },
          {
            "lineNumber": 215
          },
          {
            "text": "**BREAKING CHANGE:** &#96;RequestMiataruDeviceID&#96; is now mandatory for all &#96;GetLocation&#96; and &#96;GetLocationHistory&#96; requests. Requests without this field will return 400 Bad Request.",
            "lineNumber": 216
          },
          {
            "lineNumber": 217
          },
          {
            "text": "**Impact:** All clients must update their GetLocation and GetLocationHistory requests to include &#96;RequestMiataruDeviceID&#96; in the &#96;MiataruConfig&#96; object.",
            "lineNumber": 218
          },
          {
            "lineNumber": 219
          },
          {
            "text": "**Migration:** See the [RequestMiataruDeviceID section](#requestmiatarudeviceid-mandatory-in-api-11) above for details.",
            "lineNumber": 220
          },
          {
            "lineNumber": 221
          },
          {
            "text": "### GetLocationGeoJSON",
            "lineNumber": 222
          },
          {
            "lineNumber": 223
          },
          {
            "text": "**BREAKING CHANGE:** If a DeviceKey has been set for a device, the &#96;/v1/GetLocationGeoJSON&#96; endpoint (both POST and GET variants) will return **401 Unauthorized**.",
            "lineNumber": 224
          },
          {
            "lineNumber": 225
          },
          {
            "text": "This is a security measure to prevent unauthorized access to location data via the public GET endpoint when DeviceKey protection is enabled.",
            "lineNumber": 226
          },
          {
            "lineNumber": 227
          },
          {
            "text": "**Workaround:** Use the &#96;/v1/GetLocation&#96; POST endpoint instead, which respects the allowed devices list.",
            "lineNumber": 228
          },
          {
            "lineNumber": 229
          },
          {
            "text": "## Security Best Practices",
            "lineNumber": 230
          },
          {
            "lineNumber": 231
          },
          {
            "text": "1. **DeviceKey Selection:**",
            "lineNumber": 232
          },
          {
            "text": "   - Use a strong, randomly generated key (256 characters recommended)",
            "lineNumber": 233
          },
          {
            "text": "   - Store the key securely on the client device",
            "lineNumber": 234
          },
          {
            "text": "   - Never log or expose the DeviceKey",
            "lineNumber": 235
          },
          {
            "lineNumber": 236
          },
          {
            "text": "2. **Allowed Devices Management:**",
            "lineNumber": 237
          },
          {
            "text": "   - Regularly review and update the allowed devices list",
            "lineNumber": 238
          },
          {
            "text": "   - Remove access for devices that no longer need it",
            "lineNumber": 239
          },
          {
            "text": "   - Use granular permissions (separate currentLocation and history access)",
            "lineNumber": 240
          },
          {
            "lineNumber": 241
          },
          {
            "text": "3. **Error Handling:**",
            "lineNumber": 242
          },
          {
            "text": "   - Handle 403 Forbidden errors gracefully",
            "lineNumber": 243
          },
          {
            "text": "   - Prompt user to re-enter DeviceKey if validation fails",
            "lineNumber": 244
          },
          {
            "text": "   - Don't expose DeviceKey in error messages or logs",
            "lineNumber": 245
          },
          {
            "lineNumber": 246
          },
          {
            "text": "## Error Codes",
            "lineNumber": 247
          },
          {
            "lineNumber": 248
          },
          {
            "text": "- **400 Bad Request** - Invalid input (missing required fields, invalid format)",
            "lineNumber": 249
          },
          {
            "text": "  - Missing or empty &#96;RequestMiataruDeviceID&#96; in GetLocation or GetLocationHistory",
            "lineNumber": 250
          }
        ]
      },
      "score": 0.3451792001724243
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/DELETE_LOCATION_API.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 83,
            "column": 4
          }
        },
        "contents": "# DeleteLocation API Documentation\n\n## Overview\n\nThe DeleteLocation API endpoint allows you to permanently delete all location data associated with a specific device. This includes:\n\n- Current/last known location data\n- Complete location history\n- Visitor history data\n\n## Endpoints\n\n### Version 1 API\n- **POST** &#96;/v1/DeleteLocation&#96;\n\n### Default API (Legacy)\n- **POST** &#96;/DeleteLocation&#96;\n\n## Request Format\n\n### Request Body Structure\n&#96;&#96;&#96;json\n{\n  \"MiataruDeleteLocation\": {\n    \"Device\": \"device-id-here\"\n  }\n}\n&#96;&#96;&#96;\n\n### Parameters\n\n| Parameter | Type | Required | Description |\n|-----------|------|----------|-------------|\n| &#96;MiataruDeleteLocation&#96; | Object | Yes | Container object for delete request |\n| &#96;Device&#96; | String | Yes | Unique identifier of the device whose location data should be deleted |\n\n## Response Format\n\n### Success Response\n&#96;&#96;&#96;json\n{\n  \"MiataruResponse\": \"ACK\",\n  \"MiataruVerboseResponse\": \"Location data deleted for device: device-id-here\",\n  \"MiataruDeletedCount\": 3\n}\n&#96;&#96;&#96;\n\n### Response Fields\n\n| Field | Type | Description |\n|-------|------|-------------|\n| &#96;MiataruResponse&#96; | String | Always \"ACK\" for successful deletion |\n| &#96;MiataruVerboseResponse&#96; | String | Human-readable message confirming deletion |\n| &#96;MiataruDeletedCount&#96; | Number | Number of Redis keys that were deleted (0-3) |\n\n### Error Response\n&#96;&#96;&#96;json\n{\n  \"error\": \"BadRequestError\",\n  \"message\": \"missing device\"\n}\n&#96;&#96;&#96;\n\n## Usage Examples\n\n### cURL Examples\n\n#### Delete location data for a specific device\n&#96;&#96;&#96;bash\ncurl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/v1/DeleteLocation' \\\n  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'\n&#96;&#96;&#96;\n\n#### Delete location data using legacy endpoint\n&#96;&#96;&#96;bash\ncurl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/DeleteLocation' \\\n  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'\n&#96;&#96;&#96;\n\n### JavaScript Example\n&#96;&#96;&#96;javascript\nconst deleteLocationData = async (deviceId) =&gt; {\n  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {\n    ",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# DeleteLocation API Documentation",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "## Overview",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "The DeleteLocation API endpoint allows you to permanently delete all location data associated with a specific device. This includes:",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "- Current/last known location data",
            "lineNumber": 7
          },
          {
            "text": "- Complete location history",
            "lineNumber": 8
          },
          {
            "text": "- Visitor history data",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "## Endpoints",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "### Version 1 API",
            "lineNumber": 13
          },
          {
            "text": "- **POST** &#96;/v1/DeleteLocation&#96;",
            "lineNumber": 14
          },
          {
            "lineNumber": 15
          },
          {
            "text": "### Default API (Legacy)",
            "lineNumber": 16
          },
          {
            "text": "- **POST** &#96;/DeleteLocation&#96;",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "## Request Format",
            "lineNumber": 19
          },
          {
            "lineNumber": 20
          },
          {
            "text": "### Request Body Structure",
            "lineNumber": 21
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 22
          },
          {
            "text": "{",
            "lineNumber": 23
          },
          {
            "text": "  \"MiataruDeleteLocation\": {",
            "lineNumber": 24
          },
          {
            "text": "    \"Device\": \"device-id-here\"",
            "lineNumber": 25
          },
          {
            "text": "  }",
            "lineNumber": 26
          },
          {
            "text": "}",
            "lineNumber": 27
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 28
          },
          {
            "lineNumber": 29
          },
          {
            "text": "### Parameters",
            "lineNumber": 30
          },
          {
            "lineNumber": 31
          },
          {
            "text": "| Parameter | Type | Required | Description |",
            "lineNumber": 32
          },
          {
            "text": "|-----------|------|----------|-------------|",
            "lineNumber": 33
          },
          {
            "text": "| &#96;MiataruDeleteLocation&#96; | Object | Yes | Container object for delete request |",
            "lineNumber": 34
          },
          {
            "text": "| &#96;Device&#96; | String | Yes | Unique identifier of the device whose location data should be deleted |",
            "lineNumber": 35
          },
          {
            "lineNumber": 36
          },
          {
            "text": "## Response Format",
            "lineNumber": 37
          },
          {
            "lineNumber": 38
          },
          {
            "text": "### Success Response",
            "lineNumber": 39
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 40
          },
          {
            "text": "{",
            "lineNumber": 41
          },
          {
            "text": "  \"MiataruResponse\": \"ACK\",",
            "lineNumber": 42
          },
          {
            "text": "  \"MiataruVerboseResponse\": \"Location data deleted for device: device-id-here\",",
            "lineNumber": 43
          },
          {
            "text": "  \"MiataruDeletedCount\": 3",
            "lineNumber": 44
          },
          {
            "text": "}",
            "lineNumber": 45
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 46
          },
          {
            "lineNumber": 47
          },
          {
            "text": "### Response Fields",
            "lineNumber": 48
          },
          {
            "lineNumber": 49
          },
          {
            "text": "| Field | Type | Description |",
            "lineNumber": 50
          },
          {
            "text": "|-------|------|-------------|",
            "lineNumber": 51
          },
          {
            "text": "| &#96;MiataruResponse&#96; | String | Always \"ACK\" for successful deletion |",
            "lineNumber": 52
          },
          {
            "text": "| &#96;MiataruVerboseResponse&#96; | String | Human-readable message confirming deletion |",
            "lineNumber": 53
          },
          {
            "text": "| &#96;MiataruDeletedCount&#96; | Number | Number of Redis keys that were deleted (0-3) |",
            "lineNumber": 54
          },
          {
            "lineNumber": 55
          },
          {
            "text": "### Error Response",
            "lineNumber": 56
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 57
          },
          {
            "text": "{",
            "lineNumber": 58
          },
          {
            "text": "  \"error\": \"BadRequestError\",",
            "lineNumber": 59
          },
          {
            "text": "  \"message\": \"missing device\"",
            "lineNumber": 60
          },
          {
            "text": "}",
            "lineNumber": 61
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 62
          },
          {
            "lineNumber": 63
          },
          {
            "text": "## Usage Examples",
            "lineNumber": 64
          },
          {
            "lineNumber": 65
          },
          {
            "text": "### cURL Examples",
            "lineNumber": 66
          },
          {
            "lineNumber": 67
          },
          {
            "text": "#### Delete location data for a specific device",
            "lineNumber": 68
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 69
          },
          {
            "text": "curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/v1/DeleteLocation' \\",
            "lineNumber": 70
          },
          {
            "text": "  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'",
            "lineNumber": 71
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 72
          },
          {
            "lineNumber": 73
          },
          {
            "text": "#### Delete location data using legacy endpoint",
            "lineNumber": 74
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 75
          },
          {
            "text": "curl -H 'Content-Type: application/json' -X POST 'http://localhost:8080/DeleteLocation' \\",
            "lineNumber": 76
          },
          {
            "text": "  -d '{\"MiataruDeleteLocation\":{\"Device\":\"my-device-123\"}}'",
            "lineNumber": 77
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 78
          },
          {
            "lineNumber": 79
          },
          {
            "text": "### JavaScript Example",
            "lineNumber": 80
          },
          {
            "text": "&#96;&#96;&#96;javascript",
            "lineNumber": 81
          },
          {
            "text": "const deleteLocationData = async (deviceId) =&gt; {",
            "lineNumber": 82
          },
          {
            "text": "  const response = await fetch('http://localhost:8080/v1/DeleteLocation', {",
            "lineNumber": 83
          },
          {
            "text": "    ",
            "lineNumber": 84
          }
        ]
      },
      "score": 0.3447401523590088
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./lib/routes/location/v1/location.js",
        "range": {
          "startPosition": {
            "line": 808
          },
          "endPosition": {
            "line": 885,
            "column": 3
          }
        },
        "contents": "function setDeviceKey(req, res, next) {\n\n {\n            var done = this;\n            // Set the new key\n            deviceKeyUtils.setDeviceKey(deviceId, newDeviceKey, function(error) {\n                if (error) {\n                    return done(error);\n                }\n\n                done();\n            });\n        })\n        .seq(function() {\n            res.send((new models.ResponseSetDeviceKey()).data());\n        })\n        .catch(function(error) {\n            if (error instanceof errors.ForbiddenError) {\n                return next(error);\n            }\n            next(new errors.InternalServerError(error));\n        });\n}\n\n/**\n * SetAllowedDeviceList\n * Sets or updates the allowed devices list for a device\n * @param req\n * @param res\n * @param next\n */",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 809,
                "column": 1
              },
              "endPosition": {
                "line": 810,
                "column": 5
              }
            },
            {
              "startPosition": {
                "line": 815,
                "column": 5
              },
              "endPosition": {
                "line": 815,
                "column": 5
              }
            },
            {
              "startPosition": {
                "line": 815,
                "column": 5
              },
              "endPosition": {
                "line": 815,
                "column": 5
              }
            },
            {
              "startPosition": {
                "line": 815,
                "column": 5
              },
              "endPosition": {
                "line": 815,
                "column": 5
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function setDeviceKey(req, res, next) {",
            "lineNumber": 809,
            "isSignature": true
          },
          {
            "lineNumber": 815
          },
          {
            "text": " {",
            "lineNumber": 858
          },
          {
            "text": "            var done = this;",
            "lineNumber": 859
          },
          {
            "text": "            // Set the new key",
            "lineNumber": 860
          },
          {
            "text": "            deviceKeyUtils.setDeviceKey(deviceId, newDeviceKey, function(error) {",
            "lineNumber": 861
          },
          {
            "text": "                if (error) {",
            "lineNumber": 862
          },
          {
            "text": "                    return done(error);",
            "lineNumber": 863
          },
          {
            "text": "                }",
            "lineNumber": 864
          },
          {
            "lineNumber": 865
          },
          {
            "text": "                done();",
            "lineNumber": 866
          },
          {
            "text": "            });",
            "lineNumber": 867
          },
          {
            "text": "        })",
            "lineNumber": 868
          },
          {
            "text": "        .seq(function() {",
            "lineNumber": 869
          },
          {
            "text": "            res.send((new models.ResponseSetDeviceKey()).data());",
            "lineNumber": 870
          },
          {
            "text": "        })",
            "lineNumber": 871
          },
          {
            "text": "        .catch(function(error) {",
            "lineNumber": 872
          },
          {
            "text": "            if (error instanceof errors.ForbiddenError) {",
            "lineNumber": 873
          },
          {
            "text": "                return next(error);",
            "lineNumber": 874
          },
          {
            "text": "            }",
            "lineNumber": 875
          },
          {
            "text": "            next(new errors.InternalServerError(error));",
            "lineNumber": 876
          },
          {
            "text": "        });",
            "lineNumber": 877
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          },
          {
            "lineNumber": 879
          },
          {
            "text": "/**",
            "lineNumber": 880
          },
          {
            "text": " * SetAllowedDeviceList",
            "lineNumber": 881
          },
          {
            "text": " * Sets or updates the allowed devices list for a device",
            "lineNumber": 882
          },
          {
            "text": " * @param req",
            "lineNumber": 883
          },
          {
            "text": " * @param res",
            "lineNumber": 884
          },
          {
            "text": " * @param next",
            "lineNumber": 885
          },
          {
            "text": " */",
            "lineNumber": 886
          }
        ]
      },
      "score": 0.34402310848236084
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/COMPATIBILITY_ASSESSMENT.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 44
          }
        },
        "contents": "# Miataru API 1.1 Compatibility Assessment\n\n## Executive Summary\n\nMiataru Server 2.0 and API 1.1 maintain **full backward compatibility** with API 1.0 clients, with one **required update**: &#96;RequestMiataruDeviceID&#96; is now mandatory for &#96;GetLocation&#96; and &#96;GetLocationHistory&#96; requests. All other security features are **opt-in** and do not affect existing clients unless explicitly enabled.\n\n## Backward Compatibility Guarantees\n\n### 1. All API 1.0 Endpoints Remain Unchanged\n\nAll existing API 1.0 endpoints continue to work exactly as before:\n\n| Endpoint | API 1.0 Behavior | API 1.1 Behavior | Compatible? |\n|----------|------------------|-------------------|-------------|\n| &#96;/v1/UpdateLocation&#96; | Works as before | Works as before (DeviceKey optional) |  Yes |\n| &#96;/v1/GetLocation&#96; | Works as before | Works as before (access control optional) |  Yes |\n| &#96;/v1/GetLocationHistory&#96; | Works as before | Works as before (access control optional) |  Yes |\n| &#96;/v1/GetVisitorHistory&#96; | Works as before | Works as before (DeviceKey optional) |  Yes |\n| &#96;/v1/DeleteLocation&#96; | Works as before | Works as before |  Yes |\n| &#96;/v1/GetLocationGeoJSON&#96; | Works as before | **BREAKING CHANGE** (see below) |  Conditional |\n\n### 2. Optional Parameters\n\nAll new security parameters are **optional**:\n\n- **DeviceKey** in &#96;MiataruLocation&#96; - Can be omitted if no DeviceKey is set\n- **DeviceKey** in &#96;MiataruGetVisitorHistory&#96; - Can be omitted if no DeviceKey is set\n- **Allowed Devices List** - Only affects behavior when explicitly set\n\n### 3. Default Behavior\n\nWhen security features are **not enabled**, behavior is identical to API 1.0:\n\n- Devices without DeviceKey set work exactly as before\n- Devices without allowed devices list work exactly as before\n- All response formats remain unchanged\n- All error codes remain unchanged (except new 401/403 for security features)\n\n## Breaking Changes\n\n### RequestMiataruDeviceID is Now Mandatory\n\n**Endpoints:** &#96;POST /v1/GetLocation&#96;, &#96;POST /v1/GetLocationHistory&#96;",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Miataru API 1.1 Compatibility Assessment",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "## Executive Summary",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "Miataru Server 2.0 and API 1.1 maintain **full backward compatibility** with API 1.0 clients, with one **required update**: &#96;RequestMiataruDeviceID&#96; is now mandatory for &#96;GetLocation&#96; and &#96;GetLocationHistory&#96; requests. All other security features are **opt-in** and do not affect existing clients unless explicitly enabled.",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "## Backward Compatibility Guarantees",
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "### 1. All API 1.0 Endpoints Remain Unchanged",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "All existing API 1.0 endpoints continue to work exactly as before:",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "| Endpoint | API 1.0 Behavior | API 1.1 Behavior | Compatible? |",
            "lineNumber": 13
          },
          {
            "text": "|----------|------------------|-------------------|-------------|",
            "lineNumber": 14
          },
          {
            "text": "| &#96;/v1/UpdateLocation&#96; | Works as before | Works as before (DeviceKey optional) |  Yes |",
            "lineNumber": 15
          },
          {
            "text": "| &#96;/v1/GetLocation&#96; | Works as before | Works as before (access control optional) |  Yes |",
            "lineNumber": 16
          },
          {
            "text": "| &#96;/v1/GetLocationHistory&#96; | Works as before | Works as before (access control optional) |  Yes |",
            "lineNumber": 17
          },
          {
            "text": "| &#96;/v1/GetVisitorHistory&#96; | Works as before | Works as before (DeviceKey optional) |  Yes |",
            "lineNumber": 18
          },
          {
            "text": "| &#96;/v1/DeleteLocation&#96; | Works as before | Works as before |  Yes |",
            "lineNumber": 19
          },
          {
            "text": "| &#96;/v1/GetLocationGeoJSON&#96; | Works as before | **BREAKING CHANGE** (see below) |  Conditional |",
            "lineNumber": 20
          },
          {
            "lineNumber": 21
          },
          {
            "text": "### 2. Optional Parameters",
            "lineNumber": 22
          },
          {
            "lineNumber": 23
          },
          {
            "text": "All new security parameters are **optional**:",
            "lineNumber": 24
          },
          {
            "lineNumber": 25
          },
          {
            "text": "- **DeviceKey** in &#96;MiataruLocation&#96; - Can be omitted if no DeviceKey is set",
            "lineNumber": 26
          },
          {
            "text": "- **DeviceKey** in &#96;MiataruGetVisitorHistory&#96; - Can be omitted if no DeviceKey is set",
            "lineNumber": 27
          },
          {
            "text": "- **Allowed Devices List** - Only affects behavior when explicitly set",
            "lineNumber": 28
          },
          {
            "lineNumber": 29
          },
          {
            "text": "### 3. Default Behavior",
            "lineNumber": 30
          },
          {
            "lineNumber": 31
          },
          {
            "text": "When security features are **not enabled**, behavior is identical to API 1.0:",
            "lineNumber": 32
          },
          {
            "lineNumber": 33
          },
          {
            "text": "- Devices without DeviceKey set work exactly as before",
            "lineNumber": 34
          },
          {
            "text": "- Devices without allowed devices list work exactly as before",
            "lineNumber": 35
          },
          {
            "text": "- All response formats remain unchanged",
            "lineNumber": 36
          },
          {
            "text": "- All error codes remain unchanged (except new 401/403 for security features)",
            "lineNumber": 37
          },
          {
            "lineNumber": 38
          },
          {
            "text": "## Breaking Changes",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "### RequestMiataruDeviceID is Now Mandatory",
            "lineNumber": 41
          },
          {
            "lineNumber": 42
          },
          {
            "text": "**Endpoints:** &#96;POST /v1/GetLocation&#96;, &#96;POST /v1/GetLocationHistory&#96;",
            "lineNumber": 43
          }
        ]
      },
      "score": 0.34232810139656067
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---


DeleteLocation is not protected by DeviceKey, even though it's a write operation. Findings:

## Current state

1. Implementation: `deleteLocation` in `lib/routes/location/v1/location.js` (lines 756-800) does not validate DeviceKey before deleting data.
2. Request model: `RequestDevice` only has a `device()` method; no `deviceKey()` support.
3. Documentation:
   - `docs/DELETE_LOCATION_API.md` states: "No Authentication: The current implementation does not include authentication" (line 157).
   - `docs/API_1.1_SECURITY.md` lists DeviceKey as required for:
     - UpdateLocation (line 72)
     - GetVisitorHistory (line 73)
     - But not DeleteLocation.

## Security gap

DeleteLocation should require DeviceKey authentication when a DeviceKey is set, similar to UpdateLocation, since it modifies/deletes data.

## What needs to be done

1. Update `RequestDevice` to support `DeviceKey` (or create a new request model).
2. Add DeviceKey validation to `deleteLocation` (similar to `updateLocation`).
3. Update documentation:
   - `docs/DELETE_LOCATION_API.md`  add DeviceKey authentication.
   - `docs/API_1.1_SECURITY.md`  include DeleteLocation in the list of endpoints requiring DeviceKey.
4. Add tests for DeviceKey validation in DeleteLocation.

Should I implement these changes?

---

